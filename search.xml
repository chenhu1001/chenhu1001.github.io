<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>一键搭建 WordPress + MySQL + phpMyAdmin 环境（支持 PHP 版本选择 &amp; 自定义配置）</title>
      <link href="/2025/06/08/%E4%B8%80%E9%94%AE%E6%90%AD%E5%BB%BA-WordPress-MySQL-phpMyAdmin-%E7%8E%AF%E5%A2%83%EF%BC%88%E6%94%AF%E6%8C%81-PHP-%E7%89%88%E6%9C%AC%E9%80%89%E6%8B%A9-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%EF%BC%89/"/>
      <url>/2025/06/08/%E4%B8%80%E9%94%AE%E6%90%AD%E5%BB%BA-WordPress-MySQL-phpMyAdmin-%E7%8E%AF%E5%A2%83%EF%BC%88%E6%94%AF%E6%8C%81-PHP-%E7%89%88%E6%9C%AC%E9%80%89%E6%8B%A9-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>想快速搭建一个 WordPress 环境？这篇文章将带你一步步实现：使用 <code>Docker Compose</code> 一键部署 WordPress、MySQL 和 phpMyAdmin，同时支持指定 PHP 版本和自定义 <code>php.ini</code> 配置。</p><hr><h2 id="✅-功能亮点"><a href="#✅-功能亮点" class="headerlink" title="✅ 功能亮点"></a>✅ 功能亮点</h2><ul><li>🚀 一键启动 WordPress + MySQL + phpMyAdmin</li><li>🧩 可选 PHP 版本（通过自定义 Dockerfile）</li><li>⚙️ 自定义 <code>php.ini</code> 配置</li><li>💾 数据持久化保存到本地目录</li><li>🔐 所有配置开箱即用</li></ul><hr><h2 id="🧱-项目结构"><a href="#🧱-项目结构" class="headerlink" title="🧱 项目结构"></a>🧱 项目结构</h2><p>首先，我们建议使用如下目录结构：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">project-root/</span><br><span class="line">├── docker-compose.yml       # 核心 Docker 配置</span><br><span class="line">├── php.ini                  # PHP 自定义设置</span><br><span class="line">├── wordpress/               # WordPress Dockerfile 存放处</span><br><span class="line">│   └── Dockerfile</span><br><span class="line">└── data/                    # 数据卷</span><br><span class="line">    ├── wordpress/           # WordPress 文件（自动生成）</span><br><span class="line">    └── mysql/               # MySQL 数据（自动生成）</span><br></pre></td></tr></table></figure><hr><h2 id="📦-完整-docker-compose-yml"><a href="#📦-完整-docker-compose-yml" class="headerlink" title="📦 完整 docker-compose.yml"></a>📦 完整 <code>docker-compose.yml</code></h2><p>这是本项目的核心配置，定义了三个服务：<code>wordpress</code>、<code>db</code>（MySQL）和 <code>phpmyadmin</code>。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">wordpress:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./wordpress</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:80&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_HOST:</span> <span class="string">db:3306</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_NAME:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_USER:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/wordpress:/var/www/html</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./php.ini:/usr/local/etc/php/php.ini</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">wordpress_db</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">MYSQL_USER:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">MYSQL_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">rootpassword</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/mysql:/var/lib/mysql</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">phpmyadmin:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">phpmyadmin/phpmyadmin</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">phpmyadmin</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8081:80&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">PMA_HOST:</span> <span class="string">db</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">rootpassword</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br></pre></td></tr></table></figure><hr><h2 id="🐘-Dockerfile（选择-PHP-版本）"><a href="#🐘-Dockerfile（选择-PHP-版本）" class="headerlink" title="🐘 Dockerfile（选择 PHP 版本）"></a>🐘 Dockerfile（选择 PHP 版本）</h2><p>你可以使用 WordPress 官方镜像的 PHP 变体，例如 PHP 8.1、8.2 或 7.4：</p><p><strong><code>wordpress/Dockerfile</code></strong></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 PHP 8.1 的 WordPress 镜像</span></span><br><span class="line"><span class="keyword">FROM</span> wordpress:php8.<span class="number">1</span>-apache</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 mysqli 扩展（可按需添加更多扩展）</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> docker-php-ext-install mysqli &amp;&amp; docker-php-ext-enable mysqli</span></span><br></pre></td></tr></table></figure><hr><h2 id="⚙️-自定义-php-ini"><a href="#⚙️-自定义-php-ini" class="headerlink" title="⚙️ 自定义 php.ini"></a>⚙️ 自定义 php.ini</h2><p>如果你需要调整上传大小、内存限制等，可以创建一个 <code>php.ini</code> 文件：</p><p><strong><code>php.ini</code></strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upload_max_filesize</span> = <span class="number">1024</span>M</span><br><span class="line"><span class="attr">post_max_size</span> = <span class="number">1024</span>M</span><br><span class="line"><span class="attr">memory_limit</span> = <span class="number">256</span>M</span><br><span class="line"><span class="attr">max_execution_time</span> = <span class="number">300</span></span><br></pre></td></tr></table></figure><p>该文件会在容器中挂载到 <code>/usr/local/etc/php/php.ini</code>，自动生效。</p><hr><h2 id="🚀-启动项目"><a href="#🚀-启动项目" class="headerlink" title="🚀 启动项目"></a>🚀 启动项目</h2><p>确保你已经安装了 Docker 和 Docker Compose，然后在项目根目录运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><p>启动成功后：</p><ul><li>🖥️ 访问 WordPress：<a href="http://localhost:8080/">http://localhost:8080</a></li><li>🛠️ 访问 phpMyAdmin：<a href="http://localhost:8081（登录用户名">http://localhost:8081（登录用户名</a> <code>root</code>，密码 <code>rootpassword</code>）</li></ul><hr><h2 id="📌-常见问题-amp-提示"><a href="#📌-常见问题-amp-提示" class="headerlink" title="📌 常见问题 &amp; 提示"></a>📌 常见问题 &amp; 提示</h2><ul><li><p><strong>如何更换 PHP 版本？</strong><br>修改 <code>Dockerfile</code> 中的 <code>FROM</code> 行，例如换成 <code>wordpress:php7.4-apache</code>。</p></li><li><p><strong>WordPress 文件修改后不生效？</strong><br>确保 <code>./data/wordpress</code> 目录存在并具有正确权限（尤其是在 Linux 下）。</p></li><li><p><strong>php.ini 没生效？</strong><br>检查是否正确挂载，并重启容器 <code>docker-compose restart wordpress</code>。</p></li></ul><hr><h2 id="✅-总结"><a href="#✅-总结" class="headerlink" title="✅ 总结"></a>✅ 总结</h2><p>通过上述配置，你可以快速搭建一个可自定义的 WordPress 环境，无需繁琐手动配置数据库或 PHP 设置。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
            <tag> WordPress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AI网址大全</title>
      <link href="/2025/02/16/AI%E7%BD%91%E5%9D%80%E5%A4%A7%E5%85%A8/"/>
      <url>/2025/02/16/AI%E7%BD%91%E5%9D%80%E5%A4%A7%E5%85%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="热门-AI-网站-网页版-："><a href="#热门-AI-网站-网页版-：" class="headerlink" title="热门 AI 网站(网页版)："></a>热门 AI 网站(网页版)：</h1><p><a href="https://www.deepseek.com/">deepseek（深度求索）</a></p><p><a href="https://tongyi.aliyun.com/">Qwen（通义千问）</a></p><p><a href="https://www.doubao.com/chat/">Doubao（豆包）</a></p><p><a href="https://kimi.moonshot.cn/">Kimi(月之暗面)</a></p><p><a href="https://yuanbao.tencent.com/chat/naQivTmsDa">腾讯（混元大模型）</a></p><p><a href="https://zhida.zhihu.com/">知乎直答</a></p><h1 id="第三方部署托管版的deepseek："><a href="#第三方部署托管版的deepseek：" class="headerlink" title="第三方部署托管版的deepseek："></a>第三方部署托管版的deepseek：</h1><p><a href="https://www.ctyun.cn/act/xirang/deepseek">电信版deepseek</a></p><p><a href="https://siliconflow.cn/zh-cn/models">硅基流动deepseek(与华为合作)</a></p><p><a href="https://metaso.cn/">秘塔搜版deepseek</a></p><p><a href="https://bot.n.cn/?src=dh_bj">360(纳米AI搜索)</a></p><h1 id="热门趣味工具"><a href="#热门趣味工具" class="headerlink" title="热门趣味工具:"></a>热门趣味工具:</h1><p><a href="https://www.doubao.com/chat/write">豆包写作专区</a></p><p><a href="https://tongyi.aliyun.com/aippt">PPT创作（通义提供）</a></p><p><a href="https://tongyi.aliyun.com/live/">语音转文字（实时记录）</a></p><p><a href="https://tongyi.aliyun.com/wanxiang/creation">文字作画</a></p><p><a href="https://tongyi.aliyun.com/wanxiang/videoCreation">视频生成</a></p><p><a href="https://www.doubao.com/chat/coding">AI编程（豆包提供）</a></p><h1 id="高手专区（技术玩家进）："><a href="#高手专区（技术玩家进）：" class="headerlink" title="高手专区（技术玩家进）："></a>高手专区（技术玩家进）：</h1><p><a href="https://ollama.com/">ollama（本地部署大模型）</a></p><p><a href="https://dashi.aliyun.com/activity/aigc?userCode=pdtxefg3">打造专属AI应用</a></p><p><a href="https://dashi.aliyun.com/activity/mobi?userCode=pdtxefg3">阿里云AI+ 应用开发平台 </a></p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于C++线程延迟处理的 ROS 消息逻辑优化</title>
      <link href="/2024/11/20/%E5%9F%BA%E4%BA%8EC-%E7%BA%BF%E7%A8%8B%E5%BB%B6%E8%BF%9F%E5%A4%84%E7%90%86%E7%9A%84-ROS-%E6%B6%88%E6%81%AF%E9%80%BB%E8%BE%91%E4%BC%98%E5%8C%96/"/>
      <url>/2024/11/20/%E5%9F%BA%E4%BA%8EC-%E7%BA%BF%E7%A8%8B%E5%BB%B6%E8%BF%9F%E5%A4%84%E7%90%86%E7%9A%84-ROS-%E6%B6%88%E6%81%AF%E9%80%BB%E8%BE%91%E4%BC%98%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h3 id="基于线程延迟处理的-ROS-消息逻辑优化"><a href="#基于线程延迟处理的-ROS-消息逻辑优化" class="headerlink" title="基于线程延迟处理的 ROS 消息逻辑优化"></a><strong>基于线程延迟处理的 ROS 消息逻辑优化</strong></h3><p>在 ROS 开发中，我们常常需要对某些消息的处理逻辑进行优化。例如，某个话题的消息可能会频繁发布，而我们希望在消息连续时推迟某些操作，只有在消息停止后一定时间才触发特定逻辑。这种场景可以通过线程延迟处理机制实现。</p><p>本文以一个电笛控制系统为例，讲解如何通过线程延迟机制优化 ROS 的消息处理逻辑。</p><hr><h4 id="需求场景"><a href="#需求场景" class="headerlink" title="需求场景"></a><strong>需求场景</strong></h4><ul><li>话题 <code>/electric_horn</code> 的消息以 <code>std_msgs::Bool</code> 类型发布，表示是否按下电笛按钮。</li><li>当消息连续时，不执行心跳操作 <code>HeartBeat</code>。</li><li>当最后一条消息超过 1 秒未更新时，触发 <code>HeartBeat</code>。</li></ul><hr><h3 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a><strong>实现思路</strong></h3><ol><li><p><strong>延迟触发机制</strong><br>通过记录最近一次收到消息的时间，启动一个独立的线程监控消息间隔。只有当消息停止（超过 1 秒未更新）后，才触发 <code>HeartBeat</code> 操作。</p></li><li><p><strong>线程控制</strong><br>使用 <code>std::thread</code> 来实现延迟触发逻辑，同时通过 <code>std::atomic</code> 控制线程的启动和停止，避免多线程竞态。</p></li><li><p><strong>ROS消息回调逻辑</strong><br>每次收到新消息时，更新最新时间并终止之前的延迟线程，重新启动监控逻辑。</p></li></ol><hr><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a><strong>代码实现</strong></h3><h4 id="类成员变量"><a href="#类成员变量" class="headerlink" title="类成员变量"></a><strong>类成员变量</strong></h4><p>在 <code>TowerController</code> 类中，定义以下变量：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TowerController</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::chrono::steady_clock::time_point lastMessageTime_; <span class="comment">// 最近消息的时间</span></span><br><span class="line">    std::shared_ptr&lt;std::thread&gt; delayThread_;             <span class="comment">// 延迟处理的线程</span></span><br><span class="line">    std::atomic&lt;<span class="type">bool</span>&gt; stopDelayThread_;                    <span class="comment">// 控制线程停止的标志</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">PressElectricHornCallback</span><span class="params">(<span class="type">const</span> std_msgs::Bool::ConstPtr&amp; press)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">ElectricHorn</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">HeartBeat</span><span class="params">(<span class="type">bool</span> active)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="构造函数与析构函数"><a href="#构造函数与析构函数" class="headerlink" title="构造函数与析构函数"></a><strong>构造函数与析构函数</strong></h4><p>初始化时间点和线程控制变量，并确保析构时安全退出线程：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">TowerController::<span class="built_in">TowerController</span>() &#123;</span><br><span class="line">    lastMessageTime_ = std::chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    stopDelayThread_ = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TowerController::~<span class="built_in">TowerController</span>() &#123;</span><br><span class="line">    stopDelayThread_ = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (delayThread_ &amp;&amp; delayThread_-&gt;<span class="built_in">joinable</span>()) &#123;</span><br><span class="line">        delayThread_-&gt;<span class="built_in">join</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="消息回调函数"><a href="#消息回调函数" class="headerlink" title="消息回调函数"></a><strong>消息回调函数</strong></h4><p>每次接收到消息时，更新最新时间，终止之前的延迟线程并启动新的监控线程：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TowerController::PressElectricHornCallback</span><span class="params">(<span class="type">const</span> std_msgs::Bool::ConstPtr&amp; press)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (press-&gt;data) &#123;</span><br><span class="line">        <span class="built_in">INFO</span>(<span class="string">&quot;收到电笛按钮按下信号&quot;</span>);</span><br><span class="line">        ctThread-&gt;<span class="built_in">Enqueue</span>(std::<span class="built_in">bind</span>(&amp;TowerController::ElectricHorn, <span class="keyword">this</span>)); <span class="comment">// 异步处理电笛逻辑</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新最后一次收到消息的时间</span></span><br><span class="line">        lastMessageTime_ = std::chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 停止现有的延迟线程</span></span><br><span class="line">        stopDelayThread_ = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (delayThread_ &amp;&amp; delayThread_-&gt;<span class="built_in">joinable</span>()) &#123;</span><br><span class="line">            delayThread_-&gt;<span class="built_in">join</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        stopDelayThread_ = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动新的延迟线程</span></span><br><span class="line">        delayThread_ = std::<span class="built_in">make_shared</span>&lt;std::thread&gt;([<span class="keyword">this</span>]() &#123;</span><br><span class="line">            <span class="keyword">while</span> (!stopDelayThread_) &#123;</span><br><span class="line">                <span class="keyword">auto</span> now = std::chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">                <span class="keyword">if</span> (std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::seconds&gt;(now - lastMessageTime_).<span class="built_in">count</span>() &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="built_in">INFO</span>(<span class="string">&quot;消息间隔超过1秒，触发心跳信号&quot;</span>);</span><br><span class="line">                    <span class="built_in">HeartBeat</span>(<span class="literal">true</span>); <span class="comment">// 触发心跳操作</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">10</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="电笛逻辑"><a href="#电笛逻辑" class="headerlink" title="电笛逻辑"></a><strong>电笛逻辑</strong></h4><p>保持 <code>ElectricHorn</code> 的核心逻辑不变，负责单纯的电笛控制：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">TowerController::ElectricHorn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">INFO</span>(<span class="string">&quot;电笛按钮被触发&quot;</span>);</span><br><span class="line">    <span class="built_in">ElectricHornControl</span>();      <span class="comment">// 执行电笛硬件控制</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="优化点与注意事项"><a href="#优化点与注意事项" class="headerlink" title="优化点与注意事项"></a><strong>优化点与注意事项</strong></h3><ol><li><p><strong>避免线程泄漏</strong><br>每次启动新的延迟线程前，确保之前的线程安全退出（使用 <code>join</code>）。</p></li><li><p><strong>提高线程效率</strong><br>使用 <code>std::this_thread::sleep_for</code> 来减少线程对 CPU 的占用，同时避免繁忙轮询。</p></li><li><p><strong>多线程安全性</strong><br>使用 <code>std::atomic</code> 来控制线程停止标志，避免线程间的数据竞争。</p></li><li><p><strong>可维护性</strong><br>将 <code>HeartBeat</code> 的触发逻辑外部化，确保核心功能（如 <code>ElectricHorn</code>）独立，逻辑清晰。</p></li></ol><hr><h3 id="完整效果"><a href="#完整效果" class="headerlink" title="完整效果"></a><strong>完整效果</strong></h3><ul><li>在消息频繁时，只执行电笛控制逻辑，不触发心跳信号。</li><li>当最后一条消息超过 1 秒未更新后，延迟线程触发心跳信号。</li><li>避免频繁触发心跳信号，提高系统效率。</li></ul><hr><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>通过线程延迟机制，我们可以优雅地解决 ROS 消息的连续处理问题。这种模式不仅适用于电笛控制系统，还可以推广到其他需要延迟触发的场景，如报警信号、状态同步等。</p><p>使用延迟线程结合时间点记录，既保证了实时性，又提升了系统的灵活性，是一种实用且高效的设计模式。</p>]]></content>
      
      
      <categories>
          
          <category> ROS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROS </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 Docker 运行 Node.js：无需依赖系统版本，快速切换、环境隔离</title>
      <link href="/2024/11/19/%E4%BD%BF%E7%94%A8-Docker-%E8%BF%90%E8%A1%8C-Node-js%EF%BC%9A%E6%97%A0%E9%9C%80%E4%BE%9D%E8%B5%96%E7%B3%BB%E7%BB%9F%E7%89%88%E6%9C%AC%EF%BC%8C%E5%BF%AB%E9%80%9F%E5%88%87%E6%8D%A2%E3%80%81%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB/"/>
      <url>/2024/11/19/%E4%BD%BF%E7%94%A8-Docker-%E8%BF%90%E8%A1%8C-Node-js%EF%BC%9A%E6%97%A0%E9%9C%80%E4%BE%9D%E8%B5%96%E7%B3%BB%E7%BB%9F%E7%89%88%E6%9C%AC%EF%BC%8C%E5%BF%AB%E9%80%9F%E5%88%87%E6%8D%A2%E3%80%81%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB/</url>
      
        <content type="html"><![CDATA[<h3 id="使用-Docker-运行-Node-js：无需依赖系统版本，快速切换、环境隔离"><a href="#使用-Docker-运行-Node-js：无需依赖系统版本，快速切换、环境隔离" class="headerlink" title="使用 Docker 运行 Node.js：无需依赖系统版本，快速切换、环境隔离"></a><strong>使用 Docker 运行 Node.js：无需依赖系统版本，快速切换、环境隔离</strong></h3><p>在开发 Node.js 应用时，很多开发者会遇到一个问题：<strong>系统中的 Node.js 版本不支持最新功能，或者需要在多个版本之间频繁切换</strong>。传统方式需要手动安装和配置，这不仅费时，还容易污染系统环境。借助 <strong>Docker</strong>，你可以轻松解决这些问题。</p><p>本文将以一个实际案例展示如何使用 Docker 快速运行 <strong>Node.js 20</strong>，实现系统版本无关性、动态版本切换和环境隔离。</p><hr><h3 id="为什么使用-Docker-运行-Node-js？"><a href="#为什么使用-Docker-运行-Node-js？" class="headerlink" title="为什么使用 Docker 运行 Node.js？"></a><strong>为什么使用 Docker 运行 Node.js？</strong></h3><ol><li><p><strong>系统版本无关性</strong><br>无需关心操作系统是否支持特定版本的 Node.js（例如在 CentOS 7 上运行最新版本的 Node.js），一切都由 Docker 容器管理。</p></li><li><p><strong>动态版本切换</strong><br>Docker 镜像支持不同版本的 Node.js，切换版本只需更改镜像标签（如 <code>node:18</code>、<code>node:20</code>）。</p></li><li><p><strong>环境隔离</strong><br>容器中的 Node.js 环境独立于主机系统，避免版本冲突或环境污染。</p></li><li><p><strong>便捷共享</strong><br>使用容器共享开发环境，只需一条命令，团队成员就能快速运行一致的环境。</p></li></ol><hr><h3 id="核心命令"><a href="#核心命令" class="headerlink" title="核心命令"></a><strong>核心命令</strong></h3><p>以下是我们将在教程中使用的命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> -it --name node-container-20 -v $(<span class="built_in">pwd</span>):/app -w /app -p 4000:4000 node:20 bash</span><br></pre></td></tr></table></figure><p>这条命令启动一个基于 <strong>Node.js 20</strong> 的容器，配置了文件挂载、端口映射、环境隔离等功能。以下是详细解析。</p><hr><h3 id="命令详解"><a href="#命令详解" class="headerlink" title="命令详解"></a><strong>命令详解</strong></h3><h4 id="1-系统版本无关性：使用-Docker-镜像"><a href="#1-系统版本无关性：使用-Docker-镜像" class="headerlink" title="1. 系统版本无关性：使用 Docker 镜像"></a>1. 系统版本无关性：使用 Docker 镜像</h4><ul><li><strong><code>node:20</code></strong> 指定 Node.js 的版本为 20。</li><li>Docker 自动从官方仓库中拉取对应版本的 Node.js 镜像，镜像包含了运行时环境和必要依赖，无需考虑系统是否支持。</li></ul><h4 id="2-动态切换版本"><a href="#2-动态切换版本" class="headerlink" title="2. 动态切换版本"></a>2. 动态切换版本</h4><ul><li>如果需要切换到其他版本，只需替换镜像标签。例如切换到 Node.js 18：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> -it --name node-container-18 -v $(<span class="built_in">pwd</span>):/app -w /app -p 4000:4000 node:18 bash</span><br></pre></td></tr></table></figure></li></ul><h4 id="3-环境隔离与便捷性"><a href="#3-环境隔离与便捷性" class="headerlink" title="3. 环境隔离与便捷性"></a>3. 环境隔离与便捷性</h4><ul><li><strong>隔离</strong>：容器中的 Node.js 独立运行，不影响主机系统。无论主机是否安装了 Node.js，都可以正常运行。</li><li><strong>临时运行</strong>：使用 <code>--rm</code> 参数，容器退出后会自动删除，不留痕迹，保持系统干净。</li></ul><h4 id="4-文件挂载与共享"><a href="#4-文件挂载与共享" class="headerlink" title="4. 文件挂载与共享"></a>4. 文件挂载与共享</h4><ul><li><strong><code>-v $(pwd):/app</code></strong> 将主机当前目录挂载到容器的 <code>/app</code> 目录，主机和容器间共享文件。主机修改的代码会立即反映在容器中。</li></ul><h4 id="5-端口映射"><a href="#5-端口映射" class="headerlink" title="5. 端口映射"></a>5. 端口映射</h4><ul><li><strong><code>-p 4000:4000</code></strong> 将宿主机的 4000 端口映射到容器的 4000 端口，方便在主机上直接访问容器内运行的服务。</li></ul><hr><h3 id="实际操作"><a href="#实际操作" class="headerlink" title="实际操作"></a><strong>实际操作</strong></h3><h4 id="1-运行容器"><a href="#1-运行容器" class="headerlink" title="1. 运行容器"></a>1. 运行容器</h4><p>在项目目录运行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> -it --name node-container-20 -v $(<span class="built_in">pwd</span>):/app -w /app -p 4000:4000 node:20 bash</span><br></pre></td></tr></table></figure><h4 id="2-容器中的操作"><a href="#2-容器中的操作" class="headerlink" title="2. 容器中的操作"></a>2. 容器中的操作</h4><p>进入容器后，终端会显示类似以下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@&lt;container-id&gt;:/app#</span><br></pre></td></tr></table></figure><p>此时，你可以在容器中执行 Node.js 相关命令。例如：</p><ul><li><p>检查 Node.js 版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v20.x.x</span><br></pre></td></tr></table></figure></li><li><p>运行简单的 HTTP 服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;const http = require(&#x27;http&#x27;);&quot;</span> &gt; server.js</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;http.createServer((req, res) =&gt; res.end(&#x27;Hello, Docker!&#x27;)).listen(4000);&quot;</span> &gt;&gt; server.js</span><br><span class="line">node server.js</span><br></pre></td></tr></table></figure></li></ul><h4 id="3-宿主机访问服务"><a href="#3-宿主机访问服务" class="headerlink" title="3. 宿主机访问服务"></a>3. 宿主机访问服务</h4><p>在浏览器中访问 <code>http://localhost:4000</code> 或通过 <code>curl</code> 测试：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:4000</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello, Docker!</span><br></pre></td></tr></table></figure><h4 id="4-退出容器"><a href="#4-退出容器" class="headerlink" title="4. 退出容器"></a>4. 退出容器</h4><p>输入 <code>exit</code> 即可退出容器，容器会自动清理（由于我们使用了 <code>--rm</code> 参数）。</p><hr><h3 id="灵活切换和持久化环境"><a href="#灵活切换和持久化环境" class="headerlink" title="灵活切换和持久化环境"></a><strong>灵活切换和持久化环境</strong></h3><h4 id="切换-Node-js-版本"><a href="#切换-Node-js-版本" class="headerlink" title="切换 Node.js 版本"></a><strong>切换 Node.js 版本</strong></h4><p>如需运行不同版本，只需修改镜像标签。例如运行 Node.js 16：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> -it --name node-container-16 -v $(<span class="built_in">pwd</span>):/app -w /app -p 4000:4000 node:16 bash</span><br></pre></td></tr></table></figure><h4 id="持久化容器"><a href="#持久化容器" class="headerlink" title="持久化容器"></a><strong>持久化容器</strong></h4><p>如果希望容器退出后仍能保存环境和数据，可去掉 <code>--rm</code> 参数，并重新启动容器：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name node-container-20 -v $(<span class="built_in">pwd</span>):/app -w /app -p 4000:4000 node:20 bash</span><br></pre></td></tr></table></figure><p>退出后可以重新启动：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start -ai node-container-20</span><br></pre></td></tr></table></figure><hr><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>通过 Docker 运行 Node.js 环境，可以完全摆脱对系统版本的依赖，轻松切换不同版本，实现开发环境的快速搭建和隔离。<br>无论你是想在老旧系统（如 CentOS 7）上使用最新的 Node.js，还是需要在多个项目间切换 Node.js 版本，Docker 都能为你提供高效的解决方案。  </p><p>赶快试试这个方法，让你的开发更高效、更干净！🎉</p>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python多进程编程与进程间通信</title>
      <link href="/2024/11/19/Python%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%BC%96%E7%A8%8B%E4%B8%8E%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/"/>
      <url>/2024/11/19/Python%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%BC%96%E7%A8%8B%E4%B8%8E%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/</url>
      
        <content type="html"><![CDATA[<p>Python的多进程编程是通过multiprocessing模块来实现的，利用多进程可以有效地提高程序的运行效率。然而，在多进程编程中，进程间的通信是一个非常重要的问题。本文将介绍Python多进程编程的基础知识，并重点讨论进程间的通信方法，包括队列、管道和共享内存。</p><h1 id="Python多进程编程基础"><a href="#Python多进程编程基础" class="headerlink" title="Python多进程编程基础"></a>Python多进程编程基础</h1><p>Python的多进程编程主要通过multiprocessing模块来实现。该模块提供了一个Process类，用于创建新的进程。下面是一个简单的多进程编程例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker</span>(<span class="params">num</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Worker <span class="subst">&#123;num&#125;</span> is working...&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)  <span class="comment"># 模拟一些工作</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Worker <span class="subst">&#123;num&#125;</span> finished&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 创建多个进程</span></span><br><span class="line">    processes = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        p = multiprocessing.Process(target=worker, args=(i,))</span><br><span class="line">        processes.append(p)</span><br><span class="line">        p.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待所有进程完成</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.join()</span><br></pre></td></tr></table></figure><p>在这个例子中，我们创建了5个进程，每个进程执行worker函数。主进程等待所有进程完成后，程序结束。<br>进程间通信<br>在多进程编程中，进程间的通信是一个非常重要的问题。Python的multiprocessing模块提供了几种进程间通信的方法，包括队列、管道和共享内存。</p><h2 id="1-队列（Queue）"><a href="#1-队列（Queue）" class="headerlink" title="1. 队列（Queue）"></a>1. 队列（Queue）</h2><p>队列是最常用的进程间通信方法之一。队列是一种先进先出的数据结构，进程可以将数据放入队列中，其他进程可以从队列中取出数据。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker</span>(<span class="params">queue</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Worker is working...&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)  <span class="comment"># 模拟一些工作</span></span><br><span class="line">    result = <span class="string">&quot;Worker finished&quot;</span></span><br><span class="line">    queue.put(result)  <span class="comment"># 将结果放入队列中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 创建队列</span></span><br><span class="line">    queue = multiprocessing.Queue()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建工作进程</span></span><br><span class="line">    p = multiprocessing.Process(target=worker, args=(queue,))</span><br><span class="line">    p.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待工作进程完成</span></span><br><span class="line">    p.join()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 从队列中获取结果</span></span><br><span class="line">    result = queue.get()</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><h2 id="2-管道（Pipe）"><a href="#2-管道（Pipe）" class="headerlink" title="2. 管道（Pipe）"></a>2. 管道（Pipe）</h2><p>管道是另一种进程间通信方法。管道是一种半双工的通信方式，数据只能在一个方向上流动。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker</span>(<span class="params">conn</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Worker is working...&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)  <span class="comment"># 模拟一些工作</span></span><br><span class="line">    result = <span class="string">&quot;Worker finished&quot;</span></span><br><span class="line">    conn.send(result)  <span class="comment"># 发送结果</span></span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 创建管道</span></span><br><span class="line">    parent_conn, child_conn = multiprocessing.Pipe()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建工作进程</span></span><br><span class="line">    p = multiprocessing.Process(target=worker, args=(child_conn,))</span><br><span class="line">    p.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待工作进程完成</span></span><br><span class="line">    p.join()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 接收结果</span></span><br><span class="line">    result = parent_conn.recv()</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    parent_conn.close()</span><br></pre></td></tr></table></figure><h2 id="3-共享内存（Shared-Memory）"><a href="#3-共享内存（Shared-Memory）" class="headerlink" title="3. 共享内存（Shared Memory）"></a>3. 共享内存（Shared Memory）</h2><p>共享内存是进程间通信的另一种方法。共享内存允许多个进程访问同一块内存区域。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker</span>(<span class="params">shared_list</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Worker is working...&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)  <span class="comment"># 模拟一些工作</span></span><br><span class="line">    shared_list.append(<span class="string">&quot;Worker finished&quot;</span>)  <span class="comment"># 修改共享列表</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 创建共享列表</span></span><br><span class="line">    manager = multiprocessing.Manager()</span><br><span class="line">    shared_list = manager.<span class="built_in">list</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建工作进程</span></span><br><span class="line">    p = multiprocessing.Process(target=worker, args=(shared_list,))</span><br><span class="line">    p.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待工作进程完成</span></span><br><span class="line">    p.join()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 打印共享列表</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">list</span>(shared_list))</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Python的多进程编程是通过multiprocessing模块来实现的，利用多进程可以有效地提高程序的运行效率。进程间的通信是一个非常重要的问题，Python提供了队列、管道和共享内存等方法来实现进程间的通信。每种方法都有其优缺点，选择哪种方法取决于具体的需求。</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在 FastAPI 的 @app.on_event(“startup“) 中启动后台线程</title>
      <link href="/2024/11/19/%E5%9C%A8-FastAPI-%E7%9A%84-app-on-event-%E2%80%9Cstartup%E2%80%9C-%E4%B8%AD%E5%90%AF%E5%8A%A8%E5%90%8E%E5%8F%B0%E7%BA%BF%E7%A8%8B/"/>
      <url>/2024/11/19/%E5%9C%A8-FastAPI-%E7%9A%84-app-on-event-%E2%80%9Cstartup%E2%80%9C-%E4%B8%AD%E5%90%AF%E5%8A%A8%E5%90%8E%E5%8F%B0%E7%BA%BF%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h3 id="在-FastAPI-的-app-on-event-quot-startup-quot-中启动后台线程"><a href="#在-FastAPI-的-app-on-event-quot-startup-quot-中启动后台线程" class="headerlink" title="在 FastAPI 的 @app.on_event(&quot;startup&quot;) 中启动后台线程"></a>在 FastAPI 的 <code>@app.on_event(&quot;startup&quot;)</code> 中启动后台线程</h3><p>在 FastAPI 项目中，某些任务可能需要在应用启动时运行，并在后台持续执行，如定时清理数据库、监控资源或定时获取数据等。为此，我们可以在 FastAPI 的 <code>@app.on_event(&quot;startup&quot;)</code> 中启动后台线程，确保应用在启动后立刻开始这些任务。</p><h3 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h3><p>FastAPI 是一个支持异步编程的 Python Web 框架，运行在异步事件循环上，能够高效处理 I&#x2F;O 密集型任务。不过，在应用启动的过程中，有些任务（如 CPU 密集型任务）更适合使用传统的多线程来异步执行，以避免阻塞主事件循环。这时，可以使用 Python 标准库的 <code>threading</code> 模块，结合 <code>@app.on_event(&quot;startup&quot;)</code> 启动线程，以便在后台执行这些任务。</p><h3 id="在-startup-中启动后台线程的方式"><a href="#在-startup-中启动后台线程的方式" class="headerlink" title="在 startup 中启动后台线程的方式"></a>在 <code>startup</code> 中启动后台线程的方式</h3><p>有几种方式可以在 <code>startup</code> 中启动后台线程，以下是几种常见的方法。</p><h4 id="1-使用-threading-Thread-启动后台线程"><a href="#1-使用-threading-Thread-启动后台线程" class="headerlink" title="1. 使用 threading.Thread 启动后台线程"></a>1. 使用 <code>threading.Thread</code> 启动后台线程</h4><p><code>threading.Thread</code> 是 Python 标准库提供的多线程模块，可以在启动应用时启动一个守护线程，让它在后台运行。</p><p>示例代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">background_task</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Running background task...&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">10</span>)  <span class="comment"># 模拟一个需要重复执行的任务</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.on_event(<span class="params"><span class="string">&quot;startup&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">startup</span>():</span><br><span class="line">    <span class="comment"># 创建并启动一个守护线程，以便在应用启动时开始执行后台任务</span></span><br><span class="line">    thread = threading.Thread(target=background_task, daemon=<span class="literal">True</span>)</span><br><span class="line">    thread.start()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Background thread has started.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.on_event(<span class="params"><span class="string">&quot;shutdown&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">shutdown</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Application is shutting down.&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>解释</strong>：</p><ul><li><strong>守护线程</strong>：<code>daemon=True</code> 表示该线程是守护线程，应用关闭时不会等待该线程结束，确保应用可以快速关闭。</li><li><strong>持续运行</strong>：<code>background_task</code> 函数中的 <code>while True</code> 循环使得该线程持续执行，可以通过 <code>time.sleep()</code> 控制任务的频率。</li></ul><h4 id="2-使用-concurrent-futures-ThreadPoolExecutor-启动线程池"><a href="#2-使用-concurrent-futures-ThreadPoolExecutor-启动线程池" class="headerlink" title="2. 使用 concurrent.futures.ThreadPoolExecutor 启动线程池"></a>2. 使用 <code>concurrent.futures.ThreadPoolExecutor</code> 启动线程池</h4><p>如果有多个后台任务需要并行运行，<code>concurrent.futures.ThreadPoolExecutor</code> 是更好的选择，它可以创建一个线程池来管理多个后台任务。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line">executor = ThreadPoolExecutor(max_workers=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task_one</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Running task one...&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task_two</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Running task two...&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.on_event(<span class="params"><span class="string">&quot;startup&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">startup</span>():</span><br><span class="line">    <span class="comment"># 使用线程池启动多个后台任务</span></span><br><span class="line">    executor.submit(task_one)</span><br><span class="line">    executor.submit(task_two)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Background tasks have started.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.on_event(<span class="params"><span class="string">&quot;shutdown&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">shutdown</span>():</span><br><span class="line">    executor.shutdown(wait=<span class="literal">False</span>)  <span class="comment"># 停止所有后台任务</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Application is shutting down.&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>解释</strong>：</p><ul><li><strong>多个任务</strong>：每个任务可以独立定义，并通过 <code>executor.submit()</code> 添加到线程池。</li><li><strong>线程池</strong>：<code>ThreadPoolExecutor</code> 会自动管理线程，最大线程数通过 <code>max_workers</code> 控制。</li></ul><h4 id="3-使用-asyncio-create-task-启动异步任务"><a href="#3-使用-asyncio-create-task-启动异步任务" class="headerlink" title="3. 使用 asyncio.create_task 启动异步任务"></a>3. 使用 <code>asyncio.create_task</code> 启动异步任务</h4><p>如果任务是异步的，可以使用 <code>asyncio.create_task</code> 启动一个异步任务，这样就不需要创建新的线程。异步任务适合用于 I&#x2F;O 密集型操作，比如网络请求、数据库访问等。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">async_background_task</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Running async background task...&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">10</span>)  <span class="comment"># 模拟异步操作</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.on_event(<span class="params"><span class="string">&quot;startup&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">startup</span>():</span><br><span class="line">    <span class="comment"># 使用 asyncio 启动异步任务</span></span><br><span class="line">    asyncio.create_task(async_background_task())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Async background task has started.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.on_event(<span class="params"><span class="string">&quot;shutdown&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">shutdown</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Application is shutting down.&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>解释</strong>：</p><ul><li><strong>异步任务</strong>：<code>async_background_task</code> 使用 <code>async def</code> 声明，是一个异步函数。</li><li><strong>事件循环</strong>：<code>asyncio.create_task</code> 在主事件循环上创建任务，而不需要额外线程。这对 I&#x2F;O 密集型任务非常高效，因为异步任务会在等待 I&#x2F;O 操作时让出控制权，不会阻塞主线程。</li></ul><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol><li><strong>守护线程</strong>：确保后台线程设置为守护线程（<code>daemon=True</code>），否则 FastAPI 关闭时会等待线程结束。</li><li><strong>资源清理</strong>：在 <code>@app.on_event(&quot;shutdown&quot;)</code> 中执行清理操作，如释放数据库连接、关闭文件等，防止资源泄露。</li><li><strong>选择合适的方式</strong>：根据任务类型选择合适的实现方式：<ul><li>I&#x2F;O 密集型任务使用 <code>asyncio.create_task</code> 启动异步任务。</li><li>CPU 密集型任务使用 <code>threading.Thread</code> 启动后台线程。</li><li>多个并发任务使用 <code>ThreadPoolExecutor</code> 来管理。</li></ul></li></ol><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>在 FastAPI 中启动后台线程，可以帮助我们实现一些自动化或定时操作，确保在应用启动时即开始执行这些任务。选择适合的方式可以使后台任务更加高效，同时减少对主线程的影响，从而提升应用的响应速度。希望本文帮助大家理解在 FastAPI 中启动后台线程的不同方法。</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 asyncio.run_coroutine_threadsafe 在 Python 中处理异步操作</title>
      <link href="/2024/11/19/%E4%BD%BF%E7%94%A8-asyncio-run-coroutine-threadsafe-%E5%9C%A8-Python-%E4%B8%AD%E5%A4%84%E7%90%86%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C/"/>
      <url>/2024/11/19/%E4%BD%BF%E7%94%A8-asyncio-run-coroutine-threadsafe-%E5%9C%A8-Python-%E4%B8%AD%E5%A4%84%E7%90%86%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h3 id="使用-asyncio-run-coroutine-threadsafe-在-Python-中处理异步操作"><a href="#使用-asyncio-run-coroutine-threadsafe-在-Python-中处理异步操作" class="headerlink" title="使用 asyncio.run_coroutine_threadsafe 在 Python 中处理异步操作"></a>使用 <code>asyncio.run_coroutine_threadsafe</code> 在 Python 中处理异步操作</h3><p>在现代 Python 开发中，异步编程已经成为一种常见的模式。尤其是在处理 I&#x2F;O 密集型操作（如网络请求或文件读写）时，异步编程能够显著提高程序的性能。本文将介绍如何使用 <code>asyncio.run_coroutine_threadsafe</code> 方法来在多线程环境中安全地调度异步操作。</p><h4 id="什么是-asyncio-run-coroutine-threadsafe？"><a href="#什么是-asyncio-run-coroutine-threadsafe？" class="headerlink" title="什么是 asyncio.run_coroutine_threadsafe？"></a>什么是 <code>asyncio.run_coroutine_threadsafe</code>？</h4><p><code>asyncio.run_coroutine_threadsafe</code> 是 <code>asyncio</code> 库中的一个实用函数，它允许在与事件循环不在同一线程的情况下安全地调度异步协程。这对于在多线程程序中使用异步操作非常重要，因为直接从非事件循环线程调用协程会导致错误。</p><h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><p>想象一个场景，你有一个主线程在运行一个 ROS 节点，它需要处理来自外部线程的请求。这时，你可能希望在 ROS 节点的事件循环中执行一些异步操作。这里就是 <code>asyncio.run_coroutine_threadsafe</code> 的用武之地。</p><h4 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h4><p>以下是一个示例，展示如何使用 <code>asyncio.run_coroutine_threadsafe</code> 来调度异步操作：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncWorker</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.loop = asyncio.get_event_loop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">async_task</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;开始异步任务&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)  <span class="comment"># 模拟长时间运行的异步操作</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;异步任务完成&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_async_task</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 在主线程中调度异步任务</span></span><br><span class="line">        asyncio.run_coroutine_threadsafe(<span class="variable language_">self</span>.async_task(), <span class="variable language_">self</span>.loop)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">thread_function</span>(<span class="params">worker</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;线程启动&quot;</span>)</span><br><span class="line">    worker.run_async_task()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;线程结束&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    worker = AsyncWorker()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动新线程</span></span><br><span class="line">    thread = threading.Thread(target=thread_function, args=(worker,))</span><br><span class="line">    thread.start()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 保持事件循环运行</span></span><br><span class="line">    worker.loop.run_forever()</span><br></pre></td></tr></table></figure><h4 id="代码解析"><a href="#代码解析" class="headerlink" title="代码解析"></a>代码解析</h4><ol><li><p><strong>创建事件循环</strong>：在 <code>AsyncWorker</code> 类中，我们首先获取事件循环 <code>self.loop</code>。</p></li><li><p><strong>定义异步任务</strong>：<code>async_task</code> 方法是一个异步协程，模拟了一个需要2秒的耗时操作。</p></li><li><p><strong>调度异步任务</strong>：<code>run_async_task</code> 方法中，我们使用 <code>asyncio.run_coroutine_threadsafe</code> 将 <code>async_task</code> 调度到事件循环中。即使在另一个线程中调用它也不会引发错误。</p></li><li><p><strong>多线程环境</strong>：在 <code>thread_function</code> 中，我们启动一个新线程并调用 <code>run_async_task</code>。主线程则保持事件循环运行。</p></li></ol><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ul><li><p><strong>线程安全</strong>：<code>asyncio.run_coroutine_threadsafe</code> 是线程安全的，它会将任务放入事件循环的队列中。</p></li><li><p><strong>错误处理</strong>：在实际应用中，建议对异步任务添加适当的异常处理，以避免未捕获的错误导致程序崩溃。</p></li><li><p><strong>性能考虑</strong>：在多线程和异步的混合使用中，要注意线程的开销，确保使用这些技术确实能带来性能提升。</p></li></ul><h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p><code>asyncio.run_coroutine_threadsafe</code> 是在多线程环境中安全地调度异步操作的强大工具。通过合理使用它，可以提高程序的响应性和性能。希望本文能帮助你更好地理解和应用这一技术，让你的异步编程更加高效！</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用GeographicLib在C++中进行地理坐标转换</title>
      <link href="/2024/11/19/%E4%BD%BF%E7%94%A8GeographicLib%E5%9C%A8C-%E4%B8%AD%E8%BF%9B%E8%A1%8C%E5%9C%B0%E7%90%86%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2/"/>
      <url>/2024/11/19/%E4%BD%BF%E7%94%A8GeographicLib%E5%9C%A8C-%E4%B8%AD%E8%BF%9B%E8%A1%8C%E5%9C%B0%E7%90%86%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2/</url>
      
        <content type="html"><![CDATA[<h3 id="使用GeographicLib在C-中进行地理坐标转换"><a href="#使用GeographicLib在C-中进行地理坐标转换" class="headerlink" title="使用GeographicLib在C++中进行地理坐标转换"></a>使用GeographicLib在C++中进行地理坐标转换</h3><p>在现代软件开发中，经常需要处理地理坐标转换问题，例如将经纬度转换为局部直角坐标系。GeographicLib是一个强大的开源库，提供了便捷的工具来进行这些转换。本文将介绍如何在C++项目中使用GeographicLib进行地理坐标转换的步骤和示例代码。</p><h4 id="步骤一：安装GeographicLib"><a href="#步骤一：安装GeographicLib" class="headerlink" title="步骤一：安装GeographicLib"></a>步骤一：安装GeographicLib</h4><p>首先，确保你的系统中已安装GeographicLib库。可以通过以下命令在Ubuntu中安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install geographiclib-*   <span class="comment"># 安装GeographicLib的库</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install libgeographic-*  <span class="comment"># 安装GeographicLib的依赖库</span></span><br></pre></td></tr></table></figure><h4 id="步骤二：配置C-项目"><a href="#步骤二：配置C-项目" class="headerlink" title="步骤二：配置C++项目"></a>步骤二：配置C++项目</h4><p>在你的C++项目中，需要配置CMake以及链接GeographicLib库。<br>CMakeLists.txt</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置项目名称和语言</span></span><br><span class="line"><span class="keyword">project</span>(my_test_project LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含GeographicLib的头文件路径</span></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;/usr/include/GeographicLib&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置输出的可执行文件</span></span><br><span class="line"><span class="keyword">add_executable</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> main.cpp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接GeographicLib库（根据你的安装调整库名）</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> Geographic)</span><br></pre></td></tr></table></figure><h4 id="步骤三：示例代码"><a href="#步骤三：示例代码" class="headerlink" title="步骤三：示例代码"></a>步骤三：示例代码</h4><p>以下是一个简单的示例代码，演示了如何使用GeographicLib将经纬度转换为局部直角坐标系：<br>main.cpp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;GeographicLib/LocalCartesian.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当前点的经纬度和高度，作为局部坐标系的原点</span></span><br><span class="line">    <span class="type">double</span> origin_latitude = <span class="number">29.116543</span>;   <span class="comment">// 纬度</span></span><br><span class="line">    <span class="type">double</span> origin_longitude = <span class="number">111.506270</span>; <span class="comment">// 经度</span></span><br><span class="line">    <span class="type">double</span> origin_height = <span class="number">0.0</span>;           <span class="comment">// 高度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 LocalCartesian 对象，并设置原点</span></span><br><span class="line">    GeographicLib::LocalCartesian geoConverter;</span><br><span class="line">    geoConverter.<span class="built_in">Reset</span>(origin_latitude, origin_longitude, origin_height);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 要转换的另一个点的经纬度和高度</span></span><br><span class="line">    <span class="type">double</span> target_latitude = <span class="number">29.106543</span>;</span><br><span class="line">    <span class="type">double</span> target_longitude = <span class="number">111.606270</span>;</span><br><span class="line">    <span class="type">double</span> target_height = <span class="number">0.0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转换为局部直角坐标系</span></span><br><span class="line">    <span class="type">double</span> x, y, z;</span><br><span class="line">    geoConverter.<span class="built_in">Forward</span>(target_latitude, target_longitude, target_height, x, y, z);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出转换后的局部坐标</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Local Cartesian coordinates: (&quot;</span> &lt;&lt; x &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; y &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; z &lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>通过上述步骤，你可以在你的C++项目中轻松使用GeographicLib进行地理坐标转换。GeographicLib提供了简单且高效的方法来处理经纬度与局部直角坐标系之间的转换，为地理信息处理提供了便利。在实际应用中，可以根据需要进行更复杂的坐标转换和计算，满足不同场景下的需求。</p>]]></content>
      
      
      <categories>
          
          <category> ROS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>理解矩阵内积与矩阵乘法的区别及其应用</title>
      <link href="/2024/07/29/%E7%90%86%E8%A7%A3%E7%9F%A9%E9%98%B5%E5%86%85%E7%A7%AF%E4%B8%8E%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95%E7%9A%84%E5%8C%BA%E5%88%AB%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/"/>
      <url>/2024/07/29/%E7%90%86%E8%A7%A3%E7%9F%A9%E9%98%B5%E5%86%85%E7%A7%AF%E4%B8%8E%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95%E7%9A%84%E5%8C%BA%E5%88%AB%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>在数据科学、机器学习、计算机图形学和图像处理等领域，矩阵运算是非常基础且重要的操作。然而，矩阵内积和矩阵乘法这两种看似相似的操作却有着不同的计算方式和应用场景。本文将详细解释它们的区别及各自的用途。</p><h3 id="矩阵内积（逐元素乘积）"><a href="#矩阵内积（逐元素乘积）" class="headerlink" title="矩阵内积（逐元素乘积）"></a>矩阵内积（逐元素乘积）</h3><p>矩阵内积，或逐元素乘积，是指两个相同尺寸的矩阵对应位置元素的逐一相乘。这种运算在 numpy 中可以使用 <code>*</code> 运算符或者 <code>np.multiply</code> 函数来实现。</p><p>例如，给定两个矩阵 A 和 B：<br>$$<br>A &#x3D; \begin{bmatrix} 1 &amp; 2 \ 3 &amp; 4 \end{bmatrix}<br>B &#x3D; \begin{bmatrix} 5 &amp; 6 \ 7 &amp; 8 \end{bmatrix}<br>$$</p><p>它们的逐元素乘积为：<br>$$<br>A * B &#x3D; \begin{bmatrix} 1 \cdot 5 &amp; 2 \cdot 6 \ 3 \cdot 7 &amp; 4 \cdot 8 \end{bmatrix} &#x3D; \begin{bmatrix} 5 &amp; 12 \ 21 &amp; 32 \end{bmatrix}<br>$$</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">A = np.array([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">B = np.array([[<span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>]])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 逐元素乘积</span></span><br><span class="line">result = A * B</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="comment"># Output:</span></span><br><span class="line"><span class="comment"># [[ 5 12]</span></span><br><span class="line"><span class="comment">#  [21 32]]</span></span><br></pre></td></tr></table></figure><h3 id="矩阵内积的用途"><a href="#矩阵内积的用途" class="headerlink" title="矩阵内积的用途"></a>矩阵内积的用途</h3><ol><li><p><strong>图像处理</strong>：</p><ul><li><strong>滤波</strong>：在卷积操作中，滤波器（或核）与图像的一个区域进行逐元素相乘，然后求和。</li><li><strong>图像增强或衰减</strong>：通过逐元素乘以一个比例因子矩阵。</li></ul></li><li><p><strong>统计计算</strong>：</p><ul><li><strong>加权平均值</strong>：通过逐元素乘积将权重应用于数据矩阵。</li></ul></li><li><p><strong>科学计算和数值分析</strong>：</p><ul><li><strong>离散模型计算</strong>：逐元素乘积用于计算两组数据的交互影响，例如离散反应速率计算。</li></ul></li></ol><h3 id="矩阵乘法（矩阵积）"><a href="#矩阵乘法（矩阵积）" class="headerlink" title="矩阵乘法（矩阵积）"></a>矩阵乘法（矩阵积）</h3><p>矩阵乘法是线性代数中的基本操作，遵循特定的规则。假设矩阵 A 的维度是 m×n，矩阵 B 的维度是 n×p，则它们的乘积 C 的维度是 m×p。C 的每个元素是 A 的行向量和 B 的列向量的点积。</p><p>例如，给定矩阵 A 和 B：<br>$$<br>A &#x3D; \begin{bmatrix} 1 &amp; 2 \ 3 &amp; 4 \end{bmatrix}<br>B &#x3D; \begin{bmatrix} 5 &amp; 6 \ 7 &amp; 8 \end{bmatrix}<br>$$</p><p>它们的矩阵乘积为：<br>$$<br>C &#x3D; A \cdot B &#x3D; \begin{bmatrix} 1 \cdot 5 + 2 \cdot 7 &amp; 1 \cdot 6 + 2 \cdot 8 \ 3 \cdot 5 + 4 \cdot 7 &amp; 3 \cdot 6 + 4 \cdot 8 \end{bmatrix} &#x3D; \begin{bmatrix} 19 &amp; 22 \ 43 &amp; 50 \end{bmatrix}<br>$$</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">A = np.array([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">B = np.array([[<span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>]])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 矩阵乘积</span></span><br><span class="line">result = np.dot(A, B)</span><br><span class="line"><span class="comment"># 或者使用 @ 运算符（Python 3.5 及以上）</span></span><br><span class="line">result = A @ B</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="comment"># Output:</span></span><br><span class="line"><span class="comment"># [[19 22]</span></span><br><span class="line"><span class="comment">#  [43 50]]</span></span><br></pre></td></tr></table></figure><h3 id="矩阵乘法的用途"><a href="#矩阵乘法的用途" class="headerlink" title="矩阵乘法的用途"></a>矩阵乘法的用途</h3><ol><li><p><strong>线性代数</strong>：</p><ul><li><strong>线性变换</strong>：如旋转、缩放、平移等。</li><li><strong>线性方程组</strong>：表示和求解线性方程组。</li></ul></li><li><p><strong>计算机图形学</strong>：</p><ul><li><strong>3D 变换和投影</strong>：通过矩阵乘法将 3D 点变换到不同的坐标系。</li></ul></li><li><p><strong>机器学习和数据科学</strong>：</p><ul><li><strong>神经网络</strong>：权重矩阵与输入向量的乘法。</li><li><strong>数据降维</strong>：主成分分析（PCA）、奇异值分解（SVD）等矩阵分解技术。</li></ul></li><li><p><strong>物理模拟</strong>：</p><ul><li><strong>动态系统状态更新</strong>：通过状态转移矩阵模拟系统的演化。</li></ul></li></ol><h3 id="区别总结"><a href="#区别总结" class="headerlink" title="区别总结"></a>区别总结</h3><ol><li><p><strong>计算方式</strong>：</p><ul><li><strong>逐元素乘积（内积）</strong>：对应位置的元素相乘。</li><li><strong>矩阵乘法</strong>：行和列的点积，遵循线性代数规则。</li></ul></li><li><p><strong>尺寸要求</strong>：</p><ul><li><strong>逐元素乘积（内积）</strong>：两个矩阵必须具有相同的尺寸。</li><li><strong>矩阵乘法</strong>：第一个矩阵的列数必须等于第二个矩阵的行数。</li></ul></li><li><p><strong>结果矩阵的尺寸</strong>：</p><ul><li><strong>逐元素乘积（内积）</strong>：结果矩阵的尺寸与操作数矩阵相同。</li><li><strong>矩阵乘法</strong>：结果矩阵的尺寸为第一个矩阵的行数和第二个矩阵的列数。</li></ul></li></ol><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>理解矩阵内积和矩阵乘法的区别及各自的用途，对于数据科学、机器学习、图像处理和计算机图形学等领域的工作至关重要。选择适合的矩阵运算方法可以有效地解决问题，提高计算效率和结果的准确性。希望本文能帮助你更好地理解和应用这两种重要的矩阵运算。</p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>跨机器ROS服务调用：在不同包名下实现分布式服务端和客户端节点</title>
      <link href="/2024/07/23/%E8%B7%A8%E6%9C%BA%E5%99%A8ROS%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%EF%BC%9A%E5%9C%A8%E4%B8%8D%E5%90%8C%E5%8C%85%E5%90%8D%E4%B8%8B%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%8A%82%E7%82%B9/"/>
      <url>/2024/07/23/%E8%B7%A8%E6%9C%BA%E5%99%A8ROS%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%EF%BC%9A%E5%9C%A8%E4%B8%8D%E5%90%8C%E5%8C%85%E5%90%8D%E4%B8%8B%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%8A%82%E7%82%B9/</url>
      
        <content type="html"><![CDATA[<p>好的，我们将分别为服务端和客户端使用不同的包名，例如服务端使用<code>robot_server_package</code>，客户端使用<code>robot_client_package</code>。</p><h3 id="一、服务端节点配置（robot-server）"><a href="#一、服务端节点配置（robot-server）" class="headerlink" title="一、服务端节点配置（robot_server）"></a>一、服务端节点配置（robot_server）</h3><h4 id="创建包和定义服务类型"><a href="#创建包和定义服务类型" class="headerlink" title="创建包和定义服务类型"></a>创建包和定义服务类型</h4><ol><li><p>创建一个名为<code>robot_server_package</code>的包，并在<code>srv</code>目录下创建一个名为<code>AddTwoInts.srv</code>的文件：</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int64 a</span><br><span class="line">int64 b</span><br><span class="line">---</span><br><span class="line">int64 sum</span><br></pre></td></tr></table></figure></li><li><p>确保在<code>CMakeLists.txt</code>和<code>package.xml</code>中正确配置，以便生成服务代码。</p><p><code>CMakeLists.txt</code>：</p> <figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.0</span>.<span class="number">2</span>)</span><br><span class="line"><span class="keyword">project</span>(robot_server_package)</span><br><span class="line"></span><br><span class="line"><span class="keyword">find_package</span>(catkin REQUIRED COMPONENTS</span><br><span class="line">  rospy</span><br><span class="line">  std_msgs</span><br><span class="line">  message_generation</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">add_service_files(</span><br><span class="line">  FILES</span><br><span class="line">  AddTwoInts.srv</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">generate_messages(</span><br><span class="line">  DEPENDENCIES</span><br><span class="line">  std_msgs</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">catkin_package(</span><br><span class="line">  CATKIN_DEPENDS rospy std_msgs message_runtime</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(</span><br><span class="line">  <span class="variable">$&#123;catkin_INCLUDE_DIRS&#125;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>package.xml</code>：</p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">format</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>robot_server_package<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The robot_server_package<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">maintainer</span> <span class="attr">email</span>=<span class="string">&quot;your_email@example.com&quot;</span>&gt;</span>Your Name<span class="tag">&lt;/<span class="name">maintainer</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">license</span>&gt;</span>BSD<span class="tag">&lt;/<span class="name">license</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">buildtool_depend</span>&gt;</span>catkin<span class="tag">&lt;/<span class="name">buildtool_depend</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build_depend</span>&gt;</span>rospy<span class="tag">&lt;/<span class="name">build_depend</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build_depend</span>&gt;</span>std_msgs<span class="tag">&lt;/<span class="name">build_depend</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build_depend</span>&gt;</span>message_generation<span class="tag">&lt;/<span class="name">build_depend</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>rospy<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>std_msgs<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>message_runtime<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">export</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">export</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>运行<code>catkin_make</code>生成消息和服务代码。</p></li></ol><h4 id="编写服务端节点"><a href="#编写服务端节点" class="headerlink" title="编写服务端节点"></a>编写服务端节点</h4><p>编写服务端节点<code>add_two_ints_server.py</code>，并将其放在<code>robot_server_package/scripts</code>目录下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> robot_server_package.srv <span class="keyword">import</span> AddTwoInts, AddTwoIntsResponse</span><br><span class="line"><span class="keyword">import</span> rospy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_add_two_ints</span>(<span class="params">req</span>):</span><br><span class="line">    rospy.loginfo(<span class="string">&quot;Returning [%s + %s = %s]&quot;</span> % (req.a, req.b, (req.a + req.b)))</span><br><span class="line">    <span class="keyword">return</span> AddTwoIntsResponse(req.a + req.b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_two_ints_server</span>():</span><br><span class="line">    rospy.init_node(<span class="string">&#x27;add_two_ints_server&#x27;</span>)</span><br><span class="line">    s = rospy.Service(<span class="string">&#x27;add_two_ints&#x27;</span>, AddTwoInts, handle_add_two_ints)</span><br><span class="line">    rospy.loginfo(<span class="string">&quot;Ready to add two ints.&quot;</span>)</span><br><span class="line">    rospy.spin()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    add_two_ints_server()</span><br></pre></td></tr></table></figure><h3 id="二、客户端节点配置（robot-client）"><a href="#二、客户端节点配置（robot-client）" class="headerlink" title="二、客户端节点配置（robot_client）"></a>二、客户端节点配置（robot_client）</h3><h4 id="创建包和定义服务类型-1"><a href="#创建包和定义服务类型-1" class="headerlink" title="创建包和定义服务类型"></a>创建包和定义服务类型</h4><ol><li><p>创建一个名为<code>robot_client_package</code>的包，并在<code>srv</code>目录下创建一个名为<code>AddTwoInts.srv</code>的文件，与服务端的服务类型相同：</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int64 a</span><br><span class="line">int64 b</span><br><span class="line">---</span><br><span class="line">int64 sum</span><br></pre></td></tr></table></figure></li><li><p>确保在<code>CMakeLists.txt</code>和<code>package.xml</code>中正确配置，以便生成服务代码。</p><p><code>CMakeLists.txt</code>：</p> <figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.0</span>.<span class="number">2</span>)</span><br><span class="line"><span class="keyword">project</span>(robot_client_package)</span><br><span class="line"></span><br><span class="line"><span class="keyword">find_package</span>(catkin REQUIRED COMPONENTS</span><br><span class="line">  rospy</span><br><span class="line">  std_msgs</span><br><span class="line">  message_generation</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">add_service_files(</span><br><span class="line">  FILES</span><br><span class="line">  AddTwoInts.srv</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">generate_messages(</span><br><span class="line">  DEPENDENCIES</span><br><span class="line">  std_msgs</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">catkin_package(</span><br><span class="line">  CATKIN_DEPENDS rospy std_msgs message_runtime</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(</span><br><span class="line">  <span class="variable">$&#123;catkin_INCLUDE_DIRS&#125;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>package.xml</code>：</p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">format</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>robot_client_package<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The robot_client_package<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">maintainer</span> <span class="attr">email</span>=<span class="string">&quot;your_email@example.com&quot;</span>&gt;</span>Your Name<span class="tag">&lt;/<span class="name">maintainer</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">license</span>&gt;</span>BSD<span class="tag">&lt;/<span class="name">license</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">buildtool_depend</span>&gt;</span>catkin<span class="tag">&lt;/<span class="name">buildtool_depend</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build_depend</span>&gt;</span>rospy<span class="tag">&lt;/<span class="name">build_depend</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build_depend</span>&gt;</span>std_msgs<span class="tag">&lt;/<span class="name">build_depend</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build_depend</span>&gt;</span>message_generation<span class="tag">&lt;/<span class="name">build_depend</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>rospy<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>std_msgs<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>message_runtime<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">export</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">export</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>运行<code>catkin_make</code>生成消息和服务代码。</p></li></ol><h4 id="编写客户端节点"><a href="#编写客户端节点" class="headerlink" title="编写客户端节点"></a>编写客户端节点</h4><p>编写客户端节点<code>add_two_ints_client.py</code>，并将其放在<code>robot_client_package/scripts</code>目录下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> rospy</span><br><span class="line"><span class="keyword">from</span> robot_client_package.srv <span class="keyword">import</span> AddTwoInts</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_two_ints_client</span>(<span class="params">x, y</span>):</span><br><span class="line">    rospy.wait_for_service(<span class="string">&#x27;add_two_ints&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        add_two_ints = rospy.ServiceProxy(<span class="string">&#x27;add_two_ints&#x27;</span>, AddTwoInts)</span><br><span class="line">        resp = add_two_ints(x, y)</span><br><span class="line">        <span class="keyword">return</span> resp.<span class="built_in">sum</span></span><br><span class="line">    <span class="keyword">except</span> rospy.ServiceException <span class="keyword">as</span> e:</span><br><span class="line">        rospy.logerr(<span class="string">&quot;Service call failed: %s&quot;</span> % e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        x = <span class="built_in">int</span>(sys.argv[<span class="number">1</span>])</span><br><span class="line">        y = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: %s [x y]&quot;</span> % sys.argv[<span class="number">0</span>])</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Requesting %s+%s&quot;</span> % (x, y))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%s + %s = %s&quot;</span> % (x, y, add_two_ints_client(x, y)))</span><br></pre></td></tr></table></figure><h3 id="三、运行服务和客户端"><a href="#三、运行服务和客户端" class="headerlink" title="三、运行服务和客户端"></a>三、运行服务和客户端</h3><ol><li><strong>在两台机器上设置ROS环境</strong></li></ol><p>确保<code>/etc/hosts</code>文件包含彼此的IP地址和主机名。例如，在<code>robot_server</code>和<code>robot_client</code>机器上的<code>/etc/hosts</code>文件应该包含：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.2 robot_server</span><br><span class="line">192.168.1.3 robot_client</span><br></pre></td></tr></table></figure><p>在<code>robot_server</code>上设置环境变量：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ROS_MASTER_URI=http://robot_server:11311</span><br><span class="line"><span class="built_in">export</span> ROS_IP=robot_server</span><br></pre></td></tr></table></figure><p>在<code>robot_client</code>上设置环境变量：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ROS_MASTER_URI=http://robot_server:11311</span><br><span class="line"><span class="built_in">export</span> ROS_IP=robot_client</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>启动ROS master</strong></li></ol><p>在<code>robot_server</code>上运行：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roscore</span><br></pre></td></tr></table></figure><p>3.<strong>在<code>robot_server</code>上运行服务端节点</strong></p><p>确保脚本是可执行的：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x ~/catkin_ws/src/robot_server_package/scripts/add_two_ints_server.py</span><br></pre></td></tr></table></figure><p>运行服务端节点：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rosrun robot_server_package add_two_ints_server.py</span><br></pre></td></tr></table></figure><ol start="4"><li><strong>在<code>robot_client</code>上运行客户端节点</strong></li></ol><p>确保脚本是可执行的：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x ~/catkin_ws/src/robot_client_package/scripts/add_two_ints_client.py</span><br></pre></td></tr></table></figure><p>运行客户端节点：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rosrun robot_client_package add_two_ints_client.py 2 3</span><br></pre></td></tr></table></figure><p>如果配置正确，你应该会在<code>robot_server</code>上看到服务端处理请求的输出，并在<code>robot_client</code>上看到客户端请求的结果。</p><p>这样，你就可以在不同的机器上运行ROS节点，并调用共享的服务。</p>]]></content>
      
      
      <categories>
          
          <category> ROS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在Ubuntu上创建和启用交换文件的简单步骤</title>
      <link href="/2024/07/16/%E5%9C%A8Ubuntu%E4%B8%8A%E5%88%9B%E5%BB%BA%E5%92%8C%E5%90%AF%E7%94%A8%E4%BA%A4%E6%8D%A2%E6%96%87%E4%BB%B6%E7%9A%84%E7%AE%80%E5%8D%95%E6%AD%A5%E9%AA%A4/"/>
      <url>/2024/07/16/%E5%9C%A8Ubuntu%E4%B8%8A%E5%88%9B%E5%BB%BA%E5%92%8C%E5%90%AF%E7%94%A8%E4%BA%A4%E6%8D%A2%E6%96%87%E4%BB%B6%E7%9A%84%E7%AE%80%E5%8D%95%E6%AD%A5%E9%AA%A4/</url>
      
        <content type="html"><![CDATA[<p>在Linux系统中，交换空间是一种将内存数据临时存储在磁盘上的机制，用于缓解内存不足的情况。本文将介绍如何在Ubuntu系统上创建和启用一个12GB的交换文件。这是一种不需要重新分区的简单方法。</p><h3 id="为什么使用交换文件？"><a href="#为什么使用交换文件？" class="headerlink" title="为什么使用交换文件？"></a>为什么使用交换文件？</h3><p>交换文件与交换分区功能相同，但更加灵活。你可以在不重新分区的情况下轻松调整交换空间的大小。以下是创建和启用交换文件的详细步骤。</p><h3 id="步骤-1：创建交换文件"><a href="#步骤-1：创建交换文件" class="headerlink" title="步骤 1：创建交换文件"></a>步骤 1：创建交换文件</h3><p>首先，我们需要在文件系统上创建一个12GB的交换文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> fallocate -l 12G /swapfile</span><br></pre></td></tr></table></figure><p>如果 <code>fallocate</code> 命令不可用，可以使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/swapfile bs=1M count=12288</span><br></pre></td></tr></table></figure><h3 id="步骤-2：设置正确的权限"><a href="#步骤-2：设置正确的权限" class="headerlink" title="步骤 2：设置正确的权限"></a>步骤 2：设置正确的权限</h3><p>为了确保系统安全，我们需要将交换文件的权限设置为只有root用户可以读取和写入。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 600 /swapfile</span><br></pre></td></tr></table></figure><h3 id="步骤-3：将文件格式化为交换空间"><a href="#步骤-3：将文件格式化为交换空间" class="headerlink" title="步骤 3：将文件格式化为交换空间"></a>步骤 3：将文件格式化为交换空间</h3><p>现在，我们需要将这个文件格式化为交换空间。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> mkswap /swapfile</span><br></pre></td></tr></table></figure><h3 id="步骤-4：启用交换文件"><a href="#步骤-4：启用交换文件" class="headerlink" title="步骤 4：启用交换文件"></a>步骤 4：启用交换文件</h3><p>接下来，启用这个交换文件，使其立即生效。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> swapon /swapfile</span><br></pre></td></tr></table></figure><h3 id="步骤-5：验证交换文件"><a href="#步骤-5：验证交换文件" class="headerlink" title="步骤 5：验证交换文件"></a>步骤 5：验证交换文件</h3><p>你可以使用以下命令验证交换文件是否已成功启用：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> swapon --show</span><br></pre></td></tr></table></figure><p>你应该会看到类似于以下的输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME      TYPE  SIZE USED PRIO</span><br><span class="line">/swapfile file  12G  0B   -2</span><br></pre></td></tr></table></figure><h3 id="步骤-6：永久启用交换文件"><a href="#步骤-6：永久启用交换文件" class="headerlink" title="步骤 6：永久启用交换文件"></a>步骤 6：永久启用交换文件</h3><p>为了确保交换文件在系统启动时自动启用，我们需要编辑 <code>/etc/fstab</code> 文件。添加以下内容到文件末尾：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/swapfile none swap sw 0 0</span><br></pre></td></tr></table></figure><h3 id="步骤-7：调整-swappiness-参数（可选）"><a href="#步骤-7：调整-swappiness-参数（可选）" class="headerlink" title="步骤 7：调整 swappiness 参数（可选）"></a>步骤 7：调整 <code>swappiness</code> 参数（可选）</h3><p><code>swappiness</code> 参数决定了系统将多频繁地使用交换空间。默认值是60，范围是0到100。较低的值表示系统更倾向于使用物理内存，而不是交换空间。你可以将 <code>swappiness</code> 设置为10，以优化性能：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> sysctl vm.swappiness=10</span><br></pre></td></tr></table></figure><p>为了使这个设置永久生效，编辑 <code>/etc/sysctl.conf</code> 文件，添加以下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.swappiness=10</span><br></pre></td></tr></table></figure><h3 id="检查设置"><a href="#检查设置" class="headerlink" title="检查设置"></a>检查设置</h3><p>最后，确认交换分区和 <code>swappiness</code> 设置是否正确：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/sys/vm/swappiness</span><br><span class="line"><span class="built_in">sudo</span> swapon --show</span><br></pre></td></tr></table></figure><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>通过以上简单步骤，你已经成功在Ubuntu系统上创建并启用了一个12GB的交换文件。这种方法不仅简单，而且灵活，适用于各种Linux系统。如果你有任何问题或需要进一步的帮助，请随时留言！</p>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>机器学习数据预处理详解：标准化、填充缺失值及编码离散特征</title>
      <link href="/2024/06/29/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86%E8%AF%A6%E8%A7%A3%EF%BC%9A%E6%A0%87%E5%87%86%E5%8C%96%E3%80%81%E5%A1%AB%E5%85%85%E7%BC%BA%E5%A4%B1%E5%80%BC%E5%8F%8A%E7%BC%96%E7%A0%81%E7%A6%BB%E6%95%A3%E7%89%B9%E5%BE%81/"/>
      <url>/2024/06/29/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86%E8%AF%A6%E8%A7%A3%EF%BC%9A%E6%A0%87%E5%87%86%E5%8C%96%E3%80%81%E5%A1%AB%E5%85%85%E7%BC%BA%E5%A4%B1%E5%80%BC%E5%8F%8A%E7%BC%96%E7%A0%81%E7%A6%BB%E6%95%A3%E7%89%B9%E5%BE%81/</url>
      
        <content type="html"><![CDATA[<p>在机器学习建模过程中，数据预处理是至关重要的一步。本文将通过具体示例，详细解释数据预处理的关键步骤，包括标准化数值特征、填充缺失值以及编码离散特征。我们将使用一个简单的训练和测试数据集来说明这些步骤。</p><h3 id="示例数据集"><a href="#示例数据集" class="headerlink" title="示例数据集"></a>示例数据集</h3><h4 id="训练数据-train-data"><a href="#训练数据-train-data" class="headerlink" title="训练数据 (train_data)"></a>训练数据 (<code>train_data</code>)</h4><table><thead><tr><th>Id</th><th>Feature1</th><th>Feature2</th><th>Feature3</th><th>Label</th></tr></thead><tbody><tr><td>1</td><td>10</td><td>5.0</td><td>A</td><td>100</td></tr><tr><td>2</td><td>20</td><td>6.5</td><td>B</td><td>200</td></tr><tr><td>3</td><td>30</td><td>NaN</td><td>A</td><td>300</td></tr></tbody></table><h4 id="测试数据-test-data"><a href="#测试数据-test-data" class="headerlink" title="测试数据 (test_data)"></a>测试数据 (<code>test_data</code>)</h4><table><thead><tr><th>Id</th><th>Feature1</th><th>Feature2</th><th>Feature3</th></tr></thead><tbody><tr><td>4</td><td>25</td><td>5.5</td><td>B</td></tr><tr><td>5</td><td>35</td><td>7.0</td><td>NaN</td></tr></tbody></table><h3 id="步骤解析"><a href="#步骤解析" class="headerlink" title="步骤解析"></a>步骤解析</h3><h4 id="1-合并所有特征以进行预处理"><a href="#1-合并所有特征以进行预处理" class="headerlink" title="1. 合并所有特征以进行预处理"></a>1. 合并所有特征以进行预处理</h4><p>首先，将训练和测试数据集的特征（不包括标签列<code>Label</code>）合并，以便对所有特征进行统一的预处理。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all_features = pd.concat((train_data.iloc[:, <span class="number">1</span>:-<span class="number">1</span>], test_data.iloc[:, <span class="number">1</span>:]))</span><br></pre></td></tr></table></figure><p><strong>合并后的结果：</strong></p><table><thead><tr><th>Feature1</th><th>Feature2</th><th>Feature3</th></tr></thead><tbody><tr><td>10</td><td>5.0</td><td>A</td></tr><tr><td>20</td><td>6.5</td><td>B</td></tr><tr><td>30</td><td>NaN</td><td>A</td></tr><tr><td>25</td><td>5.5</td><td>B</td></tr><tr><td>35</td><td>7.0</td><td>NaN</td></tr></tbody></table><h4 id="2-标准化数值特征"><a href="#2-标准化数值特征" class="headerlink" title="2. 标准化数值特征"></a>2. 标准化数值特征</h4><p>确定数值型特征的列，然后对这些特征进行标准化处理，使每个数值特征的均值为0，标准差为1。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">numeric_features = all_features.dtypes[all_features.dtypes != <span class="string">&#x27;object&#x27;</span>].index</span><br><span class="line">all_features[numeric_features] = all_features[numeric_features].apply(</span><br><span class="line">    <span class="keyword">lambda</span> x: (x - x.mean()) / x.std())</span><br></pre></td></tr></table></figure><p>在这个例子中，<code>Feature1</code> 和 <code>Feature2</code> 是数值型特征。首先计算它们的均值和标准差：</p><ul><li><code>Feature1</code>的均值 &#x3D; (10 + 20 + 30 + 25 + 35) &#x2F; 5 &#x3D; 24</li><li><code>Feature1</code>的标准差 ≈ 9.57</li><li><code>Feature2</code>的均值 &#x3D; (5.0 + 6.5 + 5.5 + 7.0) &#x2F; 4 &#x3D; 6.0</li><li><code>Feature2</code>的标准差 ≈ 0.79</li></ul><p>标准化后的结果：</p><table><thead><tr><th>Feature1</th><th>Feature2</th><th>Feature3</th></tr></thead><tbody><tr><td>-1.46</td><td>-1.27</td><td>A</td></tr><tr><td>-0.42</td><td>0.63</td><td>B</td></tr><tr><td>0.63</td><td>NaN</td><td>A</td></tr><tr><td>0.10</td><td>-0.63</td><td>B</td></tr><tr><td>1.15</td><td>1.27</td><td>NaN</td></tr></tbody></table><h4 id="3-填充缺失值为0"><a href="#3-填充缺失值为0" class="headerlink" title="3. 填充缺失值为0"></a>3. 填充缺失值为0</h4><p>将数值型特征中的缺失值（NaN）填充为0。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all_features[numeric_features] = all_features[numeric_features].fillna(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>填充缺失值后的结果：</p><table><thead><tr><th>Feature1</th><th>Feature2</th><th>Feature3</th></tr></thead><tbody><tr><td>-1.46</td><td>-1.27</td><td>A</td></tr><tr><td>-0.42</td><td>0.63</td><td>B</td></tr><tr><td>0.63</td><td>0.00</td><td>A</td></tr><tr><td>0.10</td><td>-0.63</td><td>B</td></tr><tr><td>1.15</td><td>1.27</td><td>NaN</td></tr></tbody></table><h4 id="4-处理离散数值特征"><a href="#4-处理离散数值特征" class="headerlink" title="4. 处理离散数值特征"></a>4. 处理离散数值特征</h4><p>将离散特征（分类特征）进行独热编码（one-hot encoding），包括缺失值（dummy_na&#x3D;True）。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all_features = pd.get_dummies(all_features, dummy_na=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>编码后的结果：</p><table><thead><tr><th>Feature1</th><th>Feature2</th><th>Feature3_A</th><th>Feature3_B</th><th>Feature3_nan</th></tr></thead><tbody><tr><td>-1.46</td><td>-1.27</td><td>1</td><td>0</td><td>0</td></tr><tr><td>-0.42</td><td>0.63</td><td>0</td><td>1</td><td>0</td></tr><tr><td>0.63</td><td>0.00</td><td>1</td><td>0</td><td>0</td></tr><tr><td>0.10</td><td>-0.63</td><td>0</td><td>1</td><td>0</td></tr><tr><td>1.15</td><td>1.27</td><td>0</td><td>0</td><td>1</td></tr></tbody></table><h4 id="5-确保所有特征都是数值类型"><a href="#5-确保所有特征都是数值类型" class="headerlink" title="5. 确保所有特征都是数值类型"></a>5. 确保所有特征都是数值类型</h4><p>确保所有特征的数据类型都是 <code>float32</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all_features = all_features.astype(np.float32)</span><br></pre></td></tr></table></figure><p>最终结果是一个完全由数值型特征组成的DataFrame，并且所有特征都经过标准化和缺失值处理，准备好用于后续的模型训练和预测：</p><p><strong>最终结果：</strong></p><table><thead><tr><th>Feature1</th><th>Feature2</th><th>Feature3_A</th><th>Feature3_B</th><th>Feature3_nan</th></tr></thead><tbody><tr><td>-1.46</td><td>-1.27</td><td>1.0</td><td>0.0</td><td>0.0</td></tr><tr><td>-0.42</td><td>0.63</td><td>0.0</td><td>1.0</td><td>0.0</td></tr><tr><td>0.63</td><td>0.00</td><td>1.0</td><td>0.0</td><td>0.0</td></tr><tr><td>0.10</td><td>-0.63</td><td>0.0</td><td>1.0</td><td>0.0</td></tr><tr><td>1.15</td><td>1.27</td><td>0.0</td><td>0.0</td><td>1.0</td></tr></tbody></table><p>通过这些步骤，我们成功地对训练和测试数据集的特征进行了标准化、缺失值处理和独热编码，使其准备好用于后续的模型训练和预测。</p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 PyTorch 和 Pandas 进行 Kaggle 房价预测</title>
      <link href="/2024/06/28/%E4%BD%BF%E7%94%A8%20PyTorch%20%E5%92%8C%20Pandas%20%E8%BF%9B%E8%A1%8C%20Kaggle%20%E6%88%BF%E4%BB%B7%E9%A2%84%E6%B5%8B/"/>
      <url>/2024/06/28/%E4%BD%BF%E7%94%A8%20PyTorch%20%E5%92%8C%20Pandas%20%E8%BF%9B%E8%A1%8C%20Kaggle%20%E6%88%BF%E4%BB%B7%E9%A2%84%E6%B5%8B/</url>
      
        <content type="html"><![CDATA[<p>在本篇博文中，我们将探索如何使用 PyTorch 和 Pandas 库，构建一个用于 Kaggle 房价预测的模型。我们将详细讨论数据加载、预处理、模型构建、训练、验证及最终预测的全过程。</p><h2 id="1、环境设置"><a href="#1、环境设置" class="headerlink" title="1、环境设置"></a>1、环境设置</h2><p>我们首先需要导入所需的库，包括用于数据处理的 <code>pandas</code> 和 <code>numpy</code>，以及用于深度学习的 <code>torch</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> d2l <span class="keyword">import</span> torch <span class="keyword">as</span> d2l</span><br></pre></td></tr></table></figure><h2 id="2、数据下载"><a href="#2、数据下载" class="headerlink" title="2、数据下载"></a>2、数据下载</h2><p>为了下载数据，我们需要定义一个下载函数，并在其中实现数据缓存机制以避免重复下载。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保存DATA_HUB字典以便下载数据</span></span><br><span class="line">DATA_HUB = <span class="built_in">dict</span>()</span><br><span class="line">DATA_URL = <span class="string">&#x27;http://d2l-data.s3-accelerate.amazonaws.com/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存下载函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">name, cache_dir=os.path.join(<span class="params"><span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;data&#x27;</span></span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;下载一个DATA_HUB中的文件，返回本地文件名&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">assert</span> name <span class="keyword">in</span> DATA_HUB, <span class="string">f&quot;<span class="subst">&#123;name&#125;</span> 不存在于 <span class="subst">&#123;DATA_HUB&#125;</span>&quot;</span></span><br><span class="line">    url, sha1_hash = DATA_HUB[name]</span><br><span class="line">    os.makedirs(cache_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    fname = os.path.join(cache_dir, url.split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(fname):</span><br><span class="line">        sha1 = hashlib.sha1()</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(fname, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                data = f.read(<span class="number">1048576</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                sha1.update(data)</span><br><span class="line">        <span class="keyword">if</span> sha1.hexdigest() == sha1_hash:</span><br><span class="line">            <span class="keyword">return</span> fname  <span class="comment"># 命中缓存</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;正在从<span class="subst">&#123;url&#125;</span>下载<span class="subst">&#123;fname&#125;</span>...&#x27;</span>)</span><br><span class="line">    r = requests.get(url, stream=<span class="literal">True</span>, verify=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(fname, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(r.content)</span><br><span class="line">    <span class="keyword">return</span> fname</span><br></pre></td></tr></table></figure><p>接下来，我们在 <code>DATA_HUB</code> 中注册 Kaggle 房价预测的训练和测试数据集，并下载这些数据。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在DATA_HUB中注册Kaggle房价预测的训练和测试数据集</span></span><br><span class="line">DATA_HUB[<span class="string">&#x27;kaggle_house_train&#x27;</span>] = (</span><br><span class="line">    DATA_URL + <span class="string">&#x27;kaggle_house_pred_train.csv&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;585e9cc93e70b39160e7921475f9bcd7d31219ce&#x27;</span>)</span><br><span class="line"></span><br><span class="line">DATA_HUB[<span class="string">&#x27;kaggle_house_test&#x27;</span>] = (</span><br><span class="line">    DATA_URL + <span class="string">&#x27;kaggle_house_pred_test.csv&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;fa19780a7b011d9b009e8bff8e99922a8ee2eb90&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载并加载数据</span></span><br><span class="line">train_data = pd.read_csv(download(<span class="string">&#x27;kaggle_house_train&#x27;</span>))</span><br><span class="line">test_data = pd.read_csv(download(<span class="string">&#x27;kaggle_house_test&#x27;</span>))</span><br></pre></td></tr></table></figure><h2 id="3、数据预处理"><a href="#3、数据预处理" class="headerlink" title="3、数据预处理"></a>3、数据预处理</h2><p>我们首先查看数据集的形状和部分内容。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看数据集的形状和部分内容</span></span><br><span class="line"><span class="built_in">print</span>(train_data.shape)</span><br><span class="line"><span class="built_in">print</span>(test_data.shape)</span><br><span class="line"><span class="built_in">print</span>(train_data.iloc[<span class="number">0</span>:<span class="number">4</span>, [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, -<span class="number">3</span>, -<span class="number">2</span>, -<span class="number">1</span>]])</span><br></pre></td></tr></table></figure><p>然后，我们合并所有特征以进行统一预处理，并标准化数值特征，填充缺失值为0，处理离散数值特征。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 合并所有特征以进行预处理</span></span><br><span class="line">all_features = pd.concat((train_data.iloc[:, <span class="number">1</span>:-<span class="number">1</span>], test_data.iloc[:, <span class="number">1</span>:]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 标准化数值特征</span></span><br><span class="line">numeric_features = all_features.dtypes[all_features.dtypes != <span class="string">&#x27;object&#x27;</span>].index</span><br><span class="line">all_features[numeric_features] = all_features[numeric_features].apply(</span><br><span class="line">    <span class="keyword">lambda</span> x: (x - x.mean()) / (x.std()))</span><br><span class="line"><span class="comment"># 填充缺失值为0</span></span><br><span class="line">all_features[numeric_features] = all_features[numeric_features].fillna(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理离散数值特征（dummy_na=True包括缺失值）</span></span><br><span class="line">all_features = pd.get_dummies(all_features, dummy_na=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保所有特征都是数值类型</span></span><br><span class="line">all_features = all_features.astype(np.float32)</span><br></pre></td></tr></table></figure><p>将数据转换为 tensor 格式，以便 PyTorch 使用。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将数据转换为tensor格式</span></span><br><span class="line">n_train = train_data.shape[<span class="number">0</span>]</span><br><span class="line">train_features = torch.tensor(all_features[:n_train].values, dtype=torch.float32)</span><br><span class="line">test_features = torch.tensor(all_features[n_train:].values, dtype=torch.float32)</span><br><span class="line">train_labels = torch.tensor(train_data.SalePrice.values.reshape(-<span class="number">1</span>, <span class="number">1</span>), dtype=torch.float32)</span><br></pre></td></tr></table></figure><h2 id="4、模型构建"><a href="#4、模型构建" class="headerlink" title="4、模型构建"></a>4、模型构建</h2><p>我们定义一个简单的线性回归模型，并设置损失函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义损失函数和获取网络结构</span></span><br><span class="line">loss = nn.MSELoss()</span><br><span class="line">in_features = train_features.shape[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_net</span>():</span><br><span class="line">    net = nn.Sequential(nn.Linear(in_features, <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> net</span><br></pre></td></tr></table></figure><h2 id="5、训练和验证"><a href="#5、训练和验证" class="headerlink" title="5、训练和验证"></a>5、训练和验证</h2><p>为了更好地评估模型，我们定义了 K 折交叉验证和训练函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义log_rmse函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_rmse</span>(<span class="params">net, features, labels</span>):</span><br><span class="line">    clipped_preds = torch.clamp(net(features), <span class="number">1</span>, <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>))</span><br><span class="line">    rmse = torch.sqrt(loss(torch.log(clipped_preds), torch.log(labels)))</span><br><span class="line">    <span class="keyword">return</span> rmse.item()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义训练函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">net, train_features, train_labels, test_features, test_labels, num_epochs, learning_rate, weight_decay, batch_size</span>):</span><br><span class="line">    train_ls, test_ls = [], []</span><br><span class="line">    train_iter = d2l.load_array((train_features, train_labels), batch_size)</span><br><span class="line">    optimizer = torch.optim.Adam(net.parameters(), lr=learning_rate, weight_decay=weight_decay)</span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">        <span class="keyword">for</span> X, y <span class="keyword">in</span> train_iter:</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            l = loss(net(X), y)</span><br><span class="line">            l.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line">        train_ls.append(log_rmse(net, train_features, train_labels))</span><br><span class="line">        <span class="keyword">if</span> test_labels <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            test_ls.append(log_rmse(net, test_features, test_labels))</span><br><span class="line">    <span class="keyword">return</span> train_ls, test_ls</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取k折交叉验证的数据</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_k_fold_data</span>(<span class="params">k, i, X, y</span>):</span><br><span class="line">    <span class="keyword">assert</span> k &gt; <span class="number">1</span></span><br><span class="line">    fold_size = X.shape[<span class="number">0</span>] // k</span><br><span class="line">    X_train, y_train = <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(k):</span><br><span class="line">        idx = <span class="built_in">slice</span>(j * fold_size, (j + <span class="number">1</span>) * fold_size)</span><br><span class="line">        X_part, y_part = X[idx, :], y[idx]</span><br><span class="line">        <span class="keyword">if</span> j == i:</span><br><span class="line">            X_valid, y_valid = X_part, y_part</span><br><span class="line">        <span class="keyword">elif</span> X_train <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            X_train, y_train = X_part, y_part</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            X_train = torch.cat([X_train, X_part], <span class="number">0</span>)</span><br><span class="line">            y_train = torch.cat([y_train, y_part], <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> X_train, y_train, X_valid, y_valid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义k折交叉验证函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">k_fold</span>(<span class="params">k, X_train, y_train, num_epochs, learning_rate, weight_decay, batch_size</span>):</span><br><span class="line">    train_l_sum, valid_l_sum = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(k):</span><br><span class="line">        data = get_k_fold_data(k, i, X_train, y_train)</span><br><span class="line">        net = get_net()</span><br><span class="line">        train_ls, valid_ls = train(net, *data, num_epochs, learning_rate, weight_decay, batch_size)</span><br><span class="line">        train_l_sum += train_ls[-<span class="number">1</span>]</span><br><span class="line">        valid_l_sum += valid_ls[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            d2l.plot(<span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">1</span>, num_epochs + <span class="number">1</span>)), [train_ls, valid_ls], xlabel=<span class="string">&#x27;epoch&#x27;</span>, ylabel=<span class="string">&#x27;rmse&#x27;</span>, xlim=[<span class="number">1</span>, num_epochs], legend=[<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;valid&#x27;</span>], yscale=<span class="string">&#x27;log&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;折<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>，训练log rmse<span class="subst">&#123;<span class="built_in">float</span>(train_ls[-<span class="number">1</span>]):f&#125;</span>, 验证log rmse<span class="subst">&#123;<span class="built_in">float</span>(valid_ls[-<span class="number">1</span>]):f&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> train_l_sum / k, valid_l_sum / k</span><br></pre></td></tr></table></figure><h2 id="6、训练模型并生成预测结果"><a href="#6、训练模型并生成预测结果" class="headerlink" title="6、训练模型并生成预测结果"></a>6、训练模型并生成预测结果</h2><p>我们定义了最终的训练和预测函数，并训练模型生成预测结果。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义超参数并进行k折交叉验证</span></span><br><span class="line">k, num_epochs, lr, weight_decay, batch_size = <span class="number">5</span>, <span class="number">100</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">64</span></span><br><span class="line">train_l, valid_l = k_fold(k, train_features, train_labels, num_epochs, lr, weight_decay, batch_size)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;k&#125;</span>-折验证: 平均训练log rmse: <span class="subst">&#123;<span class="built_in">float</span>(train_l):f&#125;</span>, 平均验证log rmse: <span class="subst">&#123;<span class="built_in">float</span>(valid_l):f&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义最终的训练和预测函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train_and_pred</span>(<span class="params">train_features, test_features, train_labels, test_data, num_epochs, lr, weight_decay, batch_size</span>):</span><br><span class="line">    net = get_net()</span><br><span class="line">    train_ls, _ = train(net, train_features, train_labels, <span class="literal">None</span>, <span class="literal">None</span>, num_epochs, lr, weight_decay, batch_size)</span><br><span class="line">    d2l.plot(np.arange(<span class="number">1</span>, num_epochs + <span class="number">1</span>), [train_ls], xlabel=<span class="string">&#x27;epoch&#x27;</span>, ylabel=<span class="string">&#x27;log rmse&#x27;</span>, xlim=[<span class="number">1</span>, num_epochs], yscale=<span class="string">&#x27;log&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;训练log rmse：<span class="subst">&#123;<span class="built_in">float</span>(train_ls[-<span class="number">1</span>]):f&#125;</span>&#x27;</span>)</span><br><span class="line">    preds = net(test_features).detach().numpy()</span><br><span class="line">    test_data[<span class="string">&#x27;SalePrice&#x27;</span>] = pd.Series(preds.reshape(<span class="number">1</span>, -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">)[<span class="number">0</span>])</span><br><span class="line">    submission = pd.concat([test_data[<span class="string">&#x27;Id&#x27;</span>], test_data[<span class="string">&#x27;SalePrice&#x27;</span>]], axis=<span class="number">1</span>)</span><br><span class="line">    submission.to_csv(<span class="string">&#x27;submission.csv&#x27;</span>, index=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练模型并生成预测结果</span></span><br><span class="line">train_and_pred(train_features, test_features, train_labels, test_data, num_epochs, lr, weight_decay, batch_size)</span><br></pre></td></tr></table></figure><p>通过上述步骤，我们成功地使用 PyTorch 和 Pandas 实现了一个简单的线性回归模型，用于 Kaggle 房价预测任务。这篇博文涵盖了数据下载、预处理、模型构建、训练、验证及预测的全过程，为类似任务提供了一个完整的参考。</p><h2 id="7、完整代码"><a href="#7、完整代码" class="headerlink" title="7、完整代码"></a>7、完整代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> d2l <span class="keyword">import</span> torch <span class="keyword">as</span> d2l</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存DATA_HUB字典以便下载数据</span></span><br><span class="line">DATA_HUB = <span class="built_in">dict</span>()</span><br><span class="line">DATA_URL = <span class="string">&#x27;http://d2l-data.s3-accelerate.amazonaws.com/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存下载函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">name, cache_dir=os.path.join(<span class="params"><span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;data&#x27;</span></span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;下载一个DATA_HUB中的文件，返回本地文件名&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">assert</span> name <span class="keyword">in</span> DATA_HUB, <span class="string">f&quot;<span class="subst">&#123;name&#125;</span> 不存在于 <span class="subst">&#123;DATA_HUB&#125;</span>&quot;</span></span><br><span class="line">    url, sha1_hash = DATA_HUB[name]</span><br><span class="line">    os.makedirs(cache_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    fname = os.path.join(cache_dir, url.split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(fname):</span><br><span class="line">        sha1 = hashlib.sha1()</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(fname, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                data = f.read(<span class="number">1048576</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                sha1.update(data)</span><br><span class="line">        <span class="keyword">if</span> sha1.hexdigest() == sha1_hash:</span><br><span class="line">            <span class="keyword">return</span> fname  <span class="comment"># 命中缓存</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;正在从<span class="subst">&#123;url&#125;</span>下载<span class="subst">&#123;fname&#125;</span>...&#x27;</span>)</span><br><span class="line">    r = requests.get(url, stream=<span class="literal">True</span>, verify=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(fname, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(r.content)</span><br><span class="line">    <span class="keyword">return</span> fname</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在DATA_HUB中注册Kaggle房价预测的训练和测试数据集</span></span><br><span class="line">DATA_HUB[<span class="string">&#x27;kaggle_house_train&#x27;</span>] = (</span><br><span class="line">    DATA_URL + <span class="string">&#x27;kaggle_house_pred_train.csv&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;585e9cc93e70b39160e7921475f9bcd7d31219ce&#x27;</span>)</span><br><span class="line"></span><br><span class="line">DATA_HUB[<span class="string">&#x27;kaggle_house_test&#x27;</span>] = (</span><br><span class="line">    DATA_URL + <span class="string">&#x27;kaggle_house_pred_test.csv&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;fa19780a7b011d9b009e8bff8e99922a8ee2eb90&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载并加载数据</span></span><br><span class="line">train_data = pd.read_csv(download(<span class="string">&#x27;kaggle_house_train&#x27;</span>))</span><br><span class="line">test_data = pd.read_csv(download(<span class="string">&#x27;kaggle_house_test&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据集的形状和部分内容</span></span><br><span class="line"><span class="built_in">print</span>(train_data.shape)</span><br><span class="line"><span class="built_in">print</span>(test_data.shape)</span><br><span class="line"><span class="built_in">print</span>(train_data.iloc[<span class="number">0</span>:<span class="number">4</span>, [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, -<span class="number">3</span>, -<span class="number">2</span>, -<span class="number">1</span>]])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并所有特征以进行预处理</span></span><br><span class="line">all_features = pd.concat((train_data.iloc[:, <span class="number">1</span>:-<span class="number">1</span>], test_data.iloc[:, <span class="number">1</span>:]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 标准化数值特征</span></span><br><span class="line">numeric_features = all_features.dtypes[all_features.dtypes != <span class="string">&#x27;object&#x27;</span>].index</span><br><span class="line">all_features[numeric_features] = all_features[numeric_features].apply(</span><br><span class="line">    <span class="keyword">lambda</span> x: (x - x.mean()) / (x.std()))</span><br><span class="line"><span class="comment"># 填充缺失值为0</span></span><br><span class="line">all_features[numeric_features] = all_features[numeric_features].fillna(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理离散数值特征（dummy_na=True包括缺失值）</span></span><br><span class="line">all_features = pd.get_dummies(all_features, dummy_na=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保所有特征都是数值类型</span></span><br><span class="line">all_features = all_features.astype(np.float32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将数据转换为tensor格式</span></span><br><span class="line">n_train = train_data.shape[<span class="number">0</span>]</span><br><span class="line">train_features = torch.tensor(all_features[:n_train].values, dtype=torch.float32)</span><br><span class="line">test_features = torch.tensor(all_features[n_train:].values, dtype=torch.float32)</span><br><span class="line">train_labels = torch.tensor(train_data.SalePrice.values.reshape(-<span class="number">1</span>, <span class="number">1</span>), dtype=torch.float32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义损失函数和获取网络结构</span></span><br><span class="line">loss = nn.MSELoss()</span><br><span class="line">in_features = train_features.shape[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_net</span>():</span><br><span class="line">    net = nn.Sequential(nn.Linear(in_features, <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> net</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义log_rmse函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_rmse</span>(<span class="params">net, features, labels</span>):</span><br><span class="line">    clipped_preds = torch.clamp(net(features), <span class="number">1</span>, <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>))</span><br><span class="line">    rmse = torch.sqrt(loss(torch.log(clipped_preds), torch.log(labels)))</span><br><span class="line">    <span class="keyword">return</span> rmse.item()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义训练函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">net, train_features, train_labels, test_features, test_labels, num_epochs, learning_rate, weight_decay, batch_size</span>):</span><br><span class="line">    train_ls, test_ls = [], []</span><br><span class="line">    train_iter = d2l.load_array((train_features, train_labels), batch_size)</span><br><span class="line">    optimizer = torch.optim.Adam(net.parameters(), lr=learning_rate, weight_decay=weight_decay)</span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">        <span class="keyword">for</span> X, y <span class="keyword">in</span> train_iter:</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            l = loss(net(X), y)</span><br><span class="line">            l.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line">        train_ls.append(log_rmse(net, train_features, train_labels))</span><br><span class="line">        <span class="keyword">if</span> test_labels <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            test_ls.append(log_rmse(net, test_features, test_labels))</span><br><span class="line">    <span class="keyword">return</span> train_ls, test_ls</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取k折交叉验证的数据</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_k_fold_data</span>(<span class="params">k, i, X, y</span>):</span><br><span class="line">    <span class="keyword">assert</span> k &gt; <span class="number">1</span></span><br><span class="line">    fold_size = X.shape[<span class="number">0</span>] // k</span><br><span class="line">    X_train, y_train = <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(k):</span><br><span class="line">        idx = <span class="built_in">slice</span>(j * fold_size, (j + <span class="number">1</span>) * fold_size)</span><br><span class="line">        X_part, y_part = X[idx, :], y[idx]</span><br><span class="line">        <span class="keyword">if</span> j == i:</span><br><span class="line">            X_valid, y_valid = X_part, y_part</span><br><span class="line">        <span class="keyword">elif</span> X_train <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            X_train, y_train = X_part, y_part</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            X_train = torch.cat([X_train, X_part], <span class="number">0</span>)</span><br><span class="line">            y_train = torch.cat([y_train, y_part], <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> X_train, y_train, X_valid, y_valid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义k折交叉验证函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">k_fold</span>(<span class="params">k, X_train, y_train, num_epochs, learning_rate, weight_decay, batch_size</span>):</span><br><span class="line">    train_l_sum, valid_l_sum = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(k):</span><br><span class="line">        data = get_k_fold_data(k, i, X_train, y_train)</span><br><span class="line">        net = get_net()</span><br><span class="line">        train_ls, valid_ls = train(net, *data, num_epochs, learning_rate, weight_decay, batch_size)</span><br><span class="line">        train_l_sum += train_ls[-<span class="number">1</span>]</span><br><span class="line">        valid_l_sum += valid_ls[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            d2l.plot(<span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">1</span>, num_epochs + <span class="number">1</span>)), [train_ls, valid_ls], xlabel=<span class="string">&#x27;epoch&#x27;</span>, ylabel=<span class="string">&#x27;rmse&#x27;</span>, xlim=[<span class="number">1</span>, num_epochs], legend=[<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;valid&#x27;</span>], yscale=<span class="string">&#x27;log&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;折<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>，训练log rmse<span class="subst">&#123;<span class="built_in">float</span>(train_ls[-<span class="number">1</span>]):f&#125;</span>, 验证log rmse<span class="subst">&#123;<span class="built_in">float</span>(valid_ls[-<span class="number">1</span>]):f&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> train_l_sum / k, valid_l_sum / k</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义超参数并进行k折交叉验证</span></span><br><span class="line">k, num_epochs, lr, weight_decay, batch_size = <span class="number">5</span>, <span class="number">100</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">64</span></span><br><span class="line">train_l, valid_l = k_fold(k, train_features, train_labels, num_epochs, lr, weight_decay, batch_size)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;k&#125;</span>-折验证: 平均训练log rmse: <span class="subst">&#123;<span class="built_in">float</span>(train_l):f&#125;</span>, 平均验证log rmse: <span class="subst">&#123;<span class="built_in">float</span>(valid_l):f&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义最终的训练和预测函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train_and_pred</span>(<span class="params">train_features, test_features, train_labels, test_data, num_epochs, lr, weight_decay, batch_size</span>):</span><br><span class="line">    net = get_net()</span><br><span class="line">    train_ls, _ = train(net, train_features, train_labels, <span class="literal">None</span>, <span class="literal">None</span>, num_epochs, lr, weight_decay, batch_size)</span><br><span class="line">    d2l.plot(np.arange(<span class="number">1</span>, num_epochs + <span class="number">1</span>), [train_ls], xlabel=<span class="string">&#x27;epoch&#x27;</span>, ylabel=<span class="string">&#x27;log rmse&#x27;</span>, xlim=[<span class="number">1</span>, num_epochs], yscale=<span class="string">&#x27;log&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;训练log rmse：<span class="subst">&#123;<span class="built_in">float</span>(train_ls[-<span class="number">1</span>]):f&#125;</span>&#x27;</span>)</span><br><span class="line">    preds = net(test_features).detach().numpy()</span><br><span class="line">    test_data[<span class="string">&#x27;SalePrice&#x27;</span>] = pd.Series(preds.reshape(<span class="number">1</span>, -<span class="number">1</span>)[<span class="number">0</span>])</span><br><span class="line">    submission = pd.concat([test_data[<span class="string">&#x27;Id&#x27;</span>], test_data[<span class="string">&#x27;SalePrice&#x27;</span>]], axis=<span class="number">1</span>)</span><br><span class="line">    submission.to_csv(<span class="string">&#x27;submission.csv&#x27;</span>, index=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练模型并生成预测结果</span></span><br><span class="line">train_and_pred(train_features, test_features, train_labels, test_data, num_epochs, lr, weight_decay, batch_size)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何在不同电脑之间导出和导入 Docker 镜像</title>
      <link href="/2024/06/19/%E5%A6%82%E4%BD%95%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%94%B5%E8%84%91%E4%B9%8B%E9%97%B4%E5%AF%BC%E5%87%BA%E5%92%8C%E5%AF%BC%E5%85%A5%20Docker%20%E9%95%9C%E5%83%8F/"/>
      <url>/2024/06/19/%E5%A6%82%E4%BD%95%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%94%B5%E8%84%91%E4%B9%8B%E9%97%B4%E5%AF%BC%E5%87%BA%E5%92%8C%E5%AF%BC%E5%85%A5%20Docker%20%E9%95%9C%E5%83%8F/</url>
      
        <content type="html"><![CDATA[<h2 id="如何在不同电脑之间导出和导入-Docker-镜像"><a href="#如何在不同电脑之间导出和导入-Docker-镜像" class="headerlink" title="如何在不同电脑之间导出和导入 Docker 镜像"></a>如何在不同电脑之间导出和导入 Docker 镜像</h2><p>在开发和部署过程中，你可能会遇到需要将 Docker 镜像从一台电脑导出并导入到另一台电脑的情况。无论是为了分享镜像，还是为了在不同环境中进行测试，Docker 都提供了方便的工具来实现这一需求。本文将详细介绍如何使用 <code>docker save</code> 和 <code>docker load</code> 命令将 Docker 镜像从一台电脑传输到另一台电脑。</p><h3 id="步骤-1：导出镜像"><a href="#步骤-1：导出镜像" class="headerlink" title="步骤 1：导出镜像"></a>步骤 1：导出镜像</h3><p>首先，在源电脑上使用 <code>docker save</code> 命令将 Docker 镜像保存为一个 tar 文件。假设你要导出的镜像名为 <code>foxy_noetic_ubuntu20.04:v1</code>，你可以运行以下命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save -o foxy_noetic_ubuntu20.04_v1.tar foxy_noetic_ubuntu20.04:v1</span><br></pre></td></tr></table></figure><p>这条命令会创建一个名为 <code>foxy_noetic_ubuntu20.04_v1.tar</code> 的文件，该文件包含了 <code>foxy_noetic_ubuntu20.04:v1</code> 镜像的所有内容。</p><h3 id="步骤-2：传输镜像文件"><a href="#步骤-2：传输镜像文件" class="headerlink" title="步骤 2：传输镜像文件"></a>步骤 2：传输镜像文件</h3><p>接下来，需要将生成的 tar 文件从源电脑传输到目标电脑。你可以使用各种工具来实现这一点，例如 <code>scp</code>、<code>rsync</code>、USB 设备等。</p><p>以下是使用 <code>scp</code> 命令传输文件的示例：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp foxy_noetic_ubuntu20.04_v1.tar user@target-computer:/path/to/destination</span><br></pre></td></tr></table></figure><p>在此命令中，将 <code>user@target-computer</code> 替换为目标电脑的用户名和地址，并将 <code>/path/to/destination</code> 替换为目标路径。</p><h3 id="步骤-3：导入镜像"><a href="#步骤-3：导入镜像" class="headerlink" title="步骤 3：导入镜像"></a>步骤 3：导入镜像</h3><p>在目标电脑上，使用 <code>docker load</code> 命令从 tar 文件中加载 Docker 镜像：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load -i /path/to/destination/foxy_noetic_ubuntu20.04_v1.tar</span><br></pre></td></tr></table></figure><p>这条命令会从指定的 tar 文件中加载镜像，并将其添加到本地 Docker 镜像库中。</p><h3 id="步骤-4：验证镜像"><a href="#步骤-4：验证镜像" class="headerlink" title="步骤 4：验证镜像"></a>步骤 4：验证镜像</h3><p>导入完成后，你可以使用 <code>docker images</code> 命令来验证镜像是否成功导入：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure><p>你应该能够看到 <code>foxy_noetic_ubuntu20.04:v1</code> 镜像在列表中。</p><h3 id="完整操作示例"><a href="#完整操作示例" class="headerlink" title="完整操作示例"></a>完整操作示例</h3><p>以下是完整的操作步骤：</p><p><strong>在源电脑上：</strong></p><ol><li><p>将镜像保存为 tar 文件：</p> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save -o foxy_noetic_ubuntu20.04_v1.tar foxy_noetic_ubuntu20.04:v1</span><br></pre></td></tr></table></figure></li><li><p>将 tar 文件传输到目标电脑：</p> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp foxy_noetic_ubuntu20.04_v1.tar user@target-computer:/path/to/destination</span><br></pre></td></tr></table></figure></li></ol><p><strong>在目标电脑上：</strong></p><ol><li><p>从 tar 文件中加载镜像：</p> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load -i /path/to/destination/foxy_noetic_ubuntu20.04_v1.tar</span><br></pre></td></tr></table></figure></li><li><p>验证镜像是否成功导入：</p> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure></li></ol><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>通过以上步骤，你可以轻松地将 Docker 镜像从一台电脑导出并导入到另一台电脑。这对于在不同环境中测试应用程序或共享镜像非常有用。</p>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu20.04安装ros noetic</title>
      <link href="/2024/06/15/ubuntu20.04%E5%AE%89%E8%A3%85ros%20noetic/"/>
      <url>/2024/06/15/ubuntu20.04%E5%AE%89%E8%A3%85ros%20noetic/</url>
      
        <content type="html"><![CDATA[<h2 id="一、安装ROS-neotic步骤"><a href="#一、安装ROS-neotic步骤" class="headerlink" title="一、安装ROS neotic步骤"></a>一、安装ROS neotic步骤</h2><h3 id="第一步：换源（在软件和更新里面）"><a href="#第一步：换源（在软件和更新里面）" class="headerlink" title="第一步：换源（在软件和更新里面）"></a>第一步：换源（在软件和更新里面）</h3><p>这一步非常重要，决定着后面安装ROS能否成功的关键一步。<br>这里，我选择了中科大（<a href="https://mirrors.ustc.edu.cn/ubuntu/%EF%BC%89%E3%80%82">https://mirrors.ustc.edu.cn/ubuntu/）。</a></p><h3 id="第二步：添加ROS软件源"><a href="#第二步：添加ROS软件源" class="headerlink" title="第二步：添加ROS软件源"></a>第二步：添加ROS软件源</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c &#x27;echo &quot;deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main&quot; &gt; /etc/apt/sources.list.d/ros-latest.list&#x27;</span><br></pre></td></tr></table></figure><h3 id="第三步：添加密钥"><a href="#第三步：添加密钥" class="headerlink" title="第三步：添加密钥"></a>第三步：添加密钥</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-key adv --keyserver &#x27;hkp://keyserver.ubuntu.com:80&#x27; --recv-key C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654</span><br></pre></td></tr></table></figure><h3 id="第四步：更新软件源"><a href="#第四步：更新软件源" class="headerlink" title="第四步：更新软件源"></a>第四步：更新软件源</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure><h3 id="第五步：开始安装ROS"><a href="#第五步：开始安装ROS" class="headerlink" title="第五步：开始安装ROS"></a>第五步：开始安装ROS</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ros-noetic-desktop-full</span><br></pre></td></tr></table></figure><h3 id="第六步：设置-x2F-更新环境变量"><a href="#第六步：设置-x2F-更新环境变量" class="headerlink" title="第六步：设置&#x2F;更新环境变量"></a>第六步：设置&#x2F;更新环境变量</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;source /opt/ros/noetic/setup.bash&quot; &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><h3 id="第七步：安装ros所需工具"><a href="#第七步：安装ros所需工具" class="headerlink" title="第七步：安装ros所需工具"></a>第七步：安装ros所需工具</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python3-rosinstall python3-rosinstall-generator python3-wstool build-essential python3-roslaunch</span><br></pre></td></tr></table></figure><h2 id="二、测试是否安装成功"><a href="#二、测试是否安装成功" class="headerlink" title="二、测试是否安装成功"></a>二、测试是否安装成功</h2><h3 id="第一步：终端里输入roscore"><a href="#第一步：终端里输入roscore" class="headerlink" title="第一步：终端里输入roscore"></a>第一步：终端里输入roscore</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roscore</span><br></pre></td></tr></table></figure><h3 id="第二步：重新打开终端输入"><a href="#第二步：重新打开终端输入" class="headerlink" title="第二步：重新打开终端输入"></a>第二步：重新打开终端输入</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rosrun turtlesim turtlesim_node</span><br></pre></td></tr></table></figure><h3 id="第三步：再重新打开终端输入"><a href="#第三步：再重新打开终端输入" class="headerlink" title="第三步：再重新打开终端输入"></a>第三步：再重新打开终端输入</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rosrun turtlesim turtle_teleop_key</span><br></pre></td></tr></table></figure><p>把鼠标放在第三步的界面上，然后通过上下左右方向键就可以控制小海龟的移动了。<br>至此，ros已经安装完成了。</p>]]></content>
      
      
      <categories>
          
          <category> ROS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ROS简单节点demo（Python）</title>
      <link href="/2024/05/18/ros1%20%E7%AE%80%E5%8D%95%E8%8A%82%E7%82%B9demo%EF%BC%88Python%EF%BC%89/"/>
      <url>/2024/05/18/ros1%20%E7%AE%80%E5%8D%95%E8%8A%82%E7%82%B9demo%EF%BC%88Python%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>好的，下面是将 <code>talker_listener_demo</code> 从C++版本转换为Python版本的详细步骤和代码示例：</p><h3 id="步骤-1：创建ROS包"><a href="#步骤-1：创建ROS包" class="headerlink" title="步骤 1：创建ROS包"></a>步骤 1：创建ROS包</h3><p>在终端中执行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">catkin_create_pkg talker_listener_demo rospy std_msgs</span><br></pre></td></tr></table></figure><p>这将在你的Catkin工作空间中创建一个名为 <code>talker_listener_demo</code> 的ROS包，并将 <code>rospy</code> 和 <code>std_msgs</code> 添加为依赖项。</p><h3 id="步骤-2：创建Python脚本"><a href="#步骤-2：创建Python脚本" class="headerlink" title="步骤 2：创建Python脚本"></a>步骤 2：创建Python脚本</h3><p>在 <code>src</code> 文件夹下创建两个Python脚本：<code>talker.py</code> 和 <code>listener.py</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/catkin_ws/src/talker_listener_demo/src</span><br><span class="line"><span class="built_in">touch</span> talker.py</span><br><span class="line"><span class="built_in">touch</span> listener.py</span><br></pre></td></tr></table></figure><h3 id="步骤-3：编写Python节点代码"><a href="#步骤-3：编写Python节点代码" class="headerlink" title="步骤 3：编写Python节点代码"></a>步骤 3：编写Python节点代码</h3><p>编辑 <code>talker.py</code> 和 <code>listener.py</code> 文件，编写发布者节点和订阅者节点的Python代码。</p><h4 id="talker-py："><a href="#talker-py：" class="headerlink" title="talker.py："></a>talker.py：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> rospy</span><br><span class="line"><span class="keyword">from</span> std_msgs.msg <span class="keyword">import</span> String</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">talker</span>():</span><br><span class="line">    rospy.init_node(<span class="string">&#x27;talker&#x27;</span>, anonymous=<span class="literal">True</span>)</span><br><span class="line">    pub = rospy.Publisher(<span class="string">&#x27;chatter&#x27;</span>, String, queue_size=<span class="number">10</span>)</span><br><span class="line">    rate = rospy.Rate(<span class="number">1</span>) <span class="comment"># 1 Hz</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> rospy.is_shutdown():</span><br><span class="line">        hello_str = <span class="string">&quot;hello world %s&quot;</span> % rospy.get_time()</span><br><span class="line">        rospy.loginfo(hello_str)</span><br><span class="line">        pub.publish(hello_str)</span><br><span class="line">        rate.sleep()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        talker()</span><br><span class="line">    <span class="keyword">except</span> rospy.ROSInterruptException:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h4 id="listener-py："><a href="#listener-py：" class="headerlink" title="listener.py："></a>listener.py：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> rospy</span><br><span class="line"><span class="keyword">from</span> std_msgs.msg <span class="keyword">import</span> String</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">callback</span>(<span class="params">data</span>):</span><br><span class="line">    rospy.loginfo(<span class="string">&quot;I heard %s&quot;</span>, data.data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">listener</span>():</span><br><span class="line">    rospy.init_node(<span class="string">&#x27;listener&#x27;</span>, anonymous=<span class="literal">True</span>)</span><br><span class="line">    rospy.Subscriber(<span class="string">&#x27;chatter&#x27;</span>, String, callback)</span><br><span class="line">    rospy.spin()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    listener()</span><br></pre></td></tr></table></figure><h3 id="步骤-4：添加依赖项到package-xml（正常应该不需要修改）"><a href="#步骤-4：添加依赖项到package-xml（正常应该不需要修改）" class="headerlink" title="步骤 4：添加依赖项到package.xml（正常应该不需要修改）"></a>步骤 4：添加依赖项到package.xml（正常应该不需要修改）</h3><p>在 <code>talker_listener_demo</code> 包的 <code>package.xml</code> 文件中添加以下内容：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">depend</span>&gt;</span>rospy<span class="tag">&lt;/<span class="name">depend</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">depend</span>&gt;</span>std_msgs<span class="tag">&lt;/<span class="name">depend</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="步骤-5：更新CMakeLists-txt"><a href="#步骤-5：更新CMakeLists-txt" class="headerlink" title="步骤 5：更新CMakeLists.txt"></a>步骤 5：更新CMakeLists.txt</h3><p>在 <code>talker_listener_demo</code> 包的 <code>CMakeLists.txt</code> 文件中确保 <code>rospy</code> 和 <code>std_msgs</code> 被正确声明为依赖项。</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(catkin REQUIRED COMPONENTS</span><br><span class="line">  rospy</span><br><span class="line">  std_msgs</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">catkin_package(</span><br><span class="line">  CATKIN_DEPENDS rospy std_msgs</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="编译和运行"><a href="#编译和运行" class="headerlink" title="编译和运行"></a>编译和运行</h3><p>在Catkin工作空间中执行以下命令来编译ROS包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/catkin_ws</span><br><span class="line">catkin_make</span><br></pre></td></tr></table></figure><p>也可以编译指定的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">catkin_make --only-pkg-with-deps talker_listener_demo</span><br></pre></td></tr></table></figure><p>然后，在两个不同的终端中分别运行发布者节点和订阅者节点：<br>执行前需要source一下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/catkin_ws/devel/setup.bash</span><br></pre></td></tr></table></figure><p>同时给python脚本添加执行权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x talker.py</span><br><span class="line"><span class="built_in">chmod</span> +x listener.py</span><br></pre></td></tr></table></figure><p>可以用下面命令查看包是否存在</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rospack list|grep talker_listener_demo</span><br></pre></td></tr></table></figure><p>有时python命令不行，需要将python命令指向python3做符号链接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">ln</span> -s /usr/bin/python3 /usr/bin/python</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先需要启动Master</span></span><br><span class="line">roscore</span><br><span class="line"></span><br><span class="line"><span class="comment"># Terminal 1: Run the talker node</span></span><br><span class="line">rosrun talker_listener_demo talker.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># Terminal 2: Run the listener node</span></span><br><span class="line">rosrun talker_listener_demo listener.py</span><br></pre></td></tr></table></figure><p>现在，你应该能够在终端中看到发布者节点发布的消息被订阅者节点成功接收并打印出来了。</p>]]></content>
      
      
      <categories>
          
          <category> ROS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ROS简单节点demo（C++）</title>
      <link href="/2024/05/17/ros1%20%E7%AE%80%E5%8D%95%E8%8A%82%E7%82%B9demo%EF%BC%88C++%EF%BC%89/"/>
      <url>/2024/05/17/ros1%20%E7%AE%80%E5%8D%95%E8%8A%82%E7%82%B9demo%EF%BC%88C++%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>下面是一个简单的 ROS 1 demo，包括创建一个 Catkin 工作空间、创建一个 ROS 节点以发布一个字符串消息到一个话题上，并创建一个订阅器来接收并打印这个消息。这个 demo 包含两个文件：<code>CMakeLists.txt</code> 和 <code>talker_listener_demo.cpp</code>。</p><p>首先，创建一个 Catkin 工作空间：</p><ol><li>打开终端。</li><li>运行以下命令，创建一个名为 <code>catkin_ws</code> 的 Catkin 工作空间： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p ~/catkin_ws/src</span><br><span class="line"><span class="built_in">cd</span> ~/catkin_ws/src</span><br><span class="line">catkin_init_workspace</span><br></pre></td></tr></table></figure></li></ol><p>接下来，创建 ROS 节点和订阅器的源文件：</p><ol><li><p>在 <code>~/catkin_ws/src</code> 目录下创建一个名为 <code>talker_listener_demo</code> 的包，并进入该目录：</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/catkin_ws/src</span><br><span class="line">catkin_create_pkg talker_listener_demo roscpp std_msgs</span><br><span class="line"><span class="built_in">cd</span> talker_listener_demo</span><br></pre></td></tr></table></figure></li><li><p>在 <code>talker_listener_demo</code> 包中创建一个名为 <code>talker_listener_demo.cpp</code> 的 C++ 源文件，并在其中添加以下代码：</p> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ros/ros.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;std_msgs/String.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 回调函数，用于处理接收到的消息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">chatterCallback</span><span class="params">(<span class="type">const</span> std_msgs::String::ConstPtr&amp; msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">ROS_INFO</span>(<span class="string">&quot;I heard: [%s]&quot;</span>, msg-&gt;data.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// 初始化 ROS 节点</span></span><br><span class="line">  ros::<span class="built_in">init</span>(argc, argv, <span class="string">&quot;talker_listener_demo&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建节点句柄</span></span><br><span class="line">  ros::NodeHandle n;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建一个发布者，用于向 &quot;chatter&quot; 话题发布字符串消息</span></span><br><span class="line">  ros::Publisher chatter_pub = n.<span class="built_in">advertise</span>&lt;std_msgs::String&gt;(<span class="string">&quot;chatter&quot;</span>, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建一个订阅器，用于订阅 &quot;chatter&quot; 话题的消息，并调用回调函数进行处理</span></span><br><span class="line">  ros::Subscriber sub = n.<span class="built_in">subscribe</span>(<span class="string">&quot;chatter&quot;</span>, <span class="number">1000</span>, chatterCallback);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义一个循环，发布消息并休眠一段时间</span></span><br><span class="line">  <span class="function">ros::Rate <span class="title">loop_rate</span><span class="params">(<span class="number">10</span>)</span></span>;</span><br><span class="line">  <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (ros::<span class="built_in">ok</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    std_msgs::String msg;</span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    ss &lt;&lt; <span class="string">&quot;hello world &quot;</span> &lt;&lt; count;</span><br><span class="line">    msg.data = ss.<span class="built_in">str</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ROS_INFO</span>(<span class="string">&quot;%s&quot;</span>, msg.data.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    chatter_pub.<span class="built_in">publish</span>(msg);</span><br><span class="line"></span><br><span class="line">    ros::<span class="built_in">spinOnce</span>();</span><br><span class="line"></span><br><span class="line">    loop_rate.<span class="built_in">sleep</span>();</span><br><span class="line">    ++count;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>确保 <code>CMakeLists.txt</code> 文件包含以下内容：</p> <figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">2.8</span>.<span class="number">3</span>)</span><br><span class="line"><span class="keyword">project</span>(talker_listener_demo)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 找到 catkin 并包含设置好的功能</span></span><br><span class="line"><span class="keyword">find_package</span>(catkin REQUIRED COMPONENTS</span><br><span class="line">  roscpp</span><br><span class="line">  std_msgs</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 包含 catkin 工程设置的头文件和库</span></span><br><span class="line">catkin_package(</span><br><span class="line">  CATKIN_DEPENDS roscpp std_msgs</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 添加包含目录</span></span><br><span class="line"><span class="keyword">include_directories</span>(</span><br><span class="line">  <span class="variable">$&#123;catkin_INCLUDE_DIRS&#125;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 添加可执行文件</span></span><br><span class="line"><span class="keyword">add_executable</span>(talker_listener_demo src/talker_listener_demo.cpp)</span><br><span class="line"><span class="comment">## 链接库</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(talker_listener_demo <span class="variable">$&#123;catkin_LIBRARIES&#125;</span>)</span><br></pre></td></tr></table></figure></li><li><p>构建 Catkin 工作空间：</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/catkin_ws</span><br><span class="line">catkin_make</span><br></pre></td></tr></table></figure></li></ol><p>现在，您已经成功创建了一个简单的 ROS 节点和订阅器的 demo。要运行它，请执行以下步骤：</p><ol><li><p>在一个终端中启动 ROS Master：</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roscore</span><br></pre></td></tr></table></figure></li><li><p>在另一个终端中运行 <code>talker_listener_demo</code>：</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/catkin_ws/devel/setup.bash</span><br><span class="line">rosrun talker_listener_demo talker_listener_demo</span><br></pre></td></tr></table></figure></li></ol><p>您将会看到一个发布者不断地发布 “hello world” 消息，并且一个订阅器接收并打印这些消息。</p>]]></content>
      
      
      <categories>
          
          <category> ROS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL日志保留策略：设置binlog日志保存天数、文件大小限制</title>
      <link href="/2024/05/16/MySQL%E6%97%A5%E5%BF%97%E4%BF%9D%E7%95%99%E7%AD%96%E7%95%A5%EF%BC%9A%E8%AE%BE%E7%BD%AEbinlog%E6%97%A5%E5%BF%97%E4%BF%9D%E5%AD%98%E5%A4%A9%E6%95%B0%E3%80%81%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F%E9%99%90%E5%88%B6/"/>
      <url>/2024/05/16/MySQL%E6%97%A5%E5%BF%97%E4%BF%9D%E7%95%99%E7%AD%96%E7%95%A5%EF%BC%9A%E8%AE%BE%E7%BD%AEbinlog%E6%97%A5%E5%BF%97%E4%BF%9D%E5%AD%98%E5%A4%A9%E6%95%B0%E3%80%81%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F%E9%99%90%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="一、设置binlog日志保存天数、文件大小限制"><a href="#一、设置binlog日志保存天数、文件大小限制" class="headerlink" title="一、设置binlog日志保存天数、文件大小限制"></a>一、设置binlog日志保存天数、文件大小限制</h1><p>在MySQL中，有三种主要类型的日志记录：二进制日志（binlog）、错误日志和查询日志。这些日志记录对于MySQL数据库的管理和维护非常重要。在本文中，我们将重点讨论如何设置binlog日志的保留策略。</p><p>默认情况下，MySQL会自动将binlog日志文件保存在主目录或指定目录下，并且不限制binlog日志文件的大小和日志保留时间。这意味着当日志文件太大或当你不再需要它们时，你需要手动删除它们。</p><p>所以，为了优化MySQL数据库的管理，我们可以通过在MySQL配置文件my.cnf中添加以下内容来设置binlog日志的保留策略：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">#设置日志保留天数</span><br><span class="line">expire_logs_days=7</span><br><span class="line">#设置日志文件最大大小</span><br><span class="line">max_binlog_size=100M</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以上配置将保留最近7天的binlog日志文件，并且每个binlog文件的最大大小为100M。当binlog日志文件的总大小超过100M时，MySQL会自动创建一个新的binlog日志文件。当超过7天后，MySQL会自动删除所有旧的binlog日志文件。</p><p>更改设置后，需要重新启动MySQL服务才能使其生效。</p><p>注意：</p><ul><li>日志文件最大值不能设置为less than 4096 bytes。</li><li>如果你使用了“log_bin_trust_function_creators&#x3D;1” ，MySQL版本将忽略“binlog_format &#x3D; STATEMENT”，即只支持ROW模式和MIXED模式。</li></ul><h1 id="二、如何手动清理binlog"><a href="#二、如何手动清理binlog" class="headerlink" title="二、如何手动清理binlog"></a>二、如何手动清理binlog</h1><h2 id="1-使用MySQL命令行"><a href="#1-使用MySQL命令行" class="headerlink" title="1.使用MySQL命令行"></a>1.使用MySQL命令行</h2><p>在MySQL命令行中，使用PURGE BINARY LOGS语句可以删除所有指定日期前创建的过期binlog日志文件。</p><p>例如，为了删除超过7天的binlog日志文件，可以运行以下命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);</span><br></pre></td></tr></table></figure><h2 id="2-按照binlog名称删除"><a href="#2-按照binlog名称删除" class="headerlink" title="2.按照binlog名称删除"></a>2.按照binlog名称删除</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## 将mysql-bin.000011之前的日志清理掉</span><br><span class="line">mysql&gt; purge binary logs to &#x27;mysql-bin.000011&#x27;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure><h2 id="3-按照时间删除"><a href="#3-按照时间删除" class="headerlink" title="3.按照时间删除"></a>3.按照时间删除</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## 删除2023-03-21 18:08:00之前的binlog日志</span><br><span class="line">mysql&gt; purge binary logs before &#x27;2023-03-21 18:08:00&#x27;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.02 sec)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用软连接的方式修改Docker数据存储目录</title>
      <link href="/2024/05/15/%E4%BD%BF%E7%94%A8%E8%BD%AF%E8%BF%9E%E6%8E%A5%E7%9A%84%E6%96%B9%E5%BC%8F%E4%BF%AE%E6%94%B9Docker%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%9B%AE%E5%BD%95/"/>
      <url>/2024/05/15/%E4%BD%BF%E7%94%A8%E8%BD%AF%E8%BF%9E%E6%8E%A5%E7%9A%84%E6%96%B9%E5%BC%8F%E4%BF%AE%E6%94%B9Docker%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%9B%AE%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Docker 安装的东西多了或者目录分配大小未提前规划好，就容易出现磁盘空间不足的问题，可以采用软链接的方式迁移数据目录空间。</p><hr><h3 id="为什么使用符号链接？"><a href="#为什么使用符号链接？" class="headerlink" title="为什么使用符号链接？"></a>为什么使用符号链接？</h3><p>创建符号链接的好处在于，你无需修改 Docker 配置文件 <code>/etc/docker/daemon.json</code>。符号链接能够将 Docker 默认查找的数据目录路径 <code>/var/lib/docker</code> 指向新的位置，从而让 Docker 无缝找到其数据目录。</p><h3 id="迁移步骤"><a href="#迁移步骤" class="headerlink" title="迁移步骤"></a>迁移步骤</h3><p>按照以下步骤操作，即可成功迁移 Docker 数据目录：</p><ol><li><p><strong>停止 Docker 服务</strong></p><p>首先，确保停止 Docker 服务，以避免在复制数据时出现文件被占用的情况。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl stop docker</span><br></pre></td></tr></table></figure></li><li><p><strong>复制 Docker 数据目录</strong></p><p>使用 <code>cp</code> 命令复制 <code>/var/lib/docker</code> 目录到新的位置 <code>/home/app</code> 下。<code>-a</code> 选项表示归档模式，会保留文件的所有属性和权限，<code>-u</code> 表示仅在目标文件不存在或源文件更新时进行复制。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -au /var/lib/docker /home/app</span><br></pre></td></tr></table></figure></li><li><p><strong>重命名原始 Docker 目录</strong></p><p>为了确保数据安全，可以将原始的 Docker 目录重命名，而不是直接删除。这是一个备份步骤，以防出现意外情况。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mv</span> /var/lib/docker /var/lib/docker.old</span><br></pre></td></tr></table></figure></li><li><p><strong>创建符号链接</strong></p><p>创建一个符号链接，将 <code>/var/lib/docker</code> 指向新的数据目录 <code>/home/app/docker</code>。这样，Docker 会继续在 <code>/var/lib/docker</code> 路径下查找数据目录，但实际上数据已经被存储在新的位置。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">ln</span> -s /home/app/docker /var/lib/docker</span><br></pre></td></tr></table></figure></li><li><p><strong>启动 Docker 服务</strong></p><p>最后，重新启动 Docker 服务，使所有更改生效。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl start docker</span><br></pre></td></tr></table></figure></li></ol><h3 id="验证迁移"><a href="#验证迁移" class="headerlink" title="验证迁移"></a>验证迁移</h3><p>迁移完成后，你可以验证 Docker 是否在新的位置正常运行。运行以下命令，查看 Docker 根目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> docker info | grep <span class="string">&quot;Docker Root Dir&quot;</span></span><br></pre></td></tr></table></figure><p>输出应显示新的 Docker 根目录 <code>/home/app/docker</code>。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过创建符号链接，你可以轻松地将 Docker 数据目录迁移到新的位置，而无需修改 Docker 的配置文件。这种方法简便且安全，确保 Docker 能够正确找到其数据目录，并且在整个迁移过程中不会丢失任何重要数据。</p><p>现在，Docker 将使用新的数据目录来存储数据。<br>请注意，在修改 Docker 数据目录时，需要确保新的数据目录已存在且有足够的磁盘空间可供使用。</p>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>编写与测试简单的Service和Client（Python）</title>
      <link href="/2024/05/14/%E7%BC%96%E5%86%99%E4%B8%8E%E6%B5%8B%E8%AF%95%E7%AE%80%E5%8D%95%E7%9A%84Service%E5%92%8CClient%EF%BC%88Python%EF%BC%89/"/>
      <url>/2024/05/14/%E7%BC%96%E5%86%99%E4%B8%8E%E6%B5%8B%E8%AF%95%E7%AE%80%E5%8D%95%E7%9A%84Service%E5%92%8CClient%EF%BC%88Python%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h1 id="01-导读"><a href="#01-导读" class="headerlink" title="01 导读"></a>01 导读</h1><p><strong>C++ 代码必须通过编译生成可执行文件；</strong></p><p><strong>python 代码是可执行文件，不需要编译；</strong></p><ul><li>开发的功能包都放在 catkin_ws 这样一个工作空间里；</li><li>新建的功能包取名为 service_example，实现两个整数求和为例，client 端节点向 server 端节点发送 a、b 的请求，server 端节点返回响应 sum&#x3D;a+b 给 client 端节点；</li></ul><p><strong>服务编程流程</strong></p><ul><li>创建服务器</li><li>创建客户端</li><li>添加编译选项</li><li>运行可执行程序</li></ul><h1 id="02-功能包的创建"><a href="#02-功能包的创建" class="headerlink" title="02 功能包的创建"></a>02 功能包的创建</h1><p>在 catkin_ws&#x2F;src&#x2F; 目录下新建功能包 service_example，并在创建时显式的指明依赖 rospy 和 std_msgs，依赖 std_msgs 将作为基本数据类型用于定义我们的服务类型。打开命令行终端，输入命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cd ~/catkin_ws/src</span><br><span class="line"></span><br><span class="line"># 创建功能包 topic_example 时，显式的指明依赖 rospy 和 std_msgs，</span><br><span class="line"># 依赖会被默认写到功能包的 CMakeLists.txt 和 package.xml 中</span><br><span class="line">$ catkin_create_pkg service_example rospy std_msgs</span><br></pre></td></tr></table></figure><h1 id="03-在功能包中创建自定义服务类型"><a href="#03-在功能包中创建自定义服务类型" class="headerlink" title="03 在功能包中创建自定义服务类型"></a>03 在功能包中创建自定义服务类型</h1><ul><li>服务(srv): 一个 srv 文件描述一项服务。它包含两个部分：请求和响应。</li></ul><p><em>服务类型的定义文件都是以</em>.srv 为扩展名，srv 文件则存放在功能包的 srv 目录下。</p><ul><li>服务通信过程中服务的数据类型需要用户自己定义，与消息不同，节点并不提供标准服务类型。</li></ul><h2 id="3-1-定义-srv-文件"><a href="#3-1-定义-srv-文件" class="headerlink" title="3.1 定义 srv 文件"></a>3.1 定义 srv 文件</h2><p>srv 文件分为请求和响应两部分，由 ‘—‘ 分隔。</p><p>在功能包 service_example 目录下新建 srv 目录，然后在 service_example&#x2F;srv&#x2F; 目录中创建 AddTwoInts.srv 文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int64 a</span><br><span class="line">int64 b</span><br><span class="line">---</span><br><span class="line">int64 sum</span><br></pre></td></tr></table></figure><p>其中<code>a</code>和<code>b</code>是请求，而<code>sum</code> 是响应。</p><h2 id="3-2-在-package-xml-中添加功能包依赖"><a href="#3-2-在-package-xml-中添加功能包依赖" class="headerlink" title="3.2 在 package.xml 中添加功能包依赖"></a>3.2 在 package.xml 中添加功能包依赖</h2><p>srv 文件被转换成为 C++，Python 和其他语言的源代码：</p><p>查看 <code>package.xml</code>, 确保它包含一下两条语句:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;build_depend&gt;message_generation&lt;/build_depend&gt;</span><br><span class="line">&lt;exec_depend&gt;message_runtime&lt;/exec_depend&gt;</span><br></pre></td></tr></table></figure><p>如果没有，添加进去。 注意，在构建的时候，我们只需要”message_generation”。然而，在运行的时候，我们只需要”message_runtime”。</p><h2 id="3-3-在-CMakeLists-txt-添加编译选项"><a href="#3-3-在-CMakeLists-txt-添加编译选项" class="headerlink" title="3.3 在 CMakeLists.txt 添加编译选项"></a>3.3 在 CMakeLists.txt 添加编译选项</h2><p><strong>第一步，增加 message_generation</strong></p><p>打开功能包中的 CMakeLists.txt 文件，利用 find_packag 函数，增加对 <code>message_generation</code> 的依赖，这样就可以生成消息了。 你可以直接在 <code>COMPONENTS</code> 的列表里增加 <code>message_generation</code>，就像这样：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">find_package(catkin REQUIRED COMPONENTS</span><br><span class="line">  roscpp</span><br><span class="line">  rospy</span><br><span class="line">  std_msgs</span><br><span class="line">  message_generation</span><br><span class="line">  )</span><br></pre></td></tr></table></figure><p>有时候你会发现，即使你没有调用 find_package, 你也可以编译通过。这是因为 catkin 把你所有的功能包都整合在一起，因此，如果其他的功能包调用了 find_package，你的功能包的依赖就会是同样的配置。但是，在你单独编译时，忘记调用 find_package 会很容易出错。</p><p><strong>第二步，删掉 <code>#</code>，去除对下边语句的注释:</strong></p><p>找到如下代码块:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># add_service_files(</span><br><span class="line">#   FILES</span><br><span class="line">#   Service1.srv</span><br><span class="line">#   Service2.srv</span><br><span class="line"># )</span><br></pre></td></tr></table></figure><p>用你自己定义的 srv 文件名（AddTwoInts.srv）替换掉那些<code>Service*.srv</code>文件，修改好后的代码如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add_service_files(</span><br><span class="line">  FILES</span><br><span class="line">  AddTwoInts.srv</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>第三步，msg 和 srv 都需要的步骤</strong></p><p>在 <code>CMakeLists.txt</code> 中找到如下部分:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># generate_messages(</span><br><span class="line">#   DEPENDENCIES</span><br><span class="line"># #  std_msgs  # Or other packages containing msgs</span><br><span class="line"># )</span><br></pre></td></tr></table></figure><p>去掉注释并附加上所有你消息文件所依赖的那些含有<code>.msg</code>文件的功能包（这个例子是依赖<code>std_msgs</code>, 不要添加 roscpp,rospy)，结果如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">generate_messages(</span><br><span class="line">  DEPENDENCIES</span><br><span class="line">  std_msgs</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>原因：generate_messages 的作用是自动创建我们自定义的消息类型 .msg 与服务类型 .srv 相对应的 .h，由于我们定义的服务类型使用了 std_msgs 中的 int64 基本类型，所以必须向 generate_messages 指明该依赖。</p><p><strong>第四步，由于增加了新的消息，所以我们需要重新编译我们的功能包：</strong></p><p>目的：查看配置是否有问题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd ~/catkin_ws</span><br><span class="line">$ catkin_make -DCATKIN_WHITELIST_PACKAGES=&quot;service_example&quot;</span><br></pre></td></tr></table></figure><p>所有在 msg 路径下的.msg 文件都将转换为 ROS 所支持语言的源代码。生成的 C++ 头文件将会放置在<code>~/catkin_ws/devel/include/service_example/</code>。 Python 脚本语言会在<code>~/catkin_ws/devel/lib/python2.7/dist-packages/service_example/msg</code> 目录下创建。</p><h1 id="04-查看自定义的服务消息"><a href="#04-查看自定义的服务消息" class="headerlink" title="04 查看自定义的服务消息"></a>04 查看自定义的服务消息</h1><p>通过 &lt;功能包名 &#x2F; 服务类型名&gt; 找到该服务，打开命令行终端，输入命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ source ~/catkin_ws/devel/setup.bash</span><br><span class="line"></span><br><span class="line">$ rossrv show service_example/AddTwoInts</span><br></pre></td></tr></table></figure><h1 id="05-功能包的源代码编写"><a href="#05-功能包的源代码编写" class="headerlink" title="05 功能包的源代码编写"></a>05 功能包的源代码编写</h1><p>功能包中需要编写两个独立可执行的节点，一个节点用来作为 client 端发起请求，另一个节点用来作为 server 端响应请求，所以需要在新建的功能包 service_example&#x2F;scripts 目录下新建两个文件 server.py 和 client.py，并将下面的代码分别填入。</p><h2 id="5-1-编写-Service-节点（server-py）"><a href="#5-1-编写-Service-节点（server-py）" class="headerlink" title="5.1 编写 Service 节点（server.py）"></a>5.1 编写 Service 节点（server.py）</h2><p>将创建一个简单的 service 节点(“server”)，该节点将接收到两个整形数字，并返回它们的和。</p><p><strong>如何实现一个服务器</strong></p><ul><li>初始化 ROS 节点；</li><li>创建 Server 实例；</li><li>循环等待服务请求，进入回调函数；</li><li>在回调函数中完成服务功能的处理，并反馈应答数据。</li></ul><p>在 service_example 包中创建 scripts &#x2F;server.py 文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> service_example.srv <span class="keyword">import</span> AddTwoInts,AddTwoIntsResponse</span><br><span class="line"><span class="keyword">import</span> rospy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_add_two_ints</span>(<span class="params">req</span>):</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&quot;Returning [%s + %s = %s]&quot;</span>%(req.a, req.b, (req.a + req.b)))</span><br><span class="line"> </span><br><span class="line"> <span class="comment">#因为我们已经将服务的类型声明为AddTwoInts，所以它会为您生成AddTwoIntsRequest对象（可以自由传递）</span></span><br><span class="line">    <span class="keyword">return</span> AddTwoIntsResponse(req.a + req.b)    <span class="comment"># AddTwoIntsResponse由服务生成的返回函数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_two_ints_server</span>():</span><br><span class="line">    rospy.init_node(<span class="string">&#x27;add_two_ints_server&#x27;</span>)  <span class="comment"># 声明节点为add_two_ints_server</span></span><br><span class="line">   </span><br><span class="line">    <span class="comment">#定义服务器节点名称，服务类型，处理函数</span></span><br><span class="line">        <span class="comment">#处理函数调用实例化的AddTwoIntsRequest接收请求和返回实例化的AddTwoIntsResponse</span></span><br><span class="line">    s = rospy.Service(<span class="string">&#x27;add_two_ints&#x27;</span>, AddTwoInts, handle_add_two_ints)</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&quot;Ready to add two ints.&quot;</span>)</span><br><span class="line">    rospy.spin()   <span class="comment"># 就像订阅者示例一样，rospy.spin()使代码不会退出，直到服务关闭；</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    add_two_ints_server()</span><br></pre></td></tr></table></figure><p>在～&#x2F;catkin_ws&#x2F;src&#x2F;service_example 下，让节点可执行:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ chmod +x scripts/server.py</span><br></pre></td></tr></table></figure><h2 id="5-2-编写-Client-节点（client-py）"><a href="#5-2-编写-Client-节点（client-py）" class="headerlink" title="5.2 编写 Client 节点（client.py）"></a>5.2 编写 Client 节点（client.py）</h2><p><strong>如何实现一个客户端</strong></p><ul><li>初始化 ROS 节点；</li><li>创建一个 Client 实例；</li><li>发布服务请求数据；</li><li>等待 Server 处理之后的应答结果。</li></ul><p>在 service_example 包中创建 scripts &#x2F;client.py 文件，并在其中粘贴以下內容：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot; </span></span><br><span class="line"><span class="string">导入sys模块，sys.argv的功能是在外部向程序的内部传递参数。sys.argv(number)，number=0的时候是脚本的名称</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> rospy</span><br><span class="line"><span class="keyword">from</span> service_example.srv <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_two_ints_client</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="comment"># 等待服务节点的接入</span></span><br><span class="line">    rospy.wait_for_service(<span class="string">&#x27;add_two_ints&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line">        <span class="comment"># 创建服务的处理句柄，可以像调用函数一样调用句柄</span></span><br><span class="line">        add_two_ints = rospy.ServiceProxy(<span class="string">&#x27;add_two_ints&#x27;</span>, AddTwoInts)</span><br><span class="line">        <span class="comment"># 创建服务请求对象</span></span><br><span class="line">        request = AddTwoIntsRequest()</span><br><span class="line">        request.a = x</span><br><span class="line">        request.b = y</span><br><span class="line">        <span class="comment"># 调用服务并获取响应</span></span><br><span class="line">        resp = add_two_ints(request)</span><br><span class="line">        <span class="comment"># 返回响应中的和</span></span><br><span class="line">        <span class="keyword">return</span> resp.<span class="built_in">sum</span> </span><br><span class="line">    <span class="keyword">except</span> rospy.ServiceException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果调用失败，可能会抛出rospy.ServiceException</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Service call failed: %s&quot;</span> % e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">usage</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;%s [x y]&quot;</span> % sys.argv[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        x = <span class="built_in">int</span>(sys.argv[<span class="number">1</span>])</span><br><span class="line">        y = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(usage())</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Requesting %s + %s&quot;</span> % (x, y))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%s + %s = %s&quot;</span> % (x, y, add_two_ints_client(x, y)))</span><br></pre></td></tr></table></figure><p>在～&#x2F;catkin_ws&#x2F;src&#x2F;service_example 节点可执行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ chmod +x scripts/client.py</span><br></pre></td></tr></table></figure><p><strong>代码解析：</strong></p><p>我们可以像普通函数一样使用这个句柄并调用它：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">resp1 = add_two_ints(x, y)</span><br><span class="line">return resp1.sum</span><br></pre></td></tr></table></figure><p>因为我们已经将服务的类型声明为 AddTwoInts，所以它会为你生成 AddTwoIntsRequest 对象(可以自由传递)。返回值是 AddTwoIntsResponse 对象。如果调用失败，可能会抛出 rospy.ServiceException，因此你应该设置适当的 try&#x2F;except 块。</p><h1 id="06-功能包的编译"><a href="#06-功能包的编译" class="headerlink" title="06 功能包的编译"></a>06 功能包的编译</h1><p>我们使用 CMake 作为构建系统，是的，即使是 Python 节点也必须使用它。这是为了确保创建消息和服务时自动生成 Python 代码。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd ~/catkin_ws</span><br><span class="line">$ catkin_make -DCATKIN_WHITELIST_PACKAGES=&quot;service_example&quot;</span><br></pre></td></tr></table></figure><h1 id="07-测试-service-和-client"><a href="#07-测试-service-和-client" class="headerlink" title="07 测试 service 和 client"></a>07 测试 service 和 client</h1><h2 id="7-1-运行-Service"><a href="#7-1-运行-Service" class="headerlink" title="7.1 运行 Service"></a>7.1 运行 Service</h2><p>第一步，打开一个命令行终端：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ roscore</span><br></pre></td></tr></table></figure><p>第二步，打开第二个命令行终端：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 用 rosrun &lt;package_name&gt; &lt;node_name&gt; 启动功能包中的发布节点。</span><br><span class="line">$ source ~/catkin_ws/devel/setup.bash    # 激活 catkin_ws 工作空间（必须有，必不可少）</span><br><span class="line">$ rosrun service_example server.py       # (python 版本)</span><br></pre></td></tr></table></figure><p>你将看到如下的输出信息:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ready to add two ints.              # Server 节点启动后的日志信息</span><br></pre></td></tr></table></figure><h2 id="7-2-运行-Client"><a href="#7-2-运行-Client" class="headerlink" title="7.2 运行 Client"></a>7.2 运行 Client</h2><p>现在，运行 Client 并附带一些参数：</p><p>打开第三个命令行客户端：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ source ~/catkin_ws/devel/setup.bash     # 激活 catkin_ws 工作空间（必须有，必不可少）</span><br><span class="line">$ rosrun service_example client.py 1 3    # (Python)</span><br></pre></td></tr></table></figure><p>你将会看到如下的输出信息:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Client 启动后发布服务请求，并成功接收到反馈结果</span><br><span class="line">Requesting 1+3</span><br><span class="line">1 + 3 = 4</span><br><span class="line"></span><br><span class="line"># Server 接收到服务调用后完成加法求解，并将结果反馈给 Client</span><br><span class="line">Returning [1 + 3 = 4]</span><br></pre></td></tr></table></figure><p>现在，你已经成功地运行了你的第一个 Service 和 Client 程序。</p>]]></content>
      
      
      <categories>
          
          <category> ROS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Python从AS号查询IP段的方法与实现</title>
      <link href="/2024/05/14/%E6%A0%B9%E6%8D%AEAS%E5%8F%B7%E6%9F%A5%E8%AF%A2IP%E6%AE%B5/"/>
      <url>/2024/05/14/%E6%A0%B9%E6%8D%AEAS%E5%8F%B7%E6%9F%A5%E8%AF%A2IP%E6%AE%B5/</url>
      
        <content type="html"><![CDATA[<p>在网络管理和安全监控中，了解特定的自治系统（AS）号与其管理的IP地址范围之间的关系是非常重要的。IP地址范围通常用于确定特定网络实体的活动范围，因此能够从给定的AS号查询相关的IP地址段是一项有用的任务。</p><p>本文将介绍如何使用Python语言从给定的AS号查询相关的IP地址段，以及实现该过程的方法。</p><h3 id="1-AS号与IP地址的关系"><a href="#1-AS号与IP地址的关系" class="headerlink" title="1. AS号与IP地址的关系"></a>1. AS号与IP地址的关系</h3><p>自治系统号（AS号）是互联网中的一个重要概念，它是分配给互联网服务提供商（ISP）或其他网络实体的唯一标识符。每个AS号都管理着一组IP地址，这些IP地址可以用于路由和网络通信。</p><h3 id="2-从AS号查询IP地址段的方法"><a href="#2-从AS号查询IP地址段的方法" class="headerlink" title="2. 从AS号查询IP地址段的方法"></a>2. 从AS号查询IP地址段的方法</h3><p>要从给定的AS号查询相关的IP地址段，可以通过访问WHOIS数据库或使用网络爬虫从特定网站上提取信息。在本文中，我们将介绍如何使用Python编程语言结合网络爬虫技术来实现这一目标。</p><h3 id="3-实现过程"><a href="#3-实现过程" class="headerlink" title="3. 实现过程"></a>3. 实现过程</h3><p>首先，我们需要选择一个提供了AS号与IP地址对应关系的网站作为数据源。例如，可以选择像bgp.he.net这样的网站，它提供了从AS号查询IP地址段的功能。</p><p>接下来，我们可以编写Python代码来实现以下步骤：</p><ul><li>使用urllib库发送HTTP请求，从选择的网站上获取包含所需信息的页面内容。</li><li>使用正则表达式或者BeautifulSoup等库从页面内容中提取出与IP地址相关的信息，例如CIDR地址段。</li><li>将提取的IP地址段存储在合适的数据结构中，例如列表或者集合。</li><li>可选：对提取的IP地址段进行排序或者其他处理，以便进一步分析或者使用。</li></ul><p>最后，我们可以将代码封装为一个可重用的函数或者类，以便在需要查询IP地址段时直接调用。</p><h3 id="4-示例代码"><a href="#4-示例代码" class="headerlink" title="4. 示例代码"></a>4. 示例代码</h3><p>以下是一个简单的示例代码，演示了如何从bgp.he.net查询指定AS号的IP地址段：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> urllib.request  <span class="comment"># urllib2在Python 3中已被替换为urllib.request</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AS_TO_ACL</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, asnum</span>):</span><br><span class="line">        <span class="variable language_">self</span>.asnum = asnum</span><br><span class="line">        <span class="variable language_">self</span>.url = <span class="string">&quot;https://bgp.he.net/AS%s#_prefixes&quot;</span> % (<span class="variable language_">self</span>.asnum)</span><br><span class="line">        <span class="variable language_">self</span>.cidr = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">http_client</span>(<span class="params">self, url</span>):</span><br><span class="line">        <span class="comment"># 修改为urllib.request.Request</span></span><br><span class="line">        request = urllib.request.Request(url, headers=&#123;<span class="string">&#x27;User-agent&#x27;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.99 Safari/537.36&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 修改为urllib.request.urlopen</span></span><br><span class="line">            response = urllib.request.urlopen(request, timeout=<span class="number">5</span>)</span><br><span class="line">            info = response.info()</span><br><span class="line">            <span class="comment"># Python 3中urlopen返回的是bytes而不是str，需要解码为str</span></span><br><span class="line">            data = response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> urllib.error.HTTPError <span class="keyword">as</span> error:  <span class="comment"># 修改为urllib.error.HTTPError</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;%s error:%s&quot;</span> % (url, error.reason))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span> urllib.error.URLError <span class="keyword">as</span> error:  <span class="comment"># 修改为urllib.error.URLError</span></span><br><span class="line">            <span class="built_in">print</span>(error.reason)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            outdata = data</span><br><span class="line">        <span class="keyword">return</span> outdata</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_acl</span>(<span class="params">self</span>):</span><br><span class="line">        htmldata = <span class="variable language_">self</span>.http_client(<span class="variable language_">self</span>.url)</span><br><span class="line">        <span class="keyword">if</span> htmldata <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        ip_reg = re.<span class="built_in">compile</span>(<span class="string">&quot;/net/(\d+\.\d+\.\d+\.\d+/\d+)&quot;</span>)</span><br><span class="line">        <span class="comment"># Python 3中split()不再接受参数，默认按空格分割</span></span><br><span class="line">        htmls = htmldata.split()</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> htmls:</span><br><span class="line">            <span class="keyword">match</span> = ip_reg.search(line)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                ips = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">                <span class="comment"># 使用strip()而不是string.strip()</span></span><br><span class="line">                <span class="variable language_">self</span>.cidr.add(ips.strip())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ip <span class="keyword">in</span> <span class="variable language_">self</span>.cidr:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;%s\n&quot;</span> % (ip), end=<span class="string">&#x27;&#x27;</span>)  <span class="comment"># Python 3中print()默认结束符为换行符</span></span><br><span class="line"></span><br><span class="line">query = AS_TO_ACL(<span class="string">&quot;45102&quot;</span>)</span><br><span class="line">query.get_acl()</span><br></pre></td></tr></table></figure><h3 id="5-结论"><a href="#5-结论" class="headerlink" title="5. 结论"></a>5. 结论</h3><p>通过本文介绍的方法，我们可以轻松地使用Python从给定的AS号查询相关的IP地址段。这为网络管理、安全监控和其他相关领域提供了一种简单而有效的方法来获取所需的网络信息。</p>]]></content>
      
      
      <categories>
          
          <category> 分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分享 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 Docker 在 PyTorch 环境中训练模型</title>
      <link href="/2024/04/29/%E4%BD%BF%E7%94%A8%20Docker%20%E5%9C%A8%20PyTorch%20%E7%8E%AF%E5%A2%83%E4%B8%AD%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B/"/>
      <url>/2024/04/29/%E4%BD%BF%E7%94%A8%20Docker%20%E5%9C%A8%20PyTorch%20%E7%8E%AF%E5%A2%83%E4%B8%AD%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B/</url>
      
        <content type="html"><![CDATA[<p>在机器学习和深度学习任务中，使用 Docker 可以方便地构建和管理环境，特别是在涉及到复杂的依赖关系和 GPU 加速的情况下。本文将介绍如何使用 Docker 构建一个 PyTorch 环境，并在其中运行训练脚本。</p><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>首先，我们需要编写一个 Dockerfile，该文件描述了我们的 Docker 镜像应该包含的内容和操作步骤。以下是一个示例 Dockerfile：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用官方 PyTorch 镜像作为基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> pytorch/pytorch:<span class="number">1.8</span>.<span class="number">0</span>-cuda11.<span class="number">1</span>-cudnn8-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制应用程序代码到镜像中</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> train.py /app/train.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装应用程序依赖</span></span><br><span class="line"><span class="comment">#RUN pip install --no-cache-dir -r requirements.txt  # 如果有额外的依赖，可以在 requirements.txt 中指定</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install -i https://pypi.tuna.tsinghua.edu.cn/simple numpy==1.20.3</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install -i https://pypi.tuna.tsinghua.edu.cn/simple torch torchvision pandas tqdm seaborn requests</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动应用程序</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;train.py&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>在这个 Dockerfile 中，我们使用了官方提供的 PyTorch 镜像作为基础镜像，然后安装了我们的应用程序所需的 Python 包，并设置了应用程序的启动命令。<br>其中，train.py是我们训练的Python脚本，也放在同一目录。</p><h2 id="构建-Docker-镜像"><a href="#构建-Docker-镜像" class="headerlink" title="构建 Docker 镜像"></a>构建 Docker 镜像</h2><p>在 Dockerfile 所在目录下，打开终端并运行以下命令来构建 Docker 镜像：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t test_train .</span><br></pre></td></tr></table></figure><p>test_train是生成Docker镜像的名称。</p><h2 id="运行-Docker-容器"><a href="#运行-Docker-容器" class="headerlink" title="运行 Docker 容器"></a>运行 Docker 容器</h2><p>构建完成后，我们可以使用以下命令来运行 Docker 容器，并在其中执行训练脚本：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --gpus all -it --rm --shm-size=4g test_train</span><br></pre></td></tr></table></figure><p>在这个命令中，<code>--gpus all</code> 用于启用 GPU 支持，<code>-it</code> 表示以交互模式运行容器，<code>--rm</code> 表示容器停止后立即删除，<code>--shm-size</code> 表示设置共享内存大小。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过使用 Docker，我们可以轻松地构建和管理 PyTorch 环境，并在其中运行训练任务。这种方法可以帮助我们避免了环境配置的烦恼，提高了工作效率，同时也使得我们的代码更具可移植性和可重复性。</p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用PyTorch进行植物叶片分类：从数据准备到模型训练</title>
      <link href="/2024/04/28/%E4%BD%BF%E7%94%A8PyTorch%E8%BF%9B%E8%A1%8C%E6%A4%8D%E7%89%A9%E5%8F%B6%E7%89%87%E5%88%86%E7%B1%BB%EF%BC%9A%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87%E5%88%B0%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83/"/>
      <url>/2024/04/28/%E4%BD%BF%E7%94%A8PyTorch%E8%BF%9B%E8%A1%8C%E6%A4%8D%E7%89%A9%E5%8F%B6%E7%89%87%E5%88%86%E7%B1%BB%EF%BC%9A%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87%E5%88%B0%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83/</url>
      
        <content type="html"><![CDATA[<p>植物叶片分类是一个常见的计算机视觉任务，可以通过深度学习技术来解决。在这篇博客中，我们将使用PyTorch来实现一个植物叶片分类器。我们将从数据准备开始，一直到模型训练和评估。</p><h3 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h3><p>首先，我们需要获取数据集。我们从指定的URL下载了一个zip文件，其中包含了训练和测试图像数据以及相应的标签文件。我们使用Python的requests和zipfile库来下载和解压缩这个文件。</p><p>然后，我们加载了CSV格式的标签文件，并对标签进行了排序。这些标签将用于将植物叶片类别转换为数字标签，以便于模型训练。</p><p>接下来，我们定义了一个自定义的PyTorch数据集类，用于加载图像数据并进行预处理。我们使用PIL库加载图像，并根据需要对图像进行大小调整和数据增强。</p><h3 id="模型准备"><a href="#模型准备" class="headerlink" title="模型准备"></a>模型准备</h3><p>我们选择了预训练的ResNeXt-50模型作为我们的基础模型，并在其基础上进行微调。我们使用了PyTorch提供的预训练模型，并根据需要修改了最后一层全连接层的输出大小，以适应我们数据集的类别数量。</p><h3 id="模型训练"><a href="#模型训练" class="headerlink" title="模型训练"></a>模型训练</h3><p>在模型训练之前，我们首先对模型的参数进行了设置。我们选择了Adam优化器，并定义了学习率和权重衰减等超参数。我们还使用了余弦退火学习率调度器，以动态调整学习率。</p><p>然后，我们遍历了训练集的多个epoch，每个epoch中进行了训练和验证。在训练过程中，我们使用交叉熵损失函数来计算损失，并通过反向传播和优化器来更新模型参数。在验证过程中，我们评估了模型在验证集上的性能，并根据最佳性能保存了模型参数。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在这篇博客中，我们介绍了使用PyTorch进行植物叶片分类的全过程。我们从数据准备开始，加载和预处理了图像数据，并定义了自定义的数据集类。然后，我们选择了预训练的ResNeXt-50模型作为基础模型，并根据需要微调了模型。最后，我们通过训练和验证过程来训练模型，并保存了性能最佳的模型参数。</p><p>通过这篇博客，读者可以了解到如何使用PyTorch实现一个完整的图像分类任务，并可以根据需要进行修改和扩展，以解决其他类似的计算机视觉问题。<br>以下是整个训练代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset, DataLoader</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> torchvision.models <span class="keyword">as</span> models</span><br><span class="line"><span class="comment"># 用于显示进度条</span></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义URL和文件名（下面的地址改为实际训练数据的地址）</span></span><br><span class="line">url = <span class="string">&quot;http://xxx/classify-leaves.zip&quot;</span></span><br><span class="line">filename = <span class="string">&quot;classify-leaves.zip&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载文件</span></span><br><span class="line">response = requests.get(url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将下载的内容保存到文件中</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(response.content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压缩文件内容</span></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(filename, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> zip_ref:</span><br><span class="line">    zip_ref.extractall()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移除已下载的zip文件</span></span><br><span class="line">os.remove(filename)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 看看label文件长啥样</span></span><br><span class="line">labels_dataframe = pd.read_csv(<span class="string">&#x27;./train.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把label文件排个序</span></span><br><span class="line">leaves_labels = <span class="built_in">sorted</span>(<span class="built_in">list</span>(<span class="built_in">set</span>(labels_dataframe[<span class="string">&#x27;label&#x27;</span>])))</span><br><span class="line">n_classes = <span class="built_in">len</span>(leaves_labels)</span><br><span class="line"><span class="built_in">print</span>(n_classes)</span><br><span class="line"><span class="built_in">print</span>(leaves_labels[:<span class="number">10</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把label转成对应的数字</span></span><br><span class="line">class_to_num = <span class="built_in">dict</span>(<span class="built_in">zip</span>(leaves_labels, <span class="built_in">range</span>(n_classes)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再转换回来，方便最后预测的时候使用</span></span><br><span class="line">num_to_class = &#123;v : k <span class="keyword">for</span> k, v <span class="keyword">in</span> class_to_num.items()&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 继承pytorch的dataset，创建自己的</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LeavesData</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, csv_path, file_path, mode=<span class="string">&#x27;train&#x27;</span>, valid_ratio=<span class="number">0.2</span>, resize_height=<span class="number">256</span>, resize_width=<span class="number">256</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            csv_path (string): csv 文件路径</span></span><br><span class="line"><span class="string">            img_path (string): 图像文件所在路径</span></span><br><span class="line"><span class="string">            mode (string): 训练模式还是测试模式</span></span><br><span class="line"><span class="string">            valid_ratio (float): 验证集比例</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 需要调整后的照片尺寸，我这里每张图片的大小尺寸不一致</span></span><br><span class="line">        <span class="variable language_">self</span>.resize_height = resize_height</span><br><span class="line">        <span class="variable language_">self</span>.resize_width = resize_width</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.file_path = file_path</span><br><span class="line">        <span class="variable language_">self</span>.mode = mode</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 读取 csv 文件</span></span><br><span class="line">        <span class="variable language_">self</span>.data_info = pd.read_csv(csv_path, header=<span class="literal">None</span>)</span><br><span class="line">        <span class="comment"># 计算 length</span></span><br><span class="line">        <span class="variable language_">self</span>.data_len = <span class="built_in">len</span>(<span class="variable language_">self</span>.data_info.index) - <span class="number">1</span></span><br><span class="line">        <span class="variable language_">self</span>.train_len = <span class="built_in">int</span>(<span class="variable language_">self</span>.data_len * (<span class="number">1</span> - valid_ratio))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mode == <span class="string">&#x27;train&#x27;</span>:</span><br><span class="line">            <span class="variable language_">self</span>.train_image = np.asarray(<span class="variable language_">self</span>.data_info.iloc[<span class="number">1</span>:<span class="variable language_">self</span>.train_len, <span class="number">0</span>])</span><br><span class="line">            <span class="variable language_">self</span>.train_label = np.asarray(<span class="variable language_">self</span>.data_info.iloc[<span class="number">1</span>:<span class="variable language_">self</span>.train_len, <span class="number">1</span>])</span><br><span class="line">            <span class="variable language_">self</span>.image_arr = <span class="variable language_">self</span>.train_image</span><br><span class="line">            <span class="variable language_">self</span>.label_arr = <span class="variable language_">self</span>.train_label</span><br><span class="line">        <span class="keyword">elif</span> mode == <span class="string">&#x27;valid&#x27;</span>:</span><br><span class="line">            <span class="variable language_">self</span>.valid_image = np.asarray(<span class="variable language_">self</span>.data_info.iloc[<span class="variable language_">self</span>.train_len:, <span class="number">0</span>])</span><br><span class="line">            <span class="variable language_">self</span>.valid_label = np.asarray(<span class="variable language_">self</span>.data_info.iloc[<span class="variable language_">self</span>.train_len:, <span class="number">1</span>])</span><br><span class="line">            <span class="variable language_">self</span>.image_arr = <span class="variable language_">self</span>.valid_image</span><br><span class="line">            <span class="variable language_">self</span>.label_arr = <span class="variable language_">self</span>.valid_label</span><br><span class="line">        <span class="keyword">elif</span> mode == <span class="string">&#x27;test&#x27;</span>:</span><br><span class="line">            <span class="variable language_">self</span>.test_image = np.asarray(<span class="variable language_">self</span>.data_info.iloc[<span class="number">1</span>:, <span class="number">0</span>])</span><br><span class="line">            <span class="variable language_">self</span>.image_arr = <span class="variable language_">self</span>.test_image</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.real_len = <span class="built_in">len</span>(<span class="variable language_">self</span>.image_arr)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Finished reading the &#123;&#125; set of Leaves Dataset (&#123;&#125; samples found)&#x27;</span></span><br><span class="line">              .<span class="built_in">format</span>(mode, <span class="variable language_">self</span>.real_len))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        single_image_name = <span class="variable language_">self</span>.image_arr[index]</span><br><span class="line"></span><br><span class="line">        img_as_img = Image.<span class="built_in">open</span>(<span class="variable language_">self</span>.file_path + single_image_name)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.mode == <span class="string">&#x27;train&#x27;</span>:</span><br><span class="line">            transform = transforms.Compose([</span><br><span class="line">                transforms.RandomHorizontalFlip(p=<span class="number">0.5</span>),</span><br><span class="line">                transforms.RandomVerticalFlip(p=<span class="number">0.5</span>),</span><br><span class="line">                transforms.ToTensor()</span><br><span class="line">            ])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            transform = transforms.Compose([</span><br><span class="line">                transforms.Resize((<span class="number">224</span>, <span class="number">224</span>)),</span><br><span class="line">                transforms.ToTensor()</span><br><span class="line">            ])</span><br><span class="line"></span><br><span class="line">        img_as_img = transform(img_as_img)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.mode == <span class="string">&#x27;test&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> img_as_img</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            label = <span class="variable language_">self</span>.label_arr[index]</span><br><span class="line">            number_label = class_to_num[label]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> img_as_img, number_label</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.real_len</span><br><span class="line"></span><br><span class="line">train_path = <span class="string">&#x27;./train.csv&#x27;</span></span><br><span class="line">test_path = <span class="string">&#x27;./test.csv&#x27;</span></span><br><span class="line">img_path = <span class="string">&#x27;./&#x27;</span></span><br><span class="line"></span><br><span class="line">train_dataset = LeavesData(train_path, img_path, mode=<span class="string">&#x27;train&#x27;</span>)</span><br><span class="line">val_dataset = LeavesData(train_path, img_path, mode=<span class="string">&#x27;valid&#x27;</span>)</span><br><span class="line">test_dataset = LeavesData(test_path, img_path, mode=<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义data loader</span></span><br><span class="line">train_loader = torch.utils.data.DataLoader(</span><br><span class="line">        dataset=train_dataset,</span><br><span class="line">        batch_size=<span class="number">16</span>,</span><br><span class="line">        shuffle=<span class="literal">False</span>,</span><br><span class="line">        num_workers=<span class="number">5</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">val_loader = torch.utils.data.DataLoader(</span><br><span class="line">        dataset=val_dataset,</span><br><span class="line">        batch_size=<span class="number">16</span>,</span><br><span class="line">        shuffle=<span class="literal">False</span>,</span><br><span class="line">        num_workers=<span class="number">5</span></span><br><span class="line">    )</span><br><span class="line">test_loader = torch.utils.data.DataLoader(</span><br><span class="line">        dataset=test_dataset,</span><br><span class="line">        batch_size=<span class="number">16</span>,</span><br><span class="line">        shuffle=<span class="literal">False</span>,</span><br><span class="line">        num_workers=<span class="number">5</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确定是在CPU还是GPU上</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_device</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;cuda&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span></span><br><span class="line"></span><br><span class="line">device = get_device()</span><br><span class="line"><span class="built_in">print</span>(device)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否要冻住模型的前面一些层</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_parameter_requires_grad</span>(<span class="params">model, feature_extracting</span>):</span><br><span class="line">    <span class="keyword">if</span> feature_extracting:</span><br><span class="line">        model = model</span><br><span class="line">        <span class="keyword">for</span> param <span class="keyword">in</span> model.parameters():</span><br><span class="line">            param.requires_grad = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># resnet34模型</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">res_model</span>(<span class="params">num_classes, feature_extract = <span class="literal">False</span>, use_pretrained=<span class="literal">True</span></span>):</span><br><span class="line"></span><br><span class="line">    model_ft = models.resnet34(pretrained=use_pretrained)</span><br><span class="line">    set_parameter_requires_grad(model_ft, feature_extract)</span><br><span class="line">    num_ftrs = model_ft.fc.in_features</span><br><span class="line">    model_ft.fc = nn.Sequential(</span><br><span class="line">        nn.Linear(num_ftrs, num_classes)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> model_ft</span><br><span class="line"></span><br><span class="line"><span class="comment"># resnext50模型</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resnext_model</span>(<span class="params">num_classes, feature_extract = <span class="literal">False</span>, use_pretrained=<span class="literal">True</span></span>):</span><br><span class="line"></span><br><span class="line">    model_ft = models.resnext50_32x4d(pretrained=use_pretrained)</span><br><span class="line">    set_parameter_requires_grad(model_ft, feature_extract)</span><br><span class="line">    num_ftrs = model_ft.fc.in_features</span><br><span class="line">    model_ft.fc = nn.Sequential(nn.Linear(num_ftrs, num_classes))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> model_ft</span><br><span class="line"></span><br><span class="line"><span class="comment"># 超参数</span></span><br><span class="line">learning_rate = <span class="number">3e-4</span></span><br><span class="line">weight_decay = <span class="number">1e-3</span></span><br><span class="line">num_epoch = <span class="number">50</span></span><br><span class="line">model_path = <span class="string">&#x27;./pre_resnext_model.ckpt&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化模型并将其放在指定的设备上</span></span><br><span class="line">model = resnext_model(<span class="number">176</span>)</span><br><span class="line">model = model.to(device)</span><br><span class="line">model.device = device</span><br><span class="line"><span class="comment"># 对于分类任务，我们使用交叉熵作为性能度量</span></span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化优化器，您可以调整一些超参数，如学习率</span></span><br><span class="line">optimizer = torch.optim.Adam(model.parameters(), lr = learning_rate, weight_decay=weight_decay)</span><br><span class="line">scheduler = torch.optim.lr_scheduler.CosineAnnealingLR(optimizer, T_max=<span class="number">10</span>, eta_min=<span class="number">0</span>, last_epoch=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练轮数</span></span><br><span class="line">n_epochs = num_epoch</span><br><span class="line"></span><br><span class="line">best_acc = <span class="number">0.0</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(n_epochs):</span><br><span class="line">    <span class="comment"># ---------- 训练 ----------</span></span><br><span class="line">    <span class="comment"># 确保模型在训练之前处于训练模式</span></span><br><span class="line">    model.train()</span><br><span class="line">    <span class="comment"># 记录训练过程中的信息</span></span><br><span class="line">    train_loss = []</span><br><span class="line">    train_accs = []</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 遍历训练集的批次</span></span><br><span class="line">    <span class="keyword">for</span> batch <span class="keyword">in</span> tqdm(train_loader):</span><br><span class="line">        imgs, labels = batch</span><br><span class="line">        imgs = imgs.to(device)</span><br><span class="line">        labels = labels.to(device)</span><br><span class="line">        <span class="comment"># 前向传播数据</span></span><br><span class="line">        logits = model(imgs)</span><br><span class="line">        <span class="comment"># 计算交叉熵损失</span></span><br><span class="line">        loss = criterion(logits, labels)</span><br><span class="line"></span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        <span class="comment"># 计算参数的梯度</span></span><br><span class="line">        loss.backward()</span><br><span class="line">        <span class="comment"># 使用计算出的梯度来更新参数</span></span><br><span class="line">        optimizer.step()</span><br><span class="line">        <span class="comment"># 更新学习率</span></span><br><span class="line">        scheduler.step()</span><br><span class="line">        <span class="keyword">if</span>(i % <span class="number">500</span> == <span class="number">0</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;learning_rate:&quot;</span>, scheduler.get_last_lr()[<span class="number">0</span>])</span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算当前批次的准确率</span></span><br><span class="line">        acc = (logits.argmax(dim=-<span class="number">1</span>) == labels).<span class="built_in">float</span>().mean()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 记录损失和准确率</span></span><br><span class="line">        train_loss.append(loss.item())</span><br><span class="line">        train_accs.append(acc)</span><br><span class="line"></span><br><span class="line">    train_loss = <span class="built_in">sum</span>(train_loss) / <span class="built_in">len</span>(train_loss)</span><br><span class="line">    train_acc = <span class="built_in">sum</span>(train_accs) / <span class="built_in">len</span>(train_accs)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 打印信息</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[ Train | <span class="subst">&#123;epoch + <span class="number">1</span>:03d&#125;</span>/<span class="subst">&#123;n_epochs:03d&#125;</span> ] loss = <span class="subst">&#123;train_loss:<span class="number">.5</span>f&#125;</span>, acc = <span class="subst">&#123;train_acc:<span class="number">.5</span>f&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ---------- 验证 ----------</span></span><br><span class="line">    <span class="comment"># 确保模型在评估模式下，这样一些模块如dropout就会被禁用并正常工作</span></span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    <span class="comment"># 记录验证过程中的信息</span></span><br><span class="line">    valid_loss = []</span><br><span class="line">    valid_accs = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 遍历验证集的批次</span></span><br><span class="line">    <span class="keyword">for</span> batch <span class="keyword">in</span> tqdm(val_loader):</span><br><span class="line">        imgs, labels = batch</span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            logits = model(imgs.to(device))</span><br><span class="line"></span><br><span class="line">        loss = criterion(logits, labels.to(device))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算当前批次的准确率</span></span><br><span class="line">        acc = (logits.argmax(dim=-<span class="number">1</span>) == labels.to(device)).<span class="built_in">float</span>().mean()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 记录损失和准确率</span></span><br><span class="line">        valid_loss.append(loss.item())</span><br><span class="line">        valid_accs.append(acc)</span><br><span class="line"></span><br><span class="line">    valid_loss = <span class="built_in">sum</span>(valid_loss) / <span class="built_in">len</span>(valid_loss)</span><br><span class="line">    valid_acc = <span class="built_in">sum</span>(valid_accs) / <span class="built_in">len</span>(valid_accs)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 打印信息</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[ Valid | <span class="subst">&#123;epoch + <span class="number">1</span>:03d&#125;</span>/<span class="subst">&#123;n_epochs:03d&#125;</span> ] loss = <span class="subst">&#123;valid_loss:<span class="number">.5</span>f&#125;</span>, acc = <span class="subst">&#123;valid_acc:<span class="number">.5</span>f&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果模型性能提高，保存此时的模型</span></span><br><span class="line">    <span class="keyword">if</span> valid_acc &gt; best_acc:</span><br><span class="line">        best_acc = valid_acc</span><br><span class="line">        torch.save(model.state_dict(), model_path)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;saving model with acc &#123;:.3f&#125;&#x27;</span>.<span class="built_in">format</span>(best_acc))</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ROS自定义Msg消息</title>
      <link href="/2024/04/23/ROS%E8%87%AA%E5%AE%9A%E4%B9%89Msg%E6%B6%88%E6%81%AF/"/>
      <url>/2024/04/23/ROS%E8%87%AA%E5%AE%9A%E4%B9%89Msg%E6%B6%88%E6%81%AF/</url>
      
        <content type="html"><![CDATA[<h1 id="自定义消息流程"><a href="#自定义消息流程" class="headerlink" title="自定义消息流程"></a>自定义消息流程</h1><p>在Ros中，如果没有现成的消息类型来描述要去传递的消息时，我们会自定义消息。</p><p>通常我们会新建一个Package来去自定义消息，这个Package一般不去写任何的业务逻辑，只是用来声明自定义的消息类型，可以只定义一种消息类型，也可以定义多种消息类型，根据业务需求来定。</p><p>所以，首先我们单独的创建一个package，我们取名为demo_msgs，一定要要添加roscpp，rospy，rosmsg的依赖。</p><h2 id="1-创建msg目录"><a href="#1-创建msg目录" class="headerlink" title="1 . 创建msg目录"></a>1 . 创建msg目录</h2><p>在pakage目录下新建msg目录</p><h2 id="2-新建msg文件"><a href="#2-新建msg文件" class="headerlink" title="2. 新建msg文件"></a>2. 新建msg文件</h2><p>创建的这个Student.msg文件就是自定义消息文件，需要去描述消息的格式。</p><p>我们可以编辑代码如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">string name</span><br><span class="line">int64 age</span><br></pre></td></tr></table></figure><p>这个自定义的消息包含两个数据形式，name和age，name的类型 是string，age的类型是int64。</p><p>这个msg文件其实遵循一定规范的，每一行表示一种数据。前面是类型，后面是名称。</p><p>ros不只是提供了int64和string两种基本类型供我们描述，其实还有很多，具体可以自行搜索</p><h2 id="3-配置package-xml文件"><a href="#3-配置package-xml文件" class="headerlink" title="3. 配置package.xml文件"></a>3. 配置package.xml文件</h2><p>在package.xml种添加如下配置:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;build_depend&gt;message_generation&lt;/build_depend&gt;</span><br><span class="line">&lt;exec_depend&gt;message_runtime&lt;/exec_depend&gt;</span><br></pre></td></tr></table></figure><h2 id="4-配置CMakeLists-txt"><a href="#4-配置CMakeLists-txt" class="headerlink" title="4. 配置CMakeLists.txt"></a>4. 配置CMakeLists.txt</h2><p>find_package配置</p><p>在find_package添加message_generation，结果如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">find_package(catkin REQUIRED COMPONENTS</span><br><span class="line">  roscpp</span><br><span class="line">  rosmsg</span><br><span class="line">  rospy</span><br><span class="line">  message_generation</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>add_message_file配置</p><p>添加add_message_file，结果如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add_message_files(</span><br><span class="line">        FILES</span><br><span class="line">        Student.msg</span><br><span class="line">)</span><br></pre></td></tr></table></figure><blockquote><p>这里的Student.msg要和你创建的msg文件名称一致，且必须时在msg目录下，否则编译会出现问题  </p></blockquote><p>generation_msg配置<br>添加generation_msg，结果如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">generate_messages(</span><br><span class="line">        DEPENDENCIES</span><br><span class="line">        std_msgs</span><br><span class="line">)</span><br></pre></td></tr></table></figure><blockquote><p>这个配置的作用是添加生成消息的依赖，默认的时候要添加std_msgs  </p></blockquote><p>catkin_package配置<br>修改catkin_package，结果如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">catkin_package(</span><br><span class="line">#  INCLUDE_DIRS include</span><br><span class="line">#  LIBRARIES demo_msg</span><br><span class="line">   CATKIN_DEPENDS roscpp rosmsg rospy message_runtime</span><br><span class="line">#  DEPENDS system_lib</span><br><span class="line">)</span><br></pre></td></tr></table></figure><blockquote><p>为catkin编译提供了依赖message_runtime</p></blockquote><h1 id="检验自定义消息"><a href="#检验自定义消息" class="headerlink" title="检验自定义消息"></a>检验自定义消息</h1><h2 id="1-编译项目"><a href="#1-编译项目" class="headerlink" title="1. 编译项目"></a>1. 编译项目</h2><p>来到工作空间目录下，运行编译</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">catkin_make</span><br></pre></td></tr></table></figure><h2 id="2-查看生成的消息文件"><a href="#2-查看生成的消息文件" class="headerlink" title="2. 查看生成的消息文件"></a>2. 查看生成的消息文件</h2><p>c++的头文件<br>来到devel的include目录下，如果生成了头文件说明，自定义消息创建成功。</p><p>python的py文件<br>来到devel的lib&#x2F;python2.7&#x2F;dist-package目录下，查看是否生成和package名称相同的目录，以及目录内是否生成对应的py文件。</p><h2 id="3-通过rosmsg工具校验"><a href="#3-通过rosmsg工具校验" class="headerlink" title="3. 通过rosmsg工具校验"></a>3. 通过rosmsg工具校验</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rosmsg show demo_msgs/Student</span><br></pre></td></tr></table></figure><h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><h2 id="1-如果出现msg找不到的情况"><a href="#1-如果出现msg找不到的情况" class="headerlink" title="1. 如果出现msg找不到的情况"></a>1. 如果出现msg找不到的情况</h2><p>清除编译信息并重新编译，</p><h2 id="2-python导入方式"><a href="#2-python导入方式" class="headerlink" title="2. python导入方式"></a>2. python导入方式</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import rospy</span><br><span class="line">from demo_msgs.msg import Student</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ROS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>理解和构建用于MNIST分类的卷积神经网络</title>
      <link href="/2024/04/23/%E7%90%86%E8%A7%A3%E5%92%8C%E6%9E%84%E5%BB%BA%E7%94%A8%E4%BA%8EMNIST%E5%88%86%E7%B1%BB%E7%9A%84%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/"/>
      <url>/2024/04/23/%E7%90%86%E8%A7%A3%E5%92%8C%E6%9E%84%E5%BB%BA%E7%94%A8%E4%BA%8EMNIST%E5%88%86%E7%B1%BB%E7%9A%84%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/</url>
      
        <content type="html"><![CDATA[<p>在深度学习领域，构建神经网络来解决各种任务是一项令人兴奋的工作。在本文中，我们将深入探讨使用PyTorch构建卷积神经网络（CNN）对来自流行的MNIST数据集的手写数字进行分类。</p><h2 id="1、导入库和加载数据"><a href="#1、导入库和加载数据" class="headerlink" title="1、导入库和加载数据"></a>1、导入库和加载数据</h2><p>首先，让我们通过导入必要的库和加载MNIST数据集来设置我们的环境。PyTorch和torchvision对于处理数据和创建神经网络至关重要，而matplotlib则有助于可视化图像。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> datasets, transforms</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br></pre></td></tr></table></figure><p>现在，让我们加载数据集。我们将对数据进行归一化处理，以使其均值为零，方差为1，以确保训练稳定性。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">train_loader = torch.utils.data.DataLoader(</span><br><span class="line">    datasets.MNIST(root=<span class="string">&#x27;./data&#x27;</span>,</span><br><span class="line">                   train=<span class="literal">True</span>,</span><br><span class="line">                   download=<span class="literal">True</span>,</span><br><span class="line">                   transform=transforms.Compose([</span><br><span class="line">                       transforms.ToTensor(),</span><br><span class="line">                       transforms.Normalize((<span class="number">0.1307</span>,), (<span class="number">0.3081</span>,))</span><br><span class="line">                   ])),</span><br><span class="line">    batch_size=<span class="number">64</span>, shuffle=<span class="literal">True</span>)</span><br><span class="line">test_loader = torch.utils.data.DataLoader(</span><br><span class="line">    datasets.MNIST(<span class="string">&#x27;./data&#x27;</span>, train=<span class="literal">False</span>, transform=transforms.Compose([</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        transforms.Normalize((<span class="number">0.1307</span>,), (<span class="number">0.3081</span>,))</span><br><span class="line">    ])),</span><br><span class="line">    batch_size=<span class="number">64</span>, shuffle=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h2 id="2、数据可视化"><a href="#2、数据可视化" class="headerlink" title="2、数据可视化"></a>2、数据可视化</h2><p>在深入网络架构之前，让我们先偷偷看一下我们的数据。可视化一些样本图像可以帮助我们了解数据集的特征。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">imshow</span>(<span class="params">img</span>):</span><br><span class="line">    img = img / <span class="number">2</span> + <span class="number">0.5</span>  <span class="comment"># 反归一化</span></span><br><span class="line">    npimg = img.numpy()</span><br><span class="line">    plt.imshow(np.transpose(npimg, (<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>)))</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">dataiter = <span class="built_in">iter</span>(train_loader)</span><br><span class="line">images, labels = dataiter.<span class="built_in">next</span>()</span><br><span class="line">imshow(torchvision.utils.make_grid(images))</span><br></pre></td></tr></table></figure><h2 id="3、定义神经网络架构"><a href="#3、定义神经网络架构" class="headerlink" title="3、定义神经网络架构"></a>3、定义神经网络架构</h2><p>现在是核心部分 - 定义我们的CNN架构。我们将为数字分类创建一个简单而有效的网络。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Net</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(Net, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.conv1 = nn.Conv2d(<span class="number">1</span>, <span class="number">6</span>, <span class="number">5</span>)</span><br><span class="line">        <span class="variable language_">self</span>.conv2 = nn.Conv2d(<span class="number">6</span>, <span class="number">16</span>, <span class="number">5</span>)</span><br><span class="line">        <span class="variable language_">self</span>.fc1 = nn.Linear(<span class="number">16</span> * <span class="number">4</span> * <span class="number">4</span>, <span class="number">120</span>)</span><br><span class="line">        <span class="variable language_">self</span>.fc2 = nn.Linear(<span class="number">120</span>, <span class="number">84</span>)</span><br><span class="line">        <span class="variable language_">self</span>.fc3 = nn.Linear(<span class="number">84</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = F.max_pool2d(F.relu(<span class="variable language_">self</span>.conv1(x)), (<span class="number">2</span>, <span class="number">2</span>))</span><br><span class="line">        x = F.max_pool2d(F.relu(<span class="variable language_">self</span>.conv2(x)), <span class="number">2</span>)</span><br><span class="line">        x = x.view(-<span class="number">1</span>, <span class="variable language_">self</span>.num_flat_features(x))</span><br><span class="line">        x = F.relu(<span class="variable language_">self</span>.fc1(x))</span><br><span class="line">        x = F.relu(<span class="variable language_">self</span>.fc2(x))</span><br><span class="line">        x = <span class="variable language_">self</span>.fc3(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">num_flat_features</span>(<span class="params">self, x</span>):</span><br><span class="line">        size = x.size()[<span class="number">1</span>:]</span><br><span class="line">        num_features = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> size:</span><br><span class="line">            num_features *= s</span><br><span class="line">        <span class="keyword">return</span> num_features</span><br><span class="line"></span><br><span class="line">net = Net()</span><br><span class="line"><span class="built_in">print</span>(net)</span><br></pre></td></tr></table></figure><h2 id="4、前向传播和损失计算"><a href="#4、前向传播和损失计算" class="headerlink" title="4、前向传播和损失计算"></a>4、前向传播和损失计算</h2><p>在定义网络后，让我们看看它如何处理一批输入图像并计算损失。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">image = images[:<span class="number">2</span>]</span><br><span class="line">label = labels[:<span class="number">2</span>]</span><br><span class="line">out = net(image)</span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line">loss = criterion(out, label)</span><br><span class="line"><span class="built_in">print</span>(loss)</span><br></pre></td></tr></table></figure><h2 id="5、训练模型"><a href="#5、训练模型" class="headerlink" title="5、训练模型"></a>5、训练模型</h2><p>现在是训练时间！我们将遍历数据集多个周期，更新模型参数以最小化损失。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">optimizer = optim.SGD(net.parameters(), lr=<span class="number">0.01</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">epoch</span>):</span><br><span class="line">    net.train()</span><br><span class="line">    running_loss = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(train_loader):</span><br><span class="line">        inputs, labels = data</span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        outputs = net(inputs)</span><br><span class="line">        loss = criterion(outputs, labels)</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line">        running_loss += loss.item()</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[%d, %5d] loss: %.3f&#x27;</span> %</span><br><span class="line">                  (epoch + <span class="number">1</span>, i + <span class="number">1</span>, running_loss / <span class="number">100</span>))</span><br><span class="line">            running_loss = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">train(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h2 id="6、评估模型性能"><a href="#6、评估模型性能" class="headerlink" title="6、评估模型性能"></a>6、评估模型性能</h2><p>最后，让我们评估我们训练好的模型在测试集上的表现如何。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">correct = <span class="number">0</span></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> test_loader:</span><br><span class="line">        images, labels = data</span><br><span class="line">        outputs = net(images)</span><br><span class="line">        _, predicted = torch.<span class="built_in">max</span>(outputs.data, <span class="number">1</span>)</span><br><span class="line">        total += labels.size(<span class="number">0</span>)</span><br><span class="line">        correct += (predicted == labels).<span class="built_in">sum</span>().item()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;网络在10000个测试图像上的准确率为：%d %%&#x27;</span> % (<span class="number">100</span> * correct / total))</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/direct/ed9e97a5617d4acb881ea30a43c35337.png" alt="在这里插入图片描述"></p><p>通过跟随这些步骤，我们成功地构建并训练了一个用于MNIST数字分类的CNN，在未见过的数据上取得了不错的准确率。这为更高级的深度学习工作奠定了基础。祝编码愉快！ 🚀</p><p>以下是完整的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> datasets, transforms</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入数据集</span></span><br><span class="line">train_loader = torch.utils.data.DataLoader(</span><br><span class="line">    datasets.MNIST(root=<span class="string">&#x27;./data&#x27;</span>,</span><br><span class="line">                   train=<span class="literal">True</span>,</span><br><span class="line">                   download=<span class="literal">True</span>,</span><br><span class="line">                   transform=transforms.Compose([</span><br><span class="line">                       transforms.ToTensor(),</span><br><span class="line">                       transforms.Normalize((<span class="number">0.1307</span>,), (<span class="number">0.3081</span>,))</span><br><span class="line">                   ])),</span><br><span class="line">    batch_size=<span class="number">64</span>, shuffle=<span class="literal">True</span>)</span><br><span class="line">test_loader = torch.utils.data.DataLoader(</span><br><span class="line">    datasets.MNIST(<span class="string">&#x27;./data&#x27;</span>, train=<span class="literal">False</span>, transform=transforms.Compose([</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        transforms.Normalize((<span class="number">0.1307</span>,), (<span class="number">0.3081</span>,))</span><br><span class="line">    ])),</span><br><span class="line">    batch_size=<span class="number">64</span>, shuffle=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">imshow</span>(<span class="params">img</span>):</span><br><span class="line">    img = img / <span class="number">2</span> + <span class="number">0.5</span>  <span class="comment"># 反归一化</span></span><br><span class="line">    npimg = img.numpy()</span><br><span class="line">    plt.imshow(np.transpose(npimg, (<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>)))</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dataiter = <span class="built_in">iter</span>(train_loader)</span><br><span class="line">images, labels = dataiter.<span class="built_in">next</span>()</span><br><span class="line">imshow(torchvision.utils.make_grid(images))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义神经网络</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Net</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(Net, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.conv1 = nn.Conv2d(<span class="number">1</span>, <span class="number">6</span>, <span class="number">5</span>)</span><br><span class="line">        <span class="variable language_">self</span>.conv2 = nn.Conv2d(<span class="number">6</span>, <span class="number">16</span>, <span class="number">5</span>)</span><br><span class="line">        <span class="variable language_">self</span>.fc1 = nn.Linear(<span class="number">16</span> * <span class="number">4</span> * <span class="number">4</span>, <span class="number">120</span>)</span><br><span class="line">        <span class="variable language_">self</span>.fc2 = nn.Linear(<span class="number">120</span>, <span class="number">84</span>)</span><br><span class="line">        <span class="variable language_">self</span>.fc3 = nn.Linear(<span class="number">84</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = F.max_pool2d(F.relu(<span class="variable language_">self</span>.conv1(x)), (<span class="number">2</span>, <span class="number">2</span>))</span><br><span class="line">        x = F.max_pool2d(F.relu(<span class="variable language_">self</span>.conv2(x)), <span class="number">2</span>)</span><br><span class="line">        x = x.view(-<span class="number">1</span>, <span class="variable language_">self</span>.num_flat_features(x))</span><br><span class="line">        x = F.relu(<span class="variable language_">self</span>.fc1(x))</span><br><span class="line">        x = F.relu(<span class="variable language_">self</span>.fc2(x))</span><br><span class="line">        x = <span class="variable language_">self</span>.fc3(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">num_flat_features</span>(<span class="params">self, x</span>):</span><br><span class="line">        size = x.size()[<span class="number">1</span>:]</span><br><span class="line">        num_features = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> size:</span><br><span class="line">            num_features *= s</span><br><span class="line">        <span class="keyword">return</span> num_features</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">net = Net()</span><br><span class="line"><span class="built_in">print</span>(net)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 前向传播</span></span><br><span class="line">image = images[:<span class="number">2</span>]</span><br><span class="line">label = labels[:<span class="number">2</span>]</span><br><span class="line">out = net(image)</span><br><span class="line"><span class="built_in">print</span>(out)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算损失</span></span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line">loss = criterion(out, label)</span><br><span class="line"><span class="built_in">print</span>(loss)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 反向传播与更新参数</span></span><br><span class="line">optimizer = optim.SGD(net.parameters(), lr=<span class="number">0.01</span>)</span><br><span class="line">image = images[:<span class="number">2</span>]</span><br><span class="line">label = labels[:<span class="number">2</span>]</span><br><span class="line">optimizer.zero_grad()</span><br><span class="line">out = net(image)</span><br><span class="line">loss = criterion(out, label)</span><br><span class="line">loss.backward()</span><br><span class="line">optimizer.step()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始训练</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">epoch</span>):</span><br><span class="line">    net.train()</span><br><span class="line">    running_loss = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(train_loader):</span><br><span class="line">        inputs, labels = data</span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        outputs = net(inputs)</span><br><span class="line">        loss = criterion(outputs, labels)</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line">        running_loss += loss.item()</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[%d, %5d] loss: %.3f&#x27;</span> %</span><br><span class="line">                  (epoch + <span class="number">1</span>, i + <span class="number">1</span>, running_loss / <span class="number">100</span>))</span><br><span class="line">            running_loss = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">train(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 观察模型预测效果</span></span><br><span class="line">correct = <span class="number">0</span></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> test_loader:</span><br><span class="line">        images, labels = data</span><br><span class="line">        outputs = net(images)</span><br><span class="line">        _, predicted = torch.<span class="built_in">max</span>(outputs.data, <span class="number">1</span>)</span><br><span class="line">        total += labels.size(<span class="number">0</span>)</span><br><span class="line">        correct += (predicted == labels).<span class="built_in">sum</span>().item()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;网络在10000个测试图像上的准确率为：%d %%&#x27;</span> % (<span class="number">100</span> * correct / total))</span><br></pre></td></tr></table></figure><p>这段代码涵盖了从数据加载、构建模型、训练到评估的完整流程，使用了PyTorch库进行实现。</p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo博客SEO搜索引擎优化技巧</title>
      <link href="/2023/04/04/Hexo%E5%8D%9A%E5%AE%A2SEO%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7/"/>
      <url>/2023/04/04/Hexo%E5%8D%9A%E5%AE%A2SEO%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7/</url>
      
        <content type="html"><![CDATA[<p>Hexo 是一个非常受欢迎的静态网站生成器，可以将 Markdown 文件转换为 HTML 静态网页。如果您想要优化 Hexo 网站的 SEO，可以考虑以下几点：</p><h2 id="1、关键词优化"><a href="#1、关键词优化" class="headerlink" title="1、关键词优化"></a>1、关键词优化</h2><p>在您的文章中使用关键词是提高搜索引擎排名的一个重要因素。但是要注意不要滥用关键词，否则可能会被搜索引擎视为垃圾内容而降低排名。</p><p>在 Hexo 中，您可以使用插件比如 hexo-generator-seo 来优化您的关键词。这个插件可以自动生成网页的 meta description 和 meta keywords，还可以自定义每个页面的标题和描述。您可以在页面的 front-matter 中设置这些选项，比如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">title: &quot;我的博客文章&quot;</span><br><span class="line">date: 2023-04-04 10:00:00</span><br><span class="line">tags: [&quot;Hexo&quot;, &quot;SEO&quot;]</span><br><span class="line">description: &quot;这篇文章将会介绍如何优化 Hexo 网站的 SEO&quot;</span><br><span class="line">keywords: &quot;Hexo, SEO, 关键词&quot;</span><br></pre></td></tr></table></figure><h2 id="2、Sitemap"><a href="#2、Sitemap" class="headerlink" title="2、Sitemap"></a>2、Sitemap</h2><p>Sitemap 是一个 XML 文件，其中包含您网站的所有页面的链接。它帮助搜索引擎了解您的网站的结构，从而更好地抓取和索引您的网页。</p><p>在 Hexo 中，您可以使用插件 hexo-generator-sitemap 来生成 Sitemap。安装完这个插件后，在您的 Hexo 站点的根目录下，会自动生成一个 sitemap.xml 文件，其中包含您网站的所有页面的链接。</p><h2 id="3、Robots-txt"><a href="#3、Robots-txt" class="headerlink" title="3、Robots.txt"></a>3、Robots.txt</h2><p>Robots.txt 是一个文件，用于告诉搜索引擎哪些页面可以被抓取和索引，哪些页面应该被忽略。通过使用 Robots.txt，您可以控制搜索引擎爬取您的网站的范围和深度，从而优化您的网站的 SEO。</p><p>在 Hexo 中，您可以使用插件 hexo-generator-robots 来生成 Robots.txt。安装完这个插件后，在您的 Hexo 站点的根目录下，会自动生成一个 robots.txt 文件，其中包含您想要告诉搜索引擎的信息。</p><h2 id="4、Canonical-标签"><a href="#4、Canonical-标签" class="headerlink" title="4、Canonical 标签"></a>4、Canonical 标签</h2><p>如果您的网站有重复内容或多个网址指向同一页面，那么搜索引擎可能会降低您的排名。在这种情况下，您可以使用 Canonical 标签来告诉搜索引擎哪个页面是“原始”页面，应该被索引和排名。</p><p>在 Hexo 中，您可以使用插件 hexo-abbrlink 来自动生成短链接，并将其添加到您的文章中。然后，在您的页面中添加 Canonical 标签，指向原始页面的 URL。比如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=&quot;canonical&quot; href=&quot;&#123;&#123; site.url &#125;&#125;&#123;&#123; page.path &#125;&#125;&quot; /&gt;</span><br></pre></td></tr></table></figure><p>这将告诉搜索引擎，该页面的原始链接是 。</p><h2 id="5、Open-Graph-和-Twitter-Cards"><a href="#5、Open-Graph-和-Twitter-Cards" class="headerlink" title="5、Open Graph 和 Twitter Cards"></a>5、Open Graph 和 Twitter Cards</h2><p>Open Graph 和 Twitter Cards 是两个元标记，可以提高您网站在社交媒体上的分享效果。这些元标记可以帮助您控制您网站的分享标题、描述、图片等信息，从而增加您网站的曝光率和点击率。</p><p>在 Hexo 中，您可以使用插件 hexo-helper-seo 来生成 Open Graph 和 Twitter Cards。该插件可以自动生成这些元标记，您只需要在页面的 front-matter 中设置对应的选项，比如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">title: &quot;我的博客文章&quot;</span><br><span class="line">date: 2023-04-04 10:00:00</span><br><span class="line">tags: [&quot;Hexo&quot;, &quot;SEO&quot;]</span><br><span class="line">description: &quot;这篇文章将会介绍如何优化 Hexo 网站的 SEO&quot;</span><br><span class="line">og_image: &quot;/images/seo.jpg&quot;</span><br><span class="line">twitter_card: &quot;summary_large_image&quot;</span><br></pre></td></tr></table></figure><p>这将会生成一个包含上述信息的 meta 标签，用于在社交媒体上分享您的文章。</p><p>总之，以上这些方法可以帮助您优化 Hexo 网站的 SEO。除此之外，还有一些其他的方法可以提高您网站的搜索引擎排名，比如写高质量的内容、建立良好的外部链接等等。希望这些提示对您有所帮助！</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
            <tag> Hexo </tag>
            
            <tag> SEO </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>《解读基金-我的投资观与实践》阅读笔记</title>
      <link href="/2023/04/04/%E3%80%8A%E8%A7%A3%E8%AF%BB%E5%9F%BA%E9%87%91-%E6%88%91%E7%9A%84%E6%8A%95%E8%B5%84%E8%A7%82%E4%B8%8E%E5%AE%9E%E8%B7%B5%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/"/>
      <url>/2023/04/04/%E3%80%8A%E8%A7%A3%E8%AF%BB%E5%9F%BA%E9%87%91-%E6%88%91%E7%9A%84%E6%8A%95%E8%B5%84%E8%A7%82%E4%B8%8E%E5%AE%9E%E8%B7%B5%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>基金投资是目前比较受欢迎的一种投资方式，相比于股票投资和房地产投资，基金投资的风险相对较小，但收益也比较可观。在进行基金投资之前，我们需要了解一些基本概念和投资要点。</p><h2 id="基金的基本概念"><a href="#基金的基本概念" class="headerlink" title="基金的基本概念"></a>基金的基本概念</h2><p>基金是指投资者集资，由专业的基金管理人根据一定的投资目标和原则，通过买卖证券、金融衍生品等方式进行资产配置的一种集合性投资方式。基金的种类包括股票型基金、债券型基金、混合型基金、货币型基金等。投资者可以根据自己的风险偏好和投资目标来选择合适的基金种类进行投资。</p><h2 id="如何选择基金"><a href="#如何选择基金" class="headerlink" title="如何选择基金"></a>如何选择基金</h2><p>在选择基金时，需要考虑基金公司、基金经理和基金业绩等因素。</p><ul><li><p>基金公司：选择大型、知名的基金公司更为稳妥，因为这些公司在基金管理、运作等方面具有更为丰富的经验和资源。</p></li><li><p>基金经理：基金经理是基金投资的核心，投资者需要关注基金经理的经验、业绩和风格等因素，选择具有较高水平的基金经理进行投资。</p></li><li><p>基金业绩：基金业绩是选择基金的重要参考因素，投资者需要仔细分析基金的历史业绩和长期表现，以及基金的风险收益比等因素。</p></li></ul><h2 id="基金定投的优势"><a href="#基金定投的优势" class="headerlink" title="基金定投的优势"></a>基金定投的优势</h2><p>基金定投是指定期定额地购买基金，这种投资方式可以帮助投资者在长期持有中降低风险，平稳地实现资产增值。基金定投的优势包括：</p><ul><li><p>降低投资风险：基金定投可以避免投资者在市场波动时采取错误的操作，降低投资风险。</p></li><li><p>累积投资收益：基金定投可以实现资产的长期增值，让投资者从中受益。</p></li><li><p>分散投资风险：基金定投可以帮助投资者分散投资风险，避免单只基金出现亏损影响整个资产组合。</p></li></ul><h2 id="投资策略与实践"><a href="#投资策略与实践" class="headerlink" title="投资策略与实践"></a>投资策略与实践</h2><p>基金投资需要根据自己的风险偏好和投资目标选择适合自己的投资策略。投资者应该注意不要盲目跟风，需要在分析市场情况和基金经理的决策，进行投资决策。同时，基金投资需要有长期的投资视角，不能盲目追求短期收益，需要持续跟踪基金的表现和市场动态，及时调整投资策略。</p><h2 id="注意基金投资的风险"><a href="#注意基金投资的风险" class="headerlink" title="注意基金投资的风险"></a>注意基金投资的风险</h2><p>基金投资虽然相对较为稳妥，但仍然存在一定的风险。投资者需要注意以下几点：</p><ul><li><p>了解基金的风险水平：不同类型的基金风险水平不同，投资者需要在选择基金时了解基金的风险水平，并根据自己的风险偏好进行选择。</p></li><li><p>分散投资：投资者需要注意分散投资，不要将全部资产投入一只基金中，以避免单只基金出现亏损影响整个资产组合。</p></li><li><p>市场风险：基金投资同样受到市场波动的影响，投资者需要注意市场的变化，及时调整投资策略。</p></li></ul><p>总之，基金投资是一种相对稳健的投资方式，但也需要投资者在选择基金、制定投资策略和注意风险方面做好充分准备。投资者应该根据自己的风险偏好和投资目标选择合适的基金种类和投资策略，同时注意基金的历史业绩、基金经理的经验和风格、基金的风险收益比等因素，实现长期稳定的资产增值。</p>]]></content>
      
      
      <categories>
          
          <category> 投资 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 基金 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于令牌桶算法的Java限流实现</title>
      <link href="/2023/01/28/%E5%9F%BA%E4%BA%8E%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95%E7%9A%84Java%E9%99%90%E6%B5%81%E5%AE%9E%E7%8E%B0/"/>
      <url>/2023/01/28/%E5%9F%BA%E4%BA%8E%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95%E7%9A%84Java%E9%99%90%E6%B5%81%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>令牌桶算法是一种流量限制算法，通常用于限制对服务的请求速率。它通过维护一个桶来存储令牌来实现限流。每当有请求需要被处理时，都需要先从桶中获取一个令牌。如果桶中有可用令牌，请求就会被处理，并且令牌会被从桶中移除。如果桶中没有可用令牌，请求就会被拒绝或等待。</p><p>桶中的令牌是按固定的速率进行填充的，这个速率就是限流的速率。这种算法的优点是它可以平滑地处理请求，可以避免突发请求造成的服务崩溃。</p><p>令牌桶算法在多种场景下都有应用，如在网络流量控制、服务限流、网络防火墙等场景都可以应用这种算法。</p><p>首先，需要创建一个桶来存储令牌，这里可以使用 Java 的 Semaphore 类来实现。Semaphore 类是一个信号量类，可以用来控制线程的并发访问。</p><p>接下来，需要启动一个线程来不断地向桶中填充令牌。这里可以使用 Java 的 ScheduledExecutorService 来实现。ScheduledExecutorService 可以让你在给定的延迟之后或者在给定的间隔之后执行任务。</p><p>当请求需要被处理时，程序会从桶中尝试获取一个令牌。如果桶中有可用令牌，请求就会被处理，并且令牌会被从桶中移除。如果桶中没有可用令牌，请求就会被拒绝或等待。</p><p>在这个过程中，Semaphore 类的 acquire() 方法和 release() 方法用来获取和释放令牌， ScheduledExecutorService 的 scheduleAtFixedRate() 方法用来在固定的时间间隔内执行任务。</p><p>这个算法的优点是它可以平滑地处理请求，可以避免突发请求造成的服务崩溃。</p><p>以下是一个基于令牌桶算法的 Java 限流代码示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimiter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Semaphore semaphore;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> maxPermits;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> period;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TimeUnit timeUnit;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RateLimiter</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>, <span class="type">long</span> period, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.semaphore = <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="keyword">permits</span>);</span><br><span class="line">        <span class="built_in">this</span>.maxPermits = <span class="keyword">permits</span>;</span><br><span class="line">        <span class="built_in">this</span>.period = period;</span><br><span class="line">        <span class="built_in">this</span>.timeUnit = timeUnit;</span><br><span class="line">        <span class="built_in">this</span>.scheduler = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">        scheduler.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Replenisher</span>(), period, period, timeUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">acquire</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> semaphore.tryAcquire();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span> &#123;</span><br><span class="line">        semaphore.release();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Replenisher</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            semaphore.release(maxPermits - semaphore.availablePermits());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个类实现了一个令牌桶限流器，可以通过调用 acquire() 方法来获取一个令牌，如果桶中没有可用的令牌，则 acquire() 方法会返回 false。 每次调用 release() 方法都会增加一个令牌。</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 算法 </tag>
            
            <tag> 秒杀 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】15-项目与坑</title>
      <link href="/2022/07/02/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9115%E9%A1%B9%E7%9B%AE%E4%B8%8E%E5%9D%91/"/>
      <url>/2022/07/02/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9115%E9%A1%B9%E7%9B%AE%E4%B8%8E%E5%9D%91/</url>
      
        <content type="html"><![CDATA[<h1 id="slice-与-append-的坑"><a href="#slice-与-append-的坑" class="headerlink" title="slice 与 append 的坑"></a>slice 与 append 的坑</h1><p>初始容量被超过了，它会新建一个slice，然后把旧的内容拷贝过去，然后append数据，这就会导致底层数组改变了，期望的结果可能就不是预期的了</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Pingpong</span><span class="params">(s []<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">s = <span class="built_in">append</span>(s, <span class="number">3</span>) <span class="comment">// 原来的容量为0，append之后，重新分配了内存地址，s跟原来的slice s已经不是同一个了</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>) <span class="comment">// 初始化slice s，初始容量为0，长度为0</span></span><br><span class="line">fmt.Println(s)</span><br><span class="line">Pingpong(s)</span><br><span class="line">fmt.Println(s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出（两次打印的slice结果都是空）：</span><br><span class="line">[]</span><br><span class="line">[]</span><br></pre></td></tr></table></figure><p>怎么解决这个问题？答案是增加返回值</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Pingpong</span><span class="params">(s []<span class="type">int</span>)</span></span> []<span class="type">int</span> &#123; <span class="comment">// 希望修改slice的，设置返回值，通过返回值去返回数据</span></span><br><span class="line">s = <span class="built_in">append</span>(s, <span class="number">4</span>) <span class="comment">// 原来的容量为0，append之后，重新分配了内存地址，s跟原来的slice s已经不是同一个了</span></span><br><span class="line"><span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>) <span class="comment">// 初始化slice s，初始容量为0，长度为0</span></span><br><span class="line">fmt.Println(s)</span><br><span class="line">s = Pingpong(s) <span class="comment">// 这里取出返回值</span></span><br><span class="line">fmt.Println(s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[]</span><br><span class="line">[<span class="number">4</span>]</span><br></pre></td></tr></table></figure><h1 id="time-Format-的坑"><a href="#time-Format-的坑" class="headerlink" title="time.Format 的坑"></a>time.Format 的坑</h1><p>用t.Format(time.ANSIC或者t.Format(“Mon Jan _2 15:04:05 2006”这里不能调整，否则时间差异极大</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">t := time.Now()</span><br><span class="line">fmt.Println(t)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-02</span> <span class="number">18</span>:<span class="number">28</span>:<span class="number">18.1427377</span> +<span class="number">0800</span> CST m=+<span class="number">0.003047101</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果不想要时区等信息，用format</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">t := time.Now()</span><br><span class="line">fmt.Println(t.Format(time.ANSIC))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Sat Jul  <span class="number">2</span> <span class="number">18</span>:<span class="number">29</span>:<span class="number">34</span> <span class="number">2022</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">t := time.Now()</span><br><span class="line">fmt.Println(t.Format(<span class="string">&quot;Mon Jan _2 15:04:05 2006&quot;</span>)) <span class="comment">// 这里是标准的对比时间，不能改变吗，否则差异很大</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Sat Jul  <span class="number">2</span> <span class="number">18</span>:<span class="number">31</span>:<span class="number">59</span> <span class="number">2022</span></span><br></pre></td></tr></table></figure><h1 id="range-与闭包的坑"><a href="#range-与闭包的坑" class="headerlink" title="range 与闭包的坑"></a>range 与闭包的坑</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := []<span class="type">string</span>&#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> s &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">// 通过for range启动goroutine，不用参数传进去的值都是引用闭包的思想</span></span><br><span class="line">fmt.Println(v) <span class="comment">// 这里都是引用了v的地址，v全等于c</span></span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(<span class="number">3</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">c</span><br><span class="line">c</span><br><span class="line">c</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := []<span class="type">string</span>&#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> s &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(v <span class="type">string</span>)</span></span> &#123; <span class="comment">// 通过for range启动goroutine，通过传参的方式进行传值</span></span><br><span class="line">fmt.Println(v)</span><br><span class="line">&#125;(v)</span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(<span class="number">3</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">c</span><br><span class="line">b</span><br><span class="line">a</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】14-并发concurrency</title>
      <link href="/2022/07/02/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9114%E5%B9%B6%E5%8F%91concurrency/"/>
      <url>/2022/07/02/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9114%E5%B9%B6%E5%8F%91concurrency/</url>
      
        <content type="html"><![CDATA[<h1 id="并发concurrency"><a href="#并发concurrency" class="headerlink" title="并发concurrency"></a>并发concurrency</h1><ul><li>很多人都是冲着 Go 大肆宣扬的高并发而忍不住跃跃欲试，但其实从<br>源码的解析来看，goroutine 只是由官方实现的超级“线程池”而已。<br>不过话说回来，每个实例 4-5KB 的栈内存占用和由于实现机制而大幅<br>减少的创建和销毁开销，是制造 Go 号称的高并发的根本原因。另外，<br>goroutine 的简单易用，也在语言层面上给予了开发者巨大的便利。</li><li>并发不是并行：Concurrency Is Not Parallelism，并发主要由切换时间片来实现“同时”运行，在并行则是直接利用<br>多核实现多线程的运行，但 Go 可以设置使用核数，以发挥多核计算机<br>的能力。</li><li>Goroutine 奉行通过通信来共享内存，而不是共享内存来通信。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> Go()</span><br><span class="line"><span class="comment">// time.Sleep(2 * time.Second)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Go</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Go Go Go!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">没有输出，因为主线程已经退出了</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> Go()</span><br><span class="line"><span class="comment">// 利用延迟等待线程打印输出</span></span><br><span class="line">time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Go</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Go Go Go!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Go Go Go!</span><br></pre></td></tr></table></figure><h1 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h1><ul><li>Channel 是 goroutine 沟通的桥梁，大都是阻塞同步的</li><li>通过 make 创建，close 关闭</li><li>Channel 是引用类型</li><li>可以使用 for range 来迭代不断操作 channel</li><li>可以设置单向或双向通道</li><li>可以设置缓存大小，在未被填满前不会发生阻塞</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 是go一种特殊的数据类型，有点像Linux系统中的管道/消息队列</span></span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Go Go Go!&quot;</span>)</span><br><span class="line">c &lt;- <span class="literal">true</span></span><br><span class="line">&#125;()</span><br><span class="line"><span class="comment">// 等待从通道里读取值</span></span><br><span class="line">&lt;-c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Go Go Go!&quot;</span>)</span><br><span class="line">c &lt;- <span class="literal">true</span></span><br><span class="line"><span class="built_in">close</span>(c)</span><br><span class="line">&#125;()</span><br><span class="line"><span class="comment">// 可以使用for range来迭代不断操作channel，直到关闭channel</span></span><br><span class="line"><span class="keyword">for</span> v := <span class="keyword">range</span> c &#123;</span><br><span class="line">fmt.Println(v)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 有缓存的channel，非阻塞的，不会输出</span></span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Go Go Go!&quot;</span>)</span><br><span class="line">&lt;-c</span><br><span class="line">&#125;()</span><br><span class="line">c &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 无缓存的channel是阻塞的，输出：Go Go Go!</span></span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Go Go Go!&quot;</span>)</span><br><span class="line">&lt;-c</span><br><span class="line">&#125;()</span><br><span class="line">c &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在多线程情况下，程序不是顺序执行，index=9的执行完不代表所有都执行问</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">runtime.GOMAXPROCS(runtime.NumCPU())</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> Go(c, i)</span><br><span class="line">&#125;</span><br><span class="line">&lt;-c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Go</span><span class="params">(c <span class="keyword">chan</span> <span class="type">bool</span>, index <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">a := <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100000000</span>; i++ &#123;</span><br><span class="line">a += i</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(index, a)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> index == <span class="number">9</span> &#123;</span><br><span class="line">c &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出（每次都会不同）：</span><br><span class="line"><span class="number">0</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">3</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">1</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">2</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">6</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">7</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">9</span> <span class="number">4999999950000001</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解决上面多线程不能判断都执行完，通过创建带缓存区的channel来解决</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">runtime.GOMAXPROCS(runtime.NumCPU())</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> Go(c, i)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">&lt;-c</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Go</span><span class="params">(c <span class="keyword">chan</span> <span class="type">bool</span>, index <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">a := <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100000000</span>; i++ &#123;</span><br><span class="line">a += i</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(index, a)</span><br><span class="line"></span><br><span class="line">c &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出（每次都能输出<span class="number">10</span>个）：</span><br><span class="line"><span class="number">4</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">0</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">6</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">9</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">1</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">7</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">8</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">5</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">2</span> <span class="number">4999999950000001</span></span><br><span class="line"><span class="number">3</span> <span class="number">4999999950000001</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// 多线程协作通过同步包来实现</span><br><span class="line">func main() &#123;</span><br><span class="line">runtime.GOMAXPROCS(runtime.NumCPU())</span><br><span class="line">wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">wg.Add(10)</span><br><span class="line">for i := 0; i &lt; 10; i++ &#123;</span><br><span class="line">go Go(&amp;wg, i)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func Go(wg *sync.WaitGroup, index int) &#123;</span><br><span class="line">a := 1</span><br><span class="line">for i := 0; i &lt; 100000000; i++ &#123;</span><br><span class="line">a += i</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(index, a)</span><br><span class="line"></span><br><span class="line">wg.Done()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Select"><a href="#Select" class="headerlink" title="Select"></a>Select</h1><ul><li>可处理一个或多个 channel 的发送与接收</li><li>同时有多个可用的 channel时按随机顺序处理</li><li>可用空的 select 来阻塞 main 函数</li><li>可设置超时</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">c1, c2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>), <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> v, ok := &lt;-c1:</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;c1&quot;</span>, v)</span><br><span class="line"><span class="keyword">case</span> v, ok := &lt;-c2:</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;c2&quot;</span>, v)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">c1 &lt;- <span class="number">1</span></span><br><span class="line">c2 &lt;- <span class="string">&quot;hi&quot;</span></span><br><span class="line">c1 &lt;- <span class="number">3</span></span><br><span class="line">c2 &lt;- <span class="string">&quot;hello&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">close</span>(c1)</span><br><span class="line"><span class="built_in">close</span>(c2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">c1 <span class="number">1</span></span><br><span class="line">c2 hi</span><br><span class="line">c1 <span class="number">3</span></span><br><span class="line">c2 hello</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// c1、c2有一个关闭程序就会退出</span></span><br><span class="line"><span class="comment">// 两个都关闭才退出是不可行的，我们只有对其中一个进行判断</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">c1, c2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>), <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">o := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> v, ok := &lt;-c1:</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">o &lt;- <span class="literal">true</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;c1&quot;</span>, v)</span><br><span class="line"><span class="keyword">case</span> v, ok := &lt;-c2:</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">o &lt;- <span class="literal">true</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;c2&quot;</span>, v)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">c1 &lt;- <span class="number">1</span></span><br><span class="line">c2 &lt;- <span class="string">&quot;hi&quot;</span></span><br><span class="line">c1 &lt;- <span class="number">3</span></span><br><span class="line">c2 &lt;- <span class="string">&quot;hello&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">close</span>(c1)</span><br><span class="line"><span class="built_in">close</span>(c2)</span><br><span class="line"></span><br><span class="line">&lt;-o</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">c1 <span class="number">1</span></span><br><span class="line">c2 hi</span><br><span class="line">c1 <span class="number">3</span></span><br><span class="line">c2 hello</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过select来作为一个发送者的应用</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> v := <span class="keyword">range</span> c &#123;</span><br><span class="line">fmt.Println(v)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> c &lt;- <span class="number">0</span>:</span><br><span class="line"><span class="keyword">case</span> c &lt;- <span class="number">1</span>:</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可设置Select超时</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> v := &lt;-c:</span><br><span class="line">fmt.Println(v)</span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(<span class="number">3</span> * time.Second):</span><br><span class="line">fmt.Println(<span class="string">&quot;Timeout&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Timeout</span><br></pre></td></tr></table></figure><h1 id="思考问题"><a href="#思考问题" class="headerlink" title="思考问题"></a>思考问题</h1><ul><li>创建一个 goroutine，与主线程按顺序相互发送信息若干次并打印</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">var c chan string</span><br><span class="line"></span><br><span class="line">func Pingpong() &#123;</span><br><span class="line">i := 0</span><br><span class="line">for &#123;</span><br><span class="line">fmt.Println(&lt;-c)</span><br><span class="line">c &lt;- fmt.Sprintf(&quot;From Pingpong: Hi, #%d&quot;, i)</span><br><span class="line">i++</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">c = make(chan string)</span><br><span class="line">go Pingpong()</span><br><span class="line">for i := 0; i &lt; 10; i++ &#123;</span><br><span class="line">c &lt;- fmt.Sprintf(&quot;From main: Hello, #%d&quot;, i)</span><br><span class="line">fmt.Println(&lt;-c)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">From main: Hello, #0</span><br><span class="line">From Pingpong: Hi, #0</span><br><span class="line">From main: Hello, #1</span><br><span class="line">From Pingpong: Hi, #1</span><br><span class="line">From main: Hello, #2</span><br><span class="line">From Pingpong: Hi, #2</span><br><span class="line">From main: Hello, #3</span><br><span class="line">From Pingpong: Hi, #3</span><br><span class="line">From main: Hello, #4</span><br><span class="line">From Pingpong: Hi, #4</span><br><span class="line">From main: Hello, #5</span><br><span class="line">From Pingpong: Hi, #5</span><br><span class="line">From main: Hello, #6</span><br><span class="line">From Pingpong: Hi, #6</span><br><span class="line">From main: Hello, #7</span><br><span class="line">From Pingpong: Hi, #7</span><br><span class="line">From main: Hello, #8</span><br><span class="line">From Pingpong: Hi, #8</span><br><span class="line">From main: Hello, #9</span><br><span class="line">From Pingpong: Hi, #9</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】13-反射reflection</title>
      <link href="/2022/06/27/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9113%E5%8F%8D%E5%B0%84reflection/"/>
      <url>/2022/06/27/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9113%E5%8F%8D%E5%B0%84reflection/</url>
      
        <content type="html"><![CDATA[<h1 id="反射reflection"><a href="#反射reflection" class="headerlink" title="反射reflection"></a>反射reflection</h1><ul><li>反射可大大提高程序的灵活性，使得 interface{} 有更大的发挥余地</li><li>反射使用 TypeOf 和 ValueOf 函数从接口中获取目标对象信息</li><li>反射会将匿名字段作为独立字段（匿名字段本质）</li><li>想要利用反射修改对象状态，前提是 interface.data 是 settable，<br>即 pointer-interface</li><li>通过反射可以“动态”调用方法</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">Id <span class="type">int</span></span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u User)</span></span> Hello() &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Hello world.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">u := User&#123;<span class="number">1</span>, <span class="string">&quot;OK&quot;</span>, <span class="number">18</span>&#125;</span><br><span class="line">Info(u)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Info</span><span class="params">(o <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">t := reflect.TypeOf(o)</span><br><span class="line">fmt.Println(<span class="string">&quot;Type:&quot;</span>, t.Name())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反射结构的判断</span></span><br><span class="line"><span class="keyword">if</span> k := t.Kind(); k != reflect.Struct &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;XX&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">v := reflect.ValueOf(o)</span><br><span class="line">fmt.Println(<span class="string">&quot;Fields&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; t.NumField(); i++ &#123;</span><br><span class="line">f := t.Field(i)</span><br><span class="line">val := v.Field(i).Interface()</span><br><span class="line">fmt.Printf(<span class="string">&quot;%6s: %v = %v\n&quot;</span>, f.Name, f.Type, val)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; t.NumMethod(); i++ &#123;</span><br><span class="line">m := t.Method(i)</span><br><span class="line">fmt.Printf(<span class="string">&quot;%6s: %v\n&quot;</span>, m.Name, m.Type)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Type: User</span><br><span class="line">Fields</span><br><span class="line">    Id: <span class="type">int</span> = <span class="number">1</span></span><br><span class="line">  Name: <span class="type">string</span> = OK</span><br><span class="line">   Age: <span class="type">int</span> = <span class="number">18</span></span><br><span class="line"> Hello: <span class="function"><span class="keyword">func</span><span class="params">(main.User)</span></span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">Id   <span class="type">int</span></span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Manager <span class="keyword">struct</span> &#123;</span><br><span class="line">User</span><br><span class="line">title <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 嵌入结构的反射</span></span><br><span class="line">m := Manager&#123;User: User&#123;Id: <span class="number">1</span>, Name: <span class="string">&quot;tom&quot;</span>, Age: <span class="number">18</span>&#125;, title: <span class="string">&quot;developer&quot;</span>&#125;</span><br><span class="line">t := reflect.TypeOf(m)</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;%#v\n&quot;</span>, t.FieldByIndex([]<span class="type">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>&#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">reflect.StructField&#123;Name:<span class="string">&quot;Name&quot;</span>, PkgPath:<span class="string">&quot;&quot;</span>, Type:(*reflect.rtype)(<span class="number">0x905ba0</span>), Tag:<span class="string">&quot;&quot;</span>, Offset:<span class="number">0x8</span>, Index:[]<span class="type">int</span>&#123;<span class="number">1</span>&#125;, Anonymous:<span class="literal">false</span>&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 利用反射对基本类型的修改</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := <span class="number">123</span></span><br><span class="line">v := reflect.ValueOf(&amp;a)</span><br><span class="line">v.Elem().SetInt(<span class="number">999</span>)</span><br><span class="line"></span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="number">999</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">Id   <span class="type">int</span></span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">u := User&#123;<span class="number">1</span>,<span class="string">&quot;OK&quot;</span>, <span class="number">18</span>&#125;</span><br><span class="line">Set(&amp;u)</span><br><span class="line">fmt.Println(u)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 利用反射操作结构</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Set</span><span class="params">(o <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">v := reflect.ValueOf(o)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> v.Kind() == reflect.Ptr &amp;&amp; !v.Elem().CanSet() &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Can not set&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">v = v.Elem()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f := v.FieldByName(<span class="string">&quot;Name&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> !f.IsValid() &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Bad&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> f.Kind() == reflect.String &#123;</span><br><span class="line">f.SetString(<span class="string">&quot;Bye&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">&#123;<span class="number">1</span> Bye <span class="number">18</span>&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">Id   <span class="type">int</span></span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u User)</span></span> Hello(name <span class="type">string</span>) &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Hello&quot;</span>, name, <span class="string">&quot;, my name is&quot;</span>, u.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 利用反射实现方法调用</span></span><br><span class="line">u := User&#123;<span class="number">1</span>,<span class="string">&quot;OK&quot;</span>, <span class="number">18</span>&#125;</span><br><span class="line">v := reflect.ValueOf(u)</span><br><span class="line">mv := v.MethodByName(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line"></span><br><span class="line">args := []reflect.Value&#123;reflect.ValueOf(<span class="string">&quot;joe&quot;</span>)&#125;</span><br><span class="line">mv.Call(args)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Hello joe , my name is OK</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】12-接口interface</title>
      <link href="/2022/06/26/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9112%E6%8E%A5%E5%8F%A3interface/"/>
      <url>/2022/06/26/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9112%E6%8E%A5%E5%8F%A3interface/</url>
      
        <content type="html"><![CDATA[<h1 id="接口interface"><a href="#接口interface" class="headerlink" title="接口interface"></a>接口interface</h1><ul><li>接口是一个或多个方法签名的集合</li><li>只要某个类型拥有该接口的所有方法签名，即算实现该接口，无需显示</li><li>声明实现了哪个接口，这称为 Structural Typing</li><li>接口只有方法声明，没有实现，没有数据字段</li><li>接口可以匿名嵌入其它接口，或嵌入到结构中</li><li>将对象赋值给接口时，会发生拷贝，而接口内部存储的是指向这个</li><li>复制品的指针，既无法修改复制品的状态，也无法获取指针</li><li>只有当接口存储的类型和对象都为nil时，接口才等于nil</li><li>接口调用不会做receiver的自动转换</li><li>接口同样支持匿名字段方法</li><li>接口也可实现类似OOP中的多态</li><li>空接口可以作为任何类型数据的容器</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> USB <span class="keyword">interface</span> &#123;</span><br><span class="line">Name() <span class="type">string</span></span><br><span class="line"><span class="comment">// 嵌入接口</span></span><br><span class="line">Connecter</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Connecter <span class="keyword">interface</span> &#123;</span><br><span class="line">Connect()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PhoneConnecter <span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pc PhoneConnecter)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> pc.name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pc PhoneConnecter)</span></span> Connect() &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Connected:&quot;</span>, pc.name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := PhoneConnecter&#123;<span class="string">&quot;Phone Connecter&quot;</span>&#125;</span><br><span class="line">a.Connect()</span><br><span class="line">Disconnect(a)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 也可类型转换</span></span><br><span class="line"><span class="comment">pc := PhoneConnecter&#123;&quot;Phone Connecter&quot;&#125;</span></span><br><span class="line"><span class="comment">var a Connecter</span></span><br><span class="line"><span class="comment">a = Connecter(pc)</span></span><br><span class="line"><span class="comment">a.Connect()</span></span><br><span class="line"><span class="comment">输出：Connected: Phone Connecter</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Disconnect</span><span class="params">(usb USB)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> pc,ok := usb.(PhoneConnecter);ok &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Disconnected:&quot;</span>, pc.name)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;Unkown device.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Connected: Phone Connecter</span><br><span class="line">Disconnected: Phone Connecter</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> USB <span class="keyword">interface</span> &#123;</span><br><span class="line">Name() <span class="type">string</span></span><br><span class="line"><span class="comment">// 嵌入接口</span></span><br><span class="line">Connecter</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Connecter <span class="keyword">interface</span> &#123;</span><br><span class="line">Connect()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TVConnecter <span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tv TVConnecter)</span></span> Connect() &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Connected:&quot;</span>, tv.name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">tv := TVConnecter&#123;<span class="string">&quot;TVConnecter&quot;</span>&#125;</span><br><span class="line"><span class="keyword">var</span> a USB</span><br><span class="line"><span class="comment">// 会报错：cannot convert tv (variable of type TVConnecter) to type USB:</span></span><br><span class="line">a = USB(tv)</span><br><span class="line">a.Connect()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> USB <span class="keyword">interface</span> &#123;</span><br><span class="line">Name() <span class="type">string</span></span><br><span class="line"><span class="comment">// 嵌入接口</span></span><br><span class="line">Connecter</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Connecter <span class="keyword">interface</span> &#123;</span><br><span class="line">Connect()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PhoneConnecter <span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pc PhoneConnecter)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> pc.name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pc PhoneConnecter)</span></span> Connect() &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Connected:&quot;</span>, pc.name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">pc := PhoneConnecter&#123;<span class="string">&quot;Phone Connecter&quot;</span>&#125;</span><br><span class="line"><span class="keyword">var</span> a Connecter</span><br><span class="line">a = Connecter(pc)</span><br><span class="line">a.Connect()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 即使修改pc.name的值，还是输出原来的Phone Connecter，对象赋值给接口时，接口内部存储的是指向复制品的指针</span></span><br><span class="line">pc.name = <span class="string">&quot;pc&quot;</span></span><br><span class="line">a.Connect()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Connected: Phone Connecter</span><br><span class="line">Connected: Phone Connecter</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 只有当接口存储的类型和对象都为nil时，接口才等于nil</span></span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">fmt.Println(a == <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p *<span class="type">int</span> = <span class="literal">nil</span></span><br><span class="line">a = p</span><br><span class="line">fmt.Println(a == <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="literal">false</span></span><br></pre></td></tr></table></figure><h1 id="类型断言"><a href="#类型断言" class="headerlink" title="类型断言"></a>类型断言</h1><ul><li>通过类型断言的ok pattern可以判断接口中的数据类型</li><li>使用type switch则可针对空接口进行比较全面的类型判断</li></ul><h1 id="接口转换"><a href="#接口转换" class="headerlink" title="接口转换"></a>接口转换</h1><ul><li>可以将拥有超集的接口转换为子集的接口</li></ul>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】11-方法method</title>
      <link href="/2022/06/26/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9111%E6%96%B9%E6%B3%95method/"/>
      <url>/2022/06/26/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9111%E6%96%B9%E6%B3%95method/</url>
      
        <content type="html"><![CDATA[<h1 id="方法method"><a href="#方法method" class="headerlink" title="方法method"></a>方法method</h1><ul><li>Go 中虽没有class，但依旧有method</li><li>通过显示说明receiver来实现与某个类型的组合</li><li>只能为同一个包中的类型定义方法</li><li>Receiver 可以是类型的值或者指针</li><li>不存在方法重载</li><li>可以使用值或指针来调用方法，编译器会自动完成转换</li><li>从某种意义上来说，方法是函数的语法糖，因为receiver其实就是</li><li>方法所接收的第1个参数（Method Value vs. Method Expression）</li><li>如果外部结构和嵌入结构存在同名方法，则优先调用外部结构的方法</li><li>类型别名不会拥有底层类型所附带的方法</li><li>方法可以调用结构中的非公开字段</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> A <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> B <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := A&#123;&#125;</span><br><span class="line">a.Print()</span><br><span class="line"></span><br><span class="line">b := B&#123;&#125;</span><br><span class="line">b.Print()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a A)</span></span> Print() &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 这样就不行，因为go里面不能重载</span></span><br><span class="line"><span class="comment">func (a A) Print(b int) &#123;</span></span><br><span class="line"><span class="comment">fmt.Println(&quot;A&quot;)</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法的绑定只针对类型和方法同一包名下</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b B)</span></span> Print() &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;B&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">A</span><br><span class="line">B</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> A <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> B <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := A&#123;Name: <span class="string">&quot;A&quot;</span>&#125;</span><br><span class="line"><span class="comment">// go里会自动识别通过值调用还是指针调用</span></span><br><span class="line">a.Print()</span><br><span class="line">fmt.Println(a.Name)</span><br><span class="line"></span><br><span class="line">b := B&#123;Name: <span class="string">&quot;B&quot;</span>&#125;</span><br><span class="line">b.Print()</span><br><span class="line">fmt.Println(b.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Receiver可以是类型的值或者指针（这里是指针传递）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *A)</span></span> Print() &#123;</span><br><span class="line">a.Name = <span class="string">&quot;AA&quot;</span></span><br><span class="line">fmt.Println(<span class="string">&quot;A Print&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Receiver可以是类型的值或者指针（这里是值传递）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b B)</span></span> Print() &#123;</span><br><span class="line">b.Name = <span class="string">&quot;BB&quot;</span></span><br><span class="line">fmt.Println(<span class="string">&quot;B Print&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">A Print</span><br><span class="line">AA</span><br><span class="line">B Print</span><br><span class="line">B</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TZ <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> a TZ</span><br><span class="line">a.Print()</span><br><span class="line">(*TZ).Print(&amp;a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *TZ)</span></span> Print() &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;TZ&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">TZ</span><br><span class="line">TZ</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> A <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// 私有字段是以package来界定的</span></span><br><span class="line">name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := A&#123;&#125;</span><br><span class="line">a.Print()</span><br><span class="line">fmt.Println(a.name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法是可以访问类型中的私有字段</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *A)</span></span> Print() &#123;</span><br><span class="line">a.name = <span class="string">&quot;123&quot;</span></span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="思考问题"><a href="#思考问题" class="headerlink" title="思考问题"></a>思考问题</h1><ul><li>根据为结构增加方法的知识，尝试声明一个底层类型为int的类型，</li><li>并实现调用某个方法就递增100。</li><li>如：a:&#x3D;0，调用a.Increase()之后，a从0变成100。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> A <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := A(<span class="number">0</span>)</span><br><span class="line">a.Increase(<span class="number">100</span>)</span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *A)</span></span> Increase(num <span class="type">int</span>) &#123;</span><br><span class="line">    <span class="comment">// 注意：num需要强制类型转换</span></span><br><span class="line">*a += A(num)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="number">100</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】10-结构struct</title>
      <link href="/2022/06/26/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9110%E7%BB%93%E6%9E%84struct/"/>
      <url>/2022/06/26/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9110%E7%BB%93%E6%9E%84struct/</url>
      
        <content type="html"><![CDATA[<h1 id="结构struct"><a href="#结构struct" class="headerlink" title="结构struct"></a>结构struct</h1><ul><li>Go 中的struct与C中的struct非常相似，并且Go没有class</li><li>使用 type <Name> struct{} 定义结构，名称遵循可见性规则</li><li>支持指向自身的指针类型成员</li><li>支持匿名结构，可用作成员或定义成员变量</li><li>匿名结构也可以用于map的值</li><li>可以使用字面值对结构进行初始化</li><li>允许直接通过指针来读写结构成员</li><li>相同类型的成员可进行直接拷贝赋值</li><li>支持 &#x3D;&#x3D; 与 !&#x3D;比较运算符，但不支持 &gt; 或 &lt;</li><li>支持匿名字段，本质上是定义了以某个类型名为名称的字段</li><li>嵌入结构作为匿名字段看起来像继承，但不是继承</li><li>可以使用匿名字段指针</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 结构是一个值类型</span></span><br><span class="line"><span class="keyword">type</span> person <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := person&#123;&#125;</span><br><span class="line">a.Name = <span class="string">&quot;Tom&quot;</span></span><br><span class="line">a.Age = <span class="number">18</span></span><br><span class="line">fmt.Println(a)</span><br><span class="line"></span><br><span class="line">A(a)</span><br><span class="line">fmt.Println(a)</span><br><span class="line"></span><br><span class="line">b := person&#123;</span><br><span class="line">Name: <span class="string">&quot;Lue&quot;</span>,</span><br><span class="line">Age: <span class="number">16</span>,</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(b)</span><br><span class="line"></span><br><span class="line">B(&amp;b)</span><br><span class="line">fmt.Println(b)</span><br><span class="line"></span><br><span class="line"><span class="comment">// c就是一个指向person地址的指针</span></span><br><span class="line">c := &amp;person&#123;</span><br><span class="line">Name: <span class="string">&quot;Lili&quot;</span>,</span><br><span class="line">Age: <span class="number">20</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 虽然c是一个指针，但仍然可以使用a.Name进行操作</span></span><br><span class="line">c.Name = <span class="string">&quot;Hello&quot;</span></span><br><span class="line">fmt.Println(*c)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">A</span><span class="params">(per person)</span></span>  &#123;</span><br><span class="line">per.Age = <span class="number">13</span></span><br><span class="line">fmt.Println(<span class="string">&quot;A&quot;</span>, per)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">B</span><span class="params">(per *person)</span></span>  &#123;</span><br><span class="line">per.Age = <span class="number">13</span></span><br><span class="line">fmt.Println(<span class="string">&quot;B&quot;</span>, *per)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">&#123;Tom <span class="number">18</span>&#125;</span><br><span class="line">A &#123;Tom <span class="number">13</span>&#125;</span><br><span class="line">&#123;Tom <span class="number">18</span>&#125;</span><br><span class="line">&#123;Lue <span class="number">16</span>&#125;</span><br><span class="line">B &#123;Lue <span class="number">13</span>&#125;</span><br><span class="line">&#123;Lue <span class="number">13</span>&#125;</span><br><span class="line">&#123;Hello <span class="number">20</span>&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 匿名结构体</span></span><br><span class="line">a := &amp;<span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">&#125;&#123;</span><br><span class="line">Name: <span class="string">&quot;Tom&quot;</span>,</span><br><span class="line">Age:  <span class="number">18</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">&amp;&#123;Tom <span class="number">18</span>&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> person <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> person1 <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := person&#123;</span><br><span class="line">Name: <span class="string">&quot;Tom&quot;</span>,</span><br><span class="line">Age:  <span class="number">18</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b person</span><br><span class="line">b = a</span><br><span class="line">fmt.Println(b)</span><br><span class="line"></span><br><span class="line">c1 := person&#123;</span><br><span class="line">Name: <span class="string">&quot;Tom&quot;</span>,</span><br><span class="line">Age:  <span class="number">18</span>,</span><br><span class="line">&#125;</span><br><span class="line">c2 := person&#123;</span><br><span class="line">Name: <span class="string">&quot;Tom&quot;</span>,</span><br><span class="line">Age:  <span class="number">20</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 比较只能在相同类型进行比较</span></span><br><span class="line">fmt.Println(c1 == c2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">&#123;Tom <span class="number">18</span>&#125;</span><br><span class="line"><span class="literal">false</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> human <span class="keyword">struct</span> &#123;</span><br><span class="line">Sex <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结构的嵌入</span></span><br><span class="line"><span class="keyword">type</span> teacher <span class="keyword">struct</span> &#123;</span><br><span class="line">human</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">Sex <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> student <span class="keyword">struct</span> &#123;</span><br><span class="line">human</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := teacher&#123;</span><br><span class="line">Name: <span class="string">&quot;Tom&quot;</span>,</span><br><span class="line">Age: <span class="number">30</span>,</span><br><span class="line">Sex: <span class="number">1</span>,</span><br><span class="line">human: human&#123;</span><br><span class="line">Sex: <span class="number">0</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">b := student&#123;</span><br><span class="line">Name: <span class="string">&quot;Lili&quot;</span>,</span><br><span class="line">Age: <span class="number">18</span>,</span><br><span class="line">human: human&#123;</span><br><span class="line">Sex: <span class="number">1</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">a.Name = <span class="string">&quot;Tom1&quot;</span></span><br><span class="line">a.Age = <span class="number">40</span></span><br><span class="line">a.Sex = <span class="number">0</span></span><br><span class="line">a.human.Sex = <span class="number">1</span></span><br><span class="line">b.Name = <span class="string">&quot;Tom1&quot;</span></span><br><span class="line">b.Age = <span class="number">20</span></span><br><span class="line">b.Sex = <span class="number">0</span></span><br><span class="line">fmt.Println(a)</span><br><span class="line">fmt.Println(b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">&#123;&#123;<span class="number">1</span>&#125; Tom1 <span class="number">40</span> <span class="number">0</span>&#125;</span><br><span class="line">&#123;&#123;<span class="number">0</span>&#125; Tom1 <span class="number">20</span>&#125;</span><br></pre></td></tr></table></figure><h1 id="思考问题"><a href="#思考问题" class="headerlink" title="思考问题"></a>思考问题</h1><ul><li>如果匿名字段和外层结构有同名字段，应该如何进行操作？</li><li>请思考并尝试。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> A <span class="keyword">struct</span> &#123;</span><br><span class="line">B</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> B <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := A&#123;</span><br><span class="line">Name: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">B: B&#123;</span><br><span class="line">Name: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(a.Name)</span><br><span class="line">fmt.Println(a.B.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">A</span><br><span class="line">B</span><br></pre></td></tr></table></figure><p>如果嵌入结构存在内层接口和外层结构存在同名字段，访问需要带上层级。</p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】09-函数function</title>
      <link href="/2022/06/25/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9109%E5%87%BD%E6%95%B0function/"/>
      <url>/2022/06/25/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9109%E5%87%BD%E6%95%B0function/</url>
      
        <content type="html"><![CDATA[<h2 id="函数function"><a href="#函数function" class="headerlink" title="函数function"></a>函数function</h2><ul><li>Go 函数 不支持 嵌套、重载和默认参数</li><li>但支持以下特性：  <ul><li>无需声明原型、不定长度变参、多返回值、命名返回值参数  </li><li>匿名函数、闭包</li></ul></li><li>定义函数使用关键字 func，且左大括号不能另起一行</li><li>函数也可以作为一种类型使用</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(A())</span><br><span class="line">fmt.Println(B())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 非匿名返回值，a,b,c不需要定义可直接赋值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">A</span><span class="params">()</span></span> (a, b, c <span class="type">int</span>) &#123;</span><br><span class="line">a, b, c = <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匿名返回值，return后面需要指定变量名称</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">B</span><span class="params">()</span></span> (<span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>) &#123;</span><br><span class="line">a, b, c := <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span></span><br><span class="line"><span class="keyword">return</span> a, b, c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a, b := <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">A(a, b)</span><br><span class="line">fmt.Println(a, b)</span><br><span class="line"></span><br><span class="line">s1 := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;</span><br><span class="line">fmt.Println(s1)</span><br><span class="line">B(s1)</span><br><span class="line">fmt.Println(s1)</span><br><span class="line"></span><br><span class="line">c := <span class="number">7</span></span><br><span class="line">fmt.Println(c)</span><br><span class="line">C(&amp;c)</span><br><span class="line">fmt.Println(c)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不定长变参，不定长变参只能作为最后一个参数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">A</span><span class="params">(a ...<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">a[<span class="number">0</span>] = <span class="number">3</span></span><br><span class="line">a[<span class="number">1</span>] = <span class="number">4</span></span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接传递slice会影响原有变量本身</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">B</span><span class="params">(a []<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">a[<span class="number">0</span>] = <span class="number">5</span></span><br><span class="line">a[<span class="number">1</span>] = <span class="number">6</span></span><br><span class="line">a[<span class="number">2</span>] = <span class="number">7</span></span><br><span class="line">a[<span class="number">3</span>] = <span class="number">8</span></span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引用类型传递，会改变原始的值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">C</span><span class="params">(a *<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">*a = <span class="number">5</span></span><br><span class="line">fmt.Println(*a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[<span class="number">3</span> <span class="number">4</span>]</span><br><span class="line"><span class="number">1</span> <span class="number">2</span></span><br><span class="line">[<span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span>]</span><br><span class="line">[<span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span>]</span><br><span class="line">[<span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span>]</span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// go语言中函数也是类型</span></span><br><span class="line">a := A</span><br><span class="line">a()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匿名函数</span></span><br><span class="line">b := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Func B&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">b()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">A</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Func A&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Func A</span><br><span class="line">Func B</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 闭包</span></span><br><span class="line">f := closure(<span class="number">9</span>)</span><br><span class="line">fmt.Println(f(<span class="number">1</span>))</span><br><span class="line">fmt.Println(f(<span class="number">2</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3次打印的x的地址，都是同一个x</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">closure</span><span class="params">(x <span class="type">int</span>)</span></span> <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%p\n&quot;</span>, &amp;x)</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(y <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%p\n&quot;</span>, &amp;x)</span><br><span class="line"><span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="number">0xc00000a088</span></span><br><span class="line"><span class="number">0xc00000a088</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">0xc00000a088</span></span><br><span class="line"><span class="number">11</span></span><br></pre></td></tr></table></figure><h2 id="defer"><a href="#defer" class="headerlink" title="defer"></a>defer</h2><ul><li>执行方式类似其它语言中的析构函数，在函数体执行结束后按照调用顺序的相反顺序逐个执行</li><li>即使函数发生严重错误也会执行</li><li>支持匿名函数的调用</li><li>常用于资源清理、文件关闭、解锁以及记录时间等操作</li><li>通过与匿名函数配合可在return之后修改函数计算结果</li><li>如果函数体内某个变量作为defer时匿名函数的参数，则在定义defer时即已经获得了拷贝，否则则是引用某个变量的地址</li><li>Go 没有异常机制，但有 panic&#x2F;recover 模式来处理错误</li><li>Panic 可以在任何地方引发，但recover只有在defer调用的函数中有效</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="keyword">defer</span> fmt.Println(<span class="string">&quot;b&quot;</span>)</span><br><span class="line"><span class="keyword">defer</span> fmt.Println(<span class="string">&quot;c&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">a</span><br><span class="line">c</span><br><span class="line">b</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line"><span class="keyword">defer</span> fmt.Println(i)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// i一直作为引用的方式进行传递，形成了一个闭包</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(i)</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">A()</span><br><span class="line">B()</span><br><span class="line">C()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">A</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Func A&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">B</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 注意recover必须要放在发生panic之前</span></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Recover in B&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Panic in B&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">C</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Func C&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Func A</span><br><span class="line">Recover in B</span><br><span class="line">Func C</span><br></pre></td></tr></table></figure><h2 id="问题思考"><a href="#问题思考" class="headerlink" title="问题思考"></a>问题思考</h2><p>运行以下程序并分析输出结果。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> fs = [<span class="number">4</span>]<span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">4</span>; i++ &#123;</span><br><span class="line"><span class="keyword">defer</span> fmt.Println(<span class="string">&quot;defer i = &quot;</span>, i)</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; fmt.Println(<span class="string">&quot;defer_closure i = &quot;</span>, i) &#125;()</span><br><span class="line">fs[i] = <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;closure i = &quot;</span>, i)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, f := <span class="keyword">range</span> fs &#123;</span><br><span class="line">f()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">closure i =  <span class="number">4</span></span><br><span class="line">closure i =  <span class="number">4</span></span><br><span class="line">closure i =  <span class="number">4</span></span><br><span class="line">closure i =  <span class="number">4</span></span><br><span class="line">defer_closure i =  <span class="number">4</span></span><br><span class="line"><span class="keyword">defer</span> i =  <span class="number">3</span></span><br><span class="line">defer_closure i =  <span class="number">4</span></span><br><span class="line"><span class="keyword">defer</span> i =  <span class="number">2</span></span><br><span class="line">defer_closure i =  <span class="number">4</span></span><br><span class="line"><span class="keyword">defer</span> i =  <span class="number">1</span></span><br><span class="line">defer_closure i =  <span class="number">4</span></span><br><span class="line"><span class="keyword">defer</span> i =  <span class="number">0</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】08-map</title>
      <link href="/2022/06/05/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9108map/"/>
      <url>/2022/06/05/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9108map/</url>
      
        <content type="html"><![CDATA[<h2 id="map"><a href="#map" class="headerlink" title="map"></a>map</h2><ul><li><p>类似其它语言中的哈希表或者字典，以key-value形式存储数据</p></li><li><p>Key必须是支持&#x3D;&#x3D;或!&#x3D;比较运算的类型，不可以是函数、map或slice</p></li><li><p>Map查找比线性搜索快很多，但比使用索引访问数据的类型慢100倍<br>_ Map使用make()创建，支持 :&#x3D; 这种简写方式</p></li><li><p>make([keyType]valueType, cap)，cap表示容量，可省略</p></li><li><p>超出容量时会自动扩容，但尽量提供一个合理的初始值</p></li><li><p>使用len()获取元素个数</p></li><li><p>键值对不存在时自动添加，使用delete()删除某键值对</p></li><li><p>使用 for range 对map和slice进行迭代操作</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span>)</span><br><span class="line">m[<span class="number">1</span>]=<span class="string">&quot;OK&quot;</span></span><br><span class="line">a := m[<span class="number">1</span>]</span><br><span class="line">fmt.Println(a)</span><br><span class="line">fmt.Println(m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">OK</span><br><span class="line"><span class="keyword">map</span>[<span class="number">1</span>:OK]</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> m <span class="keyword">map</span>[<span class="type">int</span>]<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span></span><br><span class="line">m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span>)</span><br><span class="line">m[<span class="number">1</span>] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span>)</span><br><span class="line">m[<span class="number">1</span>][<span class="number">1</span>] = <span class="string">&quot;OK&quot;</span></span><br><span class="line">a := m[<span class="number">1</span>][<span class="number">1</span>]</span><br><span class="line">fmt.Println(a)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多返回值用于判断map的value是否存在</span></span><br><span class="line">a, ok := m[<span class="number">2</span>][<span class="number">1</span>]</span><br><span class="line">fmt.Println(a, ok)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">m[<span class="number">2</span>] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span>)</span><br><span class="line">&#125;</span><br><span class="line">m[<span class="number">2</span>][<span class="number">1</span>] = <span class="string">&quot;GOOD&quot;</span></span><br><span class="line">a, ok = m[<span class="number">2</span>][<span class="number">1</span>]</span><br><span class="line">fmt.Println(a, ok)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">OK</span><br><span class="line"> <span class="literal">false</span></span><br><span class="line">GOOD <span class="literal">true</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">sm := <span class="built_in">make</span>([]<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span>, <span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> sm &#123;</span><br><span class="line">v = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span>, <span class="number">1</span>)</span><br><span class="line">v[<span class="number">1</span>] = <span class="string">&quot;OK&quot;</span></span><br><span class="line">fmt.Println(v)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(sm)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">map</span>[<span class="number">1</span>:OK]</span><br><span class="line"><span class="keyword">map</span>[<span class="number">1</span>:OK]</span><br><span class="line"><span class="keyword">map</span>[<span class="number">1</span>:OK]</span><br><span class="line"><span class="keyword">map</span>[<span class="number">1</span>:OK]</span><br><span class="line"><span class="keyword">map</span>[<span class="number">1</span>:OK]</span><br><span class="line">[<span class="keyword">map</span>[] <span class="keyword">map</span>[] <span class="keyword">map</span>[] <span class="keyword">map</span>[] <span class="keyword">map</span>[]]</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">sm := <span class="built_in">make</span>([]<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span>, <span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> sm &#123;</span><br><span class="line">sm[i] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span>, <span class="number">1</span>)</span><br><span class="line">sm[i][<span class="number">1</span>] = <span class="string">&quot;OK&quot;</span></span><br><span class="line">fmt.Println(sm[i])</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(sm)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">map</span>[<span class="number">1</span>:OK]</span><br><span class="line"><span class="keyword">map</span>[<span class="number">1</span>:OK]</span><br><span class="line"><span class="keyword">map</span>[<span class="number">1</span>:OK]</span><br><span class="line"><span class="keyword">map</span>[<span class="number">1</span>:OK]</span><br><span class="line"><span class="keyword">map</span>[<span class="number">1</span>:OK]</span><br><span class="line">[<span class="keyword">map</span>[<span class="number">1</span>:OK] <span class="keyword">map</span>[<span class="number">1</span>:OK] <span class="keyword">map</span>[<span class="number">1</span>:OK] <span class="keyword">map</span>[<span class="number">1</span>:OK] <span class="keyword">map</span>[<span class="number">1</span>:OK]]</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 间接用slice进行map的排序</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">m := <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span>&#123;<span class="number">3</span>: <span class="string">&quot;c&quot;</span>, <span class="number">1</span>: <span class="string">&quot;a&quot;</span>, <span class="number">4</span>: <span class="string">&quot;d&quot;</span>, <span class="number">5</span>: <span class="string">&quot;e&quot;</span>, <span class="number">2</span>: <span class="string">&quot;b&quot;</span>&#125;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="built_in">len</span>(m))</span><br><span class="line">i := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> k, _ := <span class="keyword">range</span> m &#123;</span><br><span class="line">s[i] = k</span><br><span class="line">i++</span><br><span class="line">&#125;</span><br><span class="line">sort.Ints(s)</span><br><span class="line">fmt.Println(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> s &#123;</span><br><span class="line">fmt.Println(m[v])</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[<span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>]</span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br><span class="line">d</span><br><span class="line">e</span><br></pre></td></tr></table></figure><h2 id="思考问题"><a href="#思考问题" class="headerlink" title="思考问题"></a>思考问题</h2><ul><li>根据在 for range 部分讲解的知识，尝试将类型为map[int]string的键和值进行交换，变成类型map[string]int</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">m := <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span>&#123;<span class="number">3</span>: <span class="string">&quot;c&quot;</span>, <span class="number">1</span>: <span class="string">&quot;a&quot;</span>, <span class="number">4</span>: <span class="string">&quot;d&quot;</span>, <span class="number">5</span>: <span class="string">&quot;e&quot;</span>, <span class="number">2</span>: <span class="string">&quot;b&quot;</span>&#125;</span><br><span class="line">n := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>, <span class="built_in">len</span>(m))</span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> m &#123;</span><br><span class="line">n[v] = k</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(m)</span><br><span class="line">fmt.Println(n)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="keyword">map</span>[<span class="number">1</span>:a <span class="number">2</span>:b <span class="number">3</span>:c <span class="number">4</span>:d <span class="number">5</span>:e]</span><br><span class="line"><span class="keyword">map</span>[a:<span class="number">1</span> b:<span class="number">2</span> c:<span class="number">3</span> d:<span class="number">4</span> e:<span class="number">5</span>]</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】07-切片slice</title>
      <link href="/2022/06/05/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9107%E5%88%87%E7%89%87slice/"/>
      <url>/2022/06/05/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9107%E5%88%87%E7%89%87slice/</url>
      
        <content type="html"><![CDATA[<h2 id="切片Slice"><a href="#切片Slice" class="headerlink" title="切片Slice"></a>切片Slice</h2><ul><li><p>其本身并不是数组，它指向底层的数组</p></li><li><p>作为变长数组的替代方案，可以关联底层数组的局部或全部</p></li><li><p>为引用类型</p></li><li><p>可以直接创建或从底层数组获取生成</p></li><li><p>使用len()获取元素个数，cap()获取容量</p></li><li><p>一般使用make()创建</p></li><li><p>如果多个slice指向相同底层数组，其中一个的值改变会影响全部</p></li><li><p>make([]T, len, cap)</p></li><li><p>其中cap可以省略，则和len的值相同</p></li><li><p>len表示存数的元素个数，cap表示容量</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> s1 []<span class="type">int</span></span><br><span class="line">fmt.Println(s1)</span><br><span class="line"></span><br><span class="line">a := [<span class="number">10</span>]<span class="type">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>&#125;</span><br><span class="line">s2 := a[<span class="number">9</span>]</span><br><span class="line">fmt.Println(s2)</span><br><span class="line"></span><br><span class="line">s3 := a[<span class="number">5</span>:<span class="number">10</span>]</span><br><span class="line">fmt.Println(s3)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取数组某个位置开始到结束</span></span><br><span class="line">s4 := a[<span class="number">3</span>:<span class="built_in">len</span>(a)]</span><br><span class="line">s5 := a[<span class="number">3</span>:]</span><br><span class="line">fmt.Println(s4)</span><br><span class="line">fmt.Println(s5)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取前5个元素</span></span><br><span class="line">s6 := a[:<span class="number">5</span>]</span><br><span class="line">fmt.Println(s6)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[]</span><br><span class="line"><span class="number">10</span></span><br><span class="line">[<span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">10</span>]</span><br><span class="line">[<span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">10</span>]</span><br><span class="line">[<span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">10</span>]</span><br><span class="line">[<span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>]</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s1 := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">3</span>, <span class="number">10</span>)</span><br><span class="line">fmt.Println(s1)</span><br><span class="line">fmt.Println(<span class="built_in">len</span>(s1), <span class="built_in">cap</span>(s1))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"><span class="number">3</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><h2 id="Slice与底层数组的对应关系"><a href="#Slice与底层数组的对应关系" class="headerlink" title="Slice与底层数组的对应关系"></a>Slice与底层数组的对应关系</h2><p><img src="https://clang.oss-cn-shenzhen.aliyuncs.com/blog/2022/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9107%E5%88%87%E7%89%87slice_1.png-watermark"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := []<span class="type">byte</span>&#123;<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sclice_a</span></span><br><span class="line">sa := a[<span class="number">2</span>:<span class="number">5</span>]</span><br><span class="line">fmt.Println(<span class="type">string</span>(sa))</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sclice_b</span></span><br><span class="line">sb := a[<span class="number">3</span>:<span class="number">5</span>]</span><br><span class="line">fmt.Println(<span class="type">string</span>(sb))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">cde</span><br><span class="line">de</span><br></pre></td></tr></table></figure><h2 id="Reslice"><a href="#Reslice" class="headerlink" title="Reslice"></a>Reslice</h2><ul><li>Reslice时索引以被slice的切片为准</li><li>索引不可以超过被slice的切片的容量cap()值</li><li>索引越界不会导致底层数组的重新分配而是引发错误</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := []<span class="type">byte</span>&#123;<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sclice_a</span></span><br><span class="line">sa := a[<span class="number">2</span>:<span class="number">5</span>]</span><br><span class="line">fmt.Println(<span class="type">string</span>(sa))</span><br><span class="line">fmt.Println(<span class="built_in">len</span>(sa), <span class="built_in">cap</span>(sa))</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sclice_b</span></span><br><span class="line">sb := a[<span class="number">3</span>:<span class="number">5</span>]</span><br><span class="line">fmt.Println(<span class="type">string</span>(sb))</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reslice</span></span><br><span class="line">sc := sa[<span class="number">1</span>:<span class="number">3</span>]</span><br><span class="line">fmt.Println(<span class="type">string</span>(sc))</span><br><span class="line"></span><br><span class="line">sd := sa[<span class="number">3</span>:<span class="number">5</span>]</span><br><span class="line">fmt.Println(<span class="type">string</span>(sd))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">cde</span><br><span class="line"><span class="number">3</span> <span class="number">9</span></span><br><span class="line">de</span><br><span class="line">de</span><br><span class="line">fg</span><br></pre></td></tr></table></figure><h2 id="Append"><a href="#Append" class="headerlink" title="Append"></a>Append</h2><ul><li>可以在slice尾部追加元素</li><li>可以将一个slice追加在另一个slice尾部</li><li>如果最终长度未超过追加到slice的容量则返回原始slice</li><li>如果超过追加到的slice的容量则将重新分配数组并拷贝原始数据</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s1 := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">3</span>, <span class="number">6</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;%v %p\n&quot;</span>, s1, s1)</span><br><span class="line">s1 = <span class="built_in">append</span>(s1, <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;%v %p\n&quot;</span>, s1, s1)</span><br><span class="line">s1 = <span class="built_in">append</span>(s1, <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;%v %p\n&quot;</span>, s1, s1)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span>] <span class="number">0xc00000c390</span></span><br><span class="line">[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span>] <span class="number">0xc00000c390</span></span><br><span class="line">[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span>] <span class="number">0xc00004c060</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">s1 := a[<span class="number">2</span>:<span class="number">5</span>]</span><br><span class="line">s2 := a[<span class="number">1</span>:<span class="number">3</span>]</span><br><span class="line">fmt.Println(s1, s2)</span><br><span class="line">s1[<span class="number">0</span>] = <span class="number">9</span></span><br><span class="line">fmt.Println(s1, s2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[<span class="number">3</span> <span class="number">4</span> <span class="number">5</span>] [<span class="number">2</span> <span class="number">3</span>]</span><br><span class="line">[<span class="number">9</span> <span class="number">4</span> <span class="number">5</span>] [<span class="number">2</span> <span class="number">9</span>]</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">s1 := a[<span class="number">2</span>:<span class="number">5</span>]</span><br><span class="line">s2 := a[<span class="number">1</span>:<span class="number">3</span>]</span><br><span class="line">fmt.Println(s1, s2)</span><br><span class="line"><span class="comment">// s2会重新指向新的数组地址，s1值修改不会影响s2的值</span></span><br><span class="line">s2 = <span class="built_in">append</span>(s2, <span class="number">1</span>, <span class="number">2</span>, <span class="number">34</span>, <span class="number">5</span>, <span class="number">66</span>)</span><br><span class="line">s1[<span class="number">0</span>] = <span class="number">9</span></span><br><span class="line">fmt.Println(s1, s2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[<span class="number">3</span> <span class="number">4</span> <span class="number">5</span>] [<span class="number">2</span> <span class="number">3</span>]</span><br><span class="line">[<span class="number">9</span> <span class="number">4</span> <span class="number">5</span>] [<span class="number">2</span> <span class="number">3</span> <span class="number">1</span> <span class="number">2</span> <span class="number">34</span> <span class="number">5</span> <span class="number">66</span>]</span><br></pre></td></tr></table></figure><h2 id="Copy"><a href="#Copy" class="headerlink" title="Copy"></a>Copy</h2><ul><li>slice由长的往短的copy，不会改变短的len，也可以拷贝一部分，例如：copy(s2[1:2], s1[2:3])</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s1 := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line">s2 := []<span class="type">int</span>&#123;<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;</span><br><span class="line"><span class="built_in">copy</span>(s1, s2)</span><br><span class="line">fmt.Println(s1)</span><br><span class="line"></span><br><span class="line">s3 := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line">s4 := []<span class="type">int</span>&#123;<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;</span><br><span class="line"><span class="built_in">copy</span>(s4, s3)</span><br><span class="line">fmt.Println(s4)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[<span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span>]</span><br><span class="line">[<span class="number">1</span> <span class="number">2</span> <span class="number">3</span>]</span><br></pre></td></tr></table></figure><h2 id="思考问题"><a href="#思考问题" class="headerlink" title="思考问题"></a>思考问题</h2><ul><li>如何将一个slice指向一个完整的底层数组，而不是底层数组的一部分？</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line">s := a[:]</span><br><span class="line">fmt.Println(s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[<span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span>]</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】06-数组array</title>
      <link href="/2022/05/27/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9106%E6%95%B0%E7%BB%84array/"/>
      <url>/2022/05/27/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9106%E6%95%B0%E7%BB%84array/</url>
      
        <content type="html"><![CDATA[<h2 id="数组Array"><a href="#数组Array" class="headerlink" title="数组Array"></a>数组Array</h2><ul><li>定义数组的格式：var <varName> [n]<type>，n&gt;&#x3D;0</li><li>数组长度也是类型的一部分，因此具有不同长度的数组为不同类型</li><li>注意区分指向数组的指针和指针数组</li><li>数组在Go中为值类型</li><li>数组之间可以使用&#x3D;&#x3D;或!&#x3D;进行比较，但不可以使用&lt;或&gt;</li><li>可以使用new来创建数组，此方法返回一个指向数组的指针</li><li>Go支持多维数组</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数组长度也是类型的一部分，因此具有不同长度的数组为不同类型</span></span><br><span class="line"><span class="keyword">var</span> a [<span class="number">3</span>]<span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> b [<span class="number">2</span>]<span class="type">int</span></span><br><span class="line">b = a</span><br><span class="line"><span class="comment">// 上面的赋值语句会报错：cannot use a (variable of type [3]int) as type [2]int in assignment</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面的语句就能正常赋值成功</span></span><br><span class="line"><span class="keyword">var</span> a [<span class="number">2</span>]<span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> b [<span class="number">2</span>]<span class="type">int</span></span><br><span class="line">b = a</span><br><span class="line">fmt.Println(b)</span><br><span class="line"></span><br><span class="line">输出：[<span class="number">0</span> <span class="number">0</span>]</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := [<span class="number">2</span>]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line">fmt.Println(a)</span><br><span class="line"></span><br><span class="line">b := [<span class="number">20</span>]<span class="type">int</span>&#123;<span class="number">19</span>: <span class="number">1</span>&#125;</span><br><span class="line">fmt.Println(b)</span><br><span class="line"></span><br><span class="line">c := [...]<span class="type">int</span>&#123;<span class="number">19</span>: <span class="number">1</span>&#125;</span><br><span class="line">fmt.Println(c)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指向数组的指针</span></span><br><span class="line"><span class="keyword">var</span> p *[<span class="number">20</span>]<span class="type">int</span> = &amp;c</span><br><span class="line">fmt.Println(p)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指针数组</span></span><br><span class="line">x, y := <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">d := [...]*<span class="type">int</span>&#123;&amp;x, &amp;y&#125;</span><br><span class="line">fmt.Println(d)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数组比较</span></span><br><span class="line">e := [<span class="number">2</span>]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line">f := [<span class="number">2</span>]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line">fmt.Println(e == f)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 采用new关键字生成数组</span></span><br><span class="line">q := <span class="built_in">new</span>([<span class="number">10</span>]<span class="type">int</span>)</span><br><span class="line">fmt.Println(q)</span><br><span class="line"></span><br><span class="line">g := [<span class="number">10</span>]<span class="type">int</span>&#123;&#125;</span><br><span class="line">g[<span class="number">1</span>] = <span class="number">2</span></span><br><span class="line">fmt.Println(g)</span><br><span class="line">r := <span class="built_in">new</span>([<span class="number">10</span>]<span class="type">int</span>)</span><br><span class="line">r[<span class="number">1</span>] = <span class="number">2</span></span><br><span class="line">fmt.Println(r)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[<span class="number">1</span> <span class="number">2</span>]</span><br><span class="line">[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span>]</span><br><span class="line">[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span>]</span><br><span class="line">&amp;[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span>]</span><br><span class="line">[<span class="number">0xc00000a170</span> <span class="number">0xc00000a178</span>]</span><br><span class="line"><span class="literal">true</span></span><br><span class="line">&amp;[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line">&amp;[<span class="number">0</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">a := [2][3]int&#123;</span><br><span class="line">&#123;1, 1, 1&#125;,</span><br><span class="line">&#123;2, 2, 2&#125;,</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(a)</span><br><span class="line"></span><br><span class="line">b := [2][3]int&#123;</span><br><span class="line">&#123;1:1&#125;,</span><br><span class="line">&#123;2:2&#125;,</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(b)</span><br><span class="line"></span><br><span class="line">// 针对二维数组，非顶级不可以使用数量推断</span><br><span class="line">c := [...][3]int&#123;</span><br><span class="line">&#123;1:1&#125;,</span><br><span class="line">&#123;2:3&#125;,</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(c)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[[1 1 1] [2 2 2]]</span><br><span class="line">[[0 1 0] [0 0 2]]</span><br><span class="line">[[0 1 0] [0 0 3]]</span><br></pre></td></tr></table></figure><h2 id="Go语言版冒泡排序"><a href="#Go语言版冒泡排序" class="headerlink" title="Go语言版冒泡排序"></a>Go语言版冒泡排序</h2><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">s := [5]int&#123;13, 5, 3, 6, 8&#125;</span><br><span class="line">len := len(s)</span><br><span class="line">fmt.Println(s)</span><br><span class="line"></span><br><span class="line">for i := 0; i <span class="variable">&lt; len; i++ &#123;</span></span><br><span class="line"><span class="variable">for j := i + 1; j &lt; len; j++ &#123;</span></span><br><span class="line"><span class="variable">if s[i] &gt;</span> s[j] &#123;</span><br><span class="line">temp := s[i]</span><br><span class="line">s[i] = s[j]</span><br><span class="line">s[j] = temp</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[13 5 3 6 8]</span><br><span class="line">[3 5 6 8 13]</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】05-控制语句</title>
      <link href="/2022/05/26/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9105%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5/"/>
      <url>/2022/05/26/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9105%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h2><ul><li>Go虽然保留了指针，但与其它编程语言不同的是，在Go当中不支持指针运算以及”-&gt;”运算符，而直接采用”.”选择符来操作指针 目标对象的成员</li><li>操作符”&amp;”取变量地址，使用”*”通过指针间接访问目标对象</li><li>默认值为 nil 而非 NULL</li></ul><h2 id="递增递减语句"><a href="#递增递减语句" class="headerlink" title="递增递减语句"></a>递增递减语句</h2><ul><li>在Go当中，++ 与 – 是作为<font color='red'>语句</font>而并不是作为表达式</li></ul><h2 id="判断语句if"><a href="#判断语句if" class="headerlink" title="判断语句if"></a>判断语句if</h2><ul><li>条件表达式没有括号</li><li>支持一个初始化表达式（可以是并行方式）</li><li>左大括号必须和条件语句或else在同一行</li><li>支持单行模式</li><li>初始化语句中的变量为block级别，同时隐藏外部同名变量</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">a := <span class="literal">true</span></span><br><span class="line"><span class="keyword">if</span> a, b, c := <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>; a+b+c &gt; <span class="number">6</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;大于6&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;小于6&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">大于<span class="number">6</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="循环语句for"><a href="#循环语句for" class="headerlink" title="循环语句for"></a>循环语句for</h2><ul><li>Go只有for一个循环语句关键字，但支持3种形式</li><li>初始化和步进表达式可以是多个值</li><li>条件语句每次循环都会被重新检查，因此不建议在条件语句中</li><li>使用函数，尽量提前计算好条件并以变量或常量代替</li><li>左大括号必须和条件语句在同一行</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a := <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">a++</span><br><span class="line"><span class="keyword">if</span> a &gt; <span class="number">3</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(a)</span><br><span class="line"></span><br><span class="line">输出：<span class="number">4</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a := <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> a &lt;= <span class="number">3</span> &#123;</span><br><span class="line">a++</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(a)</span><br><span class="line"></span><br><span class="line">输出：<span class="number">4</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a := <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">a++</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(a)</span><br><span class="line"></span><br><span class="line">输出：<span class="number">3</span></span><br></pre></td></tr></table></figure><h2 id="选择语句switch"><a href="#选择语句switch" class="headerlink" title="选择语句switch"></a>选择语句switch</h2><ul><li>可以使用任何类型或表达式作为条件语句</li><li>不需要写break，一旦条件符合自动终止</li><li>如希望继续执行下一个case，需使用fallthrough语句</li><li>支持一个初始化表达式（可以是并行方式），右侧需跟分号</li><li>左大括号必须和条件语句在同一行</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">a := <span class="number">1</span></span><br><span class="line"><span class="keyword">switch</span> a &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;a=0&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;a=1&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">a=<span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">a := <span class="number">1</span></span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="keyword">case</span> a &gt;= <span class="number">0</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;a&gt;=0&quot;</span>)</span><br><span class="line"><span class="keyword">fallthrough</span></span><br><span class="line"><span class="keyword">case</span> a &gt;= <span class="number">1</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;a&gt;=1&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">a&gt;=<span class="number">0</span></span><br><span class="line">a&gt;=<span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line"><span class="keyword">switch</span> a := <span class="number">1</span>; &#123;</span><br><span class="line"><span class="keyword">case</span> a &gt;= <span class="number">0</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;a&gt;=0&quot;</span>)</span><br><span class="line"><span class="keyword">fallthrough</span></span><br><span class="line"><span class="keyword">case</span> a &gt;= <span class="number">1</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;a&gt;=1&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">a&gt;=<span class="number">0</span></span><br><span class="line">a&gt;=<span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="跳转语句goto-break-continue"><a href="#跳转语句goto-break-continue" class="headerlink" title="跳转语句goto, break, continue"></a>跳转语句goto, break, continue</h2><ul><li>三个语法都可以配合标签使用</li><li>标签名区分大小写，若不使用会造成编译错误</li><li>Break与continue配合标签可用于多层循环的跳出</li><li>Goto是调整执行位置，与其它2个语句配合标签的结果并不相同</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">LABEL:</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i&lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line"><span class="keyword">if</span> i &gt; <span class="number">2</span> &#123;</span><br><span class="line"><span class="keyword">break</span> LABEL</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(i)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">LABEL:</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">fmt.Println(i)</span><br><span class="line"><span class="keyword">continue</span> LABEL</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br></pre></td></tr></table></figure><h2 id="思考问题"><a href="#思考问题" class="headerlink" title="思考问题"></a>思考问题</h2><p>将下中的continue替换成goto，程序运行的结果还一样吗？<br>请尝试并思考为什么。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">LABEL:</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">fmt.Println(i)</span><br><span class="line"><span class="keyword">continue</span> LABEL</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>continue换成goto之后会导致程序死循环，因为goto是调整程序执行位置，continue结合标签是跳出循环</p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】04-常量与运算符</title>
      <link href="/2022/05/25/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9104%E5%B8%B8%E9%87%8F%E4%B8%8E%E8%BF%90%E7%AE%97%E7%AC%A6/"/>
      <url>/2022/05/25/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9104%E5%B8%B8%E9%87%8F%E4%B8%8E%E8%BF%90%E7%AE%97%E7%AC%A6/</url>
      
        <content type="html"><![CDATA[<h2 id="常量的定义"><a href="#常量的定义" class="headerlink" title="常量的定义"></a>常量的定义</h2><ul><li>常量的值在编译时就已经确定  </li><li>常量的定义格式与变量基本相同  </li><li>等号右侧必须是常量或者常量表达式</li><li>常量表达式中的函数必须是内置函数</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义单个常量</span></span><br><span class="line"><span class="keyword">const</span> a <span class="type">int</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">const</span> b = <span class="string">&#x27;B&#x27;</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">text = <span class="string">&quot;123&quot;</span></span><br><span class="line">length = <span class="built_in">len</span>(text)</span><br><span class="line">num = b * <span class="number">20</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同时定义多个变量</span></span><br><span class="line"><span class="keyword">const</span> i, j, k = <span class="number">1</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">text2, length2, num2 = <span class="string">&quot;468&quot;</span>, <span class="built_in">len</span>(text2), k * <span class="number">10</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">fmt.Println(a, b, text, length, num)</span><br><span class="line">fmt.Println(i, j, k, text2, length2, num2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span> <span class="number">66</span> <span class="number">123</span> <span class="number">3</span> <span class="number">1320</span></span><br><span class="line"><span class="number">1</span> <span class="number">2</span> <span class="number">51</span> <span class="number">468</span> <span class="number">3</span> <span class="number">510</span></span><br></pre></td></tr></table></figure><h2 id="常量的初始化规则与枚举"><a href="#常量的初始化规则与枚举" class="headerlink" title="常量的初始化规则与枚举"></a>常量的初始化规则与枚举</h2><ul><li>在定义常量组时，如果不提供初始值，则表示将使用上行的表达式</li><li>使用相同的表达式不代表具有相同的值</li><li>iota是常量的计数器，从0开始，组中每定义1个常量自动递增1</li><li>通过初始化规则与iota可以达到枚举的效果</li><li>每遇到一个const关键字，iota就会重置为0</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 常量定义也有大小写之分，大写包外可以访问</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line"><span class="comment">// a与b都为&#x27;A&#x27;,常量b会引用上一个常量的值或者表达式</span></span><br><span class="line">a = <span class="string">&#x27;A&#x27;</span></span><br><span class="line">b</span><br><span class="line"><span class="comment">// c的值为2，d的值为3，e的值为4，iota是常量计数器，显示赋值之后的常量值才生效</span></span><br><span class="line">c = <span class="literal">iota</span></span><br><span class="line">d = <span class="literal">iota</span></span><br><span class="line">e</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误写法，会提示：missing init expr for Sunday</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line"><span class="comment">// 第一个常量不可省略表达式，必须给一个明确的值</span></span><br><span class="line">Sunday</span><br><span class="line">Monday = <span class="literal">iota</span></span><br><span class="line">Tuesday</span><br><span class="line">Wednesday</span><br><span class="line">Thursday</span><br><span class="line">Friday</span><br><span class="line">Saturday</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确写法</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line"><span class="comment">// 第一个常量不可省略表达式，必须给一个明确的值</span></span><br><span class="line">Sunday = <span class="literal">iota</span></span><br><span class="line">Monday</span><br><span class="line">Tuesday</span><br><span class="line">Wednesday</span><br><span class="line">Thursday</span><br><span class="line">Friday</span><br><span class="line">Saturday</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2><p>Go中的运算符均是从左至右结合<br>优先级（从高到低）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">^     !                                          （一元运算符）</span><br><span class="line">*     /    %    &lt;&lt;    &gt;&gt;    &amp;      &amp;^            （一元运算符）</span><br><span class="line">+     -    |    ^                                （二元运算符）</span><br><span class="line">==    !=   &lt;    &lt;=    &gt;=    &gt;                    （二元运算符）</span><br><span class="line">&lt;-                                               （专门用于channel）</span><br><span class="line">&amp;&amp;</span><br><span class="line">||</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 6: 0110</span></span><br><span class="line"><span class="comment">11: 1011</span></span><br><span class="line"><span class="comment">----------</span></span><br><span class="line"><span class="comment">&amp;   0010 = 2（与）</span></span><br><span class="line"><span class="comment">|   1111 = 15（或）</span></span><br><span class="line"><span class="comment">^   1101 = 13（异或）</span></span><br><span class="line"><span class="comment">&amp;^  0100 = 4</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><h2 id="思考问题"><a href="#思考问题" class="headerlink" title="思考问题"></a>思考问题</h2><p>请尝试结合常量的iota与&lt;&lt;运算符实现计算机储存单位的枚举？</p><p>从小到大的存储单位主要利用移位操作，我们可以利用常量引用上一个常量的iota表达式来实现移位操作</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">_ = <span class="literal">iota</span></span><br><span class="line">KB <span class="type">float64</span> = <span class="number">1</span> &lt;&lt; (<span class="literal">iota</span> * <span class="number">10</span>)</span><br><span class="line">MB</span><br><span class="line">GB</span><br><span class="line">TB</span><br><span class="line">PB</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">fmt.Println(KB, MB, GB, TB, PB)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="number">1024</span> <span class="number">1.048576e+06</span> <span class="number">1.073741824e+09</span> <span class="number">1.099511627776e+12</span> <span class="number">1.125899906842624e+15</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】03-类型与变量</title>
      <link href="/2022/05/24/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9103%E7%B1%BB%E5%9E%8B%E4%B8%8E%E5%8F%98%E9%87%8F/"/>
      <url>/2022/05/24/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9103%E7%B1%BB%E5%9E%8B%E4%B8%8E%E5%8F%98%E9%87%8F/</url>
      
        <content type="html"><![CDATA[<h2 id="Go基本类型"><a href="#Go基本类型" class="headerlink" title="Go基本类型"></a>Go基本类型</h2><p>布尔型：bool</p><ul><li>长度：1字节</li><li>取值范围：true, false</li><li>注意事项：不可以用数字代表true或false</li></ul><p>整型：int&#x2F;uint</p><ul><li>根据运行平台可能为32或64位</li></ul><p>8位整型：int8&#x2F;uint8</p><ul><li>长度：1字节</li><li>取值范围：-128<del>127&#x2F;0</del>255</li></ul><p>字节型：byte（uint8别名）</p><p>16位整型：int16&#x2F;uint16</p><ul><li>长度：2字节</li><li>取值范围：-32768<del>32767&#x2F;0</del>65535</li></ul><p>32位整型：int32（rune）&#x2F;uint32</p><ul><li>长度：4字节</li><li>取值范围：-2^32&#x2F;2<del>2^32&#x2F;2-1&#x2F;0</del>2^32-1</li></ul><p>64位整型：int64&#x2F;uint64</p><ul><li>长度：8字节</li><li>取值范围：-2^64&#x2F;2<del>2^64&#x2F;2-1&#x2F;0</del>2^64-1</li></ul><p>浮点型：float32&#x2F;float64</p><ul><li>长度：4&#x2F;8字节</li><li>小数位：精确到7&#x2F;15小数位</li></ul><p>复数：complex64&#x2F;complex128</p><ul><li>长度：8&#x2F;16字节<br>足够保存指针的 32 位或 64 位整数型：uintptr</li></ul><p>其它值类型：</p><ul><li>array、struct、string<br>引用类型：</li><li>slice、map、chan</li></ul><p>接口类型：inteface<br>函数类型：func</p><h2 id="类型零值"><a href="#类型零值" class="headerlink" title="类型零值"></a>类型零值</h2><p>零值并不等于空值，而是当变量被声明为某种类型后的默认值，通常情况下值类型的默认值为0，bool为false，string为空字符串</p><h2 id="类型别名"><a href="#类型别名" class="headerlink" title="类型别名"></a>类型别名</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> (</span><br><span class="line"><span class="type">byte</span> <span class="type">int8</span></span><br><span class="line"><span class="type">rune</span> <span class="type">int32</span></span><br><span class="line">文本 <span class="type">string</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line"><span class="keyword">var</span> s 文本</span><br><span class="line">s = <span class="string">&quot;类型别名&quot;</span></span><br><span class="line">fmt.Println(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面我们定义了byte、rune和文本三个类型别名，类型别名和原类型一样使用</p><h2 id="单个变量的声明与赋值"><a href="#单个变量的声明与赋值" class="headerlink" title="单个变量的声明与赋值"></a>单个变量的声明与赋值</h2><p>变量的声明格式：var &lt;变量名称&gt; &lt;变量类型&gt;<br>变量的赋值格式：&lt;变量名称&gt; &#x3D; &lt;表达式&gt;<br>声明的同时赋值：var &lt;变量名称&gt; [变量类型] &#x3D; &lt;表达式&gt;  </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line"><span class="comment">// 变量的声明</span></span><br><span class="line"><span class="keyword">var</span> a <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 变量的赋值</span></span><br><span class="line">a = <span class="number">123</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 变量声明的时候同时赋值</span></span><br><span class="line"><span class="keyword">var</span> b <span class="type">int</span> = <span class="number">321</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 上行的格式可省略变量类型，由系统推断</span></span><br><span class="line"><span class="keyword">var</span> c = <span class="number">789</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 变量声明与赋值最简单的写法</span></span><br><span class="line">d := <span class="number">987</span></span><br><span class="line"></span><br><span class="line">fmt.Println(a, b, c, d)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="多个变量的声明与赋值"><a href="#多个变量的声明与赋值" class="headerlink" title="多个变量的声明与赋值"></a>多个变量的声明与赋值</h2><p>全局变量的声明可使用 var() 的方式进行简写<br>全局变量的声明不可以省略 var，但可使用并行方式<br>所有变量都可以使用类型推断<br>局部变量不可以使用 var() 的方式简写，只能使用并行方式  </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局变量var关键字不能省略</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line"><span class="comment">// 使用常规方式</span></span><br><span class="line">aaa = <span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="comment">// 使用并行方式以及类型推断</span></span><br><span class="line">bbb, ccc = <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line"><span class="comment">// 多个变量的声明</span></span><br><span class="line"><span class="keyword">var</span> a, b, c, d <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 多个变量的赋值</span></span><br><span class="line">a, b, c, d = <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 多个变量声明的时候同时赋值</span></span><br><span class="line"><span class="keyword">var</span> e, f, g, h <span class="type">int</span> = <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略变量类型，由系统推断</span></span><br><span class="line"><span class="keyword">var</span> i, j, k, l = <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略变量类型，由系统推断</span></span><br><span class="line">i, j, k, l = <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 多个变量声明与赋值的最简写法</span></span><br><span class="line">m, n, o, p := <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span></span><br><span class="line"></span><br><span class="line">fmt.Println(aaa, bbb, ccc, a, b, c, d, e, f, g, h, i, j, k, l, m, n, o, p)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="变量的类型转换"><a href="#变量的类型转换" class="headerlink" title="变量的类型转换"></a>变量的类型转换</h2><p>Go中不存在隐式转换，所有类型转换必须显式声明<br>转换只能发生在两种相互兼容的类型之间<br>类型转换的格式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;ValueA&gt; [:]= &lt;TypeOfValueA&gt;(&lt;ValueB&gt;)</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line"><span class="comment">// 在相互兼容的两种类型之间进行转换</span></span><br><span class="line"><span class="keyword">var</span> a <span class="type">float32</span> = <span class="number">1.1</span></span><br><span class="line">b := <span class="type">int</span>(a)</span><br><span class="line">fmt.Println(b)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 以下表达式无法通过编译</span></span><br><span class="line"><span class="comment">var c bool = true</span></span><br><span class="line"><span class="comment">d := int(c)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="思考问题"><a href="#思考问题" class="headerlink" title="思考问题"></a>思考问题</h2><p>请尝试运行以下代码，看会发生什么，并思考为什么</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line"><span class="keyword">var</span> a <span class="type">int</span> = <span class="number">65</span></span><br><span class="line">b := <span class="type">string</span>(a)</span><br><span class="line">fmt.Println(b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后会输入字母：A<br>string() 表示将数据转换成文本格式，因为计算机中存储的任何东西本质上都是数字，因此此函数自然地认为我们需要的是用数字65表示ASCII码中的文本 A</p><p>如果真要实现整形转字符串和看到的一样，可以这样来实现：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line"><span class="keyword">var</span> a <span class="type">int</span> = <span class="number">65</span></span><br><span class="line"><span class="comment">// 整形转字符串</span></span><br><span class="line">b := strconv.Itoa(a)</span><br><span class="line">fmt.Println(b)</span><br><span class="line"><span class="comment">// 字符串转整形，使用到了赋值多变量，_代表忽略该参数</span></span><br><span class="line">c, _ := strconv.Atoi(b)</span><br><span class="line">fmt.Println(c)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">65</span><br><span class="line">65</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>通过MySQL自带函数st_distance计算两个经纬度点的距离（效率更优）</title>
      <link href="/2022/05/19/%E9%80%9A%E8%BF%87MySQL%E8%87%AA%E5%B8%A6%E5%87%BD%E6%95%B0st-distance%E8%AE%A1%E7%AE%97%E4%B8%A4%E4%B8%AA%E7%BB%8F%E7%BA%AC%E5%BA%A6%E7%82%B9%E7%9A%84%E8%B7%9D%E7%A6%BB%EF%BC%88%E6%95%88%E7%8E%87%E6%9B%B4%E4%BC%98%EF%BC%89/"/>
      <url>/2022/05/19/%E9%80%9A%E8%BF%87MySQL%E8%87%AA%E5%B8%A6%E5%87%BD%E6%95%B0st-distance%E8%AE%A1%E7%AE%97%E4%B8%A4%E4%B8%AA%E7%BB%8F%E7%BA%AC%E5%BA%A6%E7%82%B9%E7%9A%84%E8%B7%9D%E7%A6%BB%EF%BC%88%E6%95%88%E7%8E%87%E6%9B%B4%E4%BC%98%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="情况一"><a href="#情况一" class="headerlink" title="情况一"></a>情况一</h2><blockquote><p>数据库：有point类型的location字段<br>实体类：有经纬度字段(double)</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">regionId,</span><br><span class="line">provinceName,</span><br><span class="line">cityName,</span><br><span class="line">districtName,</span><br><span class="line">lon,</span><br><span class="line">lat,</span><br><span class="line">(st_distance</span><br><span class="line">(location,point(<span class="number">31.0</span>, <span class="number">103.0</span>) ) <span class="operator">/</span> <span class="number">0.0111</span>) <span class="keyword">AS</span> distance</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">t_region</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="keyword">AND</span> deleted <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> distance <span class="keyword">asc</span></span><br></pre></td></tr></table></figure><h2 id="情况二"><a href="#情况二" class="headerlink" title="情况二"></a>情况二</h2><blockquote><p>数据库：有经度纬度字段，但是没有point字段<br>实体类：有经纬度字段(double)</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">regionId,</span><br><span class="line">provinceName,</span><br><span class="line">cityName,</span><br><span class="line">districtName,</span><br><span class="line">lon,</span><br><span class="line">lat,</span><br><span class="line">(st_distance</span><br><span class="line">(point(lon, lat),point(<span class="number">31.0</span>, <span class="number">103.0</span>) ) <span class="operator">/</span> <span class="number">0.0111</span>) <span class="keyword">AS</span> distance</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">t_region</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="keyword">AND</span> deleted <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> distance <span class="keyword">asc</span></span><br></pre></td></tr></table></figure><h2 id="附：建表语句"><a href="#附：建表语句" class="headerlink" title="附：建表语句"></a>附：建表语句</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> `t_region`  (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `regionId` <span class="type">int</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;编号规则6位有符号整数，例如110000。&#x27;</span>,</span><br><span class="line">  `provinceName` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">CHARACTER SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;省编号&#x27;</span>,</span><br><span class="line">  `cityName` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">CHARACTER SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;市编号&#x27;</span>,</span><br><span class="line">  `districtName` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">CHARACTER SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;区县编号&#x27;</span>,</span><br><span class="line">  `lon` <span class="keyword">double</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;经度&#x27;</span>,</span><br><span class="line">  `lat` <span class="keyword">double</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;纬度&#x27;</span>,</span><br><span class="line">  `location` point <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;经纬度point属性方便使用mysql地理位置运算&#x27;</span>,</span><br><span class="line">  `parentRegionId` <span class="type">int</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;父节点&#x27;</span>,</span><br><span class="line">  `createTime` datetime <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `createUser` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">CHARACTER SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;sys&#x27;</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">  `updateTime` datetime <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `updateUser` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">CHARACTER SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;sys&#x27;</span> COMMENT <span class="string">&#x27;修改人&#x27;</span>,</span><br><span class="line">  `deleted` <span class="type">int</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;删除状态 0 正常 1 已删除&#x27;</span>,</span><br><span class="line">  `version` <span class="type">int</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;修改序号&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT INTO</span> `t_region` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">510000</span>, <span class="string">&#x27;四川省&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="number">104.081703</span>, <span class="number">30.65722</span>, ST_GeomFromText(<span class="string">&#x27;POINT(30.65722 104.081703)&#x27;</span>), <span class="number">0</span>, <span class="string">&#x27;2017-03-15 15:06:55&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;2022-05-05 13:50:07&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CloudFlare Workers更换（workers.dev）默认域名的解决方案</title>
      <link href="/2022/05/18/CloudFlare-Workers%E6%9B%B4%E6%8D%A2%EF%BC%88workers-dev%EF%BC%89%E9%BB%98%E8%AE%A4%E5%9F%9F%E5%90%8D%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
      <url>/2022/05/18/CloudFlare-Workers%E6%9B%B4%E6%8D%A2%EF%BC%88workers-dev%EF%BC%89%E9%BB%98%E8%AE%A4%E5%9F%9F%E5%90%8D%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</url>
      
        <content type="html"><![CDATA[<p>最近由于CloudFlare Workers的默认域名（workers.dev）不能访问了。这对于使用CloudFlare Workers服务的应用带来了不便。今天这篇教程就和大家一起解决这个问题。</p><h2 id="准备材料"><a href="#准备材料" class="headerlink" title="准备材料"></a>准备材料</h2><ul><li>一个域名（可不用备案）</li><li>一个目前运行正常的Worker</li></ul><h2 id="配置步骤"><a href="#配置步骤" class="headerlink" title="配置步骤"></a>配置步骤</h2><p>1、登录CloudFlare，点击右上角的添加站点，获取域名托管在CloudFlare上的名字服务器。</p><p><img src="https://clang.oss-cn-shenzhen.aliyuncs.com/blog/2022/CloudFlare%20Workers%E6%9B%B4%E6%8D%A2%EF%BC%88workers.dev%EF%BC%89%E9%BB%98%E8%AE%A4%E5%9F%9F%E5%90%8D%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88_1.png-watermark" alt="在这里插入图片描述"></p><p>2、登录域名服务商，不同的服务商配置不一样，我的域名是在 <a href="https://www.dynadot.com/">dynadot</a> 上购买的，可以使用我的推荐码：pc7M9F6O8Zh6w，在控制台配置域名名字服务器，指向上一步CloudFlare的名字服务器，配置完成后需要等待一段时间才能生效，生效之后会收到CloudFlare发送的生效通知邮件。</p><p><img src="https://clang.oss-cn-shenzhen.aliyuncs.com/blog/2022/CloudFlare%20Workers%E6%9B%B4%E6%8D%A2%EF%BC%88workers.dev%EF%BC%89%E9%BB%98%E8%AE%A4%E5%9F%9F%E5%90%8D%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88_2.png-watermark" alt="在这里插入图片描述"></p><p>3、进入刚才添加的站点，添加一条A记录的域名，指向IP可以随意填，我这里填的是8.8.8.8，注意代理状态一定要开启（开启小云朵）。</p><p><img src="https://clang.oss-cn-shenzhen.aliyuncs.com/blog/2022/CloudFlare%20Workers%E6%9B%B4%E6%8D%A2%EF%BC%88workers.dev%EF%BC%89%E9%BB%98%E8%AE%A4%E5%9F%9F%E5%90%8D%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88_3.png-watermark" alt="在这里插入图片描述"></p><p>4、点击左侧菜单下的Workers-&gt;添加路由-&gt;输入自己域名的路由（路由需要提供这种形式：*.xxx.com&#x2F;*），在下拉框中选择自己的worker服务和环境。</p><p><img src="https://clang.oss-cn-shenzhen.aliyuncs.com/blog/2022/CloudFlare%20Workers%E6%9B%B4%E6%8D%A2%EF%BC%88workers.dev%EF%BC%89%E9%BB%98%E8%AE%A4%E5%9F%9F%E5%90%8D%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88_4.png-watermark" alt="在这里插入图片描述"></p><p>5、自此就完成了添加自定义域名。</p>]]></content>
      
      
      <categories>
          
          <category> 分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分享 </tag>
            
            <tag> CDN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】02-Go基础知识</title>
      <link href="/2022/05/13/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9102Go%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
      <url>/2022/05/13/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9102Go%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
      
        <content type="html"><![CDATA[<h2 id="Go内置关键字（25个均为小写）"><a href="#Go内置关键字（25个均为小写）" class="headerlink" title="Go内置关键字（25个均为小写）"></a>Go内置关键字（25个均为小写）</h2><table><thead><tr><th>break</th><th>default</th><th>func</th><th>interface</th><th>select</th></tr></thead><tbody><tr><td>case</td><td>defer</td><td>go</td><td>map</td><td>struct</td></tr><tr><td>chan</td><td>else</td><td>goto</td><td>package</td><td>switch</td></tr><tr><td>const</td><td>fallthrough</td><td>if</td><td>range</td><td>type</td></tr><tr><td>continue</td><td>for</td><td>import</td><td>return</td><td>var</td></tr></tbody></table><h2 id="Go注释方法"><a href="#Go注释方法" class="headerlink" title="Go注释方法"></a>Go注释方法</h2><ul><li>&#x2F;&#x2F; 单行注释</li><li>&#x2F;* *&#x2F; 多行注释</li></ul><h2 id="代码组织结构"><a href="#代码组织结构" class="headerlink" title="代码组织结构"></a>代码组织结构</h2><ul><li><p>Go程序是通过 <strong><font color="#660066">package</font></strong> 来组织的（与python类似）</p></li><li><p>只有 <strong><font color="#660066">package</font></strong> 名称为  <strong><font color="#00dddd">main</font></strong> 的包可以包含 <strong><font color="#00dddd">main</font></strong> 函数</p></li><li><p>一个可执行程序  <strong><font color="#dd0000">有且仅有</font></strong>  一个 main 包</p></li><li><p>通过 <strong><font color="#660066">import</font></strong> 关键字来导入其它非 <strong><font color="#00dddd">main</font></strong>  包</p></li><li><p>通过 <strong><font color="#660066">const</font></strong> 关键字来进行常量的定义</p></li><li><p>通过在函数体外部使用 <strong><font color="#660066">var</font></strong> 关键字来进行全局变量的声明与赋值</p></li><li><p>通过 <strong><font color="#660066">type</font></strong> 关键字来进行结构( <strong><font color="#660066">struct</font></strong> )或接口( <strong><font color="#660066">interface</font></strong> )的声明</p></li><li><p>通过 **<font color="#660066">func 关键字来进行函数的声明</p></li></ul><h2 id="Go导入-package-的格式"><a href="#Go导入-package-的格式" class="headerlink" title="Go导入 package 的格式"></a>Go导入 package 的格式</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;time&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;strings&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><ul><li>导入包之后，就可以使用格式&lt;PackageName&gt;.&lt;FuncName&gt;来对包中的函数进行调用</li><li>如果导入包之后 <strong><font color="#dd0000">未调用</font></strong> 其中的函数或者类型将会报出编译错误：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imported and not used: &quot;io&quot;</span><br></pre></td></tr></table></figure><h2 id="package别名"><a href="#package别名" class="headerlink" title="package别名"></a>package别名</h2><ul><li>当使用第三方包时，包名可能会非常接近或者相同，此时就可以使用别名来进行区别和调用。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">io <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">io.Println(<span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>**<font color="#dd0000">省略调用不建议使用</font>**，易混淆</li><li>不可以和别名同时使用</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">. <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line"><span class="comment">// 使用省略调用</span></span><br><span class="line">Println(<span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="可见性规则"><a href="#可见性规则" class="headerlink" title="可见性规则"></a>可见性规则</h2><ul><li>Go语言中，使用 <strong><font color="#660066">大小写</font></strong> 来决定该常量、变量、类型、接口、结构或函数是否可以被外部包所调用</li><li>根据约定，<font color="#0000dd">函数名</font> 首字母 <strong><font color="#00dddd">小写</font></strong> 即为private，<font color="#0000dd">函数名</font> 首字母 <strong><font color="#00dddd">大写</font></strong> 即为public</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getField</span><span class="params">(v reflect.Value, i <span class="type">int</span>)</span></span>  &#123;</span><br><span class="line">val := v.Field(i)</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Printf</span><span class="params">(format <span class="type">string</span>, a ...<span class="keyword">interface</span>&#123;&#125;)</span></span> (n <span class="type">int</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> Fprintf(os.Stdout, format, a...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Go编程基础】01-Go开发环境搭建</title>
      <link href="/2022/05/07/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9101Go%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
      <url>/2022/05/07/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9101Go%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是Go？"><a href="#什么是Go？" class="headerlink" title="什么是Go？"></a>什么是Go？</h2><p>Go是一门并发支持 、垃圾回收的编译型 系统编程语言，旨在创造一门具有在静态编译语言的 高性能 和动态语言的 高效开发 之间拥有良好平衡点的一门编程语言。</p><h2 id="Go的主要特点有哪些？"><a href="#Go的主要特点有哪些？" class="headerlink" title="Go的主要特点有哪些？"></a>Go的主要特点有哪些？</h2><ul><li>类型安全和内存安全</li><li>以非常直观和极低代价的方案实现高并发</li><li>高效的垃圾回收机制</li><li>快速编译（同时解决C语言中头文件太多的问题）</li><li>为多核计算机提供性能提升的方案</li><li>UTF-8编码支持</li></ul><h2 id="Go存在的价值是什么？"><a href="#Go存在的价值是什么？" class="headerlink" title="Go存在的价值是什么？"></a>Go存在的价值是什么？</h2><p>Go在谷歌：以软件工程为目的的语言设计</p><h2 id="Go是记事本编程吗？"><a href="#Go是记事本编程吗？" class="headerlink" title="Go是记事本编程吗？"></a>Go是记事本编程吗？</h2><p>包括GoLand，VSCode，LiteIDE等众多知名IDE均已支持</p><h2 id="Go目前有多少实际应用和资源？"><a href="#Go目前有多少实际应用和资源？" class="headerlink" title="Go目前有多少实际应用和资源？"></a>Go目前有多少实际应用和资源？</h2><ul><li>全球最大视频网站 Youtube（谷歌）</li><li>七牛云储存以及旗下网盘服务（Q盘）</li><li>爱好者开发的Go论坛及博客</li><li>已用Go开发服务端的著名企业：谷歌、盛大、七牛、360</li></ul><h2 id="Go发展成熟了吗？"><a href="#Go发展成熟了吗？" class="headerlink" title="Go发展成熟了吗？"></a>Go发展成熟了吗？</h2><p>作为一门2009年才正式发布的编程语言，Go是非常年轻的，因此不能称为一门成熟的编程语言，但开发社区每天都在不断更新其核心代码，给我们这些爱好者给予了很大的学习和开发动力。</p><h2 id="Go的爱好者多吗？"><a href="#Go的爱好者多吗？" class="headerlink" title="Go的爱好者多吗？"></a>Go的爱好者多吗？</h2><p>以Google Group为主的邮件列表每天都会更新10至20帖，国内的Go爱好者QQ群和论坛每天也在进行大量的讨论，因此可以说目前Go爱好者群体是足够壮大。</p><h2 id="安装Go语言"><a href="#安装Go语言" class="headerlink" title="安装Go语言"></a>安装Go语言</h2><ul><li>Go源码安装：<a href="https://go.dev/dl/">参考链接</a></li><li>Go标准包安装：<a href="https://go.dev/dl/">下载地址</a></li><li>第三方工具安装</li></ul><h2 id="Go环境变量与工作目录"><a href="#Go环境变量与工作目录" class="headerlink" title="Go环境变量与工作目录"></a>Go环境变量与工作目录</h2><p><img src="https://clang.oss-cn-shenzhen.aliyuncs.com/blog/2022/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9101Go%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA_1.png-watermark" alt="在这里插入图片描述"></p><p>根据约定，GOPATH下需要建立3个目录：</p><ul><li>bin（存放编译后生成的可执行文件）</li><li>pkg（存放编译后生成的包文件）</li><li>src（存放项目源码）</li></ul><h2 id="Go常用命令简介"><a href="#Go常用命令简介" class="headerlink" title="Go常用命令简介"></a>Go常用命令简介</h2><p>在命令行或终端输入go即可查看所有支持的命令</p><ul><li>go get：获取远程包（需 提前安装 git或hg）</li><li>go run：直接运行程序</li><li>go build：测试编译，检查是否有编译错误</li><li>go fmt：格式化源码（部分IDE在保存时自动调用）</li><li>go install：编译包文件并编译整个程序</li><li>go test：运行测试文件</li><li>go doc：查看文档</li></ul><h2 id="程序的整体结构"><a href="#程序的整体结构" class="headerlink" title="程序的整体结构"></a>程序的整体结构</h2><p><img src="https://clang.oss-cn-shenzhen.aliyuncs.com/blog/2022/%E3%80%90Go%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E3%80%9101Go%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA_2.png-watermark" alt="在这里插入图片描述"></p><h2 id="Go语言版”Hello-world-”"><a href="#Go语言版”Hello-world-”" class="headerlink" title="Go语言版”Hello world!”"></a>Go语言版”Hello world!”</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行输出：Hello World!</p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Cloud Gateway实现指定路由跳过全局过滤器</title>
      <link href="/2022/04/25/Spring-Cloud-Gateway%E5%AE%9E%E7%8E%B0%E6%8C%87%E5%AE%9A%E8%B7%AF%E7%94%B1%E8%B7%B3%E8%BF%87%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8/"/>
      <url>/2022/04/25/Spring-Cloud-Gateway%E5%AE%9E%E7%8E%B0%E6%8C%87%E5%AE%9A%E8%B7%AF%E7%94%B1%E8%B7%B3%E8%BF%87%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<p>在Spring Cloud Gateway中GlobalFilter可以方便的全局拦截或统计，有时候希望在某些路由中可以跳过GlobalFilter，可以通过GatewayFilter与GlobalFilter组合来实现。</p><h2 id="1、全局过滤器GlobalFilter"><a href="#1、全局过滤器GlobalFilter" class="headerlink" title="1、全局过滤器GlobalFilter"></a>1、全局过滤器GlobalFilter</h2><p>详细代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chanjet.dsf.web.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.chanjet.dsf.cache.RedisUtil;</span><br><span class="line"><span class="keyword">import</span> com.chanjet.dsf.constant.AttrbuteConstant;</span><br><span class="line"><span class="keyword">import</span> com.chanjet.dsf.constant.ResultCodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.chanjet.dsf.result.ResultFactory;</span><br><span class="line"><span class="keyword">import</span> com.chanjet.dsf.web.models.AuthTokenPo;</span><br><span class="line"><span class="keyword">import</span> com.chanjet.dsf.web.util.Constant;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.buffer.DataBuffer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(AuthFilter.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOKEN_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;DSFTOKEN::&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> exchange.getRequest().getQueryParams().getFirst(Constant.QUERY_PARAMS.TOKEN);</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;=======AuthFilter:token======&quot;</span> + token);</span><br><span class="line">        <span class="comment">// 不判断token的过滤器，比如登录接口</span></span><br><span class="line">        <span class="keyword">if</span> (exchange.getAttribute(AttrbuteConstant.ATTRIBUTE_IGNORE_TEST_GLOBAL_FILTER) != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; exchange.getAttribute(AttrbuteConstant.ATTRIBUTE_IGNORE_TEST_GLOBAL_FILTER).equals(<span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(token)) &#123;</span><br><span class="line">            <span class="comment">// 返回一个错误码 前端去做跳转淘宝授权登录页面 （前端处理）</span></span><br><span class="line">            <span class="keyword">return</span> generateJSON(exchange, ResultFactory.getErrorResult(ResultCodeEnum.TOKEN_IS_NULL));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">rediskey</span> <span class="operator">=</span> TOKEN_PREFIX + token;</span><br><span class="line">        <span class="comment">// 通过token取缓存</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">AuthTokenPo</span> <span class="variable">authTokenPo</span> <span class="operator">=</span> (AuthTokenPo) redisUtil.get(rediskey);</span><br><span class="line">            <span class="comment">//判断token过期</span></span><br><span class="line">            <span class="comment">// 校验缓存的账号信息是否为空</span></span><br><span class="line">            <span class="keyword">if</span> (authTokenPo == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> generateJSON(exchange, ResultFactory.getErrorResult(ResultCodeEnum.TOKEN_IS_INVALID));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;AuthFilter.filter 错误信息&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt;Mono <span class="title function_">generateJSON</span><span class="params">(ServerWebExchange exchange, T t)</span>&#123;</span><br><span class="line">        <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">        <span class="type">byte</span>[] bits = JSON.toJSONString(t).getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        <span class="type">DataBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> response.bufferFactory().wrap(bits);</span><br><span class="line">        response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">        <span class="comment">//指定编码，否则在浏览器中会中文乱码</span></span><br><span class="line">        response.getHeaders().add(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/plain;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> response.writeWith(Mono.just(buffer));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">900</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2、AbstractGatewayFilterFactory-局部过滤器"><a href="#2、AbstractGatewayFilterFactory-局部过滤器" class="headerlink" title="2、AbstractGatewayFilterFactory 局部过滤器"></a>2、AbstractGatewayFilterFactory 局部过滤器</h2><p>内部类写法，是为了指定过滤器的优先级，要优先于全局过滤器，否则<br>容易造成全局过滤器拦截到指定局部过滤器的配置内容，从而导致局<br>部过滤器失效。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chanjet.dsf.web.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.chanjet.dsf.constant.AttrbuteConstant;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置忽略路由</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IgnoreAuthFilter</span> <span class="keyword">extends</span> <span class="title class_">AbstractGatewayFilterFactory</span>&lt;IgnoreAuthFilter.Config&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(IgnoreAuthFilter.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">IgnoreAuthFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(Config.class);</span><br><span class="line">        logger.info(<span class="string">&quot;IgnoreFilter 进入 IgnoreAuthGatewayFilterFactory &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GatewayFilter <span class="title function_">apply</span><span class="params">(Config config)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;IgnoreFilter 进入  apply&quot;</span>);</span><br><span class="line">        <span class="comment">// ===============================注意=================================</span></span><br><span class="line">        <span class="comment">// 下面的内部类写法，是为了指定过滤器的优先级，要优先于全局过滤器，否则</span></span><br><span class="line">        <span class="comment">// 容易造成全局过滤器 拦截到指定 局部过滤器的配置内容。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InnerFilter</span>(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个内部类，来实现2个接口，指定顺序</span></span><br><span class="line"><span class="comment">     * 这里通过Ordered指定优先级</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">InnerFilter</span> <span class="keyword">implements</span> <span class="title class_">GatewayFilter</span>, Ordered &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Config config;</span><br><span class="line"></span><br><span class="line">        InnerFilter(Config config) &#123;</span><br><span class="line">            <span class="built_in">this</span>.config = config;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;进入innerFilter=====&quot;</span> + config.isIgnoreGlobalFilter());</span><br><span class="line">            <span class="keyword">if</span> (config.isIgnoreGlobalFilter() == <span class="literal">true</span>) &#123;</span><br><span class="line">                exchange.getAttributes().put(AttrbuteConstant.ATTRIBUTE_IGNORE_TEST_GLOBAL_FILTER, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1000</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span>&#123;</span><br><span class="line">        <span class="type">boolean</span> ignoreGlobalFilter;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isIgnoreGlobalFilter</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ignoreGlobalFilter;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIgnoreGlobalFilter</span><span class="params">(<span class="type">boolean</span> ignoreGlobalFilter)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.ignoreGlobalFilter = ignoreGlobalFilter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个name方法 用来在yml配置中指定对应的过滤器名称</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">name</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;IgnoreAuthFilter&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3、yml配置"><a href="#3、yml配置" class="headerlink" title="3、yml配置"></a>3、yml配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">dsf-report-ser</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://dsf-report-ser</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/report/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">dsf-account-ser</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://dsf-account-ser</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/account/**,/setting/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IgnoreAuthFilter</span> <span class="comment">#本路由跳过全局过滤器</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">ignoreGlobalFilter:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">dsf-finance-ser</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://dsf-finance-ser</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/shopTrade/**,/goods/**,/cost/**</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring Cloud </tag>
            
            <tag> Spring Cloud Gateway </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot集成Mybatis实现多数据源支持</title>
      <link href="/2022/04/21/Spring-Boot%E9%9B%86%E6%88%90Mybatis%E5%AE%9E%E7%8E%B0%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E6%94%AF%E6%8C%81/"/>
      <url>/2022/04/21/Spring-Boot%E9%9B%86%E6%88%90Mybatis%E5%AE%9E%E7%8E%B0%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E6%94%AF%E6%8C%81/</url>
      
        <content type="html"><![CDATA[<h2 id="1、背景"><a href="#1、背景" class="headerlink" title="1、背景"></a>1、背景</h2><p>在实际项目开发过程中，时不时会遇到多数据源的情况，本文详细介绍下Spring Boot集成Mybatis实现多数据源支持。</p><h2 id="2、集成过程"><a href="#2、集成过程" class="headerlink" title="2、集成过程"></a>2、集成过程</h2><h3 id="工程结构"><a href="#工程结构" class="headerlink" title="工程结构"></a>工程结构</h3><p>首先代码工程结构如下： org.spring.springboot.config.datasource 包含了多数据源的配置，同样有第三个数据源，按照前几个复制即可；resources&#x2F;mapper目录下面有两个模块，分别是 Mybatis 不同数据源需要扫描的mapper.xml 目录。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">├── pom.xml</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        ├── java</span><br><span class="line">        │   └── com</span><br><span class="line">        │       └── clang</span><br><span class="line">        │           ├── Application.java</span><br><span class="line">        │               ├── config</span><br><span class="line">        │               │   └── datasource </span><br><span class="line">        │               │       ├── ClusterDataSourceConfig.java</span><br><span class="line">        │               │       └── MasterDataSourceConfig.java</span><br><span class="line">        │               ├── controller</span><br><span class="line">        │               │   └── UserRestController.java</span><br><span class="line">        │               ├── dao</span><br><span class="line">        │               │   ├── cluster</span><br><span class="line">        │               │   │   └── CityDao.java</span><br><span class="line">        │               │   └── master</span><br><span class="line">        │               │       └── UserDao.java</span><br><span class="line">        │               ├── domain</span><br><span class="line">        │               │   ├── City.java</span><br><span class="line">        │               │   └── User.java</span><br><span class="line">        │               └── service</span><br><span class="line">        │                   ├── UserService.java</span><br><span class="line">        │                   └── impl</span><br><span class="line">        │                       └── UserServiceImpl.java</span><br><span class="line">        └── resources</span><br><span class="line">            ├── application.properties</span><br><span class="line">            └── mapper</span><br><span class="line">                ├── cluster</span><br><span class="line">                │   └── CityMapper.xml</span><br><span class="line">                └── master</span><br><span class="line">                    └── UserMapper.xml</span><br></pre></td></tr></table></figure><h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class="line">&lt;modelVersion&gt;<span class="number">4.0</span><span class="number">.0</span>&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">&lt;groupId&gt;com.clang&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;springboot-mybatis-mutil-datasource&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line">&lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">&lt;name&gt;springboot-mybatis-mutil-datasource&lt;/name&gt;</span><br><span class="line">&lt;description&gt;Demo project <span class="keyword">for</span> Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- springboot --&gt;</span><br><span class="line">&lt;parent&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;<span class="number">2.3</span><span class="number">.8</span>.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/parent&gt;</span><br><span class="line">&lt;!-- springboot --&gt;</span><br><span class="line"></span><br><span class="line">&lt;properties&gt;</span><br><span class="line">&lt;project.build.sourceEncoding&gt;UTF-<span class="number">8</span>&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">&lt;project.reporting.outputEncoding&gt;UTF-<span class="number">8</span>&lt;/project.reporting.outputEncoding&gt;</span><br><span class="line">&lt;java.version&gt;<span class="number">1.8</span>&lt;/java.version&gt;</span><br><span class="line">&lt;mybatis-spring-boot&gt;<span class="number">2.1</span><span class="number">.4</span>&lt;/mybatis-spring-boot&gt;</span><br><span class="line">&lt;mysql-connector&gt;<span class="number">8.0</span><span class="number">.11</span>&lt;/mysql-connector&gt;</span><br><span class="line">&lt;druid&gt;<span class="number">1.1</span><span class="number">.24</span>&lt;/druid&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- Spring Boot Mybatis 依赖 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;$&#123;mybatis-spring-boot&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- MySQL 连接驱动依赖 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;$&#123;mysql-connector&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- Druid 数据连接池依赖 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;druid&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;$&#123;druid&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;build&gt;</span><br><span class="line">&lt;plugins&gt;</span><br><span class="line">&lt;plugin&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br><span class="line">&lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="配置数据源"><a href="#配置数据源" class="headerlink" title="配置数据源"></a>配置数据源</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">## master 数据源配置</span><br><span class="line">master.datasource.url=jdbc:mysql:<span class="comment">//localhost:3306/db_master?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;autoReconnect=true&amp;failOverReadOnly=false&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">master.datasource.username=root</span><br><span class="line">master.datasource.password=root</span><br><span class="line">master.datasource.driverClassName=com.mysql.cj.jdbc.Driver</span><br><span class="line"></span><br><span class="line">## cluster 数据源配置</span><br><span class="line">cluster.datasource.url=jdbc:mysql:<span class="comment">//localhost:3306/db_cluster?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;autoReconnect=true&amp;failOverReadOnly=false&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">cluster.datasource.username=root</span><br><span class="line">cluster.datasource.password=root</span><br><span class="line">cluster.datasource.driverClassName=com.mysql.cj.jdbc.Driver</span><br></pre></td></tr></table></figure><h3 id="多数据源配置类"><a href="#多数据源配置类" class="headerlink" title="多数据源配置类"></a>多数据源配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// 扫描 Mapper 接口并容器管理</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = MasterDataSourceConfig.PACKAGE, sqlSessionFactoryRef = &quot;masterSqlSessionFactory&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MasterDataSourceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 精确到 master 目录，以便跟其他数据源隔离</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PACKAGE</span> <span class="operator">=</span> <span class="string">&quot;com.clang.dao.master&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MAPPER_LOCATION</span> <span class="operator">=</span> <span class="string">&quot;classpath:mapper/master/*.xml&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;master.datasource.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;master.datasource.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String user;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;master.datasource.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;master.datasource.driverClassName&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String driverClass;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;masterDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">masterDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        dataSource.setDriverClassName(driverClass);</span><br><span class="line">        dataSource.setUrl(url);</span><br><span class="line">        dataSource.setUsername(user);</span><br><span class="line">        dataSource.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceTransactionManager <span class="title function_">masterTransactionManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(masterDataSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;masterSqlSessionFactory&quot;)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory <span class="title function_">masterSqlSessionFactory</span><span class="params">(<span class="meta">@Qualifier(&quot;masterDataSource&quot;)</span> DataSource masterDataSource)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">SqlSessionFactoryBean</span> <span class="variable">sessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        sessionFactory.setDataSource(masterDataSource);</span><br><span class="line">        sessionFactory.setMapperLocations(<span class="keyword">new</span> <span class="title class_">PathMatchingResourcePatternResolver</span>()</span><br><span class="line">                .getResources(MasterDataSourceConfig.MAPPER_LOCATION));</span><br><span class="line">        <span class="keyword">return</span> sessionFactory.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>@Primary 标志这个 Bean 如果在多个同类 Bean 候选时，该 Bean 优先被考虑。「多数据源配置的时候注意，必须要有一个主数据源，用 @Primary 标志该 Bean」<br>@MapperScan 扫描 Mapper 接口并容器管理，包路径精确到 master，为了和下面 cluster 数据源做到精确区分 @Value 获取全局配置文件 application.properties 的 kv 配置,并自动装配 sqlSessionFactoryRef 表示定义了 key ，表示一个唯一 SqlSessionFactory 实例。<br>同理可得，从数据源 ClusterDataSourceConfig 配置如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = ClusterDataSourceConfig.PACKAGE, sqlSessionFactoryRef = &quot;clusterSqlSessionFactory&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClusterDataSourceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PACKAGE</span> <span class="operator">=</span> <span class="string">&quot;com.clang.dao.cluster&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MAPPER_LOCATION</span> <span class="operator">=</span> <span class="string">&quot;classpath:mapper/cluster/*.xml&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;cluster.datasource.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;cluster.datasource.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String user;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;cluster.datasource.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;cluster.datasource.driverClassName&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String driverClass;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;clusterDataSource&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">clusterDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        dataSource.setDriverClassName(driverClass);</span><br><span class="line">        dataSource.setUrl(url);</span><br><span class="line">        dataSource.setUsername(user);</span><br><span class="line">        dataSource.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;clusterTransactionManager&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceTransactionManager <span class="title function_">clusterTransactionManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(clusterDataSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;clusterSqlSessionFactory&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory <span class="title function_">clusterSqlSessionFactory</span><span class="params">(<span class="meta">@Qualifier(&quot;clusterDataSource&quot;)</span> DataSource clusterDataSource)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">SqlSessionFactoryBean</span> <span class="variable">sessionFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        sessionFactoryBean.setDataSource(clusterDataSource);</span><br><span class="line">        sessionFactoryBean.setMapperLocations(<span class="keyword">new</span> <span class="title class_">PathMatchingResourcePatternResolver</span>()</span><br><span class="line">                .getResources(ClusterDataSourceConfig.MAPPER_LOCATION));</span><br><span class="line">        <span class="keyword">return</span> sessionFactoryBean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面数据配置分别扫描 Mapper 接口，com.clang.dao.master（对应 xml classpath:mapper&#x2F;master ） 和 com.clang.dao.cluster（对应 xml classpath:mapper&#x2F;cluster ） 包中对应的 UserDAO 和 CityDAO 。 都有 @Mapper 标志为 Mybatis 的并通过容器管理的 Bean。Mybatis 内部会使用反射机制运行去解析相应 SQL。<br><a href="https://gitee.com/chenhu1001/multiple-datasource.git">代码下载</a>  </p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring Boot </tag>
            
            <tag> Mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决Spring Cloud Gateway网关跨域问题</title>
      <link href="/2022/04/21/%E8%A7%A3%E5%86%B3Spring-Cloud-Gateway%E7%BD%91%E5%85%B3%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98/"/>
      <url>/2022/04/21/%E8%A7%A3%E5%86%B3Spring-Cloud-Gateway%E7%BD%91%E5%85%B3%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>今天前端突然说接口不支持跨域了，马上排查了一番，原因是之前接口一直提供给App使用的，所以不存在跨域的问题。<br>解决方案就是在网关处新增配置类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.reactive.CorsWebFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.util.pattern.PathPatternParser;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CorsConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 允许跨域请求</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CorsWebFilter <span class="title function_">corsFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 允许cookies跨域</span></span><br><span class="line">        config.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 允许向该服务器提交请求的URI，*表示全部允许，在SpringMVC中，如果设成*，会自动转成当前请求头中的Origin</span></span><br><span class="line">        config.addAllowedOrigin(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">// 允许访问的头信息,*表示全部</span></span><br><span class="line">        config.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了</span></span><br><span class="line">        config.setMaxAge(<span class="number">18000L</span>);</span><br><span class="line">        <span class="comment">// 允许提交请求的方法类型，*表示全部允许</span></span><br><span class="line">        config.addAllowedMethod(<span class="string">&quot;OPTIONS&quot;</span>);</span><br><span class="line">        config.addAllowedMethod(<span class="string">&quot;HEAD&quot;</span>);</span><br><span class="line">        config.addAllowedMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">        config.addAllowedMethod(<span class="string">&quot;PUT&quot;</span>);</span><br><span class="line">        config.addAllowedMethod(<span class="string">&quot;POST&quot;</span>);</span><br><span class="line">        config.addAllowedMethod(<span class="string">&quot;DELETE&quot;</span>);</span><br><span class="line">        config.addAllowedMethod(<span class="string">&quot;PATCH&quot;</span>);</span><br><span class="line"></span><br><span class="line">        org.springframework.web.cors.reactive.<span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">org</span>.springframework.web.cors.reactive.UrlBasedCorsConfigurationSource(<span class="keyword">new</span> <span class="title class_">PathPatternParser</span>());</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, config);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CorsWebFilter</span>(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：网关加上跨域之后，在各个微服务对应的Controller上就不需要加@CrossOrigin跨域支持了。</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring Cloud Gateway </tag>
            
            <tag> 跨域 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多租户SaaS数据库租户模式</title>
      <link href="/2021/12/21/%E5%A4%9A%E7%A7%9F%E6%88%B7SaaS%E6%95%B0%E6%8D%AE%E5%BA%93%E7%A7%9F%E6%88%B7%E6%A8%A1%E5%BC%8F/"/>
      <url>/2021/12/21/%E5%A4%9A%E7%A7%9F%E6%88%B7SaaS%E6%95%B0%E6%8D%AE%E5%BA%93%E7%A7%9F%E6%88%B7%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<p>本文介绍可用于多租户 SaaS 应用程序的各种租户模型。</p><p>在设计多租户 SaaS 应用程序时，必须慎重选择最符合应用程序需要的租户模型。 租户模型确定如何将每个租户的数据映射到存储。 所选的租户模型会影响应用程序设计和管理。 今后改用不同的模型可能需要付出一定的代价。</p><h1 id="A-SaaS-概念和术语"><a href="#A-SaaS-概念和术语" class="headerlink" title="A. SaaS 概念和术语"></a>A. SaaS 概念和术语</h1><p>在软件即服务 (SaaS) 模型中，贵公司不会销售软件的 许可证。 而是，每个客户都会向贵公司支付租金，使每个客户成为贵公司的 租户。</p><p>作为支付租金的回报，每个租户都可以访问 SaaS 应用程序组件，并将数据存储在 SaaS 系统中。</p><p>术语 租户模型 是指租户存储数据的组织方式：</p><ul><li>单租户：  每个数据库仅存储来自一个租户的数据。</li><li>多租户：  每个数据库都存储来自多个独立租户的数据（使用保护数据隐私的机制）。</li><li>混合租户模式也可用。</li></ul><h1 id="B-如何选择适当的租户模型"><a href="#B-如何选择适当的租户模型" class="headerlink" title="B. 如何选择适当的租户模型"></a>B. 如何选择适当的租户模型</h1><p>一般情况下，租户模型不会影响应用程序的功能，但可能会影响总体解决方案的其他方面。 以下条件用于评估每个模型：</p><ul><li><p><strong>可伸缩性：</strong></p><ul><li>租户数目。</li><li>每个租户的存储量。</li><li>总存储量。</li><li>工作负荷。</li></ul></li><li><p>租户隔离：数据隔离和性能（一个租户的工作负荷是否影响其他租户）。</p></li><li><p><strong>每个租户的成本：</strong>  数据库成本。</p></li><li><p><strong>开发复杂性：</strong></p><ul><li>架构更改。</li><li>查询更改（模式所需）。</li></ul></li><li><p><strong>操作复杂性：</strong></p><ul><li>监视和管理性能。</li><li>架构管理。</li><li>还原租户。</li><li>灾难恢复。</li></ul></li><li><p><strong>可自定义性：</strong>  易于支持租户特定或租户类特定的架构自定义。</p></li></ul><p>有关租户的讨论侧重于数据层。 但是，请花费片刻时间思考一下应用程序层。 应用程序层被视为单一实体。 如果将应用程序划分成多个小型组件，所选的租户模型可能会更改。 在所用的租户和存储技术或平台方面，可以不同的方式对待某些组件。</p><h1 id="C-包含单租户数据库的独立单租户应用"><a href="#C-包含单租户数据库的独立单租户应用" class="headerlink" title="C. 包含单租户数据库的独立单租户应用"></a>C. 包含单租户数据库的独立单租户应用</h1><h2 id="应用程序级隔离"><a href="#应用程序级隔离" class="headerlink" title="应用程序级隔离"></a>应用程序级隔离</h2><p>在此模型中，针对每个租户重复安装整个应用程序一次。 应用的每个实例是独立实例，因此，它永远不与其他任何独立实例交互。 应用的每个实例只有一个租户，因此只需要一个数据库。 租户包含自身的整个数据库。<br><img src="https://clang.oss-cn-shenzhen.aliyuncs.com/blog/2021/%E5%A4%9A%E7%A7%9F%E6%88%B7SaaS%E6%95%B0%E6%8D%AE%E5%BA%93%E7%A7%9F%E6%88%B7%E6%A8%A1%E5%BC%8F_1.png-watermark" alt="在这里插入图片描述"><br>每个应用实例安装在单独的 Azure 资源组中。 该资源组可以属于软件供应商或租户拥有的订阅。 在任一情况下，供应商可为租户管理软件。 每个应用程序实例已配置为连接到其相应的数据库。</p><p>每个租户数据库都部署为单一数据库。 此模型提供最佳的数据库隔离性。 但是，隔离需要向每个数据库分配足够的资源来处理数据库峰值负载。 此处的一个要点是，无法对不同资源组中部署的数据库或不同的订阅使用弹性池。 从总体数据库成本的角度看，这种限制使得这种独立单租户应用模型成了最昂贵的解决方案。</p><h2 id="供应商管理"><a href="#供应商管理" class="headerlink" title="供应商管理"></a>供应商管理</h2><p>供应商可以访问所有独立应用实例中的所有数据库，即使应用实例安装在不同的租户订阅中。 访问是通过 SQL 连接实现的。 这种跨实例访问可让供应商出于报告或分析目的，在集中位置进行架构管理和跨数据库查询。 如果需要此类集中化管理，必须部署一个可将租户标识符映射到数据库 URI 的目录。 Azure SQL Database 提供了一个分片库，用于提供目录。 该分片库的正式名称为弹性数据库客户端库。</p><h1 id="D-采用“每个租户各有数据库”模型的多租户应用"><a href="#D-采用“每个租户各有数据库”模型的多租户应用" class="headerlink" title="D. 采用“每个租户各有数据库”模型的多租户应用"></a>D. 采用“每个租户各有数据库”模型的多租户应用</h1><p>接下来的这个模式使用包含许多数据库的多租户应用程序，这些数据库都是单租户数据库。 针对每个新租户预配一个新数据库。 可通过为每个节点添加更多的资源来纵向扩展应用程序层。 或者，可通过添加更多的节点来横向扩展应用。 缩放基于工作负荷，不受各个数据库的数目或规模的影响。<br><img src="https://clang.oss-cn-shenzhen.aliyuncs.com/blog/2021/%E5%A4%9A%E7%A7%9F%E6%88%B7SaaS%E6%95%B0%E6%8D%AE%E5%BA%93%E7%A7%9F%E6%88%B7%E6%A8%A1%E5%BC%8F_2.png-watermark" alt="在这里插入图片描述"></p><h2 id="根据租户进行自定义"><a href="#根据租户进行自定义" class="headerlink" title="根据租户进行自定义"></a>根据租户进行自定义</h2><p>与独立应用模式一样，使用单租户数据库可提供强大的租户隔离性。 在其模型仅指定了单租户数据库的任何应用中，可以根据任一给定数据库的租户自定义和优化该数据库的架构。 这种自定义不会影响应用中的其他租户。 某个租户所需的数据可能超过了所有租户所需的基本数据字段。 此外，附加的数据字段可能需要索引。</p><p>使用“每个租户各有数据库”模型，可以直截了当地定义一个或多个租户的架构。 应用程序供应商必须设计适当的过程，以慎重地大规模管理架构自定义。</p><h2 id="弹性池"><a href="#弹性池" class="headerlink" title="弹性池"></a>弹性池</h2><p>如果将数据库部署在同一个资源组中，可将其分组到弹性池。 通过池可以经济高效地在许多数据库之间共享资源。 与创建足够大的数据库来适应它所遇到的用量高峰相比，使用这种池选项的成本更低廉。 即使共用数据库共享资源访问权限，也仍能实现较高程度的性能隔离。<br><img src="https://clang.oss-cn-shenzhen.aliyuncs.com/blog/2021/%E5%A4%9A%E7%A7%9F%E6%88%B7SaaS%E6%95%B0%E6%8D%AE%E5%BA%93%E7%A7%9F%E6%88%B7%E6%A8%A1%E5%BC%8F_3.png-watermark" alt="在这里插入图片描述"><br>Azure SQL 数据库提供所需的工具用于配置、监视和管理共享。 可在 Azure 门户中查看池级别和数据库级性能指标，也可以通过 Azure Monitor 日志查看。 指标可以提供聚合性能和租户特定性能的深入见解。 可以在池之间移动单个数据库，以便向特定的租户提供保留的资源。 使用这些工具可确保以经济高效的方式获得良好性能。</p><h2 id="“每个租户各有数据库”模型的操作规模"><a href="#“每个租户各有数据库”模型的操作规模" class="headerlink" title="“每个租户各有数据库”模型的操作规模"></a>“每个租户各有数据库”模型的操作规模</h2><p>Azure SQL 数据库提供多种管理功能，用于大规模管理大量数据库（例如 100,000 以上的数据库）。 这些功能使“每个租户各有数据库”模式变得合理。</p><p>例如，假设某个系统使用一个包含 1000 个租户的数据库作为其唯一的数据库。 该数据库可能包含 20 个索引。 如果该系统改用 1000 个单租户数据库，则索引数量会提高到 20,000 个。 在自动优化过程中，默认会在 Azure SQL 数据库中启用自动索引功能。 自动索引会自动管理所有 20,000 个索引，以及这些索引的持续创建和删除优化操作。 这些自动操作发生在单个数据库内部，不受其他数据库中类似操作的协调或限制。 自动索引在繁忙数据库中处理索引的方式与在不太繁忙的数据库中不同。 如果必须手动完成这种异常繁重的管理任务，则以“每个租户各有数据库”规模进行这种索引管理自定义是不切实际的。</p><p>其他可以正常缩放的管理功能包括：</p><ul><li>内置备份。</li><li>高可用性。</li><li>磁盘中加密。</li><li>性能遥测。</li></ul><h2 id="自动化"><a href="#自动化" class="headerlink" title="自动化"></a>自动化</h2><p>可以编写管理操作的脚本，并通过 devops 模型提供这些操作。 甚至可以在应用程序中自动化和公开操作。</p><p>例如，可将单个租户自动恢复到以前的某个时间点。 恢复操作只需还原一个存储租户的单租户数据库。 此还原操作不会影响其他租户，确保以每个租户的粒度级完成管理操作。</p><h1 id="E-包含多租户数据库的多租户应用"><a href="#E-包含多租户数据库的多租户应用" class="headerlink" title="E. 包含多租户数据库的多租户应用"></a>E. 包含多租户数据库的多租户应用</h1><p>另一种可用模式是在一个多租户数据库中存储许多租户。 应用程序实例可以包含任意数量的多租户数据库。 多租户数据库的架构必须包含一个或多个租户标识符列，以便能够选择性地检索任意给定租户中的数据。 此外，该架构可能需要几个只由一部分租户使用的表或列。 但是，静态代码和引用数据只会存储一次，并由所有租户共享。</p><h2 id="丧失租户隔离性"><a href="#丧失租户隔离性" class="headerlink" title="丧失租户隔离性"></a>丧失租户隔离性</h2><p>数据：  使用多租户数据库势必会丧失租户隔离性。 多个租户的数据统一存储在一个数据库中。 在开发期间，需确保查询永远不会公开多个租户中的数据。 SQL 数据库支持行级安全性，这种安全性可以强制某个查询返回的数据划归到单个租户。</p><p>处理：  多租户数据库在其所有租户之间共享计算和存储资源。 可将数据库作为一个整体进行监视，确保其性能可接受。 但是，Azure 系统不提供内置的方式来监视或管理单个租户对这些资源的使用。 因此，多租户数据库增大了遇到干扰性邻居的风险：一个过度活跃的租户的工作负荷影响同一数据库中其他租户的性能体验。 其他应用程序级监视可以监视租户级性能。</p><h2 id="成本更低"><a href="#成本更低" class="headerlink" title="成本更低"></a>成本更低</h2><p>一般而言，多租户数据库的每租户成本最低。 单一数据库的资源成本比同等大小的弹性池的成本更低。 此外，在租户只需有限存储的情况下，有可能会将数百万个租户存储在单个数据库中。 没有任何弹性池可以包含数百万个数据库。 但是，使用包含 1000 个池、每个池包含 1000 个数据库的解决方案可以实现百万量级的规模，而风险是管理变得复杂。</p><p>下面介绍多租户数据库模型的两种变体，其中，分片多租户模型是灵活性和可伸缩性最高的模型。</p><h1 id="F-包含单个多租户数据库的多租户应用"><a href="#F-包含单个多租户数据库的多租户应用" class="headerlink" title="F. 包含单个多租户数据库的多租户应用"></a>F. 包含单个多租户数据库的多租户应用</h1><p>最简单的多租户数据库模式使用单一数据库来托管所有租户的数据。 添加更多的租户时，该数据库会使用更多的存储和计算资源进行纵向扩展。 通过这种纵向扩展也许能够做到高枕无忧，不过，规模始终有一个最终的限制。 但是，在远远未达到该限制之前，数据库可能就会变得难以管理。</p><p>在多租户数据库中，侧重于单个租户的管理操作更难实现。 大规模执行这些操作可能会使速度变得非常缓慢，让人无法接受。 一个例子是只是对一个租户的数据执行时间点还原。</p><h1 id="G-包含分片多租户数据库的多租户应用"><a href="#G-包含分片多租户数据库的多租户应用" class="headerlink" title="G. 包含分片多租户数据库的多租户应用"></a>G. 包含分片多租户数据库的多租户应用</h1><p>大多数 SaaS 应用程序每次只访问一个租户的数据。 使用此访问模式可在多个数据库或分片之间分布租户数据，其中，任一租户的所有数据包含在一个分片中。 将分片模型与多租户数据库模式相结合可以实现几乎无限的规模。<br><img src="https://clang.oss-cn-shenzhen.aliyuncs.com/blog/2021/%E5%A4%9A%E7%A7%9F%E6%88%B7SaaS%E6%95%B0%E6%8D%AE%E5%BA%93%E7%A7%9F%E6%88%B7%E6%A8%A1%E5%BC%8F_4.png-watermark" alt="在这里插入图片描述"></p><h2 id="管理分片"><a href="#管理分片" class="headerlink" title="管理分片"></a>管理分片</h2><p>分片增大了设计和操作管理的复杂性。 需要在目录中维护租户与数据库之间的映射。 此外，需要执行管理过程来管理分片和租户填充。 例如，必须设计相应的过程来添加和删除分片，以及在分片之间移动租户数据。 一种缩放方式是添加一个新分片并在其中填充新租户。 在其他时候，可将密集填充的分片拆分成两个不太密实的分片。 移动或停用多个租户后，可将稀疏填充的分片合并在一起。 合并会导致资源利用变得更加经济高效。 还可以在分片之间移动租户，以均衡工作负荷。</p><p>SQL 数据库提供一个可与分片库和目录数据库结合使用的拆分&#x2F;合并工具。 提供的应用可以拆分与合并分片，并可以在分片之间移动租户数据。 应用还会在执行这些操作期间维护目录，将受影响的租户标记为已脱机，然后移动这些租户。 移动后，应用会使用新映射再次更新目录，并将租户标记为已重新联机。</p><h2 id="小型数据库更易于管理"><a href="#小型数据库更易于管理" class="headerlink" title="小型数据库更易于管理"></a>小型数据库更易于管理</h2><p>通过在多个数据库之间分配租户，分片多租户解决方案可以生成更易于管理的小型数据库。 例如，将特定的租户还原到以前的某个时间点现在涉及到从备份中还原单个小型数据库，而不是从包含所有租户的大型数据库中还原。 可以选择数据库大小以及每个数据库的租户数，以均衡工作负荷与管理工作量。</p><h2 id="架构中的租户标识符"><a href="#架构中的租户标识符" class="headerlink" title="架构中的租户标识符"></a>架构中的租户标识符</h2><p>根据所用的分片方法，可能需要对数据库架构施加更多的约束。 SQL 数据库拆分&#x2F;合并应用程序要求架构包含分片键，这通常是租户标识符。 租户标识符是所有分片表的主键中的前导元素。 租户标识符可让拆分&#x2F;合并应用程序快速找到和移动与特定租户关联的数据。</p><h2 id="分片的弹性池"><a href="#分片的弹性池" class="headerlink" title="分片的弹性池"></a>分片的弹性池</h2><p>可将分片多租户数据库放在弹性池中。 一般而言，在一个池中放置许多单租户数据库，与在少量多租户数据库中放置许多租户的经济高效性相当。 当有大量的相对不活跃租户时，多租户数据库就很有优势。</p><h1 id="H-混合分片多租户数据库模型"><a href="#H-混合分片多租户数据库模型" class="headerlink" title="H. 混合分片多租户数据库模型"></a>H. 混合分片多租户数据库模型</h1><p>在混合模型中，所有数据库在其架构中包含租户标识符。 这些数据库都能存储多个租户，并且可以分片。 因此，在架构的意义上，它们都是多租户数据库。 但实际上，其中一些数据库只包含一个租户。 不管怎样，给定数据库中存储的租户数量不会对数据库架构造成影响。</p><h2 id="移动租户"><a href="#移动租户" class="headerlink" title="移动租户"></a>移动租户</h2><p>随时可将特定的租户移到其自身的多租户数据库中。 也随时可以改变主意，将租户移回到包含多个租户的数据库中。 此外，在预配新数据库时，还可将租户分配到新的单租户数据库中。</p><p>当可识别的租户组的资源需求有很大差异时，混合模型的优势将很明显。 例如，假设无法向参与免费试用的租户提供与订阅租户相同的性能级别。 策略可以是将处于免费试用阶段的租户存储在由所有免费试用租户共享的某个多租户数据库中。 当某个免费试用租户订阅“基本”服务层级时，可将该租户移到可能包含更少租户的另一个多租户数据库中。 可将购买“高级”服务层级的订阅者移到其拥有的新单租户数据库中。</p><h2 id="池"><a href="#池" class="headerlink" title="池"></a>池</h2><p>在此混合模型中，可将订阅者租户的单租户数据库放在资源池中，以减少每个租户的数据库成本。 “每个租户各有数据库”模型中也采用了这种做法。</p><h1 id="I-租户模型的比较"><a href="#I-租户模型的比较" class="headerlink" title="I. 租户模型的比较"></a>I. 租户模型的比较</h1><p>下表汇总了主要租户模型之间的差异。</p><table><thead><tr><th>度量</th><th>独立应用</th><th>每个租户各有数据库</th><th>分片多租户</th></tr></thead><tbody><tr><td>缩放</td><td>中型   1到数百个</td><td>很高   1 到数十万个</td><td>无限制   1到数百万个</td></tr><tr><td>租户隔离</td><td>很高</td><td>高</td><td>低；任何单租户（即独自在 MT 数据库中的租户）除外。</td></tr><tr><td>每个租户的数据库成本</td><td>高；大小根据峰值而定</td><td>低；使用池。</td><td>最低，适用于 MT 数据库中的小租户。</td></tr><tr><td>性能监视和管理</td><td>仅限每租户</td><td>聚合 + 每租户</td><td>聚合；不过，对于单租户，将应用“仅限每租户”模式。</td></tr><tr><td>开发复杂性</td><td>低</td><td>低</td><td>中等；受分片影响。</td></tr><tr><td>操作复杂性</td><td>低到高。 单个操作较简单，大规模操作较复杂。</td><td>低到中等。 模式可以解决大规模操作的复杂性。</td><td>低到高。 单个租户的管理比较复杂。</td></tr></tbody></table><p>原文链接：<a href="https://docs.microsoft.com/en-us/azure/azure-sql/database/saas-tenancy-app-design-patterns">https://docs.microsoft.com/en-us/azure/azure-sql/database/saas-tenancy-app-design-patterns</a>  </p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 多租户 </tag>
            
            <tag> SaaS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IntelliJ IDEA 2021.1激活步骤</title>
      <link href="/2021/12/15/IntelliJ-IDEA-2021-1%E6%BF%80%E6%B4%BB%E6%AD%A5%E9%AA%A4/"/>
      <url>/2021/12/15/IntelliJ-IDEA-2021-1%E6%BF%80%E6%B4%BB%E6%AD%A5%E9%AA%A4/</url>
      
        <content type="html"><![CDATA[<p>目前Jetbrains系列软件的激活方式为通过插件进行30天试用期重置的方式，其他方式都已经失效</p><h2 id="1、关于下载"><a href="#1、关于下载" class="headerlink" title="1、关于下载"></a>1、关于下载</h2><p>安装包可以直接到官方网站下载 <a href="https://www.jetbrains.com/idea/download/">https://www.jetbrains.com/idea/download/</a> 下载版本2021.1</p><h2 id="2、IDE-Eval-Reset-重置试用期插件"><a href="#2、IDE-Eval-Reset-重置试用期插件" class="headerlink" title="2、IDE Eval Reset 重置试用期插件"></a>2、IDE Eval Reset 重置试用期插件</h2><p>安装方法：<br>(1)、运行软件，点击试用，进入到软件创建新项目窗口；<br>(2)、左上角菜单栏点打开软件设置窗口：IntelliJ IDEA&#x2F;Preferences，然后选择 Plugins，点击设置图标手动添加第三方插件仓库地：<a href="https://plugins.zhile.io/">https://plugins.zhile.io</a><br>(3)、添加仓库后，搜索IDE Eval Reset 插件进行安装</p><h2 id="3-插件使用方法"><a href="#3-插件使用方法" class="headerlink" title="3.插件使用方法"></a>3.插件使用方法</h2><p>安装插件后，在Help -&gt; Eval Reset 调出，有 2 个按钮和 1 个勾选项：<br>按钮：Reload 用来刷新界面上的显示信息。<br>按钮：Reset 点击会询问是否重置试用信息并重启 IDE。<br>选择 Yes 则执行重置操作并重启 IDE 生效，选择 No 则什么也不做。（此为手动重置方式）<br>勾选项：Auto reset before per restart 如果勾选了，则自勾选后每次重启&#x2F;退出 IDE 时会自动重置试用信息，你无需做额外的事情。（此为自动重置方式，推荐此方法！）</p><h2 id="4-中文汉化方法"><a href="#4-中文汉化方法" class="headerlink" title="4.中文汉化方法"></a>4.中文汉化方法</h2><p>安装中文插件后重启IDE即可：插件中搜索chinese进行安装</p>]]></content>
      
      
      <categories>
          
          <category> 分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分享 </tag>
            
            <tag> IDEA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go实现文件接收  </title>
      <link href="/2020/07/11/Golang%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E6%8E%A5%E6%94%B6/"/>
      <url>/2020/07/11/Golang%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E6%8E%A5%E6%94%B6/</url>
      
        <content type="html"><![CDATA[<p>前段时间遇到一个问题，在只有nginx的情况下，实现文件的上传，突然想着利用Go可以非常简单的来实现。分为两个部分：服务端和客户端。代码如下所示：  </p><p>服务端：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">import (</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">&quot;io&quot;</span><br><span class="line">&quot;net/http&quot;</span><br><span class="line">&quot;os&quot;</span><br><span class="line">)</span><br><span class="line">const (</span><br><span class="line">upload_path string = &quot;/Users/chenhu/Desktop/upload/&quot;</span><br><span class="line">)</span><br><span class="line">func helloHandle(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">io.WriteString(w, &quot;hello world!&quot;)</span><br><span class="line">&#125;</span><br><span class="line">//上传</span><br><span class="line">func uploadHandle(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">//从请求当中判断方法</span><br><span class="line">if r.Method == &quot;GET&quot; &#123;</span><br><span class="line">io.WriteString(w, &quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;我的第一个页面&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;form action=&#x27;&#x27; method=\&quot;post\&quot; enctype=\&quot;multipart/form-data\&quot;&gt;&lt;label&gt;上传图片&lt;/label&gt;&lt;input type=\&quot;file\&quot; name=&#x27;file&#x27;  /&gt;&lt;br/&gt;&lt;label&gt;&lt;input type=\&quot;submit\&quot; value=\&quot;上传图片\&quot;/&gt;&lt;/label&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;&quot;)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">//获取文件内容 要这样获取</span><br><span class="line">file, head, err := r.FormFile(&quot;file&quot;)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line">defer file.Close()</span><br><span class="line">//创建文件</span><br><span class="line">fW, err := os.Create(upload_path + head.Filename)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">fmt.Println(&quot;文件创建失败&quot;)</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line">defer fW.Close()</span><br><span class="line">_, err = io.Copy(fW, file)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">fmt.Println(&quot;文件保存失败&quot;)</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line">//io.WriteString(w, head.Filename+&quot; 保存成功&quot;)</span><br><span class="line">http.Redirect(w, r, &quot;/hello&quot;, http.StatusFound)</span><br><span class="line">//io.WriteString(w, head.Filename)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">func main() &#123;</span><br><span class="line">//启动一个http 服务器</span><br><span class="line">http.HandleFunc(&quot;/hello&quot;, helloHandle)</span><br><span class="line">//上传</span><br><span class="line">http.HandleFunc(&quot;/upload&quot;, uploadHandle)</span><br><span class="line">err := http.ListenAndServe(&quot;:8080&quot;, nil)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">fmt.Println(&quot;服务器启动失败&quot;)</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(&quot;服务器启动成功&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>客户端：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;bytes&quot;</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">&quot;io&quot;</span><br><span class="line">&quot;io/ioutil&quot;</span><br><span class="line">&quot;mime/multipart&quot;</span><br><span class="line">&quot;net/http&quot;</span><br><span class="line">&quot;os&quot;</span><br><span class="line">&quot;path/filepath&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func postFile(path string, targetUrl string) error &#123;</span><br><span class="line">bodyBuf := &amp;bytes.Buffer&#123;&#125;</span><br><span class="line">bodyWriter := multipart.NewWriter(bodyBuf)</span><br><span class="line"></span><br><span class="line">paths, fileName := filepath.Split(path)</span><br><span class="line">fmt.Println(paths, fileName)</span><br><span class="line"></span><br><span class="line">//关键的一步操作</span><br><span class="line">fileWriter, err := bodyWriter.CreateFormFile(&quot;file&quot;, fileName)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">fmt.Println(&quot;error writing to buffer&quot;)</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//打开文件句柄操作</span><br><span class="line">fh, err := os.Open(path)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">fmt.Println(&quot;error opening file&quot;)</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br><span class="line">defer fh.Close()</span><br><span class="line"></span><br><span class="line">//iocopy</span><br><span class="line">_, err = io.Copy(fileWriter, fh)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contentType := bodyWriter.FormDataContentType()</span><br><span class="line">bodyWriter.Close()</span><br><span class="line"></span><br><span class="line">resp, err := http.Post(targetUrl, contentType, bodyBuf)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br><span class="line">defer resp.Body.Close()</span><br><span class="line">resp_body, err := ioutil.ReadAll(resp.Body)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(resp.Status)</span><br><span class="line">fmt.Println(string(resp_body))</span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// sample usage</span><br><span class="line">func main() &#123;</span><br><span class="line">target_url := &quot;http://localhost:9003/upload&quot;</span><br><span class="line">path := os.Args[1]</span><br><span class="line">postFile(path, target_url)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义Spring Cache的key</title>
      <link href="/2019/06/22/%E8%87%AA%E5%AE%9A%E4%B9%89Spring-Cache%E7%9A%84key/"/>
      <url>/2019/06/22/%E8%87%AA%E5%AE%9A%E4%B9%89Spring-Cache%E7%9A%84key/</url>
      
        <content type="html"><![CDATA[<p>在多租户系统中，为了统一处理系统缓存，需在缓存组件中加上租户Id，以下是自定义自定义Spring Cache的key步骤。</p><h2 id="1、继承RedisCacheManager"><a href="#1、继承RedisCacheManager" class="headerlink" title="1、继承RedisCacheManager"></a>1、继承RedisCacheManager</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class RedisAutoCacheManager extends RedisCacheManager &#123;</span><br><span class="line">    public RedisAutoCacheManager(RedisCacheWriter cacheWriter, RedisCacheConfiguration defaultCacheConfiguration) &#123;</span><br><span class="line">        super(cacheWriter, defaultCacheConfiguration);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 从上下文中获取租户ID，重写@Cacheable value值</span><br><span class="line">     * @param name</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public Cache getCache(String name) &#123;</span><br><span class="line">        return super.getCache( name + StrUtil.COLON + TenantContextHolder.getTenantId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2、在Spring-Boot启动类中注入容器"><a href="#2、在Spring-Boot启动类中注入容器" class="headerlink" title="2、在Spring Boot启动类中注入容器"></a>2、在Spring Boot启动类中注入容器</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public RedisCacheManager cacheManager(RedisConnectionFactory redisConnectionFactory) &#123;</span><br><span class="line">    // 初始化一个RedisCacheWriter</span><br><span class="line">    RedisCacheWriter redisCacheWriter = RedisCacheWriter.nonLockingRedisCacheWriter(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">    // 设置CacheManager的值序列化方式为json序列化</span><br><span class="line">    RedisSerializer&lt;Object&gt; jsonSerializer = new GenericFastJsonRedisSerializer();</span><br><span class="line">    RedisSerializationContext.SerializationPair&lt;Object&gt; pair = RedisSerializationContext.SerializationPair.fromSerializer(jsonSerializer);</span><br><span class="line">    RedisCacheConfiguration defaultCacheConfig = RedisCacheConfiguration.defaultCacheConfig().serializeValuesWith(pair);</span><br><span class="line"></span><br><span class="line">    // 初始化RedisCacheManager</span><br><span class="line">    return new RedisAutoCacheManager(redisCacheWriter, defaultCacheConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3、租户类"><a href="#3、租户类" class="headerlink" title="3、租户类"></a>3、租户类</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class TenantContextHolder &#123;</span><br><span class="line"></span><br><span class="line">    private static final ThreadLocal&lt;Integer&gt; CONTEXT = new ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    public static void setTenantId(Integer tenantId) &#123;</span><br><span class="line">        CONTEXT.set(tenantId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Integer getTenantId() &#123;</span><br><span class="line">        return CONTEXT.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void clear() &#123;</span><br><span class="line">        CONTEXT.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring Cache </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue实现跨域请求</title>
      <link href="/2019/02/02/Vue%E5%AE%9E%E7%8E%B0%E8%B7%A8%E5%9F%9F%E8%AF%B7%E6%B1%82/"/>
      <url>/2019/02/02/Vue%E5%AE%9E%E7%8E%B0%E8%B7%A8%E5%9F%9F%E8%AF%B7%E6%B1%82/</url>
      
        <content type="html"><![CDATA[<p>一般解决跨域问题可以通过CORS跨域、JSONP和反向代理跨域。下面分别介绍这三种跨域方式：</p><h2 id="1、CORS"><a href="#1、CORS" class="headerlink" title="1、CORS"></a>1、CORS</h2><p>以netty为例，支持跨域请求需要配置的返回头信息。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FullHttpResponse response = null;</span><br><span class="line">String responseStr = result.toString() + &quot;xxxxx&quot;;</span><br><span class="line">response.headers().set(&quot;response&quot;, MD5Util.getMD5Code(responseStr, true));</span><br><span class="line">response.headers().set(HttpHeaderNames.ACCESS_CONTROL_EXPOSE_HEADERS, &quot;response&quot;); // 有增加头的配置</span><br><span class="line">response.headers().set(HttpHeaderNames.CONTENT_TYPE, &quot;application/json&quot;);</span><br><span class="line">response.headers().set(HttpHeaderNames.CONTENT_LENGTH, response.content().readableBytes());</span><br><span class="line">response.headers().set(HttpHeaderNames.ACCESS_CONTROL_ALLOW_ORIGIN, &quot;*&quot;);</span><br><span class="line">response.headers().set(HttpHeaderNames.ACCESS_CONTROL_ALLOW_HEADERS, &quot;*&quot;);</span><br><span class="line">response.headers().set(&quot;Access-Control-Allow-Headers&quot;, &quot;PLATFORM,H5TOKEN,sign,UUID,RESOURCEPLATFORM,response&quot;); // 根据实际情况配置</span><br><span class="line">response.headers().set(HttpHeaderNames.CONNECTION, HttpHeaderValues.KEEP_ALIVE);</span><br><span class="line">ctx.writeAndFlush(response);</span><br></pre></td></tr></table></figure><p>spring全局配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class WebAppConfigurer extends WebMvcConfigurerAdapter &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void addCorsMappings(CorsRegistry registry) &#123;</span><br><span class="line">        registry.addMapping(&quot;/**&quot;)</span><br><span class="line">        .allowedOrigins(&quot;http://192.168.89.89&quot;) // 根据情况，可以是*</span><br><span class="line">                .allowedMethods(&quot;GET&quot;, &quot;POST&quot;,&quot;DELETE&quot;)</span><br><span class="line">                .allowCredentials(false).maxAge(3600);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>spring单接口配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@CrossOrigin(origins = &quot;*&quot;, maxAge = 3600) //* 可以改成ip地址</span><br><span class="line">@PostMapping(&quot;save&quot;)</span><br><span class="line">public ResponseEntity&lt;Result&gt; addNote(@RequestParam String noteName) &#123;</span><br><span class="line">    //</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="2、JSONP"><a href="#2、JSONP" class="headerlink" title="2、JSONP"></a>2、JSONP</h2><p>ajax与jsonp的异同：<br>1、ajax和jsonp这两种技术在调用方式上”看起来”很像，目的也一样，都是请求一个url，然后把服务器返回的数据进行处理，因此jquery和ext等框架都把jsonp作为ajax的一种形式进行了封装。<br>2、但ajax和jsonp其实本质上是不同的东西。ajax的核心是通过XmlHttpRequest获取非本页内容，而jsonp的核心则是动态添加。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span><br><span class="line">&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; &gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">     &lt;title&gt;Untitled Page&lt;/title&gt;</span><br><span class="line">      &lt;script type=&quot;text/javascript&quot; src=jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">      &lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">     jQuery(document).ready(function()&#123; </span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">             type: &quot;get&quot;,</span><br><span class="line">             async: false,</span><br><span class="line">             url: &quot;http://flightQuery.com/jsonp/flightResult.aspx?code=CA1998&quot;,</span><br><span class="line">             dataType: &quot;jsonp&quot;,</span><br><span class="line">             jsonp: &quot;callback&quot;,//传递给请求处理程序或页面的，用以获得jsonp回调函数名的参数名(一般默认为:callback)</span><br><span class="line">             jsonpCallback:&quot;flightHandler&quot;,//自定义的jsonp回调函数名称，默认为jQuery自动生成的随机函数名，也可以写&quot;?&quot;，jQuery会自动为你处理数据</span><br><span class="line">             success: function(json)&#123;</span><br><span class="line">                 alert(&#x27;您查询到航班信息：票价： &#x27; + json.price + &#x27; 元，余票： &#x27; + json.tickets + &#x27; 张。&#x27;);</span><br><span class="line">             &#125;,</span><br><span class="line">             error: function()&#123;</span><br><span class="line">                 alert(&#x27;fail&#x27;);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">     &#125;);</span><br><span class="line">     &lt;/script&gt;</span><br><span class="line">     &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h2 id="3、反向代理"><a href="#3、反向代理" class="headerlink" title="3、反向代理"></a>3、反向代理</h2><p>配置nginx就可以实现跨域，一般在生产环境采用这种方式。具体配置如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location /ticketManagement/ &#123;</span><br><span class="line">    proxy_pass http://116.6.1.53:9001/;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header Host $http_host;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>重放攻击的实现方案</title>
      <link href="/2018/06/23/%E9%87%8D%E6%94%BE%E6%94%BB%E5%87%BB%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/"/>
      <url>/2018/06/23/%E9%87%8D%E6%94%BE%E6%94%BB%E5%87%BB%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/</url>
      
        <content type="html"><![CDATA[<p>最近系统上线之前需要做安全测试，安全测试人员指出了系统存在重放攻击，由于之前项目没有遇到过这样的问题，在这里就详细探讨一下重放攻击。</p><p>所谓重放攻击就是攻击者发送一个目的主机已接收过的包，来达到欺骗系统的目的，主要用于身份认证过程。攻击者利用网络监听或者其他方式盗取认证凭据，之后再把它重新发给认证服务器。从这个解释上理解，加密可以有效防止会话劫持，但是却防止不了重放攻击。重放攻击任何网络通讯过程中都可能发生。</p><h2 id="1、基于timestamp的方案"><a href="#1、基于timestamp的方案" class="headerlink" title="1、基于timestamp的方案"></a>1、基于timestamp的方案</h2><p>每次HTTP请求，都需要加上timestamp参数，然后把timestamp和其他参数一起进行数字签名。因为一次正常的HTTP请求，从发出到达服务器一般都不会超过60s，所以服务器收到HTTP请求之后，首先判断时间戳参数与当前时间相比较，是否超过了60s，如果超过了则认为是非法的请求。<br>假如黑客通过抓包得到了我们的请求url：<br><a href="https://www.clang.asia/index/Info?uid=ZX07&stime=1480862753&sign=80b886d71449cb33355d017893720666">https://www.clang.asia/index/Info?uid=ZX07&amp;stime=1480862753&amp;sign=80b886d71449cb33355d017893720666</a><br>其中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String sign = md5(uid, token, stime);</span><br></pre></td></tr></table></figure><p>一般情况下，黑客从抓包重放请求耗时远远超过了60s，所以此时请求中的stime参数已经失效了。<br>如果黑客修改stime参数为当前的时间戳，则sign参数对应的数字签名就会失效，因为黑客不知道token值，没有办法生成新的数字签名。<br>但这种方式的漏洞也是显而易见的，如果在60s之内进行重放攻击，那就没办法了，所以这种方式不能保证请求仅一次有效。</p><h2 id="2、基于nonce的方案"><a href="#2、基于nonce的方案" class="headerlink" title="2、基于nonce的方案"></a>2、基于nonce的方案</h2><p>nonce的意思是仅一次有效的随机字符串，要求每次请求时，该参数要保证不同，所以该参数一般与时间戳有关，我们这里为了方便起见，直接使用时间戳的16进制，实际使用时可以加上客户端的ip地址、mac地址等信息做个哈希之后，作为nonce参数。<br>我们将每次请求的nonce参数存储到一个“集合”中，可以json格式存储到数据库或缓存中。<br>每次处理HTTP请求时，首先判断该请求的nonce参数是否在该“集合”中，如果存在则认为是非法请求。<br>假如黑客通过抓包得到了我们的请求url：<br><a href="https://www.clang.asia/index/Info?uid=ZX07&nonce=58442c21&sign=80b886d71449cb33355d017893720666">https://www.clang.asia/index/Info?uid=ZX07&amp;nonce=58442c21&amp;sign=80b886d71449cb33355d017893720666</a><br>其中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String sign = md5(uid, token, nonce);</span><br></pre></td></tr></table></figure><p>这种方式也有很大的问题，那就是存储nonce参数的“集合”会越来越大，验证nonce是否存在“集合”中的耗时会越来越长。我们不能让nonce“集合”无限大，所以需要定期清理该“集合”，但是一旦该“集合”被清理，我们就无法验证被清理了的nonce参数了。也就是说，假设该“集合”平均1天清理一次的话，我们抓取到的该url，虽然当时无法进行重放攻击，但是我们还是可以每隔一天进行一次重放攻击的。而且存储24小时内，所有请求的“nonce”参数，也是一笔不小的开销。</p><h2 id="3、基于timestamp和nonce的方案"><a href="#3、基于timestamp和nonce的方案" class="headerlink" title="3、基于timestamp和nonce的方案"></a>3、基于timestamp和nonce的方案</h2><p>那我们如果同时使用timestamp和nonce参数呢？nonce的一次性可以解决timestamp参数60s的问题，timestamp可以解决nonce参数“集合”越来越大的问题。<br>我们在timestamp方案的基础上，加上nonce参数，因为timstamp参数对于超过60s的请求，都认为非法请求，所以我们只需要存储60s的nonce参数的“集合”即可。<br>假如黑客通过抓包得到了我们的请求url：<br><a href="https://www.clang.asia/index/Info?uid=ZX07&stime=1480862753&nonce=58442c21&sign=80b886d71449cb33355d017893720666">https://www.clang.asia/index/Info?uid=ZX07&amp;stime=1480862753&amp;nonce=58442c21&amp;sign=80b886d71449cb33355d017893720666</a><br>其中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String sign = md5(uid, token, stime, nonce);</span><br></pre></td></tr></table></figure><p>如果在60s内，重放该HTTP请求，因为nonce参数已经在首次请求的时候被记录在服务器的nonce参数“集合”中，所以会被判断为非法请求。超过60s之后，stime参数就会失效，此时因为黑客不清楚token的值，所以无法重新生成签名。<br>综上，我们认为一次正常的HTTP请求发送不会超过60s，在60s之内的重放攻击可以由nonce参数保证，超过60s的重放攻击可以由stime参数保证。<br>因为nonce参数只会在60s之内起作用，所以只需要保存60s之内的nonce参数即可。<br>我们并不一定要每个60s去清理该nonce参数的集合，只需要在新的nonce到来时，判断nonce集合最后一次修改时间，超过60s的话，就清空该集合，存放新的nonce参数集合。其实nonce参数集合可以存放的时间更久一些，但是最少是60s。<br>随机数集合可以根据业务场景采用定期清理或根据大小自动清理的方案，例如该接口每秒的请求数最高为1000，则60s内的请求数量最多为1500*60&#x3D;90000，则我们在每次请求后检查集合大小是否超过90000，若超高该数量则清空。<br>整体验证流程:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">// 获取token</span><br><span class="line">String token = request.getHeader(&quot;token&quot;);</span><br><span class="line">// 获取时间戳</span><br><span class="line">String timestamp = request.getHeader(&quot;timestamp&quot;);</span><br><span class="line">// 获取随机字符串</span><br><span class="line">String nonceStr = request.getHeader(&quot;nonce&quot;);</span><br><span class="line">// 获取请求地址</span><br><span class="line">String url = request.getHeader(&quot;url&quot;);</span><br><span class="line">// 获取签名</span><br><span class="line">String signature = request.getHeader(&quot;sign&quot;);</span><br><span class="line"></span><br><span class="line">// 判断参数是否为空</span><br><span class="line">if (StringUtils.isBlank(token) || StringUtils.isBlank(timestamp) || StringUtils.isBlank(nonceStr) || StringUtils.isBlank(url) || StringUtils.isBlank(signature)) &#123;</span><br><span class="line">    //非法请求</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//验证token有效性，得到用户信息</span><br><span class="line">UserTokenInfo userTokenInfo = TokenUtils.getUserTokenInfo(token);</span><br><span class="line"></span><br><span class="line">if (userTokenInfo == null) &#123;</span><br><span class="line">    //token认证失败（防止token伪造）</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 判断请求的url参数是否正确</span><br><span class="line">if (!request.getRequestURI().equals(url))&#123;</span><br><span class="line">    //非法请求 (防止跨域攻击)</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 判断时间是否大于60秒</span><br><span class="line">if(DateUtils.getSecond()-DateUtils.toSecond(timestamp)&gt;60)&#123;</span><br><span class="line">    //请求超时(防止重放攻击)</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 判断该用户的nonceStr参数是否已经在redis中</span><br><span class="line">if (RedisUtils.haveNonceStr(userTokenInfo,nonceStr))&#123;</span><br><span class="line">    //请求仅一次有效（防止短时间内的重放攻击）</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 对请求头参数进行签名</span><br><span class="line">String stringB = SignUtil.signature(token, timestamp, nonceStr, url,request);</span><br><span class="line"></span><br><span class="line">// 如果签名验证不通过</span><br><span class="line">if (!signature.equals(stringB)) &#123;</span><br><span class="line">    //非法请求（防止请求参数被篡改）</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 将本次用户请求的nonceStr参数存到redis中设置60秒后自动删除</span><br><span class="line">RedisUtils.saveNonceStr(userTokenInfo,nonceStr,60);</span><br><span class="line"></span><br><span class="line">//开始处理合法的请求</span><br><span class="line">...</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>macOS下如何编译FFmpeg for macOS APP</title>
      <link href="/2017/08/11/macOS%E4%B8%8B%E5%A6%82%E4%BD%95%E7%BC%96%E8%AF%91FFmpeg-for-macOS-APP/"/>
      <url>/2017/08/11/macOS%E4%B8%8B%E5%A6%82%E4%BD%95%E7%BC%96%E8%AF%91FFmpeg-for-macOS-APP/</url>
      
        <content type="html"><![CDATA[<p>我们今天来说说如何编译出适用于macOS APP的库，包括动态库和静态库。</p><h2 id="一、基本编译"><a href="#一、基本编译" class="headerlink" title="一、基本编译"></a>一、基本编译</h2><p>1、首先我们下载一个最新的ffmpeg源码。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://git.ffmpeg.org/ffmpeg.git</span><br></pre></td></tr></table></figure><p>2、配置.&#x2F;configure选项，这个要注意需要设置对macOS最低版本的要求，否则是默认当前本机的最新系统如，这样的话在使用库的时候，如果是APP要运行在10.10及之下的系统时候，就会报错。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--extra-cflags=-mmacosx-version-min=10.8 --extra-ldflags=-mmacosx-version-min=10.8</span><br></pre></td></tr></table></figure><p>3、执行.&#x2F;configure内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --target-os=darwin --enable-static --enable-swscale --enable-nonfree  --enable-gpl --enable-version3 --enable-nonfree --disable-programs  --libdir=/ffmpegbuild/lib --incdir=/ffmpegbuild/include --enable-shared --extra-cflags=-mmacosx-version-min=10.8 --extra-ldflags=-mmacosx-version-min=10.8 </span><br></pre></td></tr></table></figure><p>4、执行编译和安装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; sudo make install  </span><br></pre></td></tr></table></figure><p>5、在根目录下的ffmpegbuild目录中，就是编译好的头文件和库文件，包括静态库和动态库。</p><h2 id="二、高级编译"><a href="#二、高级编译" class="headerlink" title="二、高级编译"></a>二、高级编译</h2><p>前面的之所以说是基本编译，主要都是ffmpeg自带的库的编译，包括了几乎全部的大部分的Decoder解码编译器，但是对于Encoder编码编译器，却不是特别多，比如aac就只有解码器没有编码器，如果想要对一个音频转换到aac格式，那么这时候就需要用的aac编码器。</p><p>1、下载和编译aac库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/mstorsjo/fdk-aac.git</span><br><span class="line">cd fdk-aac</span><br><span class="line">./autogen.sh /* 执行这个一步的需要automake，如果没有可以直接brew install automake */</span><br><span class="line">./configure —enable-shared —enable-static —prefix=/Users/forcetech/Downloads/opt/</span><br><span class="line">make &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure><p>当然也可以直接通过brew安装编译后的aac库，下面是我使用的命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install fdk-aac</span><br></pre></td></tr></table></figure><p>2、下载和编译x264库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone http://git.videolan.org/git/x264.git.</span><br><span class="line">cd x264</span><br><span class="line">./configure —disable-asm —enable-shared —enable-static —prefix=/Users/forcetech/Downloads/opt/</span><br><span class="line">make &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure><p>当然也可以直接通过brew安装编译后的x264库，下面是我使用的命令行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install x264</span><br></pre></td></tr></table></figure><p>3、.&#x2F;configure配置<br>这里要注意，需要把acc、x264的库文件和头文件的路径加到配置里面，要不回出错，提示aac not found。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --target-os=darwin --enable-static --enable-swscale --enable-libfdk-aac --enable-libx264 --enable-nonfree  --enable-gpl --enable-version3 --enable-nonfree --disable-programs  --libdir=/ffmpegbuild/lib --incdir=/ffmpegbuild/include --enable-shared --extra-cflags=-mmacosx-version-min=10.8 --extra-ldflags=-mmacosx-version-min=10.8 --extra-cflags=-I/Users/forcetech/Downloads/opt/include --extra-ldflags=-L/Users/forcetech/Downloads/opt/lib --prefix=/Users/forcetech/Downloads/opt/</span><br></pre></td></tr></table></figure><p>4、执行编译和安装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; sudo make install  </span><br></pre></td></tr></table></figure><p>5、在根目录下的ffmpegbuild目录中，就是编译好的头文件和库文件，包括静态库和动态库。</p>]]></content>
      
      
      <categories>
          
          <category> 音视频 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 音视频 </tag>
            
            <tag> macOS </tag>
            
            <tag> FFmpeg </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOS直播技术分享-直播播放器（六）</title>
      <link href="/2016/10/25/iOS%E7%9B%B4%E6%92%AD%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB-%E7%9B%B4%E6%92%AD%E6%92%AD%E6%94%BE%E5%99%A8%EF%BC%88%E5%85%AD%EF%BC%89/"/>
      <url>/2016/10/25/iOS%E7%9B%B4%E6%92%AD%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB-%E7%9B%B4%E6%92%AD%E6%92%AD%E6%94%BE%E5%99%A8%EF%BC%88%E5%85%AD%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>随着互联网技术的飞速发展，移动端播放视频的需求如日中天，由此也催生了一批开源、闭源的播放器，但是无论这个播放器功能是否强大、兼容性是否优秀，它的基本模块通常都是由以下部分组成：事务处理、数据的接收和解复用、音视频解码以及渲染，其基本框架如下图所示：</p><p><img src="https://clang.oss-cn-shenzhen.aliyuncs.com/blog/2016/iOS%E7%9B%B4%E6%92%AD%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB-%E7%9B%B4%E6%92%AD%E6%92%AD%E6%94%BE%E5%99%A8%EF%BC%88%E5%85%AD%EF%BC%89_1.png-watermark" alt="直播技术流程"><br>针对各种铺天盖地的播放器项目，选取了比较出众的ijkplayer进行源码剖析。它是一个基于FFPlay的轻量级Android&#x2F;iOS视频播放器，实现了跨平台的功能，API易于集成；编译配置可裁剪，方便控制安装包大小。</p><h1 id="一、总体说明"><a href="#一、总体说明" class="headerlink" title="一、总体说明"></a>一、总体说明</h1><p>打开ijkplayer，可看到其主要目录结构如下:</p><p>tool - 初始化项目工程脚本<br>config - 编译ffmpeg使用的配置文件<br>extra - 存放编译ijkplayer所需的依赖源文件, 如ffmpeg、openssl等<br>ijkmedia - 核心代码<br>&amp;emsp;&amp;emsp;ijkplayer - 播放器数据下载及解码相关<br>&amp;emsp;&amp;emsp;ijksdl - 音视频数据渲染相关<br>ios - iOS平台上的上层接口封装以及平台相关方法<br>android - android平台上的上层接口封装以及平台相关方法</p><h1 id="二、初始化流程"><a href="#二、初始化流程" class="headerlink" title="二、初始化流程"></a>二、初始化流程</h1><p>初始化完成的主要工作就是创建播放器对象，打开ijkplayer&#x2F;ios&#x2F;IJKMediaDemo&#x2F;IJKMediaDemo.xcodeproj工程，可看到IJKMoviePlayerViewController类中viewDidLoad方法中创建了IJKFFMoviePlayerController对象，即iOS平台上的播放器对象。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    self.player = [[IJKFFMoviePlayerController alloc] initWithContentURL:self.url withOptions:options];</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看ijkplayer&#x2F;ios&#x2F;IJKMediaPlayer&#x2F;IJKMediaPlayer&#x2F;IJKFFMoviePlayerController.m文件，其初始化方法具体实现如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (id)initWithContentURL:(NSURL *)aUrl</span><br><span class="line">             withOptions:(IJKFFOptions *)options</span><br><span class="line">&#123;</span><br><span class="line">    if (aUrl == nil)</span><br><span class="line">        return nil;</span><br><span class="line"></span><br><span class="line">    // Detect if URL is file path and return proper string for it</span><br><span class="line">    NSString *aUrlString = [aUrl isFileURL] ? [aUrl path] : [aUrl absoluteString];</span><br><span class="line"></span><br><span class="line">    return [self initWithContentURLString:aUrlString</span><br><span class="line">                              withOptions:options];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (id)initWithContentURLString:(NSString *)aUrlString</span><br><span class="line">                   withOptions:(IJKFFOptions *)options</span><br><span class="line">&#123;</span><br><span class="line">    if (aUrlString == nil)</span><br><span class="line">        return nil;</span><br><span class="line"></span><br><span class="line">    self = [super init];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        ......</span><br><span class="line">        // init player</span><br><span class="line">        _mediaPlayer = ijkmp_ios_create(media_player_msg_loop);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可发现在此创建了IjkMediaPlayer结构体实例_mediaPlayer：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">IjkMediaPlayer *ijkmp_ios_create(int (*msg_loop)(void*))</span><br><span class="line">&#123;</span><br><span class="line">    IjkMediaPlayer *mp = ijkmp_create(msg_loop);</span><br><span class="line">    if (!mp)</span><br><span class="line">        goto fail;</span><br><span class="line"></span><br><span class="line">    mp-&gt;ffplayer-&gt;vout = SDL_VoutIos_CreateForGLES2();</span><br><span class="line">    if (!mp-&gt;ffplayer-&gt;vout)</span><br><span class="line">        goto fail;</span><br><span class="line"></span><br><span class="line">    mp-&gt;ffplayer-&gt;pipeline = ffpipeline_create_from_ios(mp-&gt;ffplayer);</span><br><span class="line">    if (!mp-&gt;ffplayer-&gt;pipeline)</span><br><span class="line">        goto fail;</span><br><span class="line"></span><br><span class="line">    return mp;</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">    ijkmp_dec_ref_p(&amp;mp);</span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在该方法中主要完成了三个动作：</p><p>1、创建IJKMediaPlayer对象</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">IjkMediaPlayer *ijkmp_create(int (*msg_loop)(void*))</span><br><span class="line">&#123;</span><br><span class="line">    IjkMediaPlayer *mp = (IjkMediaPlayer *) mallocz(sizeof(IjkMediaPlayer));</span><br><span class="line">    ......</span><br><span class="line">    mp-&gt;ffplayer = ffp_create();</span><br><span class="line">    ......</span><br><span class="line">    mp-&gt;msg_loop = msg_loop;</span><br><span class="line">    ......</span><br><span class="line">    return mp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过ffp_create方法创建了FFPlayer对象，并设置消息处理函数。</p><p>2、创建图像渲染对象SDL_Vout</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SDL_Vout *SDL_VoutIos_CreateForGLES2()</span><br><span class="line">&#123;</span><br><span class="line">    SDL_Vout *vout = SDL_Vout_CreateInternal(sizeof(SDL_Vout_Opaque));</span><br><span class="line">    if (!vout)</span><br><span class="line">        return NULL;</span><br><span class="line"></span><br><span class="line">    SDL_Vout_Opaque *opaque = vout-&gt;opaque;</span><br><span class="line">    opaque-&gt;gl_view = nil;</span><br><span class="line">    vout-&gt;create_overlay = vout_create_overlay;</span><br><span class="line">    vout-&gt;free_l = vout_free_l;</span><br><span class="line">    vout-&gt;display_overlay = vout_display_overlay;</span><br><span class="line"></span><br><span class="line">    return vout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、创建平台相关的IJKFF_Pipeline对象，包括视频解码以及音频输出部分</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">IJKFF_Pipeline *ffpipeline_create_from_ios(FFPlayer *ffp)</span><br><span class="line">&#123;</span><br><span class="line">    IJKFF_Pipeline *pipeline = ffpipeline_alloc(&amp;g_pipeline_class, sizeof(IJKFF_Pipeline_Opaque));</span><br><span class="line">    if (!pipeline)</span><br><span class="line">        return pipeline;</span><br><span class="line"></span><br><span class="line">    IJKFF_Pipeline_Opaque *opaque     = pipeline-&gt;opaque;</span><br><span class="line">    opaque-&gt;ffp                       = ffp;</span><br><span class="line">    pipeline-&gt;func_destroy            = func_destroy;</span><br><span class="line">    pipeline-&gt;func_open_video_decoder = func_open_video_decoder;</span><br><span class="line">    pipeline-&gt;func_open_audio_output  = func_open_audio_output;</span><br><span class="line"></span><br><span class="line">    return pipeline;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此已经完成了ijkplayer播放器初始化的相关流程，简单来说，就是创建播放器对象，完成音视频解码、渲染的准备工作。</p><p>作者金山视频云，首发简书 <a href="https://www.jianshu.com/p/daf0a61cc1e0">Jianshu.com</a>  </p>]]></content>
      
      
      <categories>
          
          <category> 音视频 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 音视频 </tag>
            
            <tag> iOS </tag>
            
            <tag> 播放器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOS直播技术分享-延迟优化（五）</title>
      <link href="/2016/10/25/iOS%E7%9B%B4%E6%92%AD%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB-%E5%BB%B6%E8%BF%9F%E4%BC%98%E5%8C%96%EF%BC%88%E4%BA%94%EF%BC%89/"/>
      <url>/2016/10/25/iOS%E7%9B%B4%E6%92%AD%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB-%E5%BB%B6%E8%BF%9F%E4%BC%98%E5%8C%96%EF%BC%88%E4%BA%94%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>音视频的直播系统是一个复杂的工程系统，要做到非常低延迟的直播，需要复杂的系统工程优化和对各组件非常熟悉的掌握。这里分享几个简单而常用的调优技巧。</p><h2 id="编码优化"><a href="#编码优化" class="headerlink" title="编码优化"></a>编码优化</h2><p>1、确保 Codec 开启了最低延迟的设置。Codec 一般都会有低延迟优化的开关，对于 H.264 来说其效果尤其明显。很多人可能不知道 H.264 的解码器正常情况下会在显示之前缓存一定的视频帧，对于 QCIF 分辨率大小的视频（176 × 144）一般会缓存 16 帧，对于 720P 的视频则缓存 5 帧。对于第一帧的读取来说，这是一个很大的延迟。如果你的视频不是使用 H.264 来编码压缩的，确保没有使用到 B 帧，它对延迟也会有较大的影响，因为视频中 B 帧的解码依赖于前后的视频帧，会增加延迟。<br>2、编码器一般都会有码控造成的延迟，一般也叫做初始化延迟或者视频缓存检验器 VBV 的缓存大小，把它当成编码器和解码器比特流之间的缓存，在不影响视频质量的情况下可以将其设置得尽可能小也可以降低延迟。<br>3、如果是仅仅优化首开延迟，可以在视频帧间插入较多的关键帧，这样客户端收到视频流之后可以尽快解码。但如果需要优化传输过程中的累计延迟，尽可能少使用关键帧也就是 I 帧（GOP 变大），在保证同等视频质量的情况下，I 帧越多，码率越大，传输所需的网络带宽越多，也就意味着累计延迟可能越大。这个优化效果可能在秒级延迟的系统中不是很明显，但是在 100 ms 甚至更低延迟的系统中就会非常明显。同时，尽量使用 ACC-LC Codec 来编码音频，HE-ACC 或者 HE-ACC 2 虽然编码效率高，但是编码所需时间更长，而产生更大体积的音频造成的传输延迟对于视频流的传输来说影响更小。<br>4、不要使用视频 MJPEG 的视频压缩格式，至少使用不带 B 帧的 MPEG4 视频压缩格式（Simple profile），甚至最好使用 H.264 baseline profile（X264 还有一个「-tune zerolatency」的优化开关）。这样一个简单的优化可以降低延迟，因为它能够以更低的码率编码全帧率视频。<br>5、如果使用了 FFmpeg，降低「-probesize 」和「 -analyze duration」参数的值，这两个值用于视频帧信息监测和用于监测的时长，这两个值越大对编码延迟的影响越大，在直播场景下对于视频流来说 analyzeduration 参数甚至没有必要设定。<br>6、固定码率编码 CBR 可以一定程度上消除网络抖动影响，如果能够使用可变码率编码 VBR 可以节省一些不必要的网络带宽，降低一定的延迟。因此建议尽量使用 VBR 进行编码。</p><h2 id="传输协议优化"><a href="#传输协议优化" class="headerlink" title="传输协议优化"></a>传输协议优化</h2><p>1、在服务端节点和节点之间尽量使用 RTMP 而非基于 HTTP 的 HLS 协议进行传输，这样可以降低整体的传输延迟。这个主要针对终端用户使用 HLS 进行播放的情况。<br>2、如果终端用户使用 RTMP 来播放，尽量在靠近推流端的收流节点进行转码，这样传输的视频流比原始视频流更小。<br>3、如果有必要，可以使用定制的 UDP 协议来替换 TCP 协议，省去弱网环节下的丢包重传可以降低延迟。它的主要缺点在于，基于 UDP 协议进行定制的协议的视频流的传输和分发不够通用，CDN 厂商支持的是标准的传输协议。另一个缺点在于可能出现丢包导致的花屏或者模糊（缺少关键帧的解码参考），这就要求协议定制方在 UDP 基础之上做好丢包控制。 </p><h2 id="传输网络优化"><a href="#传输网络优化" class="headerlink" title="传输网络优化"></a>传输网络优化</h2><p>1、我们曾经介绍过七牛直播云的实时流传输网络，它是一种新型的节点自组织的网状传输网络，既适合国内多运营商网络条件下的传输优化，也适合众多海外直播的需求。<br>2、在服务端节点中缓存当前 GOP，配合播放器端优化视频首开时间。<br>3、服务端实时记录每个视频流流向每个环节时的秒级帧率和码率，实时监控码率和帧率的波动。<br>4、客户端（推流和播放）通过查询服务端准实时获取当前最优节点（5 秒一次），准实时下线当前故障节点和线路。</p><h2 id="推流、播放优化"><a href="#推流、播放优化" class="headerlink" title="推流、播放优化"></a>推流、播放优化</h2><p>1、考察发送端系统自带的网络 buffer 大小，系统可能在发送数据之前缓存数据，这个参数的调优也需要找到一个平衡点。<br>2、播放端缓存控制对于视频的首开延迟也有较大影响，如果仅优化首开延迟，可以在 0 缓存情况下在数据到达的时候立即解码。但如果在弱网环境下为了消除网络抖动造成的影响，设置一定的缓存也有必要，因此需要在直播的稳定性和首开延迟优化上找到平衡，调整优化缓冲区大小这个值。<br>3、播放端动态 buffer 策略，这是上面播放端缓存控制的改进版本。如果只是做 0 缓存和固定大小的缓存之间进行选择找到平衡，最终还是会选择一个固定大小的缓存，这对亿级的移动互联网终端用户来说并不公平，他们不同的网络状况决定了这个固定大小的缓存并不完全合适。因此，我们可以考虑一种「动态 buffer 策略」，在播放器开启的时候采用非常小甚至 0 缓存的策略，通过对下载首片视频的耗时来决定下一个时间片的缓存大小，同时在播放过程中实时监测当前网络，实时调整播放过程中缓存的大小。这样即可做到极低的首开时间，又可能够尽量消除网络抖动造成的影响。<br>4、动态码率播放策略。除了动态调整 buffer 大小的策略之外，也可以利用实时监测的网络信息来动态调整播放过程中的码率，在网络带宽不足的情况下降低码率进行播放，减少延迟。</p><p>以上，是在低延迟优化方面的部分技巧。实际上我们优化低延迟的时候并不是只关注「低延迟」，而是在保证其它条件不影响用户体验的情况下尽量做到低延迟，因此它的内容涉及到更多广泛的话题。而视频直播的优化也包含方方面面，这里只分享了其中经过我们实践的部分。随着实践的积累，我们接下来会在线上和线下分享更多关于视频直播甚至点播的优化技巧。</p>]]></content>
      
      
      <categories>
          
          <category> 音视频 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 音视频 </tag>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOS直播技术分享-推流和传输（四）</title>
      <link href="/2016/10/25/iOS%E7%9B%B4%E6%92%AD%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB-%E6%8E%A8%E6%B5%81%E5%92%8C%E4%BC%A0%E8%BE%93%EF%BC%88%E5%9B%9B%EF%BC%89/"/>
      <url>/2016/10/25/iOS%E7%9B%B4%E6%92%AD%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB-%E6%8E%A8%E6%B5%81%E5%92%8C%E4%BC%A0%E8%BE%93%EF%BC%88%E5%9B%9B%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>推流是直播的第一公里，直播的推流对这个直播链路影响非常大，如果推流的网络不稳定，无论我们如何做优化，观众的体验都会很糟糕。所以也是我们排查问题的第一步，如何系统地解决这类问题需要我们对相关理论有基础的认识。</p><p>推送协议</p><p>下面就先介绍一下都有哪些推送协议，他们在直播领域的现状和优缺点。<br>RTMP<br>WebRTC<br>基于 UDP 的私有协议</p><h2 id="1、RTMP"><a href="#1、RTMP" class="headerlink" title="1、RTMP"></a>1、RTMP</h2><p>RTMP 是 Real Time Messaging Protocol（实时消息传输协议）的首字母缩写。该协议基于 TCP，是一个协议族，包括 RTMP 基本协议及 RTMPT&#x2F;RTMPS&#x2F;RTMPE 等多种变种。RTMP 是一种设计用来进行实时数据通信的网络协议，主要用来在 Flash&#x2F;AIR 平台和支持 RTMP 协议的流媒体&#x2F;交互服务器之间进行音视频和数据通信。支持该协议的软件包括 Adobe Media Server&#x2F;Ultrant Media Server&#x2F;red5 等。<br>RTMP 是目前主流的流媒体传输协议，广泛用于直播领域，可以说市面上绝大多数的直播产品都采用了这个协议。</p><p>优点<br>CDN 支持良好，主流的 CDN 厂商都支持<br>协议简单，在各平台上实现容易</p><p>缺点<br>基于 TCP ，传输成本高，在弱网环境丢包率高的情况下问题显著<br>不支持浏览器推送<br>Adobe 私有协议，Adobe 已经不再更新</p><h2 id="2、WebRTC"><a href="#2、WebRTC" class="headerlink" title="2、WebRTC"></a>2、WebRTC</h2><p>WebRTC，名称源自网页即时通信（英语：Web Real-Time Communication）的缩写，是一个支持网页浏览器进行实时语音对话或视频对话的 API。它于 2011 年 6 月 1 日开源并在 Google、Mozilla、Opera 支持下被纳入万维网联盟的 W3C 推荐标准。</p><p>目前主要应用于视频会议和连麦中，协议分层如下：</p><p>优点<br>W3C 标准，主流浏览器支持程度高<br>Google 在背后支撑，并在各平台有参考实现<br>底层基于 SRTP 和 UDP，弱网情况优化空间大<br>可以实现点对点通信，通信双方延时低</p><p>缺点<br>ICE,STUN,TURN 传统 CDN 没有类似的服务提供</p><h2 id="3、基于-UDP-的私有协议"><a href="#3、基于-UDP-的私有协议" class="headerlink" title="3、基于 UDP 的私有协议"></a>3、基于 UDP 的私有协议</h2><p>有些直播应用会使用 UDP 做为底层协议开发自己的私有协议，因为 UDP 在弱网环境下的优势通过一些定制化的调优可以达到比较好的弱网优化效果，但同样因为是私有协议也势必有现实问题：</p><p>优点<br>更多空间进行定制化优化</p><p>缺点<br>开发成本高<br>CDN 不友好，需要自建 CDN 或者和 CDN 达成协议<br>独立作战，无法和社区一起演进</p>]]></content>
      
      
      <categories>
          
          <category> 音视频 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 音视频 </tag>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOS直播技术分享-视频编码（三）</title>
      <link href="/2016/07/11/iOS%E7%9B%B4%E6%92%AD%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB-%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81%EF%BC%88%E4%B8%89%EF%BC%89/"/>
      <url>/2016/07/11/iOS%E7%9B%B4%E6%92%AD%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB-%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81%EF%BC%88%E4%B8%89%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>x264是一种免费的、具有更优秀算法的符合H.264&#x2F;MPEG-4 AVC视频压缩编码标准格式的编码库。它同xvid一样都是开源项目，但x264是采用H.264标准的，而xvid是采用MPEG-4早期标准的。由于H.264是2003年正式发布的最新的视频编码标准，因此，在通常情况下，x264压缩出的视频文件在相同质量下要比xvid压缩出的文件要小，或者也可以说，在相同体积下比xvid压缩出的文件质量要好。它符合GPL许可证。 </p><p>iOS视频编码分为硬编码和软编码：硬编码就是利用手机专用的硬件进行编码，软编码是用CPU进行编码。由于苹果在iOS8开放的硬编码的API，故现在大多数的直播应用都是采用的硬编码。</p><h2 id="iOS硬编码"><a href="#iOS硬编码" class="headerlink" title="iOS硬编码"></a>iOS硬编码</h2><p>从iOS8开始，苹果开放了硬解码和硬编码API，框架为 VideoToolbox.framework， 此框架需要在iOS8及以上的系统上才能使用。  </p><p>此框架中的硬解码API是几个纯C函数，在任何OC或者 C++代码里都可以使用。使用的时候，首先，要把VideoToolbox.framework 添加到工程里，并且在要使用该API的文件中包含头文件#include &lt;VideoToolbox&#x2F;VideoToolbox.h&gt;，然后，就可以畅快的高效的对视频流进行硬编码了。</p><p>直接上代码来说明，首先是定义了编码所需的变量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@interface CLHardwareVideoEncoder ()&#123;</span><br><span class="line">    VTCompressionSessionRef compressionSession;</span><br><span class="line">    NSInteger frameCount;</span><br><span class="line">    NSData *sps;</span><br><span class="line">    NSData *pps;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    BOOL enabledWriteVideoFile;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@property (nonatomic, strong) CLLiveVideoConfiguration *configuration;</span><br><span class="line">@property (nonatomic,weak) id&lt;CLVideoEncodingDelegate&gt; h264Delegate;</span><br><span class="line">@property (nonatomic) BOOL isBackGround;</span><br><span class="line">@property (nonatomic) NSInteger currentVideoBitRate;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>初始化编码session</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (void)initCompressionSession&#123;</span><br><span class="line">    if(compressionSession)&#123;</span><br><span class="line">        VTCompressionSessionCompleteFrames(compressionSession, kCMTimeInvalid);</span><br><span class="line">        </span><br><span class="line">        VTCompressionSessionInvalidate(compressionSession);</span><br><span class="line">        CFRelease(compressionSession);</span><br><span class="line">        compressionSession = NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    OSStatus status = VTCompressionSessionCreate(NULL, _configuration.videoSize.width, _configuration.videoSize.height, kCMVideoCodecType_H264, NULL, NULL, NULL, VideoCompressonOutputCallback, (__bridge void *)self, &amp;compressionSession);</span><br><span class="line">    if(status != noErr)&#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _currentVideoBitRate = _configuration.videoBitRate;</span><br><span class="line">    VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_MaxKeyFrameInterval,(__bridge CFTypeRef)@(_configuration.videoMaxKeyframeInterval));</span><br><span class="line">    VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_MaxKeyFrameIntervalDuration,(__bridge CFTypeRef)@(_configuration.videoMaxKeyframeInterval));</span><br><span class="line">    VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_ExpectedFrameRate, (__bridge CFTypeRef)@(_configuration.videoFrameRate));</span><br><span class="line">    VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_AverageBitRate, (__bridge CFTypeRef)@(_configuration.videoBitRate));</span><br><span class="line">    NSArray *limit = @[@(_configuration.videoBitRate * 1.5/8),@(1)];</span><br><span class="line">    VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_DataRateLimits, (__bridge CFArrayRef)limit);</span><br><span class="line">    VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_RealTime, kCFBooleanFalse);</span><br><span class="line">    VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_ProfileLevel, kVTProfileLevel_H264_Main_AutoLevel);</span><br><span class="line">    VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_AllowFrameReordering, kCFBooleanFalse);</span><br><span class="line">    VTSessionSetProperty(compressionSession, kVTCompressionPropertyKey_H264EntropyMode, kVTH264EntropyMode_CABAC);</span><br><span class="line">    VTCompressionSessionPrepareToEncodeFrames(compressionSession);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编码输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (void)encodeVideoData:(CVImageBufferRef)pixelBuffer timeStamp:(uint64_t)timeStamp&#123;</span><br><span class="line">    if(_isBackGround) return;</span><br><span class="line">    </span><br><span class="line">    frameCount ++;</span><br><span class="line">    CMTime presentationTimeStamp = CMTimeMake(frameCount, (int32_t)_configuration.videoFrameRate);</span><br><span class="line">    VTEncodeInfoFlags flags;</span><br><span class="line">    CMTime duration = CMTimeMake(1, (int32_t)_configuration.videoFrameRate);</span><br><span class="line">    </span><br><span class="line">    NSDictionary *properties = nil;</span><br><span class="line">    if(frameCount % (int32_t)_configuration.videoMaxKeyframeInterval == 0)&#123;</span><br><span class="line">        properties = @&#123;(__bridge NSString *)kVTEncodeFrameOptionKey_ForceKeyFrame: @YES&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    NSNumber *timeNumber = @(timeStamp);</span><br><span class="line">    </span><br><span class="line">    VTCompressionSessionEncodeFrame(compressionSession, pixelBuffer, presentationTimeStamp, duration, (__bridge CFDictionaryRef)properties, (__bridge_retained void *)timeNumber, &amp;flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>回调</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">static void VideoCompressonOutputCallback(void *VTref, void *VTFrameRef, OSStatus status, VTEncodeInfoFlags infoFlags, CMSampleBufferRef sampleBuffer)</span><br><span class="line">&#123;</span><br><span class="line">    if(!sampleBuffer) return;</span><br><span class="line">    CFArrayRef array = CMSampleBufferGetSampleAttachmentsArray(sampleBuffer, true);</span><br><span class="line">    if(!array) return;</span><br><span class="line">    CFDictionaryRef dic = (CFDictionaryRef)CFArrayGetValueAtIndex(array, 0);</span><br><span class="line">    if(!dic) return;</span><br><span class="line">    </span><br><span class="line">    BOOL keyframe = !CFDictionaryContainsKey(dic, kCMSampleAttachmentKey_NotSync);</span><br><span class="line">    uint64_t timeStamp = [((__bridge_transfer NSNumber*)VTFrameRef) longLongValue];</span><br><span class="line">    </span><br><span class="line">    CLHardwareVideoEncoder *videoEncoder = (__bridge CLHardwareVideoEncoder *)VTref;</span><br><span class="line">    if(status != noErr)&#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (keyframe &amp;&amp; !videoEncoder-&gt;sps)</span><br><span class="line">    &#123;</span><br><span class="line">        CMFormatDescriptionRef format = CMSampleBufferGetFormatDescription(sampleBuffer);</span><br><span class="line">        </span><br><span class="line">        size_t sparameterSetSize, sparameterSetCount;</span><br><span class="line">        const uint8_t *sparameterSet;</span><br><span class="line">        OSStatus statusCode = CMVideoFormatDescriptionGetH264ParameterSetAtIndex(format, 0, &amp;sparameterSet, &amp;sparameterSetSize, &amp;sparameterSetCount, 0 );</span><br><span class="line">        if (statusCode == noErr)</span><br><span class="line">        &#123;</span><br><span class="line">            size_t pparameterSetSize, pparameterSetCount;</span><br><span class="line">            const uint8_t *pparameterSet;</span><br><span class="line">            OSStatus statusCode = CMVideoFormatDescriptionGetH264ParameterSetAtIndex(format, 1, &amp;pparameterSet, &amp;pparameterSetSize, &amp;pparameterSetCount, 0 );</span><br><span class="line">            if (statusCode == noErr)</span><br><span class="line">            &#123;</span><br><span class="line">                videoEncoder-&gt;sps = [NSData dataWithBytes:sparameterSet length:sparameterSetSize];</span><br><span class="line">                videoEncoder-&gt;pps = [NSData dataWithBytes:pparameterSet length:pparameterSetSize];</span><br><span class="line">                </span><br><span class="line">                if(videoEncoder-&gt;enabledWriteVideoFile)&#123;</span><br><span class="line">                    NSMutableData *data = [[NSMutableData alloc] init];</span><br><span class="line">                    uint8_t header[] = &#123;0x00,0x00,0x00,0x01&#125;;</span><br><span class="line">                    [data appendBytes:header length:4];</span><br><span class="line">                    [data appendData:videoEncoder-&gt;sps];</span><br><span class="line">                    [data appendBytes:header length:4];</span><br><span class="line">                    [data appendData:videoEncoder-&gt;pps];</span><br><span class="line">                    fwrite(data.bytes, 1,data.length,videoEncoder-&gt;fp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    CMBlockBufferRef dataBuffer = CMSampleBufferGetDataBuffer(sampleBuffer);</span><br><span class="line">    size_t length, totalLength;</span><br><span class="line">    char *dataPointer;</span><br><span class="line">    OSStatus statusCodeRet = CMBlockBufferGetDataPointer(dataBuffer, 0, &amp;length, &amp;totalLength, &amp;dataPointer);</span><br><span class="line">    if (statusCodeRet == noErr) &#123;</span><br><span class="line">        size_t bufferOffset = 0;</span><br><span class="line">        static const int AVCCHeaderLength = 4;</span><br><span class="line">        while (bufferOffset &lt; totalLength - AVCCHeaderLength) &#123;</span><br><span class="line">            // Read the NAL unit length</span><br><span class="line">            uint32_t NALUnitLength = 0;</span><br><span class="line">            memcpy(&amp;NALUnitLength, dataPointer + bufferOffset, AVCCHeaderLength);</span><br><span class="line">            </span><br><span class="line">            NALUnitLength = CFSwapInt32BigToHost(NALUnitLength);</span><br><span class="line"></span><br><span class="line">            CLVideoFrame *videoFrame = [CLVideoFrame new];</span><br><span class="line">            videoFrame.timestamp = timeStamp;</span><br><span class="line">            videoFrame.data = [[NSData alloc] initWithBytes:(dataPointer + bufferOffset + AVCCHeaderLength) length:NALUnitLength];</span><br><span class="line">            videoFrame.isKeyFrame = keyframe;</span><br><span class="line">            videoFrame.sps = videoEncoder-&gt;sps;</span><br><span class="line">            videoFrame.pps = videoEncoder-&gt;pps;</span><br><span class="line">            </span><br><span class="line">            if(videoEncoder.h264Delegate &amp;&amp; [videoEncoder.h264Delegate respondsToSelector:@selector(videoEncoder:videoFrame:)])&#123;</span><br><span class="line">                [videoEncoder.h264Delegate videoEncoder:videoEncoder videoFrame:videoFrame];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if(videoEncoder-&gt;enabledWriteVideoFile)&#123;</span><br><span class="line">                NSMutableData *data = [[NSMutableData alloc] init];</span><br><span class="line">                if(keyframe)&#123;</span><br><span class="line">                    uint8_t header[] = &#123;0x00,0x00,0x00,0x01&#125;;</span><br><span class="line">                    [data appendBytes:header length:4];</span><br><span class="line">                &#125;else&#123;</span><br><span class="line">                    uint8_t header[] = &#123;0x00,0x00,0x01&#125;;</span><br><span class="line">                    [data appendBytes:header length:3];</span><br><span class="line">                &#125;</span><br><span class="line">                [data appendData:videoFrame.data];</span><br><span class="line">                fwrite(data.bytes, 1,data.length,videoEncoder-&gt;fp);</span><br><span class="line">            &#125;</span><br><span class="line">            bufferOffset += AVCCHeaderLength + NALUnitLength;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="iOS软编码"><a href="#iOS软编码" class="headerlink" title="iOS软编码"></a>iOS软编码</h2><p>软编码主要是利用CPU进行编码的过程, 具体的编码通常会用FFmpeg+x264，需要自己先编译FFmpeg(iOS)和X264。</p><ul><li>将编译好的文件夹拖入到工程中</li><li>添加依赖库:<br>libiconv.dylib&#x2F;libz.dylib&#x2F;libbz2.dylib&#x2F;CoreMedia.framework&#x2F;AVFoundation.framework</li><li>FFmpeg编码两个重要的类</li><li>AVFormat<br>保存的是解码后和原始的音视频信息</li><li>AVPacket<br>解码完成的数据及附加信息（解码时间戳、显示时间戳、时长等）</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> *  设置X264</span><br><span class="line"> */</span><br><span class="line">- (int)setX264ResourceWithVideoWidth:(int)width height:(int)height bitrate:(int)bitrate</span><br><span class="line">&#123;</span><br><span class="line">    // 1.默认从第0帧开始(记录当前的帧数)</span><br><span class="line">    framecnt = 0;</span><br><span class="line"></span><br><span class="line">    // 2.记录传入的宽度&amp;高度</span><br><span class="line">    encoder_h264_frame_width = width;</span><br><span class="line">    encoder_h264_frame_height = height;</span><br><span class="line"></span><br><span class="line">    // 3.注册FFmpeg所有编解码器(无论编码还是解码都需要该步骤)</span><br><span class="line">    av_register_all();</span><br><span class="line"></span><br><span class="line">    // 4.初始化AVFormatContext: 用作之后写入视频帧并编码成 h264，贯穿整个工程当中(释放资源时需要销毁)</span><br><span class="line">    pFormatCtx = avformat_alloc_context();</span><br><span class="line"></span><br><span class="line">    // 5.设置输出文件的路径</span><br><span class="line">    fmt = av_guess_format(NULL, out_file, NULL);</span><br><span class="line">    pFormatCtx-&gt;oformat = fmt;</span><br><span class="line"></span><br><span class="line">    // 6.打开文件的缓冲区输入输出，flags 标识为  AVIO_FLAG_READ_WRITE ，可读写</span><br><span class="line">    if (avio_open(&amp;pFormatCtx-&gt;pb, out_file, AVIO_FLAG_READ_WRITE) &lt; 0)&#123;</span><br><span class="line">        printf(&quot;Failed to open output file! \n&quot;);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 7.创建新的输出流, 用于写入文件</span><br><span class="line">    video_st = avformat_new_stream(pFormatCtx, 0);</span><br><span class="line"></span><br><span class="line">    // 8.设置 20 帧每秒 ，也就是 fps 为 20</span><br><span class="line">    video_st-&gt;time_base.num = 1;</span><br><span class="line">    video_st-&gt;time_base.den = 25;</span><br><span class="line"></span><br><span class="line">    if (video_st==NULL)&#123;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 9.pCodecCtx 用户存储编码所需的参数格式等等</span><br><span class="line">    // 9.1.从媒体流中获取到编码结构体，他们是一一对应的关系，一个 AVStream 对应一个  AVCodecContext</span><br><span class="line">    pCodecCtx = video_st-&gt;codec;</span><br><span class="line"></span><br><span class="line">    // 9.2.设置编码器的编码格式(是一个id)，每一个编码器都对应着自己的 id，例如 h264 的编码 id 就是 AV_CODEC_ID_H264</span><br><span class="line">    pCodecCtx-&gt;codec_id = fmt-&gt;video_codec;</span><br><span class="line"></span><br><span class="line">    // 9.3.设置编码类型为 视频编码</span><br><span class="line">    pCodecCtx-&gt;codec_type = AVMEDIA_TYPE_VIDEO;</span><br><span class="line"></span><br><span class="line">    // 9.4.设置像素格式为 yuv 格式</span><br><span class="line">    pCodecCtx-&gt;pix_fmt = PIX_FMT_YUV420P;</span><br><span class="line"></span><br><span class="line">    // 9.5.设置视频的宽高</span><br><span class="line">    pCodecCtx-&gt;width = encoder_h264_frame_width;</span><br><span class="line">    pCodecCtx-&gt;height = encoder_h264_frame_height;</span><br><span class="line"></span><br><span class="line">    // 9.6.设置帧率</span><br><span class="line">    pCodecCtx-&gt;time_base.num = 1;</span><br><span class="line">    pCodecCtx-&gt;time_base.den = 15;</span><br><span class="line"></span><br><span class="line">    // 9.7.设置码率（比特率）</span><br><span class="line">    pCodecCtx-&gt;bit_rate = bitrate;</span><br><span class="line"></span><br><span class="line">    // 9.8.视频质量度量标准(常见qmin=10, qmax=51)</span><br><span class="line">    pCodecCtx-&gt;qmin = 10;</span><br><span class="line">    pCodecCtx-&gt;qmax = 51;</span><br><span class="line"></span><br><span class="line">    // 9.9.设置图像组层的大小(GOP--&gt;两个I帧之间的间隔)</span><br><span class="line">    pCodecCtx-&gt;gop_size = 250;</span><br><span class="line"></span><br><span class="line">    // 9.10.设置 B 帧最大的数量，B帧为视频图片空间的前后预测帧， B 帧相对于 I、P 帧来说，压缩率比较大，也就是说相同码率的情况下，</span><br><span class="line">    // 越多 B 帧的视频，越清晰，现在很多打视频网站的高清视频，就是采用多编码 B 帧去提高清晰度，</span><br><span class="line">    // 但同时对于编解码的复杂度比较高，比较消耗性能与时间</span><br><span class="line">    pCodecCtx-&gt;max_b_frames = 5;</span><br><span class="line"></span><br><span class="line">    // 10.可选设置</span><br><span class="line">    AVDictionary *param = 0;</span><br><span class="line">    // H.264</span><br><span class="line">    if(pCodecCtx-&gt;codec_id == AV_CODEC_ID_H264) &#123;</span><br><span class="line">        // 通过--preset的参数调节编码速度和质量的平衡。</span><br><span class="line">        av_dict_set(&amp;param, &quot;preset&quot;, &quot;slow&quot;, 0);</span><br><span class="line"></span><br><span class="line">        // 通过--tune的参数值指定片子的类型，是和视觉优化的参数，或有特别的情况。</span><br><span class="line">        // zerolatency: 零延迟，用在需要非常低的延迟的情况下，比如视频直播的编码</span><br><span class="line">        av_dict_set(&amp;param, &quot;tune&quot;, &quot;zerolatency&quot;, 0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 11.输出打印信息，内部是通过printf函数输出（不需要输出可以注释掉该局）</span><br><span class="line">    av_dump_format(pFormatCtx, 0, out_file, 1);</span><br><span class="line"></span><br><span class="line">    // 12.通过 codec_id 找到对应的编码器</span><br><span class="line">    pCodec = avcodec_find_encoder(pCodecCtx-&gt;codec_id);</span><br><span class="line">    if (!pCodec) &#123;</span><br><span class="line">        printf(&quot;Can not find encoder! \n&quot;);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 13.打开编码器，并设置参数 param</span><br><span class="line">    if (avcodec_open2(pCodecCtx, pCodec,&amp;param) &lt; 0) &#123;</span><br><span class="line">        printf(&quot;Failed to open encoder! \n&quot;);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 13.初始化原始数据对象: AVFrame</span><br><span class="line">    pFrame = av_frame_alloc();</span><br><span class="line"></span><br><span class="line">    // 14.通过像素格式(这里为 YUV)获取图片的真实大小，例如将 480 * 720 转换成 int 类型</span><br><span class="line">    avpicture_fill((AVPicture *)pFrame, picture_buf, pCodecCtx-&gt;pix_fmt, pCodecCtx-&gt;width, pCodecCtx-&gt;height);</span><br><span class="line"></span><br><span class="line">    // 15.h264 封装格式的文件头部，基本上每种编码都有着自己的格式的头部，想看具体实现的同学可以看看 h264 的具体实现</span><br><span class="line">    avformat_write_header(pFormatCtx, NULL);</span><br><span class="line"></span><br><span class="line">    // 16.创建编码后的数据 AVPacket 结构体来存储 AVFrame 编码后生成的数据</span><br><span class="line">    av_new_packet(&amp;pkt, picture_size);</span><br><span class="line"></span><br><span class="line">    // 17.设置 yuv 数据中 y 图的宽高</span><br><span class="line">    y_size = pCodecCtx-&gt;width * pCodecCtx-&gt;height;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>编码每一帧数据<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * 将CMSampleBufferRef格式的数据编码成h264并写入文件</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">- (void)encoderToH264:(CMSampleBufferRef)sampleBuffer</span><br><span class="line">&#123;</span><br><span class="line">    // 1.通过CMSampleBufferRef对象获取CVPixelBufferRef对象</span><br><span class="line">    CVPixelBufferRef imageBuffer = CMSampleBufferGetImageBuffer(sampleBuffer);</span><br><span class="line"></span><br><span class="line">    // 2.锁定imageBuffer内存地址开始进行编码</span><br><span class="line">    if (CVPixelBufferLockBaseAddress(imageBuffer, 0) == kCVReturnSuccess) &#123;</span><br><span class="line">        // 3.从CVPixelBufferRef读取YUV的值</span><br><span class="line">        // NV12和NV21属于YUV格式，是一种two-plane模式，即Y和UV分为两个Plane，但是UV（CbCr）为交错存储，而不是分为三个plane</span><br><span class="line">        // 3.1.获取Y分量的地址</span><br><span class="line">        UInt8 *bufferPtr = (UInt8 *)CVPixelBufferGetBaseAddressOfPlane(imageBuffer,0);</span><br><span class="line">        // 3.2.获取UV分量的地址</span><br><span class="line">        UInt8 *bufferPtr1 = (UInt8 *)CVPixelBufferGetBaseAddressOfPlane(imageBuffer,1);</span><br><span class="line"></span><br><span class="line">        // 3.3.根据像素获取图片的真实宽度&amp;高度</span><br><span class="line">        size_t width = CVPixelBufferGetWidth(imageBuffer);</span><br><span class="line">        size_t height = CVPixelBufferGetHeight(imageBuffer);</span><br><span class="line">        // 获取Y分量长度</span><br><span class="line">        size_t bytesrow0 = CVPixelBufferGetBytesPerRowOfPlane(imageBuffer,0);</span><br><span class="line">        size_t bytesrow1  = CVPixelBufferGetBytesPerRowOfPlane(imageBuffer,1);</span><br><span class="line">        UInt8 *yuv420_data = (UInt8 *)malloc(width * height *3/2);</span><br><span class="line"></span><br><span class="line">        /* convert NV12 data to YUV420*/</span><br><span class="line">        // 3.4.将NV12数据转成YUV420数据</span><br><span class="line">        UInt8 *pY = bufferPtr ;</span><br><span class="line">        UInt8 *pUV = bufferPtr1;</span><br><span class="line">        UInt8 *pU = yuv420_data + width*height;</span><br><span class="line">        UInt8 *pV = pU + width*height/4;</span><br><span class="line">        for(int i =0;i&lt;height;i++)</span><br><span class="line">        &#123;</span><br><span class="line">            memcpy(yuv420_data+i*width,pY+i*bytesrow0,width);</span><br><span class="line">        &#125;</span><br><span class="line">        for(int j = 0;j&lt;height/2;j++)</span><br><span class="line">        &#123;</span><br><span class="line">            for(int i =0;i&lt;width/2;i++)</span><br><span class="line">            &#123;</span><br><span class="line">                *(pU++) = pUV[i&lt;&lt;1];</span><br><span class="line">                *(pV++) = pUV[(i&lt;&lt;1) + 1];</span><br><span class="line">            &#125;</span><br><span class="line">            pUV+=bytesrow1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 3.5.分别读取YUV的数据</span><br><span class="line">        picture_buf = yuv420_data;</span><br><span class="line">        pFrame-&gt;data[0] = picture_buf;              // Y</span><br><span class="line">        pFrame-&gt;data[1] = picture_buf+ y_size;      // U</span><br><span class="line">        pFrame-&gt;data[2] = picture_buf+ y_size*5/4;  // V</span><br><span class="line"></span><br><span class="line">        // 4.设置当前帧</span><br><span class="line">        pFrame-&gt;pts = framecnt;</span><br><span class="line">        int got_picture = 0;</span><br><span class="line"></span><br><span class="line">        // 4.设置宽度高度以及YUV各式</span><br><span class="line">        pFrame-&gt;width = encoder_h264_frame_width;</span><br><span class="line">        pFrame-&gt;height = encoder_h264_frame_height;</span><br><span class="line">        pFrame-&gt;format = PIX_FMT_YUV420P;</span><br><span class="line"></span><br><span class="line">        // 5.对编码前的原始数据(AVFormat)利用编码器进行编码，将 pFrame 编码后的数据传入pkt 中</span><br><span class="line">        int ret = avcodec_encode_video2(pCodecCtx, &amp;pkt, pFrame, &amp;got_picture);</span><br><span class="line">        if(ret &lt; 0) &#123;</span><br><span class="line">            printf(&quot;Failed to encode! \n&quot;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 6.编码成功后写入 AVPacket 到 输入输出数据操作着 pFormatCtx 中，当然，记得释放内存</span><br><span class="line">        if (got_picture==1) &#123;</span><br><span class="line">            framecnt++;</span><br><span class="line">            pkt.stream_index = video_st-&gt;index;</span><br><span class="line">            ret = av_write_frame(pFormatCtx, &amp;pkt);</span><br><span class="line">            av_free_packet(&amp;pkt);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 7.释放yuv数据</span><br><span class="line">        free(yuv420_data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CVPixelBufferUnlockBaseAddress(imageBuffer, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>释放资源<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * 释放资源</span><br><span class="line"> */</span><br><span class="line">- (void)freeX264Resource</span><br><span class="line">&#123;</span><br><span class="line">    // 1.释放AVFormatContext</span><br><span class="line">    int ret = flush_encoder(pFormatCtx,0);</span><br><span class="line">    if (ret &lt; 0) &#123;</span><br><span class="line">        printf(&quot;Flushing encoder failed\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2.将还未输出的AVPacket输出出来</span><br><span class="line">    av_write_trailer(pFormatCtx);</span><br><span class="line"></span><br><span class="line">    // 3.关闭资源</span><br><span class="line">    if (video_st)&#123;</span><br><span class="line">        avcodec_close(video_st-&gt;codec);</span><br><span class="line">        av_free(pFrame);</span><br><span class="line">    &#125;</span><br><span class="line">    avio_close(pFormatCtx-&gt;pb);</span><br><span class="line">    avformat_free_context(pFormatCtx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int flush_encoder(AVFormatContext *fmt_ctx,unsigned int stream_index)</span><br><span class="line">&#123;</span><br><span class="line">    int ret;</span><br><span class="line">    int got_frame;</span><br><span class="line">    AVPacket enc_pkt;</span><br><span class="line">    if (!(fmt_ctx-&gt;streams[stream_index]-&gt;codec-&gt;codec-&gt;capabilities &amp;</span><br><span class="line">          CODEC_CAP_DELAY))</span><br><span class="line">        return 0;</span><br><span class="line"></span><br><span class="line">    while (1) &#123;</span><br><span class="line">        enc_pkt.data = NULL;</span><br><span class="line">        enc_pkt.size = 0;</span><br><span class="line">        av_init_packet(&amp;enc_pkt);</span><br><span class="line">        ret = avcodec_encode_video2 (fmt_ctx-&gt;streams[stream_index]-&gt;codec, &amp;enc_pkt,</span><br><span class="line">                                     NULL, &amp;got_frame);</span><br><span class="line">        av_frame_free(NULL);</span><br><span class="line">        if (ret &lt; 0)</span><br><span class="line">            break;</span><br><span class="line">        if (!got_frame)&#123;</span><br><span class="line">            ret=0;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = av_write_frame(fmt_ctx, &amp;enc_pkt);</span><br><span class="line">        if (ret &lt; 0)</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> 音视频 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 音视频 </tag>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOS直播技术分享-音频编码（二）</title>
      <link href="/2016/07/11/iOS%E7%9B%B4%E6%92%AD%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB-%E9%9F%B3%E9%A2%91%E7%BC%96%E7%A0%81%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
      <url>/2016/07/11/iOS%E7%9B%B4%E6%92%AD%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB-%E9%9F%B3%E9%A2%91%E7%BC%96%E7%A0%81%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="音频基础知识"><a href="#音频基础知识" class="headerlink" title="音频基础知识"></a>音频基础知识</h2><h3 id="PCM格式"><a href="#PCM格式" class="headerlink" title="PCM格式"></a>PCM格式</h3><p>pcm是经过话筒录音后直接得到的未经压缩的数据流<br>数据大小&#x3D;采样频率<em>采样位数</em>声道*秒数&#x2F;8<br>采样频率一般是44k，位数一般是8位或者16位，声道一般是单声道或者双声道<br>pcm属于编码格式，就是一串由多个样本值组成的数据流，本身没有任何头信息或者帧的概念。如果不是音频的录制者，光凭一段PCM数据，是没有办法知道它的采样率等信息的。</p><h3 id="AAC格式"><a href="#AAC格式" class="headerlink" title="AAC格式"></a>AAC格式</h3><p>初步了解，AAC文件可以没有文件头，全部由帧序列组成，每个帧由帧头和数据部分组成。帧头包含采样率、声道数、帧长度等，有点类似MP3格式。</p><h2 id="AAC编码"><a href="#AAC编码" class="headerlink" title="AAC编码"></a>AAC编码</h2><h3 id="初始化编码转换器"><a href="#初始化编码转换器" class="headerlink" title="初始化编码转换器"></a>初始化编码转换器</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">-(BOOL)createAudioConvert&#123; //根据输入样本初始化一个编码转换器</span><br><span class="line">    if (m_converter != nil)&#123;</span><br><span class="line">        return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    AudioStreamBasicDescription inputFormat = &#123;0&#125;;</span><br><span class="line">    inputFormat.mSampleRate = _configuration.audioSampleRate;</span><br><span class="line">    inputFormat.mFormatID = kAudioFormatLinearPCM;</span><br><span class="line">    inputFormat.mFormatFlags = kAudioFormatFlagIsSignedInteger | kAudioFormatFlagsNativeEndian | kAudioFormatFlagIsPacked;</span><br><span class="line">    inputFormat.mChannelsPerFrame = (UInt32)_configuration.numberOfChannels;</span><br><span class="line">    inputFormat.mFramesPerPacket = 1;</span><br><span class="line">    inputFormat.mBitsPerChannel = 16;</span><br><span class="line">    inputFormat.mBytesPerFrame = inputFormat.mBitsPerChannel / 8 * inputFormat.mChannelsPerFrame;</span><br><span class="line">    inputFormat.mBytesPerPacket = inputFormat.mBytesPerFrame * inputFormat.mFramesPerPacket;</span><br><span class="line">    </span><br><span class="line">    AudioStreamBasicDescription outputFormat; // 这里开始是输出音频格式</span><br><span class="line">    memset(&amp;outputFormat, 0, sizeof(outputFormat));</span><br><span class="line">    outputFormat.mSampleRate       = inputFormat.mSampleRate; // 采样率保持一致</span><br><span class="line">    outputFormat.mFormatID         = kAudioFormatMPEG4AAC;    // AAC编码 kAudioFormatMPEG4AAC kAudioFormatMPEG4AAC_HE_V2</span><br><span class="line">    outputFormat.mChannelsPerFrame = (UInt32)_configuration.numberOfChannels;;</span><br><span class="line">    outputFormat.mFramesPerPacket  = 1024;                    // AAC一帧是1024个字节</span><br><span class="line">    </span><br><span class="line">    const OSType subtype = kAudioFormatMPEG4AAC;</span><br><span class="line">    AudioClassDescription requestedCodecs[2] = &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            kAudioEncoderComponentType,</span><br><span class="line">            subtype,</span><br><span class="line">            kAppleSoftwareAudioCodecManufacturer</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            kAudioEncoderComponentType,</span><br><span class="line">            subtype,</span><br><span class="line">            kAppleHardwareAudioCodecManufacturer</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    OSStatus result = AudioConverterNewSpecific(&amp;inputFormat, &amp;outputFormat, 2, requestedCodecs, &amp;m_converter);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    if(result != noErr) return NO;</span><br><span class="line">    </span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="编码转换"><a href="#编码转换" class="headerlink" title="编码转换"></a>编码转换</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">char *aacBuf;</span><br><span class="line"></span><br><span class="line">if(!aacBuf)&#123;</span><br><span class="line">        aacBuf = malloc(inBufferList.mBuffers[0].mDataByteSize);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 初始化一个输出缓冲列表</span><br><span class="line">    AudioBufferList outBufferList;</span><br><span class="line">    outBufferList.mNumberBuffers              = 1;</span><br><span class="line">    outBufferList.mBuffers[0].mNumberChannels = inBufferList.mBuffers[0].mNumberChannels;</span><br><span class="line">    outBufferList.mBuffers[0].mDataByteSize   = inBufferList.mBuffers[0].mDataByteSize; // 设置缓冲区大小</span><br><span class="line">    outBufferList.mBuffers[0].mData           = aacBuf; // 设置AAC缓冲区</span><br><span class="line">    UInt32 outputDataPacketSize               = 1;</span><br><span class="line">    if (AudioConverterFillComplexBuffer(m_converter, inputDataProc, &amp;inBufferList, &amp;outputDataPacketSize, &amp;outBufferList, NULL) != noErr)&#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    AudioFrame *audioFrame = [AudioFrame new];</span><br><span class="line">    audioFrame.timestamp = timeStamp;</span><br><span class="line">    audioFrame.data = [NSData dataWithBytes:aacBuf length:outBufferList.mBuffers[0].mDataByteSize];</span><br><span class="line"></span><br><span class="line">    char exeData[2];</span><br><span class="line">    exeData[0] = _configuration.asc[0];</span><br><span class="line">    exeData[1] = _configuration.asc[1];</span><br><span class="line">    audioFrame.audioInfo =[NSData dataWithBytes:exeData length:2];</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 音视频 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 音视频 </tag>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOS直播技术分享-音视频采集（一）</title>
      <link href="/2016/07/02/iOS%E7%9B%B4%E6%92%AD%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB-%E9%9F%B3%E8%A7%86%E9%A2%91%E9%87%87%E9%9B%86%EF%BC%88%E4%B8%80%EF%BC%89/"/>
      <url>/2016/07/02/iOS%E7%9B%B4%E6%92%AD%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB-%E9%9F%B3%E8%A7%86%E9%A2%91%E9%87%87%E9%9B%86%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="1、iOS直播技术的流程"><a href="#1、iOS直播技术的流程" class="headerlink" title="1、iOS直播技术的流程"></a>1、iOS直播技术的流程</h2><p>直播技术的流程大致可以分为几个步骤：数据采集、图像处理（实时滤镜）、视频编码、封包、上传、云端（转码、录制、分发）、直播播放器。  </p><ul><li>数据采集：通过摄像头和麦克风获得实时的音视频数据；  </li><li>图像处理：将数据采集的输入流进行实时滤镜，得到我们美化之后的视频帧； </li><li>视频编码：编码分为软编码和硬编码。现在一般的编码方式都是H.264，比较新的H.265据说压缩率比较高，但算法也相当要复杂一些，使用还不够广泛。软编码是利用CPU进行编码，硬编码就是使用GPU进行编码，软编码支持现在所有的系统版本，由于苹果在iOS8才开放硬编码的API，故硬编码只支持iOS8以上的系统；  </li><li>封包：现在直播推流中，一般采用的格式是FLV；  </li><li>上传：常用的协议是利用RTMP协议进行推流；  </li><li>云端：进行流的转码、分发和录制；  </li><li>直播播放器：负责拉流、解码、播放。</li></ul><p>用一张腾讯云的图来说明上面的流程：<br><img src="https://clang.oss-cn-shenzhen.aliyuncs.com/blog/2016/iOS%E7%9B%B4%E6%92%AD%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB-%E9%9F%B3%E8%A7%86%E9%A2%91%E9%87%87%E9%9B%86%EF%BC%88%E4%B8%80%EF%BC%89_1.png-watermark" alt="直播技术流程"></p><h2 id="2、获取系统的授权"><a href="#2、获取系统的授权" class="headerlink" title="2、获取系统的授权"></a>2、获取系统的授权</h2><p>直播的第一步就是采集数据，包含视频和音频数据，由于iOS权限的要求，需要先获取访问摄像头和麦克风的权限：</p><p>请求获取访问摄像头权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">__weak typeof(self) _self = self;</span><br><span class="line">    AVAuthorizationStatus status = [AVCaptureDevice authorizationStatusForMediaType:AVMediaTypeVideo];</span><br><span class="line">    switch (status) &#123;</span><br><span class="line">        case AVAuthorizationStatusNotDetermined:&#123;</span><br><span class="line">            // 许可对话没有出现，发起授权许可</span><br><span class="line">            [AVCaptureDevice requestAccessForMediaType:AVMediaTypeVideo completionHandler:^(BOOL granted) &#123;</span><br><span class="line">                if (granted) &#123;</span><br><span class="line">                    dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                        [_self.session setRunning:YES];</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;];</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        case AVAuthorizationStatusAuthorized:&#123;</span><br><span class="line">            // 已经开启授权，可继续</span><br><span class="line">            [_self.session setRunning:YES];</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        case AVAuthorizationStatusDenied:</span><br><span class="line">        case AVAuthorizationStatusRestricted:</span><br><span class="line">            // 用户明确地拒绝授权，或者相机设备无法访问</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>请求获取访问麦克风权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">AVAuthorizationStatus status = [AVCaptureDevice authorizationStatusForMediaType:AVMediaTypeAudio];</span><br><span class="line">    switch (status) &#123;</span><br><span class="line">        case AVAuthorizationStatusNotDetermined:&#123;</span><br><span class="line">            [AVCaptureDevice requestAccessForMediaType:AVMediaTypeAudio completionHandler:^(BOOL granted) &#123;</span><br><span class="line">            &#125;];</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        case AVAuthorizationStatusAuthorized:&#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        case AVAuthorizationStatusDenied:</span><br><span class="line">        case AVAuthorizationStatusRestricted:</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="3、配置采样参数"><a href="#3、配置采样参数" class="headerlink" title="3、配置采样参数"></a>3、配置采样参数</h2><p> 音频：需要配置码率、采样率；<br> 视频：需要配置视频分辨率、视频的帧率、视频的码率。</p><h2 id="4、音视频的录制"><a href="#4、音视频的录制" class="headerlink" title="4、音视频的录制"></a>4、音视频的录制</h2><p> 音频的录制</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">self.taskQueue = dispatch_queue_create(&quot;com.1905.live.audioCapture.Queue&quot;, NULL);</span><br><span class="line">       </span><br><span class="line">       AVAudioSession *session = [AVAudioSession sharedInstance];</span><br><span class="line">       [session setActive:YES withOptions:kAudioSessionSetActiveFlag_NotifyOthersOnDeactivation error:nil];</span><br><span class="line">       </span><br><span class="line">       [[NSNotificationCenter defaultCenter] addObserver: self</span><br><span class="line">                                                selector: @selector(handleRouteChange:)</span><br><span class="line">                                                    name: AVAudioSessionRouteChangeNotification</span><br><span class="line">                                                  object: session];</span><br><span class="line">       [[NSNotificationCenter defaultCenter] addObserver: self</span><br><span class="line">                                                selector: @selector(handleInterruption:)</span><br><span class="line">                                                    name: AVAudioSessionInterruptionNotification</span><br><span class="line">                                                  object: session];</span><br><span class="line">       </span><br><span class="line">       NSError *error = nil;</span><br><span class="line">       </span><br><span class="line">       [session setCategory:AVAudioSessionCategoryPlayAndRecord withOptions:AVAudioSessionCategoryOptionDefaultToSpeaker | AVAudioSessionCategoryOptionMixWithOthers error:nil];</span><br><span class="line">       </span><br><span class="line">       [session setMode:AVAudioSessionModeVideoRecording error:&amp;error];</span><br><span class="line">       </span><br><span class="line">       if (![session setActive:YES error:&amp;error]) &#123;</span><br><span class="line">           [self handleAudioComponentCreationFailure];</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       AudioComponentDescription acd;</span><br><span class="line">       acd.componentType = kAudioUnitType_Output;</span><br><span class="line">       acd.componentSubType = kAudioUnitSubType_RemoteIO;</span><br><span class="line">       acd.componentManufacturer = kAudioUnitManufacturer_Apple;</span><br><span class="line">       acd.componentFlags = 0;</span><br><span class="line">       acd.componentFlagsMask = 0;</span><br><span class="line">       </span><br><span class="line">       self.component = AudioComponentFindNext(NULL, &amp;acd);</span><br><span class="line">       </span><br><span class="line">       OSStatus status = noErr;</span><br><span class="line">       status = AudioComponentInstanceNew(self.component, &amp;_componetInstance);</span><br><span class="line">       </span><br><span class="line">       if (noErr != status) &#123;</span><br><span class="line">           [self handleAudioComponentCreationFailure];</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       UInt32 flagOne = 1;</span><br><span class="line">       </span><br><span class="line">       AudioUnitSetProperty(self.componetInstance, kAudioOutputUnitProperty_EnableIO, kAudioUnitScope_Input, 1, &amp;flagOne, sizeof(flagOne));</span><br><span class="line">       </span><br><span class="line">       AudioStreamBasicDescription desc = &#123;0&#125;;</span><br><span class="line">       desc.mSampleRate = _configuration.audioSampleRate;</span><br><span class="line">       desc.mFormatID = kAudioFormatLinearPCM;</span><br><span class="line">       desc.mFormatFlags = kAudioFormatFlagIsSignedInteger | kAudioFormatFlagsNativeEndian | kAudioFormatFlagIsPacked;</span><br><span class="line">       desc.mChannelsPerFrame = (UInt32)_configuration.numberOfChannels;</span><br><span class="line">       desc.mFramesPerPacket = 1;</span><br><span class="line">       desc.mBitsPerChannel = 16;</span><br><span class="line">       desc.mBytesPerFrame = desc.mBitsPerChannel / 8 * desc.mChannelsPerFrame;</span><br><span class="line">       desc.mBytesPerPacket = desc.mBytesPerFrame * desc.mFramesPerPacket;</span><br><span class="line">       </span><br><span class="line">       AURenderCallbackStruct cb;</span><br><span class="line">       cb.inputProcRefCon = (__bridge void *)(self);</span><br><span class="line">       cb.inputProc = handleInputBuffer;</span><br><span class="line">       status = AudioUnitSetProperty(self.componetInstance, kAudioUnitProperty_StreamFormat, kAudioUnitScope_Output, 1, &amp;desc, sizeof(desc));</span><br><span class="line">       status = AudioUnitSetProperty(self.componetInstance, kAudioOutputUnitProperty_SetInputCallback, kAudioUnitScope_Global, 1, &amp;cb, sizeof(cb));</span><br><span class="line">       </span><br><span class="line">       status = AudioUnitInitialize(self.componetInstance);</span><br><span class="line">       </span><br><span class="line">       if (noErr != status) &#123;</span><br><span class="line">           [self handleAudioComponentCreationFailure];</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       [session setPreferredSampleRate:_configuration.audioSampleRate error:nil];</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">       [session setActive:YES error:nil];</span><br></pre></td></tr></table></figure><p>视频的录制：调用GPUImage中的GPUImageVideoCamera</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_videoCamera = [[GPUImageVideoCamera alloc] initWithSessionPreset:_configuration.avSessionPreset cameraPosition:AVCaptureDevicePositionFront];</span><br><span class="line">_videoCamera.outputImageOrientation = _configuration.orientation;</span><br><span class="line">_videoCamera.horizontallyMirrorFrontFacingCamera = NO;</span><br><span class="line">_videoCamera.horizontallyMirrorRearFacingCamera = NO;</span><br><span class="line">_videoCamera.frameRate = (int32_t)_configuration.videoFrameRate;</span><br><span class="line">        </span><br><span class="line">_gpuImageView = [[GPUImageView alloc] initWithFrame:[UIScreen mainScreen].bounds];</span><br><span class="line">[_gpuImageView setFillMode:kGPUImageFillModePreserveAspectRatioAndFill];</span><br><span class="line">[_gpuImageView setAutoresizingMask:UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleHeight];</span><br><span class="line">        [_gpuImageView setInputRotation:kGPUImageFlipHorizonal atIndex:0];</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 音视频 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 音视频 </tag>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Github+Hexo搭建免费个人博客</title>
      <link href="/2016/06/10/Github-Hexo%E6%90%AD%E5%BB%BA%E5%85%8D%E8%B4%B9%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/"/>
      <url>/2016/06/10/Github-Hexo%E6%90%AD%E5%BB%BA%E5%85%8D%E8%B4%B9%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</url>
      
        <content type="html"><![CDATA[<p>经过各种找资料，踩过各种坑，终于搭建好了hexo，域名目前用的是github的，我的hexo是3.2.2版本，hexo不同的版本，很多配置都不一样。好吧，废话不多说了，开始吧。  </p><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>这篇教程是针对Mac的，之前是想着写博客，一方面是给自己做笔记，可以提升自己的写作、总结能力。一个技术点我们会使用，并不难，但是要做到让别人也能听懂，还是需要一定的技巧和经验的。很多类似于CSDN、博客园也都可以写文章，但是页面的样式我不是太喜欢，简书还算好点（我的文章在简书上也有同步）。最近看到一些大神们的博客，貌似都是用hexo写的，我也依葫芦画瓢的搭建了一个。不啰嗦了，直接上搭建步骤。</p><h2 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h2><h3 id="安装Node-js（必须）"><a href="#安装Node-js（必须）" class="headerlink" title="安装Node.js（必须）"></a>安装Node.js（必须）</h3><p>作用：用来生成静态页面。<br>到Node.js<a href="https://nodejs.org/en/">官网</a>下载相应平台的最新版本，按照提示一路安装即可。</p><h3 id="安装Git（必须）"><a href="#安装Git（必须）" class="headerlink" title="安装Git（必须）"></a>安装Git（必须）</h3><p>作用：把本地的hexo内容提交到github上去。<br>如果已经安装了Xcode就自带Git，我就不多说了。</p><h3 id="申请GitHub（必须）"><a href="#申请GitHub（必须）" class="headerlink" title="申请GitHub（必须）"></a>申请GitHub（必须）</h3><p>作用：是用来做博客的远程仓库、域名、服务器之类的，怎么与本地hexo建立连接等下讲。<br><a href="https://github.com/">Github</a>账号我也不再啰嗦了，没有的话直接申请就行了，跟一般的注册账号差不多，SSH Keys，看你自己了，可以不配置，不配置的话以后每次对自己的博客有改动提交的时候就要手动输入账号密码，假如配置了就不需要了，怎么配置我就不多说了，网上有很多教程。</p><h2 id="开始安装Hexo"><a href="#开始安装Hexo" class="headerlink" title="开始安装Hexo"></a>开始安装Hexo</h2><h3 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h3><p>Node.js和Git都安装好后，可执行如下命令安装hexo：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo npm install -g hexo</span><br></pre></td></tr></table></figure><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>然后，执行init命令初始化hexo到你指定的目录，我是直接cd到目标，在目录里执行如下命令:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo init</span><br></pre></td></tr></table></figure><p>好啦，至此，全部安装工作已经完成！</p><h3 id="生成静态页面"><a href="#生成静态页面" class="headerlink" title="生成静态页面"></a>生成静态页面</h3><p>cd 到你的init目录，执行如下命令，生成静态页面至public目录。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate（hexo g也可以）</span><br></pre></td></tr></table></figure><h3 id="本地启动"><a href="#本地启动" class="headerlink" title="本地启动"></a>本地启动</h3><p>启动本地服务，进行文章预览调试，命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>在浏览器中输入:<a href="http://localhost:4000/">http://localhost:4000</a><br>我不知道你们能不能，反正我不能，因为我还没有把环境配置好<br>我把我报的一些错，和解决方式列出来：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR Plugin load failed: hexo-server</span><br></pre></td></tr></table></figure><p>原因：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Besides, utilities are separated into a standalone module. hexo.util is not reachable anymore.</span><br></pre></td></tr></table></figure><p>解决方法，执行命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo npm install hexo-server --save </span><br></pre></td></tr></table></figure><p>安装完成后，输入以下命令以启动服务器，您的网站会在 <a href="http://localhost:4000/">http://localhost:4000</a> 下启动。在服务器启动期间，Hexo 会监视文件变动并自动更新，您无须重启服务器。<br>这个时候再重新生成静态文件，命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate（或hexo g）  </span><br></pre></td></tr></table></figure><p>启动本地服务器：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>如果您想要更改端口，或是在执行时遇到了 EADDRINUSE 错误，可以在执行时使用 -p 选项指定其他端口，如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server -p 5000</span><br></pre></td></tr></table></figure><h2 id="配置-Github"><a href="#配置-Github" class="headerlink" title="配置 Github"></a>配置 Github</h2><h3 id="建立Repository"><a href="#建立Repository" class="headerlink" title="建立Repository"></a>建立Repository</h3><p>建立与你用户名对应的仓库，仓库名必须为【your_user_name.github.io】，固定写法。然后建立关联，我的blog在本地&#x2F;Users&#x2F;chenhu&#x2F;Documents&#x2F;Hexo，这里面有：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_config.yml    node_modules    public        source　　　　</span><br><span class="line">db.json        package.json    scaffolds    themes</span><br></pre></td></tr></table></figure><p>现在我们需要修改_config.yml文件来建立关联，命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim _config.yml</span><br></pre></td></tr></table></figure><p>翻到最下面，改成类似我这样子</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repository: https://github.com/chenhu1001/chenhu1001.github.io.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure><p>执行如下命令才能使用git部署</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure><p>网上会有很多说法，有的type是github，还有repository最后面的后缀也不一样，是github.com.git，我也踩了很多坑，我现在的版本是hexo:3.2.2，执行命令hexo -version就出来了，貌似3.0以后全部改成我上面这种格式了。<br>然后，执行配置命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>然后再浏览器中输入<a href="https://chenhu1001.github.io/">https://chenhu1001.github.io</a>就行了，我的github账户叫chenhu1001，把这个改成你github的账户名就行了。</p><h2 id="部署步骤"><a href="#部署步骤" class="headerlink" title="部署步骤"></a>部署步骤</h2><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>每次部署的步骤，可按以下三步来进行。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean  </span><br><span class="line">hexo generate  </span><br><span class="line">hexo deploy</span><br></pre></td></tr></table></figure><p>还可以将上面的3个命令封装成一个shell脚本（publish.sh），放在Hexo对应的目录下方便上传部署。</p><h3 id="一些常用命令："><a href="#一些常用命令：" class="headerlink" title="一些常用命令："></a>一些常用命令：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hexo new &quot;postName&quot;   //新建文章  </span><br><span class="line">hexo new page &quot;pageName&quot;   //新建页面  </span><br><span class="line">hexo generate   //生成静态页面至public目录  </span><br><span class="line">hexo server   //开启预览访问端口（默认端口4000，&#x27;ctrl + c&#x27;关闭server）  </span><br><span class="line">hexo deploy   //将Hexo部署到GitHub  </span><br><span class="line">hexo help   //查看帮助  </span><br><span class="line">hexo version   //查看Hexo的版本   </span><br><span class="line">&amp;emsp;&amp;emsp;   //段落前空两格(为了显示，没有转移符) </span><br><span class="line">&lt;!--more--&gt;   //用于文章的隔断，显示更多  </span><br><span class="line">[iOS,WebRTC,直播,FFMpeg]   //用于写文章时增加tag</span><br></pre></td></tr></table></figure><h3 id="一些基本路径"><a href="#一些基本路径" class="headerlink" title="一些基本路径"></a>一些基本路径</h3><p>文章在source&#x2F;_posts下，支持Markdown语法，可以用Markdown编辑器进行编辑，如果想修改头像可以直接在主题的_config.yml文件里面修改，友情链接之类的都在这里，开始打理你的博客吧，有什么问题或者建议，都可以提出来，我会继续完善的。  </p><h2 id="Markdown语法"><a href="#Markdown语法" class="headerlink" title="Markdown语法"></a>Markdown语法</h2><p><a href="https://www.zybuluo.com/mdeditor">实用的Markdown语法例子</a></p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
            <tag> Github </tag>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
